<!doctype html><html lang=fr><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta charset=utf-8><meta name=robots content="noindex, nofollow, noarchive, nosnipper, noodp, noydir"><meta name=google content="notranslate, noimageindex"><meta name=slurp content="notranslate, noimageindex"><meta name=msnbot content="notranslate, noimageindex"><meta name=bingbot content="notranslate, noimageindex"><meta name=generator content="Hugo 0.125.1"><link rel=stylesheet href=https://www.pragmatias.fr//css/bootstrap.min.css><link rel=stylesheet href=https://www.pragmatias.fr//css/pragmatias.css><script src=https://www.pragmatias.fr//js/jquery-3.6.0.slim.min.js></script><script src=https://www.pragmatias.fr//js/popper.min.js></script><script src=https://www.pragmatias.fr//js/bootstrap.bundle.min.js></script><link rel=alternate type=application/rss+xml href=https://www.pragmatias.fr/feed.xml><title>Databricks : Unity Catalog - Découverte - Partie 1 - Mise en place</title><body><div class="navbar navbar-expand-md prag-bg-primary prag-header" role=navigation><div class="container-fluid justify-content-center"><div class=navbar-brand><a href=https://www.pragmatias.fr/blog/><img src=/images/logo_pragmatias.svg alt=pragmatias></a></div><button class="navbar-toggler justify-content-end prag-navbar" type=button data-toggle=collapse data-target=#navbarSupportedContent1,#navbarSupportedContent2 aria-controls=navbarSupportedContent1 aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent1><ul class="navbar-nav text-center"><li class=nav-item><a class=nav-link href=https://www.pragmatias.fr/blog/>Blog</a></li><li class=nav-item><a class=nav-link href=https://www.pragmatias.fr/tags/>Tags</a></li><li class=nav-item><a class=nav-link href=https://www.pragmatias.fr/archives/>Archives</a></li></ul></div><div class="collapse navbar-collapse justify-content-md-end" id=navbarSupportedContent2><ul class="navbar-nav flex-row justify-content-center"><li class=nav-item><a href=https://www.pragmatias.fr/en/2023/05/04/databricks-unity-catalog-first-step-part-1-set-up/ class="prag_header_svg mr-1 ml-1"><img src=/images/united-kingdom-flag-round-xs-24.png alt=English></a></li><li class=nav-item><a href=https://www.pragmatias.fr/feed.xml title="Pragmatias Blog" class="prag_header_svg mr-1 ml-1"><svg height="24" style="enable-background:new 0 0 508.52 508.52" viewBox="0 0 508.52 508.52" width="24" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path style="fill-rule:evenodd;clip-rule:evenodd;fill:" d="M254.26.0C113.845.0.0 113.845.0 254.26s113.845 254.26 254.26 254.26 254.26-113.845 254.26-254.26C508.52 113.813 394.675.0 254.26.0zM137.141 412.441c-22.852.0-41.413-18.434-41.413-41.285.0-22.693 18.561-41.349 41.413-41.349 22.915.0 41.444 18.656 41.476 41.349C178.618 393.976 160.088 412.441 137.141 412.441zM241.197 412.791c0-39.029-15.16-75.674-42.62-103.071-27.46-27.524-63.978-42.716-102.785-42.716V207.38c113.177.0 205.315 92.137 205.315 205.41h-59.91zM347.001 412.727c0-138.603-112.669-251.399-251.145-251.399v-59.624c171.435.0 310.96 139.589 310.96 311.023H347.001z"/></svg></a></li><li class=nav-item><a href=mailto:contact@pragmatias.fr title=Mail class="prag_header_svg mr-1 ml-1"><svg height="24" style="enable-background:new 0 0 299.997 299.997" viewBox="0 0 299.997 299.997" width="24" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path style="fill-rule:evenodd;clip-rule:evenodd;fill:" d="M149.996.0C67.157.0.001 67.158.001 149.997c0 82.837 67.156 150 149.995 150s150-67.163 150-150C299.996 67.158 232.835.0 149.996.0zM149.999 52.686l88.763 55.35H61.236l88.763-55.35zm89.869 143.737h-.009c0 8.878-7.195 16.072-16.072 16.072H76.211c-8.878.0-16.072-7.195-16.072-16.072v-84.865c0-.939.096-1.852.252-2.749l84.808 52.883c.104.065.215.109.322.169.112.062.226.122.34.179.599.309 1.216.558 1.847.721.065.018.13.026.195.041.692.163 1.393.265 2.093.265h.005c.005.0.01.0.01.0.7.0 1.401-.099 2.093-.265.065-.016.13-.023.195-.041.63-.163 1.245-.412 1.847-.721.114-.057.228-.117.34-.179.106-.06.218-.104.322-.169l84.808-52.883c.156.897.252 1.808.252 2.749v84.865z"/></svg></a></li><li><a href=https://github.com/pragmatias/ title=github class="prag_header_svg mr-1 ml-1"><svg height="24" style="enable-background:new 0 0 438.549 438.549" viewBox="0 0 438.549 438.549" width="24" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path style="fill-rule:evenodd;clip-rule:evenodd;fill:" d="M409.132 114.573c-19.608-33.596-46.205-60.194-79.798-79.8C295.736 15.166 259.057 5.365 219.271 5.365c-39.781.0-76.472 9.804-110.063 29.408-33.596 19.605-60.192 46.204-79.8 79.8C9.803 148.168.0 184.854.0 224.63c0 47.78 13.94 90.745 41.827 128.906 27.884 38.164 63.906 64.572 108.063 79.227 5.14.954 8.945.283 11.419-1.996 2.475-2.282 3.711-5.14 3.711-8.562.0-.571-.049-5.708-.144-15.417-.098-9.709-.144-18.179-.144-25.406l-6.567 1.136c-4.187.767-9.469 1.092-15.846 1-6.374-.089-12.991-.757-19.842-1.999-6.854-1.231-13.229-4.086-19.13-8.559-5.898-4.473-10.085-10.328-12.56-17.556l-2.855-6.57c-1.903-4.374-4.899-9.233-8.992-14.559-4.093-5.331-8.232-8.945-12.419-10.848l-1.999-1.431c-1.332-.951-2.568-2.098-3.711-3.429-1.142-1.331-1.997-2.663-2.568-3.997-.572-1.335-.098-2.43 1.427-3.289s4.281-1.276 8.28-1.276l5.708.853c3.807.763 8.516 3.042 14.133 6.851 5.614 3.806 10.229 8.754 13.846 14.842 4.38 7.806 9.657 13.754 15.846 17.847 6.184 4.093 12.419 6.136 18.699 6.136s11.704-.476 16.274-1.423c4.565-.952 8.848-2.383 12.847-4.285 1.713-12.758 6.377-22.559 13.988-29.41-10.848-1.14-20.601-2.857-29.264-5.14-8.658-2.286-17.605-5.996-26.835-11.14-9.235-5.137-16.896-11.516-22.985-19.126-6.09-7.614-11.088-17.61-14.987-29.979-3.901-12.374-5.852-26.648-5.852-42.826.0-23.035 7.52-42.637 22.557-58.817-7.044-17.318-6.379-36.732 1.997-58.24 5.52-1.715 13.706-.428 24.554 3.853 10.85 4.283 18.794 7.952 23.84 10.994 5.046 3.041 9.089 5.618 12.135 7.708 17.705-4.947 35.976-7.421 54.818-7.421s37.117 2.474 54.823 7.421l10.849-6.849c7.419-4.57 16.18-8.758 26.262-12.565 10.088-3.805 17.802-4.853 23.134-3.138 8.562 21.509 9.325 40.922 2.279 58.24 15.036 16.18 22.559 35.787 22.559 58.817.0 16.178-1.958 30.497-5.853 42.966-3.9 12.471-8.941 22.457-15.125 29.979-6.191 7.521-13.901 13.85-23.131 18.986-9.232 5.14-18.182 8.85-26.84 11.136-8.662 2.286-18.415 4.004-29.263 5.146 9.894 8.562 14.842 22.077 14.842 40.539v60.237c0 3.422 1.19 6.279 3.572 8.562 2.379 2.279 6.136 2.95 11.276 1.995 44.163-14.653 80.185-41.062 108.068-79.226 27.88-38.161 41.825-81.126 41.825-128.906C438.536 184.851 428.728 148.168 409.132 114.573z"/></svg></a></li></ul></div></div></div><div id=content><div class=container-fluid><article class="blog-post blog-post-with-toc"><header><h2 class=blog-post-title>Databricks : Unity Catalog - Découverte - Partie 1 - Mise en place</h2><div class=blog-post-date><span>Dernière modification : 4 Mai 2023</span></div><div class=blog-post-date>Temps de lecture : 18 minute(s) - 3729 mots</div><div class=blog-post-tags><strong>Tags:</strong>
<a href=https://www.pragmatias.fr/tags/databricks/>Databricks</a>
<a href=https://www.pragmatias.fr/tags/unity-catalog/>Unity Catalog</a></div></header><aside class=prag-toc><h1 class=prag-toc-head>Sommaire</h1><div class=prag-toc-body><nav id=TableOfContents><ol><li><a href=#introduction>Introduction</a></li><li><a href=#quest-ce-quun-métastore>Qu&rsquo;est-ce qu&rsquo;un métastore</a></li><li><a href=#quest-ce-que-la-solution-unity-catalog>Qu&rsquo;est ce que la solution Unity Catalog</a></li><li><a href=#hiérarchie-des-objets>Hiérarchie des objets</a></li><li><a href=#contexte>Contexte</a><ol><li><a href=#schématisation>Schématisation</a></li><li><a href=#prérequis>Prérequis</a></li><li><a href=#les-étapes-à-réaliser>Les étapes à réaliser</a></li></ol></li><li><a href=#mise-en-place>Mise en place</a><ol><li><a href=#étape-n0--initialisation-des-variables-denvironnement>Étape n°0 : Initialisation des variables d&rsquo;environnement</a></li><li><a href=#étape-n1--création-de-la-ressource-aws-s3>Étape n°1 : Création de la ressource AWS S3</a></li><li><a href=#étape-n2--création-dune-politique-et-dun-rôle-avec-la-ressource-aws-iam>Étape n°2 : Création d&rsquo;une politique et d&rsquo;un rôle avec la ressource AWS IAM</a></li><li><a href=#step-n3--création-dun-metastore>Step n°3 : Création d&rsquo;un Metastore</a></li><li><a href=#étape-n4--création-dun-storage-credential>Étape n°4 : Création d&rsquo;un Storage Credential</a></li><li><a href=#étape-n5--association-dun-storage-credential-avec-un-metastore>Étape n°5 : Association d&rsquo;un Storage Credential avec un Metastore</a></li><li><a href=#étape-n6--association-dun-metastore-à-un-workspace-databricks>Étape n°6 : Association d&rsquo;un Metastore à un Workspace Databricks</a></li><li><a href=#étape-n7--nettoyage-des-variables-denvironnements>Étape n°7 : Nettoyage des variables d&rsquo;environnements</a></li></ol></li><li><a href=#conclusion>Conclusion</a></li><li><a href=#ressources>Ressources</a><ol><li><a href=#glossaire>Glossaire</a></li><li><a href=#gestion-de-la-connexion-pour-loutil-aws-cli>Gestion de la connexion pour l&rsquo;outil AWS CLI</a></li><li><a href=#gestion-de-la-connexion-pour-loutil-databricks-cli>Gestion de la connexion pour l&rsquo;outil Databricks CLI</a></li></ol></li></ol></nav></div></aside><a id=showTopBtn href=# class=prag-sticky-bot><svg height="24" id="Layer_1" style="enable-background:new 0 0 438.533 438.533" viewBox="0 0 438.533 438.533" width="24" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path style="fill-rule:evenodd;clip-rule:evenodd;fill:" d="M409.133 109.203c-19.608-33.592-46.205-60.189-79.798-79.796C295.736 9.801 259.058.0 219.273.0c-39.781.0-76.47 9.801-110.063 29.407-33.595 19.604-60.192 46.201-79.8 79.796C9.801 142.8.0 179.489.0 219.267c0 39.78 9.804 76.463 29.407 110.062 19.607 33.592 46.204 60.189 79.799 79.798 33.597 19.605 70.283 29.407 110.063 29.407s76.47-9.802 110.065-29.407c33.593-19.602 60.189-46.206 79.795-79.798 19.603-33.596 29.403-70.284 29.403-110.062C438.533 179.485 428.732 142.795 409.133 109.203zM361.449 231.831l-25.981 25.981c-3.613 3.613-7.901 5.42-12.847 5.42-4.948.0-9.229-1.807-12.847-5.42l-53.954-53.961v143.32c0 4.948-1.813 9.232-5.428 12.847-3.613 3.62-7.898 5.427-12.847 5.427h-36.547c-4.948.0-9.231-1.807-12.847-5.427-3.617-3.614-5.426-7.898-5.426-12.847v-143.32l-53.959 53.961c-3.431 3.425-7.708 5.133-12.85 5.133-5.14.0-9.423-1.708-12.85-5.133l-25.981-25.981c-3.422-3.429-5.137-7.714-5.137-12.852.0-5.137 1.709-9.419 5.137-12.847l103.356-103.353 25.981-25.981c3.427-3.425 7.71-5.14 12.847-5.14 5.142.0 9.423 1.715 12.849 5.14l25.98 25.981 103.35 103.353c3.432 3.427 5.14 7.71 5.14 12.847C366.589 224.117 364.881 228.402 361.449 231.831z"/></svg>
</a><script>$(document).ready(function(){$("#showTopBtn").removeClass("prag-sticky-bot"),$("#showTopBtn").addClass("prag-sticky-hide"),$(function(){$(window).scroll(function(){$(this).scrollTop()>900?($("#showTopBtn").addClass("prag-sticky-bot"),$("#showTopBtn").removeClass("prag-sticky-hide")):($("#showTopBtn").addClass("prag-sticky-hide"),$("#showTopBtn").removeClass("prag-sticky-bot"))})})})</script><div class=blog-post-main><p>Nous allons découvrir la solution <a href=https://docs.databricks.com/data-governance/unity-catalog/index.html>Unity Catalog</a> de Databricks et plus particulièrement comment la mettre en place sur un workspace existant.</p><p>Nous allons utiliser un Account Databricks sur AWS pour réaliser cette démonstration.</p><p><em>Note : Nous allons garder des termes techniques en anglais pour faciliter la compréhension</em></p><p><em>Note : Les travaux se basent sur l&rsquo;état de la solution Unity Catalog à la fin du 1er trimestre 2023 sur AWS et Azure.</em></p><h1 id=introduction>Introduction</h1><p>En décembre 2021, Databricks a annoncé la disponibilité générale du <a href=https://www.databricks.com/blog/2021/12/15/announcing-general-availability-of-databricks-sql.html>SQL Warehouse</a>. Cela représente une étape importante dans le développement de la plateforme Lakehouse afin de multiplier les usages des données stockées au format Delta. La gestion des données se faisait principalement en s&rsquo;appuyant sur Hive Metastore, ce qui avait pour inconvénient d&rsquo;être par défaut local à un Workspace Databricks.
Cela signifiait qu&rsquo;il fallait redéfinir les différents objets et la gestion des droits sur les différents Workspace Databricks nécessitant d&rsquo;accéder aux données de la plateforme Lakehouse si on voulait utiliser un SQL Warehouse sur les différents Workspace Databricks.</p><p>Afin d&rsquo;utiliser au mieux la plateforme Lakehouse et surtout de pouvoir gérer la gouvernance des données, nous attendions une solution de Databricks pour centraliser l&rsquo;ensemble des métadonnées au niveau de l&rsquo;Account Databricks et pouvoir faciliter le partage des informations entre Workspace Databricks.</p><p>A la fin de l&rsquo;été 2022, Databricks a annoncé la disponibilité générale de la solution Unity Catalog sur <a href=https://docs.databricks.com/release-notes/unity-catalog/20220825.html>AWS</a> et sur <a href=https://azure.microsoft.com/en-us/updates/generally-available-unity-catalog-for-azure-databricks/>Azure</a> puis fin du 1er trimestre 2023, l&rsquo;annonce a été faite sur <a href=https://www.databricks.com/blog/2023/03/22/announcing-general-availability-databricks-unity-catalog-google-cloud-platform.html>GCP</a>.
Avec ces annonces, Unity Catalog est devenu la solution par défaut pour la gouvernance de données pour la plateforme Lakehouse de Databricks (aussi bien sur AWS, Azure et GCP).</p><p>A la fin de l&rsquo;été 2022, Databricks a aussi annoncé la disponibilité générale du <a href=https://www.databricks.com/blog/2022/08/26/announcing-general-availability-delta-sharing.html>Delta Sharing</a> qui est une solution ouverte ayant pour objectif de partager de manière efficace, simple et sécurisée les données gérées par la plateforme Lakehouse avec des outils/technologies tierces (Python, Java, Scala, Power BI, et bien d&rsquo;autres) mais aussi avec d&rsquo;autres Account Databricks (utilisant ou non la solution Unity Catalog).</p><p>A la fin de l&rsquo;année 2022, Databricks a annoncé la disponibilité générale de la fonctionnalité <a href=https://www.databricks.com/blog/2022/12/12/announcing-general-availability-data-lineage-unity-catalog.html>Data Lineage</a>. Cette fonctionnalité étant très importante pour pouvoir suivre le cycle de vie de l&rsquo;ensemble des données sur la plateforme Lakehouse.</p><p>Afin de pouvoir rendre accessible au plus grand nombre la solution Unity Catalog qui est une solution clé dans l&rsquo;utilisation et la gestion de la plateforme Lakehouse de Databricks, une série de 5 articles a été rédigée dans un esprit de découverte (pédagogique) pour mettre en place et utiliser les différents fonctionnalités de la solution Unity Catalog.</p><p>Les 5 articles ont été organisé de la manière suivante :</p><ul><li>Databricks : Unity Catalog - Découverte - Partie 1 - Mise en place</li><li>Databricks : Unity Catalog - Découverte - Partie 2 - Gestion des données</li><li>Databricks : Unity Catalog - Découverte - Partie 3 - Data Lineage</li><li>Databricks : Unity Catalog - Découverte - Partie 4 - Delta Sharing</li><li>Databricks : Unity Catalog - Découverte - Partie 5 - Delta Live Tables</li></ul><p>Attention : Les travaux se basent sur l&rsquo;état de la solution Unity Catalog à la fin du 1er trimestre 2023 sur AWS et Azure.</p><p>Nous allons utiliser les outils suivants :</p><ul><li><a href=https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-getting-started.html>AWS CLI</a></li><li><a href=https://learn.microsoft.com/en-us/cli/azure/>Azure CLI</a></li><li><a href=https://docs.databricks.com/dev-tools/cli/index.html>Databricks CLI</a></li><li><a href=https://docs.databricks.com/dev-tools/api/index.html>Databricks REST API</a></li></ul><h1 id=quest-ce-quun-métastore>Qu&rsquo;est-ce qu&rsquo;un métastore</h1><p>Un métastore est un référentiel permettant de stocker un ensemble de métadonnées liés aux données (stockage, usage, options).</p><p>Une métadonnée est une information sur une donnée permettant de définir son contexte (description, droits, date et heure technique de création ou mise à jour, créateur, &mldr;) et son usage (stockage, structure, accès, &mldr;).</p><p>Un métastore peut être local à une instance d&rsquo;une ressource (un cluster, un workspace) ou central à l&rsquo;ensemble des ressources gérant des données.</p><p>Dans une entreprise ayant une gouvernance de données basée sur un modèle Data Lake, Datawarehouse ou Lakehouse par exemple, nous allons conseiller de mettre en place un métastore centralisé permettant de stocker l&rsquo;ensemble des métadonnées des données de l&rsquo;entreprise pour pouvoir faciliter la gouvernance, l&rsquo;usage et le partage des données à l&rsquo;ensemble des équipes.</p><h1 id=quest-ce-que-la-solution-unity-catalog>Qu&rsquo;est ce que la solution Unity Catalog</h1><p>Unity Catalog est la solution de Databricks permettant d&rsquo;avoir une gouvernance unifiée et centralisée pour l&rsquo;ensemble des données gérées par les ressources Databricks ainsi que de sécuriser et faciliter la gestion et le partage des données à l&rsquo;ensemble des acteurs internes et externes d&rsquo;une organisation.</p><p>L&rsquo;utilisation interne se fait en partageant un métastore d&rsquo;Unity Catalog sur l&rsquo;ensemble des workspaces Databricks.</p><p>L&rsquo;utilisation externe se fait en utilisant la fonctionnalité &ldquo;Delta Sharing&rdquo; de l&rsquo;Unity Catalog ou par l&rsquo;usage de la fonctionnalité SQL Warehouse par un outil externe (connecteur JDBC, ODC ou partenaires databricks).</p><p>Quelques exemples de fonctionnalités proposées par la solution Unity Catalog :</p><ul><li>Gestion des droits sur les objets par des groupes et des utilisateurs en utilisant une syntaxe SQL ANSI</li><li>Gestion des objets permettant d&rsquo;être créés dans un workspace Databricks et utilisés par l&rsquo;ensemble des workspaces Databricks utilisant Unity Catalog</li><li>Possibilité de partager les données de manière simple et sécurisée en passant par la fonctionnalité Delta Sharing</li><li>Permet de capturer des informations sur le cycle de vie et la provenance des données (Data Lineage)</li><li>Permet de capturer l&rsquo;ensemble des logs pour être en capacité de faire l&rsquo;audit des accès et de l&rsquo;utilisation des données</li></ul><p>Vous pourrez avec une vue d&rsquo;ensemble plus complète en parcourant la <a href=https://docs.databricks.com/data-governance/unity-catalog/index.html>documentation officielle</a></p><h1 id=hiérarchie-des-objets>Hiérarchie des objets</h1><p>Avant d&rsquo;aller plus loin, nous allons introduire la hiérarchie des objets au sein de la solution Unity Catalog.
Nous allons nous concentrer uniquement sur les éléments nécessaires à la mise en place de la solution Unity Catalog.</p><p>Schématisation de la hiérarchie des objets :
<a href=/blog/web/20230504_databricks_unity_catalog_schema_01.png><img alt=schema_01 src=/blog/web/20230504_databricks_unity_catalog_schema_01.png></a></p><p>La hiérarchie des objets est constituée des trois niveaux suivants :</p><ol><li>Metastore (métastore) :<ol><li>C&rsquo;est l&rsquo;objet le plus haut niveau pouvant contenir des métadonnées</li><li>Il ne peut y avoir qu&rsquo;un seul Metastore par région</li><li>Un Metastore doit être rattaché à un Workspace pour pouvoir être utilisé</li><li>Le Metastore doit avoir la même région que le Workspace auquel il est rattaché</li></ol></li><li>Catalog (catalogue) :<ol><li>C&rsquo;est le 1er niveau de la hiérarchie permettant d&rsquo;organiser les données</li><li>Il permet d&rsquo;organiser les objets (données) par Schéma (aussi nommé Base de données)</li><li>Si l&rsquo;on souhaite pouvoir avoir plusieurs environnements dans un même Metastore (dans une même région) alors on pourra créer un Catalog par environnement</li></ol></li><li>Schema (schéma ou base de données) :<ol><li>C&rsquo;est le 2ème et dernier niveau de la hiérarchie permettant d&rsquo;organiser les données</li><li>Ce niveau permet de stocker l&rsquo;ensemble des métadonnées sur les objets de type Table, Vue ou Fonction</li></ol></li></ol><p>Lorsque vous souhaitez accéder à un objet (par exemple une table), il sera nécessaire de renseigner le catalogue et le schéma où est défini l&rsquo;objet.
Exemple : <code>select ... from catalog.schema.table</code></p><p>Objet utilisé par la solution Unity Catalog pour gérer l&rsquo;accès global aux données :</p><ul><li>Storage Credential : Cet objet est associé directement au Metastore et permet de stocker les accès à un cloud provider (par exemple AWS S3) permettant à la solution Unity Catalog de gérer les droits sur les données.</li></ul><p>Objets utilisés par la solution Unity Catalog pour stocker et gérer les métadonnées (usage des données):</p><ul><li>Table : Objet permettant de définir la structure et le stockage des données.<ul><li>Managed Table : Table dont la donnée est directement gérée par la solution Unity Catalog et dont le format est Delta</li><li>External Table : Table dont la donnée n&rsquo;est pas directement gérée par la solution Unity Catalog (l&rsquo;utilisateur défini le chemin d&rsquo;accès à la donnée) et dont le format peut être Delta, CSV, JSON, Avro, Parquet, ORC ou Texte</li></ul></li><li>View (Vue) : Objet permettant d&rsquo;encapsuler une requête utilisant un ou plusieurs objets (table ou vue)</li><li>Function (Fonction) : Objet permettant de définir des opérations sur les données</li></ul><p>Quelques informations concernant les quotas des objets sur la solution Unity Catalog :</p><ul><li>Un Metastore peut contenir jusqu&rsquo;à 1000 catalogues</li><li>Un Metastore peut contenir jusqu&rsquo;à 200 objets Storage Credential</li><li>Un catalogue peut contenir jusqu&rsquo;à 10000 schémas</li><li>Un schéma peut contenir jusqu&rsquo;à 10000 tables (ou vues) et 10000 fonctions</li></ul><h1 id=contexte>Contexte</h1><p>Pour cette démonstration, nous allons nous concentrer uniquement sur la mise en place d&rsquo;un Metastore de la solution Unity Catalog sur un Account Databricks sur AWS.</p><p>Dans un contexte projet/entreprise, il est recommandé d&rsquo;utiliser l&rsquo;outil Terraform afin de pouvoir gérer l&rsquo;infrastructure avec du code (IaC) et rendre reproductible les éléments.</p><p>Dans le contexte de cette démonstration, nous allons volontairement utiliser des lignes de commandes pour rendre plus clair et didactique notre démarche.</p><p>Nous allons utiliser principalement les deux outils suivants :</p><ul><li>Databricks CLI : Interface de ligne de commande permettant de faciliter l&rsquo;utilisation et la configuration des ressources Databricks</li><li>AWS CLI : Interface de ligne de commande permettant de faciliter l&rsquo;utilisation et la configuration des ressources AWS</li></ul><h2 id=schématisation>Schématisation</h2><p>Schéma de l&rsquo;ensemble des éléments que nous allons mettre en place pour pouvoir utiliser la solution Unity Catalog avec un Workspace Databricks.</p><p><a href=/blog/web/20230504_databricks_unity_catalog_schema_02.png><img alt=schema_02 src=/blog/web/20230504_databricks_unity_catalog_schema_02.png></a></p><h2 id=prérequis>Prérequis</h2><p>Les éléments suivants sont nécessaires avant de démarrer les actions :</p><ul><li>Le Workspace doit être dans un plan Premium ou supérieur</li><li>Vous devez avoir un Account Databricks sur AWS</li><li>Vous devez avoir un Workspace Databricks basé sur la région &ldquo;eu-west-1&rdquo;</li><li>Vous devez avoir un compte utilisateur Databricks avec les droits d&rsquo;administration sur l&rsquo;Account Databricks</li><li>Vous devez avoir un compte utilisateur AWS avec les droits d&rsquo;administration sur les ressources AWS S3 et AWS IAM</li></ul><p>Afin d&rsquo;utiliser les outils Databricks CLI et AWS CLI vous devez avoir créé les éléments suivants :</p><ul><li>Un Token Utilisateur pour Databricks pour utiliser Databricks CLI</li><li>Un Token Utilisateur AWS pour utiliser AWS CLI
<em>Note : Vous trouverez la démarche pour la configuration des outils AWS CLI et Databricks CLI dans les ressources de cette article</em></li></ul><p>Information concernant le rôle global Databricks pour la gestion des accès AWS par Unity Catalog :</p><ul><li>AWS IAM Role Unity Catalog : <code>arn:aws:iam::414351767826:role/unity-catalog-prod-UCMasterRole-14S5ZJVKOTYTL</code></li></ul><p>Information concernant le Databricks Workspace ID :</p><ul><li>En se basant sur l&rsquo;URL du Workspace Databricks <code>https://&lt;databricks-instance>.com/o=XXXXX</code>, le Databricks Workspace ID est le numéro représenté par <code>XXXXX</code>.</li></ul><h2 id=les-étapes-à-réaliser>Les étapes à réaliser</h2><p>Pour mettre en place la solution Unity Catalog et créer le Metastore nécessaire, nous allons réaliser les étapes suivantes :</p><ol><li>Création d&rsquo;une ressource AWS S3</li><li>Création d&rsquo;une Politique (Policy) et d&rsquo;un Rôle (AWS IAM) pour gérer l&rsquo;accès à la ressource AWS S3 avec la ressource AWS IAM</li><li>Création d&rsquo;un Metastore</li><li>Création d&rsquo;un Storage Credential</li><li>Association d&rsquo;un Storage Credential à un Metastore</li><li>Association d&rsquo;un Metastore avec un Workspace Databricks</li></ol><h1 id=mise-en-place>Mise en place</h1><h2 id=étape-n0--initialisation-des-variables-denvironnement>Étape n°0 : Initialisation des variables d&rsquo;environnement</h2><p>Création des variables d&rsquo;environnement permettant de définir les nommage et de faciliter la rédaction des commandes</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4># AWS Variables</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>AWS_S3_DBX_UC</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;s3-dbx-metastore-uc&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>AWS_IAM_ROLE_DBX_UC</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;role-dbx-metastore-uc&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>AWS_IAM_POLICY_DBX_UC</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;policy-dbx-metastore-uc&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>AWS_TAGS</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#39;{&#34;TagSet&#34;: [{&#34;Key&#34;: &#34;owner&#34;,&#34;Value&#34;: &#34;admin&#34;},{&#34;Key&#34;: &#34;project&#34;,&#34;Value&#34;: &#34;databricks&#34;}]}&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#6272a4># Databricks Variables</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>DBX_WORKSPACE_ID</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;0000000000000000&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>DBX_METASTORE_NAME</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;metastor-sandbox&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>DBX_METASTORE_SC</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;sc-metastore-sandbox&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#6272a4># AWS Variables to define during the steps executions</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>AWS_IAM_ROLE_DBX_UC_ARN</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>AWS_IAM_POLICY_DBX_UC_ARN</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#6272a4># Databricks Variables to define during the steps executions</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>DBX_METASTORE_ID</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>DBX_METASTORE_SC_ID</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;&#34;</span>
</span></span></code></pre></div><h2 id=étape-n1--création-de-la-ressource-aws-s3>Étape n°1 : Création de la ressource AWS S3</h2><p>Cette ressource AWS S3 sera utilisée par Unity Catalog pour stocker les données des objets &ldquo;Managed&rdquo; et les métadonnées.</p><p>Exécution des commandes suivantes en s&rsquo;appuyant sur AWS CLI :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4># Bucket creation</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>aws s3api create-bucket --bucket <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AWS_S3_DBX_UC</span><span style=color:#f1fa8c>}</span> --create-bucket-configuration <span style=color:#8be9fd;font-style:italic>LocationConstraint</span><span style=color:#ff79c6>=</span>eu-west-1
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#6272a4># Add Encryption information</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>aws s3api put-bucket-encryption --bucket <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AWS_S3_DBX_UC</span><span style=color:#f1fa8c>}</span> --server-side-encryption-configuration <span style=color:#f1fa8c>&#39;{&#34;Rules&#34;: [{&#34;ApplyServerSideEncryptionByDefault&#34;: {&#34;SSEAlgorithm&#34;: &#34;AES256&#34;},&#34;BucketKeyEnabled&#34;: true}]}&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#6272a4># Revoke public access</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>aws s3api put-public-access-block --bucket <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AWS_S3_DBX_UC</span><span style=color:#f1fa8c>}</span> --public-access-block-configuration <span style=color:#f1fa8c>&#39;{&#34;BlockPublicAcls&#34;: true,&#34;IgnorePublicAcls&#34;: true,&#34;BlockPublicPolicy&#34;: true,&#34;RestrictPublicBuckets&#34;: true}&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#6272a4># Add ownership controls information</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>aws s3api put-bucket-ownership-controls --bucket <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AWS_S3_DBX_UC</span><span style=color:#f1fa8c>}</span> --ownership-controls <span style=color:#f1fa8c>&#39;{&#34;Rules&#34;: [{&#34;ObjectOwnership&#34;: &#34;BucketOwnerEnforced&#34;}]}&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#6272a4># Add tags</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>aws s3api put-bucket-tagging --bucket <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AWS_S3_DBX_UC</span><span style=color:#f1fa8c>}</span> --tagging <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AWS_TAGS</span><span style=color:#f1fa8c>}</span>
</span></span></code></pre></div><h2 id=étape-n2--création-dune-politique-et-dun-rôle-avec-la-ressource-aws-iam>Étape n°2 : Création d&rsquo;une politique et d&rsquo;un rôle avec la ressource AWS IAM</h2><p>La politique et le rôle vont permettre de donner les droits d&rsquo;administration à la solution Unity Catalog pour gérer les accès aux données.</p><p>Exécution des commandes suivantes en s&rsquo;appuyant sur AWS CLI :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2</span><span><span style=color:#6272a4># Create JSON config file for role creation (init)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3</span><span>cat &gt; tmp_role_document.json <span style=color:#f1fa8c>&lt;&lt;EOF
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4</span><span><span style=color:#f1fa8c>{
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5</span><span><span style=color:#f1fa8c>    &#34;Version&#34;: &#34;2012-10-17&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6</span><span><span style=color:#f1fa8c>    &#34;Statement&#34;: [
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7</span><span><span style=color:#f1fa8c>        {
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8</span><span><span style=color:#f1fa8c>            &#34;Effect&#34;: &#34;Allow&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9</span><span><span style=color:#f1fa8c>            &#34;Principal&#34;: {
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10</span><span><span style=color:#f1fa8c>                &#34;AWS&#34;: [
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11</span><span><span style=color:#f1fa8c>                    &#34;arn:aws:iam::414351767826:role/unity-catalog-prod-UCMasterRole-14S5ZJVKOTYTL&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12</span><span><span style=color:#f1fa8c>                ]
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13</span><span><span style=color:#f1fa8c>            },
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14</span><span><span style=color:#f1fa8c>            &#34;Action&#34;: &#34;sts:AssumeRole&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15</span><span><span style=color:#f1fa8c>            &#34;Condition&#34;: {
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16</span><span><span style=color:#f1fa8c>                &#34;StringEquals&#34;: {
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17</span><span><span style=color:#f1fa8c>                    &#34;sts:ExternalId&#34;: &#34;&lt;AWS Account Databricks ID&gt;&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18</span><span><span style=color:#f1fa8c>                }
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19</span><span><span style=color:#f1fa8c>            }
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20</span><span><span style=color:#f1fa8c>        }
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21</span><span><span style=color:#f1fa8c>    ]
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22</span><span><span style=color:#f1fa8c>}
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23</span><span><span style=color:#f1fa8c>EOF</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27</span><span><span style=color:#6272a4># Role creation</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28</span><span>aws iam create-role --role-name <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AWS_IAM_ROLE_DBX_UC</span><span style=color:#f1fa8c>}</span> --assume-role-policy-document file://tmp_role_document.json
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29</span><span><span style=color:#6272a4># Get the role ARN</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>AWS_IAM_ROLE_DBX_UC_ARN</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>`</span>aws_ippon_dtl iam get-role --role-name <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AWS_IAM_ROLE_DBX_UC</span><span style=color:#f1fa8c>}</span> | jq <span style=color:#f1fa8c>&#39;.Role.Arn&#39;</span><span style=color:#f1fa8c>`</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34</span><span><span style=color:#6272a4># Create JSON config file for role update</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35</span><span>cat &gt; tmp_role_document_update.json <span style=color:#f1fa8c>&lt;&lt;EOF
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36</span><span><span style=color:#f1fa8c>{
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37</span><span><span style=color:#f1fa8c>    &#34;Version&#34;: &#34;2012-10-17&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38</span><span><span style=color:#f1fa8c>    &#34;Statement&#34;: [
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39</span><span><span style=color:#f1fa8c>        {
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40</span><span><span style=color:#f1fa8c>            &#34;Effect&#34;: &#34;Allow&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41</span><span><span style=color:#f1fa8c>            &#34;Principal&#34;: {
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42</span><span><span style=color:#f1fa8c>                &#34;AWS&#34;: [
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43</span><span><span style=color:#f1fa8c>                    ${AWS_IAM_ROLE_DBX_UC_ARN},
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44</span><span><span style=color:#f1fa8c>                    &#34;arn:aws:iam::414351767826:role/unity-catalog-prod-UCMasterRole-14S5ZJVKOTYTL&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45</span><span><span style=color:#f1fa8c>                ]
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46</span><span><span style=color:#f1fa8c>            },
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47</span><span><span style=color:#f1fa8c>            &#34;Action&#34;: &#34;sts:AssumeRole&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48</span><span><span style=color:#f1fa8c>            &#34;Condition&#34;: {
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49</span><span><span style=color:#f1fa8c>                &#34;StringEquals&#34;: {
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50</span><span><span style=color:#f1fa8c>                    &#34;sts:ExternalId&#34;: &#34;&lt;AWS Account Databricks ID&gt;&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51</span><span><span style=color:#f1fa8c>                }
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52</span><span><span style=color:#f1fa8c>            }
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53</span><span><span style=color:#f1fa8c>        }
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54</span><span><span style=color:#f1fa8c>    ]
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55</span><span><span style=color:#f1fa8c>}
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56</span><span><span style=color:#f1fa8c>EOF</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58</span><span><span style=color:#6272a4># Add reference on himself</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59</span><span>aws iam update-assume-role-policy --role-name <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AWS_IAM_ROLE_DBX_UC</span><span style=color:#f1fa8c>}</span>  --policy-document file://tmp_role_document_update.json
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60</span><span><span style=color:#6272a4># Add tags</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61</span><span>aws iam tag-role --role-name <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AWS_IAM_ROLE_DBX_UC</span><span style=color:#f1fa8c>}</span> --tags <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AWS_TAGS</span><span style=color:#f1fa8c>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62</span><span><span style=color:#6272a4># Add description</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63</span><span>aws iam update-role-description --role-name <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AWS_IAM_ROLE_DBX_UC</span><span style=color:#f1fa8c>}</span> --description <span style=color:#f1fa8c>&#39;This role is used for storing Databricks Unity Catalog metadata to S3 Resources&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68</span><span><span style=color:#6272a4># Create JSON config file for policy creation</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69</span><span>cat &gt; tmp_policy_document.json <span style=color:#f1fa8c>&lt;&lt;EOF
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70</span><span><span style=color:#f1fa8c>{
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71</span><span><span style=color:#f1fa8c> &#34;Version&#34;: &#34;2012-10-17&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72</span><span><span style=color:#f1fa8c> &#34;Statement&#34;: [
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73</span><span><span style=color:#f1fa8c>     {
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74</span><span><span style=color:#f1fa8c>         &#34;Action&#34;: [
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75</span><span><span style=color:#f1fa8c>             &#34;s3:GetObject&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76</span><span><span style=color:#f1fa8c>             &#34;s3:PutObject&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77</span><span><span style=color:#f1fa8c>             &#34;s3:DeleteObject&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78</span><span><span style=color:#f1fa8c>             &#34;s3:ListBucket&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79</span><span><span style=color:#f1fa8c>             &#34;s3:GetBucketLocation&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80</span><span><span style=color:#f1fa8c>             &#34;s3:GetLifecycleConfiguration&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81</span><span><span style=color:#f1fa8c>             &#34;s3:PutLifecycleConfiguration&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82</span><span><span style=color:#f1fa8c>         ],
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83</span><span><span style=color:#f1fa8c>         &#34;Resource&#34;: [
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84</span><span><span style=color:#f1fa8c>             &#34;arn:aws:s3:::${AWS_S3_DBX_UC}/*&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85</span><span><span style=color:#f1fa8c>             &#34;arn:aws:s3:::${AWS_S3_DBX_UC}&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86</span><span><span style=color:#f1fa8c>         ],
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87</span><span><span style=color:#f1fa8c>         &#34;Effect&#34;: &#34;Allow&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88</span><span><span style=color:#f1fa8c>     },
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89</span><span><span style=color:#f1fa8c>     {
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90</span><span><span style=color:#f1fa8c>         &#34;Action&#34;: [
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91</span><span><span style=color:#f1fa8c>             &#34;sts:AssumeRole&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92</span><span><span style=color:#f1fa8c>         ],
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93</span><span><span style=color:#f1fa8c>         &#34;Resource&#34;: [
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94</span><span><span style=color:#f1fa8c>             ${AWS_IAM_ROLE_DBX_UC_ARN}
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95</span><span><span style=color:#f1fa8c>         ],
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96</span><span><span style=color:#f1fa8c>         &#34;Effect&#34;: &#34;Allow&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97</span><span><span style=color:#f1fa8c>     }
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98</span><span><span style=color:#f1fa8c>   ]
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99</span><span><span style=color:#f1fa8c>}
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">100</span><span><span style=color:#f1fa8c>EOF</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">101</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">102</span><span><span style=color:#6272a4># Policy creation</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">103</span><span>aws iam create-policy --policy-name <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AWS_IAM_POLICY_DBX_UC</span><span style=color:#f1fa8c>}</span> --policy-document file://tmp_policy_document.json &gt; tmp_result_creation_policy.json
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">104</span><span><span style=color:#6272a4># Get Policy ARN</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">105</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>AWS_IAM_POLICY_DBX_UC_ARN</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>`</span>cat tmp_result_creation_policy.json | jq <span style=color:#f1fa8c>&#39;.Policy.Arn&#39;</span><span style=color:#f1fa8c>`</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">106</span><span><span style=color:#6272a4># Add tags</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">107</span><span>aws iam tag-policy --policy-arn <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AWS_IAM_POLICY_DBX_UC_ARN</span><span style=color:#f1fa8c>}</span> --tags <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AWS_TAGS</span><span style=color:#f1fa8c>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">108</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">109</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">110</span><span><span style=color:#6272a4># Attach Policy to the Role</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">111</span><span>aws iam attach-role-policy --role-name <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AWS_IAM_ROLE_DBX_UC</span><span style=color:#f1fa8c>}</span>  --policy-arn <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AWS_IAM_POLICY_DBX_UC_ARN</span><span style=color:#f1fa8c>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">112</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">113</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">114</span><span><span style=color:#6272a4># Delete temporary JSON files</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">115</span><span>rm tmp_role_document_update.json
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">116</span><span>rm tmp_role_document.json
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">117</span><span>rm tmp_policy_document.json
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">118</span><span>rm tmp_result_creation_policy.json
</span></span></code></pre></div><h2 id=step-n3--création-dun-metastore>Step n°3 : Création d&rsquo;un Metastore</h2><p>Création d&rsquo;un Metastore Unity Catalog dans la même région que le Workspace avec lequel nous voulons l&rsquo;utiliser.</p><p>Exécution des commandes suivantes en s&rsquo;appuyant sur Databricks CLI :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4># Create metastore</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>databricks unity-catalog metastores create --name <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_METASTORE_NAME</span><span style=color:#f1fa8c>}</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#f1fa8c></span>                                           --storage-root s3://<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AWS_S3_DBX_UC</span><span style=color:#f1fa8c>}</span>/<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_METASTORE_NAME</span><span style=color:#f1fa8c>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#6272a4># Get the metastore ID</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>DBX_METASTORE_ID</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>`</span>databricks unity-catalog metastores get-summary | jq <span style=color:#f1fa8c>&#39;select(.name == $ENV.DBX_METASTORE_NAME) | .metastore_id&#39;</span><span style=color:#f1fa8c>`</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#6272a4># Check the metastore ID (it must not be empty)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_METASTORE_ID</span><span style=color:#f1fa8c>}</span>
</span></span></code></pre></div><h2 id=étape-n4--création-dun-storage-credential>Étape n°4 : Création d&rsquo;un Storage Credential</h2><p>Création d&rsquo;un Storage Credential pour stocker les accès pour le rôle global Databricks sur la ressource AWS S3 utilisée pour stocker les données du Metastore.</p><p>Exécution des commandes suivantes en s&rsquo;appuyant sur Databricks CLI :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4># Create JSON config file</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>cat &gt; tmp_databricks_metastore_storagecredential.json <span style=color:#f1fa8c>&lt;&lt;EOF
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#f1fa8c>{
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#f1fa8c>  &#34;name&#34;: ${DBX_METASTORE_SC},
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#f1fa8c>  &#34;aws_iam_role&#34;: {
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#f1fa8c>    &#34;role_arn&#34;: ${AWS_IAM_ROLE_DBX_UC_ARN}
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#f1fa8c>  },
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#f1fa8c>  &#34;comment&#34; : &#34;Storage Credential for Unity Catalog Storage&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#f1fa8c>}
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#f1fa8c>EOF</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#6272a4># Create Storage Credential</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>databricks unity-catalog storage-credentials create --json-file tmp_databricks_metastore_storagecredential.json
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#6272a4># Get Storage Credential ID</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>DBX_METASTORE_SC_ID</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>`</span>databricks unity-catalog storage-credentials get --name <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_METASTORE_SC</span><span style=color:#f1fa8c>}</span> | jq <span style=color:#f1fa8c>&#39;.id&#39;</span><span style=color:#f1fa8c>`</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#6272a4># Delete temporary files</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>rm tmp_databricks_metastore_storagecredential.json
</span></span></code></pre></div><h2 id=étape-n5--association-dun-storage-credential-avec-un-metastore>Étape n°5 : Association d&rsquo;un Storage Credential avec un Metastore</h2><p>Afin que le Metastore puisse utiliser le Storage Credential pour accéder à la ressource AWS S3 et pour pouvoir gérer les accès sur les données pour l&rsquo;ensemble des utilisateurs, nous devons associer le Storage Credential au Metastore.</p><p>Exécution des commandes suivantes en s&rsquo;appuyant sur Databricks CLI :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4># Create JSON config file</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>cat &gt; tmp_databricks_metastore_update_sc.json <span style=color:#f1fa8c>&lt;&lt;EOF
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#f1fa8c>{
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#f1fa8c>  &#34;default_data_access_config_id&#34;: ${DBX_METASTORE_SC_ID},
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#f1fa8c>  &#34;storage_root_credential_id&#34;: ${DBX_METASTORE_SC_ID}
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#f1fa8c>}
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#f1fa8c>EOF</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#6272a4># Update Metastore with the Storage Credential</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>databricks unity-catalog metastores update --id <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_METASTORE_ID</span><span style=color:#f1fa8c>}</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#f1fa8c></span>                                           --json-file tmp_databricks_metastore_update_sc.json
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#6272a4># Delete temporary files</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>rm tmp_databricks_metastore_update_sc.json
</span></span></code></pre></div><h2 id=étape-n6--association-dun-metastore-à-un-workspace-databricks>Étape n°6 : Association d&rsquo;un Metastore à un Workspace Databricks</h2><p>Pour pouvoir utiliser le Metastore avec un Workspace Databricks, il est nécessaire d&rsquo;assigner le Metastore au Workspace Databricks au niveau de l&rsquo;account Databricks.
Note : il est possible de définir le nom du catalogue par défaut pour les utilisateurs du Workspace.</p><p>Exécution des commandes suivantes en s&rsquo;appuyant sur Databricks CLI :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>databricks unity-catalog metastores assign --workspace-id <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_WORKSPACE_ID</span><span style=color:#f1fa8c>}</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#f1fa8c></span>                                           --metastore-id <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_METASTORE_ID</span><span style=color:#f1fa8c>}</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#f1fa8c></span>                                           --default-catalog-name main
</span></span></code></pre></div><h2 id=étape-n7--nettoyage-des-variables-denvironnements>Étape n°7 : Nettoyage des variables d&rsquo;environnements</h2><p>Nous pouvons supprimer l&rsquo;ensemble des variables d&rsquo;environnements utilisées lors de la mise en place d&rsquo;Unity Catalog.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4># Clean the AWS &amp; Databricks Attributes</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#8be9fd;font-style:italic>unset</span> AWS_S3_DBX_UC
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#8be9fd;font-style:italic>unset</span> AWS_IAM_ROLE_DBX_UC
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#8be9fd;font-style:italic>unset</span> AWS_IAM_POLICY_DBX_UC
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#8be9fd;font-style:italic>unset</span> AWS_TAGS
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#8be9fd;font-style:italic>unset</span> DBX_WORKSPACE_ID
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#8be9fd;font-style:italic>unset</span> DBX_METASTORE_NAME
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#8be9fd;font-style:italic>unset</span> DBX_METASTORE_SC
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#8be9fd;font-style:italic>unset</span> AWS_IAM_ROLE_DBX_UC_ARN
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#8be9fd;font-style:italic>unset</span> AWS_IAM_POLICY_DBX_UC_ARN
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#8be9fd;font-style:italic>unset</span> DBX_METASTORE_ID
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#8be9fd;font-style:italic>unset</span> DBX_METASTORE_SC_ID
</span></span></code></pre></div><h1 id=conclusion>Conclusion</h1><p>A l&rsquo;aide des outils Databricks CLI et AWS CLI, nous avons pu très facilement mettre en place un Metastore sur notre Workspace Databricks afin de pouvoir utiliser la solution Unity Catalog.</p><p>Cela nous a permis de mettre en place simplement une solution permettant de gérer notre référentiel centralisé de métadonnées pour l&rsquo;ensemble des données gérées et manipulées par nos ressources Databricks (Cluster et SQL Warehouse).</p><p>Les avantages de l&rsquo;utilisation de la solution Unity Catalog :</p><ul><li>Unity Catalog permet de simplifier et centraliser la gestion des droits sur l&rsquo;ensemble des objets gérés.</li><li>Unity Catalog permet de sécuriser, faciliter et multiplier les usages sur les données grâce aux nombreux connecteurs pour SQL Warehouse ainsi que la possibilité d&rsquo;exporter les informations vers d&rsquo;autres outils de gestion de catalogue de données.</li><li>Unity Catalog est un outil qui s&rsquo;améliore régulièrement et qui devrait devenir la référence pour la gouvernance des données pour tous ceux qui utilisent Databricks.</li></ul><p>Quelques informations concernant les limitations sur la solution Unity Catalog :</p><ul><li>Le Workspace Databricks doit être au moins au niveau premium pour pouvoir utiliser la solution Unity Catalog</li><li>Un Metastore doit contenir l&rsquo;ensemble des éléments concernant une région.</li><li>Il est recommandé d&rsquo;utiliser un cluster avec le Databricks Runtime en version 11.3 LTS (DBR) ou supérieur</li><li>La création d&rsquo;un Storage Credential n&rsquo;est possible qu&rsquo;avec un rôle AWS IAM lorsque l&rsquo;Account Databricks est sur AWS</li><li>Une partie de la gestion des utilisateurs et groupes doit se faire au niveau de l&rsquo;Account Databricks et non plus seulement au niveau du Workspace Databricks</li><li>Les groupes définis localement dans un Workspace Databricks ne peuvent pas être utilisés avec Unity Catalog, il est nécessaire de les recréer au niveau de l&rsquo;Account Databricks pour pouvoir les utiliser avec la solution Unity Catalog (Migration).</li></ul><h1 id=ressources>Ressources</h1><h2 id=glossaire>Glossaire</h2><ul><li>Account Databricks : Niveau le plus haut pour l&rsquo;administration de Databricks</li><li>Cluster Databricks : Ensemble de ressources de calcul permettant d&rsquo;exécuter des traitements Spark avec Databricks</li><li>Workspace Databricks : Espace de travail dans Databricks</li><li>Databricks Workspace ID : Identifiant du workspace Databricks</li><li>Storage Credential : Objet permettant le stockage des accès par la solution Unity Catalog</li><li>Data Lake : Lac de données permettant de stocker des données structurée, semi-structurée ou non structurée</li><li>Data Warehouse : Entrepôt de données permettant de stocker des données structurées (Base de données relationnelle)</li><li>Lakehouse : Architecture de gestion des données qui combine les avantages d&rsquo;un lac de données et les fonctionnalités de gestion d&rsquo;un entrepôt de données</li><li>Metastore : un métastore dans la solution Unity Catalog</li><li>Catalog (Catalgoue) : Objet de la solution Unity Catalog permettant d&rsquo;organiser les données (objets) par Schéma</li><li>External Table (Table externe) : Table dont la donnée n&rsquo;est pas directement géré par la solution Unity Catalog (l&rsquo;utilisateur défini le chemin d&rsquo;accès à la donnée)</li><li>Managed Table (Table managée) : Table dont la donnée est directement géré par la solution Unity Catalog</li><li>Databricks CLI : Interface de ligne de commande permettant de faciliter l&rsquo;utilisation et la configuration des ressources Databricks</li><li>AWS CLI : Interface de ligne de commande permettant de faciliter l&rsquo;utilisation et la configuration des ressources AWS</li><li>AWS S3 : Service AWS Simple Storage permettant de stocker des données/objets</li><li>AWS IAM : Service AWS Identity and Access Management permettant de contrôler l&rsquo;accès aux services et aux ressources AWS.</li><li>AWS IAM Policy : Politique de droit sur AWS IAM</li></ul><h2 id=gestion-de-la-connexion-pour-loutil-aws-cli>Gestion de la connexion pour l&rsquo;outil AWS CLI</h2><ol><li><p>Installez l&rsquo;outil <code>AWS CLI</code> sur macOS avec l&rsquo;outil Homebrew : <code>brew install awscli</code></p></li><li><p>Définissez un utilisateur spécifique pour AWS CLI : <em>(pour l&rsquo;exemple, nous avons pris le nom <code>usr_adm_cli</code>)</em></p><ol><li>Allez sur <code>AWS IAM > Users</code></li><li>Cliquez sur <code>Add users</code></li><li>Renseigner l&rsquo;information &ldquo;User Name&rdquo; : <code>usr_adm_cli</code> et cliquez sur <code>Next</code></li><li>Si vous avez un groupe d&rsquo;administration (AWS IAM Group) déjà défini :<ol><li>Sélectionnez <code>Add user to group</code></li><li>Sélectionnez le groupe souhaité : <code>FullAdmin</code> et cliquez sur <code>Next</code></li></ol></li><li>Si vous avez une politique d&rsquo;administration (AWS IAM Policy) déjà définie :<ol><li>Sélectionnez <code>Attach policies directly</code></li><li>Sélectionnez la politique souhaitée : <code>AdministratorAccess</code> et cliquez sur <code>Next</code></li></ol></li><li>Si vous souhaitez définir des tags : Cliquez sur <code>Add new tag</code> et ajoutez les informations souhaités</li><li>Cliquez sur <code>Create user</code></li><li>Sélectionnez l&rsquo;utilisateur créé <code>usr_adm_cli</code></li><li>Cliquez sur <code>Security credentials</code></li><li>Cliquez sur <code>Create access key</code></li><li>Sélectionnez <code>Command Line Interface (CLI)</code>, cochez sur l&rsquo;option <code>I understand the above .... to proceed to create an access key</code> et cliquez sur <code>Next</code></li><li>Renseignez l&rsquo;information <code>Description tag value</code> : <code>administration</code> et cliquez sur <code>Create access key</code></li><li>Copiez les informations <code>Access key</code> et <code>Secret access key</code> pour pouvoir les utiliser avec l&rsquo;outil AWS CLI <em>(ces informations ne seront plus accessibles après avoir quitté la page)</em></li></ol></li><li><p>Configurez l&rsquo;outil AWS CLI avec le nouvel utilisateur créé :</p><ol><li>Exécutez la commande : <code>aws configure</code><ol><li>Renseignez l&rsquo;information <code>AWS Access Key ID</code> avec l&rsquo;information <code>Access key</code> du nouvel utilisateur <code>usr_adm_cli</code></li><li>Renseignez l&rsquo;information <code>AWS Secret Access Key</code> avec l&rsquo;information <code>Secret access key</code> du nouvel utilisateur <code>usr_adm_cli</code></li><li>Renseignez l&rsquo;information <code>Default region name</code> avec la région par défaut : <code>eu-west-1</code></li><li>Renseignez l&rsquo;information <code>Default output format</code> avec le format de sortie par défaut <code>json</code></li></ol></li></ol></li><li><p>Vérification de la configuration de l&rsquo;outil AWS CLI</p><ol><li>Exécutez la commande <code>aws s3api list-buckets</code></li><li>Résultat :</li></ol></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    <span style=color:#ff79c6>&#34;Buckets&#34;</span>: [
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>        {...}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>    ]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>}
</span></span></code></pre></div><h2 id=gestion-de-la-connexion-pour-loutil-databricks-cli>Gestion de la connexion pour l&rsquo;outil Databricks CLI</h2><ol><li><p>Installez l&rsquo;outil <code>Databricks CLI</code> avec <code>pip</code> (nécessite d&rsquo;avoir python3)</p><ol><li>Exécutez la commande : <code>pip install databricks-cli</code></li><li>Vérifiez le résultat avec la commande : <code>databricks --version</code> (Résultat possible : <code>Version 0.17.6</code>)</li></ol></li><li><p>Créez un Token Utilisateur sur Databricks</p><ol><li>Allez sur le workspace Databricks</li><li>Cliquez sur votre nom d&rsquo;utilisateur et cliquez sur l&rsquo;option <code>User Settings</code></li><li>Cliquez sur <code>Access tokens</code></li><li>Cliquez sur <code>Generate new token</code></li><li>Renseignez les parties <code>comment</code> et <code>define the token life time</code> avec les valeurs souhaitées</li><li>Cliquez sur <code>Generate</code></li><li>Copiez le Token Databricks généré pour pouvoir l&rsquo;utiliser avec l&rsquo;outil Databricks CLI <em>(vous ne pourrez plus le voir après avoir quitté la page)</em></li></ol></li><li><p>Configurez Databricks CLI</p><ol><li>Exécutez la commande : <code>databricks configure --token</code></li><li>Renseignez l&rsquo;information <code>Databricks Host (should begin with https://):</code> avec l&rsquo;URL de votre workspace Databricks : <code>https://dbc-XXXXXXXX-XXXX.cloud.databricks.com</code></li><li>Renseignez l&rsquo;information <code>Access Token</code> avec le Token Databricks récupéré lors de l&rsquo;étape précédente : <code>dapi2c0000aa000a0r0a00e000000000000</code></li></ol></li></ol><p>Vous pouvez voir les informations enregistrées avec la commande : <code>cat ~/.databrickscfg</code></p></div></article></div></div><footer><div class="container-fluid prag-bg-primary prag-foot">Généré avec <a href=https://gohugo.io/>Hugo</a>
&nbsp; - &nbsp;
<a href=https://en.wikipedia.org/wiki/WTFPL>WTFPL license</a> © 2018–2024</div></footer></body></html>