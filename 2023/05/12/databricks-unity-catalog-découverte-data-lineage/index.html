<!doctype html><html lang=fr><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta http-equiv=x-ua-compatible content="IE=edge"><meta charset=utf-8><meta name=robots content="noindex, nofollow, noarchive, nosnipper, noodp, noydir"><meta name=google content="notranslate, noimageindex"><meta name=slurp content="notranslate, noimageindex"><meta name=msnbot content="notranslate, noimageindex"><meta name=bingbot content="notranslate, noimageindex"><meta name=generator content="Hugo 0.111.3"><link rel=stylesheet href=https://www.pragmatias.fr/css/bootstrap.min.css><link rel=stylesheet href=https://www.pragmatias.fr/css/pragmatias.css><script src=https://www.pragmatias.fr/js/jquery-3.6.0.slim.min.js></script>
<script src=https://www.pragmatias.fr/js/popper.min.js></script>
<script src=https://www.pragmatias.fr/js/bootstrap.bundle.min.js></script>
<link rel=alternate type=application/rss+xml href=https://www.pragmatias.fr/feed.xml><title>Databricks : Unity Catalog - Découverte - Data Lineage</title><body><div class="navbar navbar-expand-md prag-bg-primary prag-header" role=navigation><div class="container-fluid justify-content-center"><div class=navbar-brand><a href=https://www.pragmatias.fr/blog/><img src=/images/logo_pragmatias.svg alt=pragmatias></a></div><button class="navbar-toggler justify-content-end prag-navbar" type=button data-toggle=collapse data-target=#navbarSupportedContent1,#navbarSupportedContent2 aria-controls=navbarSupportedContent1 aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent1><ul class="navbar-nav text-center"><li class=nav-item><a class=nav-link href=https://www.pragmatias.fr/blog/>Blog</a></li><li class=nav-item><a class=nav-link href=https://www.pragmatias.fr/tags/>Tags</a></li><li class=nav-item><a class=nav-link href=https://www.pragmatias.fr/archives/>Archives</a></li></ul></div><div class="collapse navbar-collapse justify-content-md-end" id=navbarSupportedContent2><ul class="navbar-nav flex-row justify-content-center"><li class=nav-item><a href=https://www.pragmatias.fr/en/2023/05/12/databricks-unity-catalog-first-step-data-lineage/ class="prag_header_svg mr-1 ml-1"><img src=/images/united-kingdom-flag-round-xs-24.png alt=English></a></li><li class=nav-item><a href=https://www.pragmatias.fr/feed.xml title="Pragmatias Blog" class="prag_header_svg mr-1 ml-1"><svg height="24" style="enable-background:new 0 0 508.52 508.52" viewBox="0 0 508.52 508.52" width="24" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path style="fill-rule:evenodd;clip-rule:evenodd;fill:" d="M254.26.0C113.845.0.0 113.845.0 254.26s113.845 254.26 254.26 254.26 254.26-113.845 254.26-254.26C508.52 113.813 394.675.0 254.26.0zM137.141 412.441c-22.852.0-41.413-18.434-41.413-41.285.0-22.693 18.561-41.349 41.413-41.349 22.915.0 41.444 18.656 41.476 41.349C178.618 393.976 160.088 412.441 137.141 412.441zM241.197 412.791c0-39.029-15.16-75.674-42.62-103.071-27.46-27.524-63.978-42.716-102.785-42.716V207.38c113.177.0 205.315 92.137 205.315 205.41h-59.91zM347.001 412.727c0-138.603-112.669-251.399-251.145-251.399v-59.624c171.435.0 310.96 139.589 310.96 311.023H347.001z"/></svg></a></li><li class=nav-item><a href=mailto:contact@pragmatias.fr title=Mail class="prag_header_svg mr-1 ml-1"><svg height="24" style="enable-background:new 0 0 299.997 299.997" viewBox="0 0 299.997 299.997" width="24" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path style="fill-rule:evenodd;clip-rule:evenodd;fill:" d="M149.996.0C67.157.0.001 67.158.001 149.997c0 82.837 67.156 150 149.995 150s150-67.163 150-150C299.996 67.158 232.835.0 149.996.0zM149.999 52.686l88.763 55.35H61.236l88.763-55.35zm89.869 143.737h-.009c0 8.878-7.195 16.072-16.072 16.072H76.211c-8.878.0-16.072-7.195-16.072-16.072v-84.865c0-.939.096-1.852.252-2.749l84.808 52.883c.104.065.215.109.322.169.112.062.226.122.34.179.599.309 1.216.558 1.847.721.065.018.13.026.195.041.692.163 1.393.265 2.093.265h.005c.005.0.01.0.01.0.7.0 1.401-.099 2.093-.265.065-.016.13-.023.195-.041.63-.163 1.245-.412 1.847-.721.114-.057.228-.117.34-.179.106-.06.218-.104.322-.169l84.808-52.883c.156.897.252 1.808.252 2.749v84.865z"/></svg></a></li><li><a href=https://github.com/pragmatias/ title=github class="prag_header_svg mr-1 ml-1"><svg height="24" style="enable-background:new 0 0 438.549 438.549" viewBox="0 0 438.549 438.549" width="24" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path style="fill-rule:evenodd;clip-rule:evenodd;fill:" d="M409.132 114.573c-19.608-33.596-46.205-60.194-79.798-79.8C295.736 15.166 259.057 5.365 219.271 5.365c-39.781.0-76.472 9.804-110.063 29.408-33.596 19.605-60.192 46.204-79.8 79.8C9.803 148.168.0 184.854.0 224.63c0 47.78 13.94 90.745 41.827 128.906 27.884 38.164 63.906 64.572 108.063 79.227 5.14.954 8.945.283 11.419-1.996 2.475-2.282 3.711-5.14 3.711-8.562.0-.571-.049-5.708-.144-15.417-.098-9.709-.144-18.179-.144-25.406l-6.567 1.136c-4.187.767-9.469 1.092-15.846 1-6.374-.089-12.991-.757-19.842-1.999-6.854-1.231-13.229-4.086-19.13-8.559-5.898-4.473-10.085-10.328-12.56-17.556l-2.855-6.57c-1.903-4.374-4.899-9.233-8.992-14.559-4.093-5.331-8.232-8.945-12.419-10.848l-1.999-1.431c-1.332-.951-2.568-2.098-3.711-3.429-1.142-1.331-1.997-2.663-2.568-3.997-.572-1.335-.098-2.43 1.427-3.289s4.281-1.276 8.28-1.276l5.708.853c3.807.763 8.516 3.042 14.133 6.851 5.614 3.806 10.229 8.754 13.846 14.842 4.38 7.806 9.657 13.754 15.846 17.847 6.184 4.093 12.419 6.136 18.699 6.136s11.704-.476 16.274-1.423c4.565-.952 8.848-2.383 12.847-4.285 1.713-12.758 6.377-22.559 13.988-29.41-10.848-1.14-20.601-2.857-29.264-5.14-8.658-2.286-17.605-5.996-26.835-11.14-9.235-5.137-16.896-11.516-22.985-19.126-6.09-7.614-11.088-17.61-14.987-29.979-3.901-12.374-5.852-26.648-5.852-42.826.0-23.035 7.52-42.637 22.557-58.817-7.044-17.318-6.379-36.732 1.997-58.24 5.52-1.715 13.706-.428 24.554 3.853 10.85 4.283 18.794 7.952 23.84 10.994 5.046 3.041 9.089 5.618 12.135 7.708 17.705-4.947 35.976-7.421 54.818-7.421s37.117 2.474 54.823 7.421l10.849-6.849c7.419-4.57 16.18-8.758 26.262-12.565 10.088-3.805 17.802-4.853 23.134-3.138 8.562 21.509 9.325 40.922 2.279 58.24 15.036 16.18 22.559 35.787 22.559 58.817.0 16.178-1.958 30.497-5.853 42.966-3.9 12.471-8.941 22.457-15.125 29.979-6.191 7.521-13.901 13.85-23.131 18.986-9.232 5.14-18.182 8.85-26.84 11.136-8.662 2.286-18.415 4.004-29.263 5.146 9.894 8.562 14.842 22.077 14.842 40.539v60.237c0 3.422 1.19 6.279 3.572 8.562 2.379 2.279 6.136 2.95 11.276 1.995 44.163-14.653 80.185-41.062 108.068-79.226 27.88-38.161 41.825-81.126 41.825-128.906C438.536 184.851 428.728 148.168 409.132 114.573z"/></svg></a></li></ul></div></div></div><div id=content><div class=container-fluid><article class="blog-post blog-post-with-toc"><header><h2 class=blog-post-title>Databricks : Unity Catalog - Découverte - Data Lineage</h2><div class=blog-post-date><span>Dernière modification : 12 Mai 2023</span></div><div class=blog-post-date>Temps de lecture : 19 minute(s) - 3999 mots</div><div class=blog-post-tags><strong>Tags:</strong>
<a href=https://www.pragmatias.fr/tags/databricks/>Databricks</a>
<a href=https://www.pragmatias.fr/tags/unity-catalog/>Unity Catalog</a></div></header><aside class=prag-toc><h1 class=prag-toc-head>Sommaire</h1><div class=prag-toc-body><nav id=TableOfContents><ol><li><a href=#quest-ce-quest-le-data-lineage>Qu&rsquo;est ce qu&rsquo;est le Data Lineage</a></li><li><a href=#unity-catalog-et-la-hiérarchie-des-objets>Unity Catalog et la hiérarchie des objets</a><ol><li><a href=#synthèse>Synthèse</a></li></ol></li><li><a href=#préparation-de-lenvironnement>Préparation de l&rsquo;environnement</a><ol><li><a href=#contexte>Contexte</a></li><li><a href=#schématisation-de-lenvironnement>Schématisation de l&rsquo;environnement</a></li><li><a href=#mise-en-place-dun-jeu-de-données-sur-la-ressource-aws-s3>Mise en place d&rsquo;un jeu de données sur la ressource AWS S3</a></li><li><a href=#mise-en-place-des-objets-dans-le-metastore-unity-catalog>Mise en place des objets dans le Metastore Unity Catalog</a></li></ol></li><li><a href=#data-explorer>Data Explorer</a></li><li><a href=#data-lineage>Data Lineage</a><ol><li><a href=#synthèse-1>Synthèse</a></li><li><a href=#visualisation>Visualisation</a></li><li><a href=#export-des-données-de-data-linage-avec-databricks-rest-api>Export des données de Data Linage avec Databricks REST API</a></li></ol></li><li><a href=#suppression-des-éléments>Suppression des éléments</a></li><li><a href=#conclusion>Conclusion</a></li></ol></nav></div></aside><a id=showTopBtn href=# class=prag-sticky-bot><svg height="24" id="Layer_1" style="enable-background:new 0 0 438.533 438.533" viewBox="0 0 438.533 438.533" width="24" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path style="fill-rule:evenodd;clip-rule:evenodd;fill:" d="M409.133 109.203c-19.608-33.592-46.205-60.189-79.798-79.796C295.736 9.801 259.058.0 219.273.0c-39.781.0-76.47 9.801-110.063 29.407-33.595 19.604-60.192 46.201-79.8 79.796C9.801 142.8.0 179.489.0 219.267c0 39.78 9.804 76.463 29.407 110.062 19.607 33.592 46.204 60.189 79.799 79.798 33.597 19.605 70.283 29.407 110.063 29.407s76.47-9.802 110.065-29.407c33.593-19.602 60.189-46.206 79.795-79.798 19.603-33.596 29.403-70.284 29.403-110.062C438.533 179.485 428.732 142.795 409.133 109.203zM361.449 231.831l-25.981 25.981c-3.613 3.613-7.901 5.42-12.847 5.42-4.948.0-9.229-1.807-12.847-5.42l-53.954-53.961v143.32c0 4.948-1.813 9.232-5.428 12.847-3.613 3.62-7.898 5.427-12.847 5.427h-36.547c-4.948.0-9.231-1.807-12.847-5.427-3.617-3.614-5.426-7.898-5.426-12.847v-143.32l-53.959 53.961c-3.431 3.425-7.708 5.133-12.85 5.133-5.14.0-9.423-1.708-12.85-5.133l-25.981-25.981c-3.422-3.429-5.137-7.714-5.137-12.852.0-5.137 1.709-9.419 5.137-12.847l103.356-103.353 25.981-25.981c3.427-3.425 7.71-5.14 12.847-5.14 5.142.0 9.423 1.715 12.849 5.14l25.98 25.981 103.35 103.353c3.432 3.427 5.14 7.71 5.14 12.847C366.589 224.117 364.881 228.402 361.449 231.831z"/></svg></a><script>$(document).ready(function(){$("#showTopBtn").removeClass("prag-sticky-bot"),$("#showTopBtn").addClass("prag-sticky-hide"),$(function(){$(window).scroll(function(){$(this).scrollTop()>900?($("#showTopBtn").addClass("prag-sticky-bot"),$("#showTopBtn").removeClass("prag-sticky-hide")):($("#showTopBtn").addClass("prag-sticky-hide"),$("#showTopBtn").removeClass("prag-sticky-bot"))})})})</script><div class=blog-post-main><p>Nous allons découvrir la fonctionnalité <a href=https://docs.databricks.com/data-governance/unity-catalog/data-lineage.html>Data Lineage</a> proposée par la solution <a href=https://docs.databricks.com/data-governance/unity-catalog/index.html>Unity Catalog</a>.</p><p>Nous allons utiliser un Account Databricks sur AWS pour réaliser cette découverte.</p><p><em>Note : Nous allons garder des termes techniques en anglais pour faciliter la compréhension</em></p><h1 id=quest-ce-quest-le-data-lineage>Qu&rsquo;est ce qu&rsquo;est le Data Lineage</h1><p>Le Data Lineage consiste à cartographier l&rsquo;ensemble des objets et leur utilisation afin de pouvoir visualiser le cycle de vie des données.</p><p>Lorsque l&rsquo;on souhaite mettre en place une gouvernance de données, le Data Lineage apporte des informations extrêmement utiles.</p><p>Un Lineage fonctionnel consiste à mettre en place les éléments et outils pour cartographier les objets fonctionnels et leur usage dans les différentes applications et projets de l&rsquo;entreprise afin de visualiser l&rsquo;usage des données dans l&rsquo;ensemble de l&rsquo;organisation (équipes, applications, projets)
Cela permet de faciliter les travaux de rationalisation de l&rsquo;usage global des données ainsi que la mise en place d&rsquo;un langage fonctionnel commun à l&rsquo;entreprise.</p><p>Un Lineage technique consiste à mettre en place les éléments et outils pour cartographier les objets techniques et l&rsquo;utilisation des données par les différents outils techniques.
Cela permet de visualiser la relation entre les différents objets et de pouvoir identifier rapidement la provenance des données d&rsquo;un objet ainsi que les éléments impactés par les changements d&rsquo;un objet.</p><p>Certain outils de gouvernance de données permettant d&rsquo;automatiser la capture des métadonnées pour centraliser les informations de type Data Lineage comme par exemple Apache Atlas, Azure Purview ou AWS Glue (et bien d&rsquo;autres)</p><p>Dans notre cas, nous allons nous appuyer sur la solution Unity Catalog proposée par Databricks et plus précisément sur la capture des informations mis en place par cette solution pour cartographier l&rsquo;ensemble des éléments liés au Data Lineage.</p><p>Remarque : Il est aussi possible de mettre en place cette cartographie de manière manuelle avec l&rsquo;utilisation d&rsquo;un support de type Wiki alimenté manuellement ou à l&rsquo;aide de scripts pour extraire les métadonnées des différents outils lorsque cela est possible.
Cela nécessite énormément de temps et d&rsquo;énergie pour rédiger, maintenir, extraire et valider les informations dans le temps (évolution des outils, évolution des applications, évolution des données, &mldr;)</p><h1 id=unity-catalog-et-la-hiérarchie-des-objets>Unity Catalog et la hiérarchie des objets</h1><h2 id=synthèse>Synthèse</h2><p>Unity Catalog est la solution de Databricks permettant d&rsquo;avoir une gouvernance unifiée et centralisée pour l&rsquo;ensemble des données gérées par les ressources Databricks ainsi que de sécuriser et faciliter la gestion et le partage des données à l&rsquo;ensemble des acteurs internes et externes d&rsquo;une organisation.</p><p>Vous pourrez avec une vue d&rsquo;ensemble plus complète en parcourant la <a href=https://docs.databricks.com/data-governance/unity-catalog/index.html>documentation officielle</a></p><p>Rappel concernant la hiérarchie des objets :
<a href=/blog/web/20230512_databricks_unity_catalog_datalineage_30.png><img src=/blog/web/20230512_databricks_unity_catalog_datalineage_30.png alt=schema_30></a></p><p>Les différents objets sont :</p><ul><li>Storage Credential : Cet objet est associé directement au Metastore et permet de stocker les accès à un cloud provider (par exemple AWS S3) permettant à la solution Unity Catalog de gérer les droits sur les données.</li><li>External Location : Cet objet est associé au Metastore et permet de stocker le chemin vers un cloud provider (par exemple une ressource AWS S3) en combinaison avec un Storage Credential pour gérer les accès aux données</li><li>Metastore : Objet du plus haut niveau pouvant contenir des métadonnées</li><li>Catalog (Catalogue) : Objet de 1er niveau permettant d&rsquo;organiser les données par schéma (aussi nommé Base de données)</li><li>Schema (Schéma) : Objet de 2ème et dernier niveau permettant d&rsquo;organiser les données (contient les tables, les vues et les fonctions)</li><li>Table : Objet permettant de définir la structure et le stockage des données.</li><li>View (Vue) : Objet permettant d&rsquo;encapsuler une requête utilisant un ou plusieurs objets (table ou vue)</li><li>Function (Fonction) : Objet permettant de définir des opérations sur les données</li></ul><p>Lorsque vous souhaitez accéder à un objet (par exemple une table), il sera nécessaire de renseigner le nom du catalogue et le nom du schéma où est défini l&rsquo;objet.
Exemple : <code>select * from catalog.schema.table</code></p><h1 id=préparation-de-lenvironnement>Préparation de l&rsquo;environnement</h1><p>Nous allons mettre en place un ensemble d&rsquo;éléments nous permettant de découvrir plus en détail la fonctionnalité de Data Lineage de la solution Unity Catalog.</p><h2 id=contexte>Contexte</h2><p>Pré-requis :</p><ul><li>Création du groupe <code>grp_demo</code></li><li>Création de l&rsquo;utilisateur <code>john.do.dbx@gmail.com</code> et ajout de l&rsquo;utilisateur dans le groupe <code>grp_demo</code></li><li>Création d&rsquo;un SQL Warehouse et donner le droit d&rsquo;utilisation au groupe <code>grp_demo</code></li><li>Existence d&rsquo;un Metastore nommé <code>metastore-sandbox</code> avec le Storage Credential nommé <code>sc-metastore-sandbox</code> permettant de stocker les données par défaut dans la ressource AWS S3 nommée <code>s3-dbx-metastore-uc</code></li><li>Création d&rsquo;une ressource AWS S3 nommée <code>s3-demo-data-uc</code></li><li>Création d&rsquo;un rôle AWS IAM nommé <code>role-databricks-demo-data-uc</code> et d&rsquo;une politique AWS IAM nommée <code>policy-databricks-demo-data-uc</code> permettant au rôle global Databricks de gérer l&rsquo;accès à la ressource AWS S3 nommée <code>s3-demo-data-uc</code></li><li>Création d&rsquo;un Storage Credential nommé <code>sc-demo-data-uc</code> et d&rsquo;un External Location nommé <code>el_demo_data_uc</code> permettant au rôle global Databricks de gérer l&rsquo;accès à la ressource AWS S3 nommée <code>s3-demo-data-uc</code></li></ul><p>Mise en place des droits pour le groupe <code>grp_demo</code> :</p><ol><li>Donner le droit de créer des catalogues au niveau du Metastore pour le groupe <code>grp_demo</code></li><li>Donner le droit de lire les fichiers externes à partir de l&rsquo;objet External Location nommé <code>el_demo_data_uc</code></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>-- 1. Give Create Catalog right on Metastore to grp_demo
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>GRANT</span> <span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>CATALOG</span> <span style=color:#ff79c6>ON</span> METASTORE <span style=color:#ff79c6>TO</span> grp_demo;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#6272a4>-- 2. Give Read Files right on el_demo_data_uc location to grp_demo
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>GRANT</span> <span style=color:#ff79c6>READ</span> FILES <span style=color:#ff79c6>ON</span> <span style=color:#ff79c6>EXTERNAL</span> <span style=color:#ff79c6>LOCATION</span> <span style=color:#ff79c6>`</span>el_demo_data_uc<span style=color:#ff79c6>`</span> <span style=color:#ff79c6>TO</span> grp_demo;
</span></span></code></pre></div><h2 id=schématisation-de-lenvironnement>Schématisation de l&rsquo;environnement</h2><p>Schématisation des éléments de 1er niveau du Metastore correspondant au pré-requis :
<a href=/blog/web/20230512_databricks_unity_catalog_datalineage_31.png><img src=/blog/web/20230512_databricks_unity_catalog_datalineage_31.png alt=schema_31></a></p><p>Schématisation du contenu du catalogue <code>ctg_ipp</code> :
<a href=/blog/web/20230512_databricks_unity_catalog_datalineage_32.png><img src=/blog/web/20230512_databricks_unity_catalog_datalineage_32.png alt=schema_32></a></p><p>Schématisation du contenu du catalogue <code>ctg_ext</code> :
<a href=/blog/web/20230512_databricks_unity_catalog_datalineage_33.png><img src=/blog/web/20230512_databricks_unity_catalog_datalineage_33.png alt=schema_33></a></p><p>Schématisation de l&rsquo;alimentation des données entre les différents objets :
<a href=/blog/web/20230512_databricks_unity_catalog_datalineage_34.png><img src=/blog/web/20230512_databricks_unity_catalog_datalineage_34.png alt=schema_34></a></p><h2 id=mise-en-place-dun-jeu-de-données-sur-la-ressource-aws-s3>Mise en place d&rsquo;un jeu de données sur la ressource AWS S3</h2><p>Contenu du fichier <code>ref_stores.csv</code> :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>id,lib,postal_code,surface,last_maj
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>1,BustaPhone One,75001,120,2022-01-01 00:00:00
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>2,BustaPhone Two,79002,70,2022-01-01 00:00:00
</span></span></code></pre></div><p>Contenu du fichier <code>ref_clients.csv</code> :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>id,lib,age,contact,phone,is_member,last_maj
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>1,Maxence,23,max1235@ter.tt,+33232301123,No,2023-01-01 11:01:02
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>2,Bruce,26,br_br@ter.tt,+33230033155,Yes,2023-01-01 13:01:00
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>3,Charline,40,ccccharline@ter.tt,+33891234192,Yes,2023-03-02 09:00:00
</span></span></code></pre></div><p>Contenu du fichier <code>ref_products.csv</code> :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>id,lib,brand,os,last_maj
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>1,Pixel 7 Pro,Google,Android,2023-01-01 09:00:00
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>2,Iphone 14,Apple,IOS,2023-01-01 09:00:00
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>3,Galaxy S23,Samsung,Android,2023-01-01 09:00:00
</span></span></code></pre></div><p>Contenu du fichier <code>fct_transactions.csv</code> :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>id_trx,ts_trx,id_product,id_shop,id_client,quantity
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>1,2023-04-01 09:00:00,1,2,1,1
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>2,2023-04-01 11:00:00,1,1,1,3
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>3,2023-04-03 14:00:00,1,2,1,1
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>4,2023-04-05 08:00:00,3,1,2,9
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>5,2023-04-06 10:00:00,1,2,1,3
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>6,2023-04-06 12:00:00,2,2,1,1
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>7,2023-04-10 18:30:00,2,1,2,11
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9</span><span>8,2023-04-10 18:30:00,3,1,2,2
</span></span></code></pre></div><p>Réalisation de la copie des données vers le répertoire <code>demo</code>de la ressource AWS S3 nommée <code>s3-demo-data-uc</code> avec l&rsquo;outil AWS CLI:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>aws s3 cp ref_stores.csv s3://s3-demo-data-uc/demo/ref_stores.csv 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>aws s3 cp ref_clients.csv s3://s3-demo-data-uc/demo/ref_clients.csv 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>aws s3 cp ref_products.csv s3://s3-demo-data-uc/demo/ref_products.csv 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>aws s3 cp fct_transactions.csv s3://s3-demo-data-uc/demo/fct_transactions.csv 
</span></span></code></pre></div><h2 id=mise-en-place-des-objets-dans-le-metastore-unity-catalog>Mise en place des objets dans le Metastore Unity Catalog</h2><p>Note : Utilisation d&rsquo;un utilisateur du groupe <code>grp_demo</code></p><ol><li>Création des catalogues</li></ol><ul><li><code>ctg_ipp</code> : Catalogue permettant de gérer les éléments managés par Unity Catalog</li><li><code>ctg_ext</code> : Catalogue permettant de gérer les éléments externes</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>-- Create Catalog (for managed data)
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>CATALOG</span> <span style=color:#ff79c6>IF</span> <span style=color:#ff79c6>NOT</span> <span style=color:#ff79c6>EXISTS</span> ctg_ipp
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>    <span style=color:#ff79c6>COMMENT</span> <span style=color:#f1fa8c>&#39;Catalog for managed data&#39;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#6272a4>-- Create Catalog (for external data)
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>CATALOG</span> <span style=color:#ff79c6>IF</span> <span style=color:#ff79c6>NOT</span> <span style=color:#ff79c6>EXISTS</span> ctg_ext
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>    <span style=color:#ff79c6>COMMENT</span> <span style=color:#f1fa8c>&#39;Catalog for external data&#39;</span>;
</span></span></code></pre></div><ol start=2><li>Création des schémas
La liste des schémas est la suivante :</li></ol><ul><li><code>ctg_ext.sch_ref</code> : Schéma permettant de regrouper les tables externes pour l&rsquo;accès aux données référentiels</li><li><code>ctg_ipp.sch_bronze</code> : Schéma permettant de stocker les données brutes</li><li><code>ctg_ipp.sch_silver</code> : Schéma permettant de stocker les données raffinées</li><li><code>ctg_ipp.sch_gold</code> : Schéma permettant de stocker les données agrégées</li><li><code>ctg_ipp.sch_gold_v</code> : Schéma permettant de définir les vues pour l&rsquo;exposition des données</li><li><code>ctg_ipp.sch_reject</code> : Schéma permettant de stocker les données rejetées</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>-- Create Schema for external data
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>SCHEMA</span> <span style=color:#ff79c6>IF</span> <span style=color:#ff79c6>NOT</span> <span style=color:#ff79c6>EXISTS</span> ctg_ext.sch_ref
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#ff79c6>COMMENT</span> <span style=color:#f1fa8c>&#39;Schema for external referential data&#39;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#6272a4>-- Create Schema for managed data
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>SCHEMA</span> <span style=color:#ff79c6>IF</span> <span style=color:#ff79c6>NOT</span> <span style=color:#ff79c6>EXISTS</span> ctg_ipp.sch_bronze
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#ff79c6>COMMENT</span> <span style=color:#f1fa8c>&#39;Schema for Bronze Data&#39;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>SCHEMA</span> <span style=color:#ff79c6>IF</span> <span style=color:#ff79c6>NOT</span> <span style=color:#ff79c6>EXISTS</span> ctg_ipp.sch_silver
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#ff79c6>COMMENT</span> <span style=color:#f1fa8c>&#39;Schema for Silver Data&#39;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>SCHEMA</span> <span style=color:#ff79c6>IF</span> <span style=color:#ff79c6>NOT</span> <span style=color:#ff79c6>EXISTS</span> ctg_ipp.sch_gold
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#ff79c6>COMMENT</span> <span style=color:#f1fa8c>&#39;Schema for Gold Data&#39;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>SCHEMA</span> <span style=color:#ff79c6>IF</span> <span style=color:#ff79c6>NOT</span> <span style=color:#ff79c6>EXISTS</span> ctg_ipp.sch_gold_v
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    <span style=color:#ff79c6>COMMENT</span> <span style=color:#f1fa8c>&#39;Schema for Gold Views&#39;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>SCHEMA</span> <span style=color:#ff79c6>IF</span> <span style=color:#ff79c6>NOT</span> <span style=color:#ff79c6>EXISTS</span> ctg_ipp.sch_reject
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    <span style=color:#ff79c6>COMMENT</span> <span style=color:#f1fa8c>&#39;Schema for Reject Data&#39;</span>;
</span></span></code></pre></div><ol start=3><li>Création des tables externes (External Table) pour accéder aux données des référentiels</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>-- Create external table (referential)
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>TABLE</span> ctg_ext.sch_ref.ref_clients (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    id <span style=color:#8be9fd;font-style:italic>int</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    ,lib string
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    ,age <span style=color:#8be9fd;font-style:italic>int</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    ,contact string
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    ,phone string
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    ,is_member string
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    ,last_maj <span style=color:#ff79c6>timestamp</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#ff79c6>USING</span> CSV
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#ff79c6>OPTIONS</span> (path <span style=color:#f1fa8c>&#34;s3://s3-demo-data-uc/demo/ref_clients.csv&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>        <span style=color:#ff79c6>delimiter</span> <span style=color:#f1fa8c>&#34;,&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>        header <span style=color:#f1fa8c>&#34;true&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>TABLE</span> ctg_ext.sch_ref.ref_products (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    id <span style=color:#8be9fd;font-style:italic>int</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    ,lib string
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    ,brand string
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    ,os string
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>    ,last_maj <span style=color:#ff79c6>timestamp</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#ff79c6>USING</span> CSV
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span><span style=color:#ff79c6>OPTIONS</span> (path <span style=color:#f1fa8c>&#34;s3://s3-demo-data-uc/demo/ref_products.csv&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>        <span style=color:#ff79c6>delimiter</span> <span style=color:#f1fa8c>&#34;,&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>        header <span style=color:#f1fa8c>&#34;true&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span><span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>TABLE</span> ctg_ext.sch_ref.ref_shops (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>    id <span style=color:#8be9fd;font-style:italic>int</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>    ,lib string
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>    ,postal_code string
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>    ,surface <span style=color:#8be9fd;font-style:italic>int</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>    ,last_maj <span style=color:#ff79c6>timestamp</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span><span style=color:#ff79c6>USING</span> CSV
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span><span style=color:#ff79c6>OPTIONS</span> (path <span style=color:#f1fa8c>&#34;s3://s3-demo-data-uc/demo/ref_shops.csv&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>        <span style=color:#ff79c6>delimiter</span> <span style=color:#f1fa8c>&#34;,&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>        header <span style=color:#f1fa8c>&#34;true&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>        ;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span><span style=color:#6272a4>-- Create managed table
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>TABLE</span> ctg_ipp.sch_bronze.fct_transactions_raw (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>    id_trx string
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>    ,ts_trx string
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>    ,id_product string
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span>    ,id_shop string
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span>    ,id_client string
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span>    ,quantity string
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span><span style=color:#ff79c6>COMMENT</span> <span style=color:#f1fa8c>&#39;Bronze Transactions Data&#39;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span><span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>TABLE</span> ctg_ipp.sch_reject.fct_transactions_rej (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span><span>    id_rej <span style=color:#8be9fd;font-style:italic>int</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span><span>    ,ts_rej <span style=color:#ff79c6>timestamp</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57</span><span>    ,id_trx string
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58</span><span>    ,ts_trx string
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59</span><span>    ,id_product string
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60</span><span>    ,id_shop string
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61</span><span>    ,id_client string
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62</span><span>    ,quantity string
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63</span><span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64</span><span><span style=color:#ff79c6>COMMENT</span> <span style=color:#f1fa8c>&#39;Reject Transactions Data&#39;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67</span><span><span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>TABLE</span> ctg_ipp.sch_silver.fct_transactions (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68</span><span>    id_trx <span style=color:#8be9fd;font-style:italic>integer</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69</span><span>    ,ts_trx <span style=color:#ff79c6>timestamp</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">70</span><span>    ,id_product <span style=color:#8be9fd;font-style:italic>integer</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">71</span><span>    ,id_shop <span style=color:#8be9fd;font-style:italic>integer</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">72</span><span>    ,id_client <span style=color:#8be9fd;font-style:italic>integer</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">73</span><span>    ,quantity <span style=color:#8be9fd;font-style:italic>integer</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">74</span><span>    ,ts_tech <span style=color:#ff79c6>timestamp</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">75</span><span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">76</span><span><span style=color:#ff79c6>COMMENT</span> <span style=color:#f1fa8c>&#39;Silver Transactions Data&#39;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">77</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">78</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">79</span><span><span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>TABLE</span> ctg_ipp.sch_gold.fct_transactions_agg_day (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">80</span><span>    dt_trx <span style=color:#8be9fd;font-style:italic>date</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">81</span><span>    ,id_product <span style=color:#8be9fd;font-style:italic>integer</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">82</span><span>    ,is_member <span style=color:#8be9fd;font-style:italic>boolean</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">83</span><span>    ,quantity <span style=color:#8be9fd;font-style:italic>integer</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">84</span><span>    ,ts_tech <span style=color:#ff79c6>timestamp</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">85</span><span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">86</span><span><span style=color:#ff79c6>COMMENT</span> <span style=color:#f1fa8c>&#39;Gold Transactions Data Agg Day&#39;</span>;
</span></span></code></pre></div><ol start=4><li>Alimentation des tables managées</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>-- Insert Bronze Data
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>COPY</span> <span style=color:#ff79c6>INTO</span> ctg_ipp.sch_bronze.fct_transactions_raw
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>  <span style=color:#ff79c6>FROM</span> <span style=color:#f1fa8c>&#39;s3://s3-demo-data-uc/demo/fct_transactions.csv&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>  FILEFORMAT <span style=color:#ff79c6>=</span> CSV
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>  FORMAT_OPTIONS (<span style=color:#f1fa8c>&#39;encoding&#39;</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;utf8&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>                ,<span style=color:#f1fa8c>&#39;inferSchema&#39;</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;false&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>                ,<span style=color:#f1fa8c>&#39;nullValue&#39;</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;N/A&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>                ,<span style=color:#f1fa8c>&#39;mergeSchema&#39;</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;false&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>                ,<span style=color:#f1fa8c>&#39;delimiter&#39;</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;,&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>                ,<span style=color:#f1fa8c>&#39;header&#39;</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;true&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>                ,<span style=color:#f1fa8c>&#39;mode&#39;</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;failfast&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#6272a4>-- Insert Reject Data
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>INSERT</span> <span style=color:#ff79c6>INTO</span> ctg_ipp.sch_reject.fct_transactions_rej (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    id_rej
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    ,ts_rej
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    ,id_trx
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    ,ts_trx
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>    ,id_product
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>    ,id_shop
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>    ,id_client
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>    ,quantity
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span><span style=color:#ff79c6>SELECT</span> <span style=color:#bd93f9>1</span> <span style=color:#ff79c6>as</span> id_rej
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>    ,<span style=color:#ff79c6>current_timestamp</span>() <span style=color:#ff79c6>as</span> ts_rej
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>    ,id_trx
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>    ,ts_trx
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>    ,id_product
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>    ,id_shop
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>    ,id_client
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>    ,quantity
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span><span style=color:#ff79c6>FROM</span> ctg_ipp.sch_bronze.fct_transactions_raw
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span><span style=color:#ff79c6>WHERE</span> TRY_CAST(quantity <span style=color:#ff79c6>AS</span> <span style=color:#8be9fd;font-style:italic>integer</span>) <span style=color:#ff79c6>IS</span> <span style=color:#ff79c6>NULL</span> 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>    <span style=color:#ff79c6>OR</span> TRY_CAST(quantity <span style=color:#ff79c6>AS</span> <span style=color:#8be9fd;font-style:italic>integer</span>) <span style=color:#ff79c6>&lt;</span> <span style=color:#bd93f9>1</span> ;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span><span style=color:#6272a4>-- Insert Silver Data
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>INSERT</span> <span style=color:#ff79c6>INTO</span> ctg_ipp.sch_silver.fct_transactions (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>    id_trx
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>    ,ts_trx
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>    ,id_product
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>    ,id_shop
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>    ,id_client
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span>    ,quantity
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span>    ,ts_tech
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span><span style=color:#ff79c6>SELECT</span> 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span>    <span style=color:#ff79c6>case</span> <span style=color:#ff79c6>when</span> (id_trx <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;N/A&#39;</span>) <span style=color:#ff79c6>then</span> <span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>cast</span>(id_trx <span style=color:#ff79c6>as</span> <span style=color:#8be9fd;font-style:italic>integer</span>) <span style=color:#ff79c6>end</span> <span style=color:#ff79c6>as</span> id_trx
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span>    ,<span style=color:#ff79c6>case</span> <span style=color:#ff79c6>when</span> (ts_trx<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#39;N/A&#39;</span>) <span style=color:#ff79c6>then</span> <span style=color:#ff79c6>cast</span>(<span style=color:#f1fa8c>&#39;1900-01-01 00:00:00&#39;</span> <span style=color:#ff79c6>as</span> <span style=color:#ff79c6>timestamp</span>) <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>cast</span>(ts_trx <span style=color:#ff79c6>as</span> <span style=color:#ff79c6>timestamp</span>) <span style=color:#ff79c6>end</span> <span style=color:#ff79c6>as</span> ts_trx
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span>    ,<span style=color:#ff79c6>case</span> <span style=color:#ff79c6>when</span> (id_product <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;N/A&#39;</span>) <span style=color:#ff79c6>then</span> <span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>cast</span>(id_product <span style=color:#ff79c6>as</span> <span style=color:#8be9fd;font-style:italic>integer</span>) <span style=color:#ff79c6>end</span> <span style=color:#ff79c6>as</span> id_product
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span>    ,<span style=color:#ff79c6>case</span> <span style=color:#ff79c6>when</span> (id_shop <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;N/A&#39;</span>) <span style=color:#ff79c6>then</span> <span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>cast</span>(id_shop <span style=color:#ff79c6>as</span> <span style=color:#8be9fd;font-style:italic>integer</span>) <span style=color:#ff79c6>end</span> <span style=color:#ff79c6>as</span> id_shop
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span><span>    ,<span style=color:#ff79c6>case</span> <span style=color:#ff79c6>when</span> (id_client <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;N/A&#39;</span>) <span style=color:#ff79c6>then</span> <span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>cast</span>(id_client <span style=color:#ff79c6>as</span> <span style=color:#8be9fd;font-style:italic>integer</span>) <span style=color:#ff79c6>end</span> <span style=color:#ff79c6>as</span> id_client
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span><span>    ,<span style=color:#ff79c6>case</span> <span style=color:#ff79c6>when</span> (quantity <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;N/A&#39;</span>) <span style=color:#ff79c6>then</span> <span style=color:#bd93f9>0</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>cast</span>(quantity <span style=color:#ff79c6>as</span> <span style=color:#8be9fd;font-style:italic>integer</span>) <span style=color:#ff79c6>end</span> <span style=color:#ff79c6>as</span> quantity
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57</span><span>    ,<span style=color:#ff79c6>current_timestamp</span>() <span style=color:#ff79c6>as</span> ts_tech
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58</span><span><span style=color:#ff79c6>FROM</span> ctg_ipp.sch_bronze.fct_transactions_raw
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59</span><span><span style=color:#ff79c6>WHERE</span> <span style=color:#ff79c6>case</span> <span style=color:#ff79c6>when</span> (quantity <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;N/A&#39;</span>) <span style=color:#ff79c6>then</span> <span style=color:#bd93f9>0</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>cast</span>(quantity <span style=color:#ff79c6>as</span> <span style=color:#8be9fd;font-style:italic>integer</span>) <span style=color:#ff79c6>end</span> <span style=color:#ff79c6>&gt;</span> <span style=color:#bd93f9>0</span> ;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63</span><span><span style=color:#6272a4>-- Insert Gold Data
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>INSERT</span> <span style=color:#ff79c6>INTO</span> ctg_ipp.sch_gold.fct_transactions_agg_day (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65</span><span>    dt_trx
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66</span><span>    ,id_product
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67</span><span>    ,is_member
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68</span><span>    ,quantity
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69</span><span>    ,ts_tech
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">70</span><span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">71</span><span><span style=color:#ff79c6>SELECT</span> <span style=color:#ff79c6>cast</span>(trx.ts_trx <span style=color:#ff79c6>as</span> <span style=color:#8be9fd;font-style:italic>date</span>) <span style=color:#ff79c6>as</span> dt_trx
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">72</span><span>    ,trx.id_product
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">73</span><span>    ,<span style=color:#ff79c6>case</span> <span style=color:#ff79c6>when</span> (rc.is_member <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;Yes&#39;</span>) <span style=color:#ff79c6>then</span> <span style=color:#ff79c6>true</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>false</span> <span style=color:#ff79c6>end</span> is_member
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">74</span><span>    ,<span style=color:#ff79c6>sum</span>(trx.quantity)  <span style=color:#ff79c6>as</span> quantity
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">75</span><span>    ,<span style=color:#ff79c6>current_timestamp</span>() <span style=color:#ff79c6>as</span> ts_tech
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">76</span><span><span style=color:#ff79c6>FROM</span> ctg_ipp.sch_silver.fct_transactions trx
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">77</span><span><span style=color:#ff79c6>INNER</span> <span style=color:#ff79c6>JOIN</span> ctg_ext.sch_ref.ref_clients rc
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">78</span><span><span style=color:#ff79c6>ON</span> (rc.id <span style=color:#ff79c6>=</span> trx.id_client)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">79</span><span><span style=color:#ff79c6>GROUP</span> <span style=color:#ff79c6>BY</span> dt_trx
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">80</span><span>    ,trx.id_product
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">81</span><span>    ,rc.is_member;
</span></span></code></pre></div><ol start=5><li>Création des vues</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>-- Create Views
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>OR</span> <span style=color:#ff79c6>REPLACE</span> <span style=color:#ff79c6>VIEW</span> ctg_ipp.sch_gold_v.fct_transactions_day_products
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#ff79c6>AS</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#ff79c6>SELECT</span> atd.dt_trx
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    ,rp.lib <span style=color:#ff79c6>as</span> lib_product
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    ,atd.quantity
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    ,atd.ts_tech
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#ff79c6>FROM</span> ctg_ipp.sch_gold.fct_transactions_agg_day atd
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#ff79c6>LEFT</span> <span style=color:#ff79c6>OUTER</span> <span style=color:#ff79c6>JOIN</span> ctg_ext.sch_ref.ref_products rp
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#ff79c6>ON</span> (rp.id <span style=color:#ff79c6>=</span> atd.id_product)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#ff79c6>where</span> is_member <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>true</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>OR</span> <span style=color:#ff79c6>REPLACE</span> <span style=color:#ff79c6>VIEW</span> ctg_ipp.sch_gold_v.fct_transactions_detail
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#ff79c6>AS</span> <span style=color:#ff79c6>SELECT</span> trx.id_trx
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    ,trx.ts_trx
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    ,rp.lib <span style=color:#ff79c6>as</span> lib_product
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    ,rp.brand <span style=color:#ff79c6>as</span> brand_product
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    ,rp.os <span style=color:#ff79c6>as</span> os_product
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    ,rs.lib <span style=color:#ff79c6>as</span> lib_shop
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>    ,rs.postal_code <span style=color:#ff79c6>as</span> postal_code_shop
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>    ,rc.lib <span style=color:#ff79c6>as</span> name_client
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>    ,<span style=color:#ff79c6>case</span> <span style=color:#ff79c6>when</span> is_member(<span style=color:#f1fa8c>&#39;admins&#39;</span>) <span style=color:#ff79c6>then</span> rc.contact <span style=color:#ff79c6>else</span> <span style=color:#f1fa8c>&#39;XXX@XXX.XX&#39;</span> <span style=color:#ff79c6>end</span> <span style=color:#ff79c6>as</span> contact_client
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>    ,trx.ts_tech
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span><span style=color:#ff79c6>FROM</span> ctg_ipp.sch_silver.fct_transactions trx
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span><span style=color:#ff79c6>INNER</span> <span style=color:#ff79c6>JOIN</span> ctg_ext.sch_ref.ref_clients rc 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span><span style=color:#ff79c6>ON</span> (trx.id_client <span style=color:#ff79c6>=</span> rc.id)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span><span style=color:#ff79c6>LEFT</span> <span style=color:#ff79c6>OUTER</span> <span style=color:#ff79c6>JOIN</span> ctg_ext.sch_ref.ref_shops rs 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span><span style=color:#ff79c6>ON</span> (trx.id_shop <span style=color:#ff79c6>=</span> rs.id)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span><span style=color:#ff79c6>LEFT</span> <span style=color:#ff79c6>OUTER</span> <span style=color:#ff79c6>JOIN</span> ctg_ext.sch_ref.ref_products rp
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span><span style=color:#ff79c6>ON</span> (trx.id_product <span style=color:#ff79c6>=</span> rp.id);
</span></span></code></pre></div><h1 id=data-explorer>Data Explorer</h1><p>L&rsquo;outil Data Explorer permet d&rsquo;avoir une interface utilisateur pour l&rsquo;exploration et la gestion des données (Catalogue, Schéma, Tables, Vues, Droits) et permet d&rsquo;avoir de nombreuses informations sur les différents objets ainsi que sur leur utilisation.</p><p>Cet outil est accessible dans toutes les vues du Workspace Databricks (Data Science & Engineering, Machine Learning, SQL) en cliquant sur l&rsquo;option <code>Data</code> du menu latéral.</p><p>Cet outil utilise les droits d&rsquo;accès de l&rsquo;utilisateur du Workspace Databricks, par conséquent il est nécessaire d&rsquo;avoir les droits suffisants sur les objets.
Pour pouvoir explorer les éléments sans avoir le droit de lire les données, il faut avoir le droit <code>USE</code> sur les différents objets (Catalogue, Schéma, Table, Vue)
Pour pouvoir accéder à un échantillon des données ou à l&rsquo;historique d&rsquo;une table au format Delta, il faut avoir le droit <code>SELECT</code> en plus du droit <code>USE</code>.</p><p>Il est possible d&rsquo;accéder aux métadonnées de l&rsquo;ensemble des éléments de l&rsquo;Unity Catalog sans utiliser un SQL Warehouse.
Pour les actions suivantes, il est nécessaire d&rsquo;avoir un SQL Warehouse actif pour lire les données nécessaires :</p><ul><li>Accès au catalogue <code>hive_metastore</code></li><li>Accès à un échantillon des données d&rsquo;une table</li><li>Accès à l&rsquo;historique d&rsquo;une table Delta</li></ul><p>Le menu <code>Explorer</code> (barre latérale) permet d&rsquo;accéder aux éléments suivants :</p><ul><li>Option <code>Data</code> : Permet de naviguer dans la hiérarchie des éléments du Metastore (Catalogues, Schémas, Tables, Vues, &mldr;)</li><li>Option <code>External Data</code> : Contient la liste des éléments concernant les Storage Credential et les External Location.</li></ul><p>Écran de l&rsquo;option <code>Data</code> :
<a href=/blog/web/20230512_databricks_unity_catalog_datalineage_01.png><img src=/blog/web/20230512_databricks_unity_catalog_datalineage_01.png alt=schema_01></a></p><p>Écran de l&rsquo;option <code>External Data</code> :
<a href=/blog/web/20230512_databricks_unity_catalog_datalineage_02.png><img src=/blog/web/20230512_databricks_unity_catalog_datalineage_02.png alt=schema_02></a>
<a href=/blog/web/20230512_databricks_unity_catalog_datalineage_03.png><img src=/blog/web/20230512_databricks_unity_catalog_datalineage_03.png alt=schema_03></a>
<a href=/blog/web/20230512_databricks_unity_catalog_datalineage_04.png><img src=/blog/web/20230512_databricks_unity_catalog_datalineage_04.png alt=schema_04></a></p><p>L&rsquo;interface <code>Principale</code> permet d&rsquo;accéder aux éléments suivants :</p><ul><li>Affichage de la liste des catalogues, visibles par l&rsquo;utilisateur, avec pour chaque catalogue le timestamp de création et le propriétaire (créateur par défaut)</li><li>Permet de créer, renommer ou supprimer un catalogue</li></ul><p>Écran de l&rsquo;interface <code>Principale</code> :
<a href=/blog/web/20230512_databricks_unity_catalog_datalineage_05.png><img src=/blog/web/20230512_databricks_unity_catalog_datalineage_05.png alt=schema_05></a></p><p>L&rsquo;interface <code>Catalog</code> :</p><ul><li>Onglet <code>Schemas</code> : Affichage de la liste des schémas, visibles par l&rsquo;utilisateurs, dans le catalogue avec pour chaque schéma le timestamp de création et le propriétaire (créateur par défaut)</li><li>Onglet <code>Detail</code> : Affichage du détail des informations concernant le catalogue (Metastore Id, &mldr;)</li><li>Onglet <code>Permissions</code> : Gestion des droits sur le catalogue</li></ul><p>Écran de l&rsquo;onglet <code>Schemas</code> de l&rsquo;interface <code>Catalog</code> :
<a href=/blog/web/20230512_databricks_unity_catalog_datalineage_06.png><img src=/blog/web/20230512_databricks_unity_catalog_datalineage_06.png alt=schema_06></a></p><p>Écran de l&rsquo;onglet <code>Details</code> de l&rsquo;interface <code>Catalog</code> :
<a href=/blog/web/20230512_databricks_unity_catalog_datalineage_07.png><img src=/blog/web/20230512_databricks_unity_catalog_datalineage_07.png alt=schema_07></a></p><p>L&rsquo;interface <code>Schema</code> d&rsquo;un catalogue :</p><ul><li>Onglet <code>Tables</code> : Affichage de la liste des objets (tables et vues), visibles de l&rsquo;utilisateur, dans le schéma avec leur timestamp de création et le propriétaire (créateur par défaut)</li><li>Onglet <code>Details</code> : Détail des informations concernant le schéma</li><li>Onglet <code>Permissions</code> : Gestion des droits sur le schéma</li></ul><p>Écran de l&rsquo;onglet <code>Tables</code> de l&rsquo;interface <code>Schema</code> :
<a href=/blog/web/20230512_databricks_unity_catalog_datalineage_08.png><img src=/blog/web/20230512_databricks_unity_catalog_datalineage_08.png alt=schema_08></a></p><p>Écran de l&rsquo;onglet <code>Details</code> de l&rsquo;interface <code>Schema</code> :
<a href=/blog/web/20230512_databricks_unity_catalog_datalineage_09.png><img src=/blog/web/20230512_databricks_unity_catalog_datalineage_09.png alt=schema_09></a></p><p>L&rsquo;interface <code>Table</code> d&rsquo;un schéma :</p><ul><li>Onglet <code>Columns</code> : Affichage de la liste des colonnes (nom et type des données) et gestion des commentaires sur les colonnes</li><li>Onglet <code>Sample Data</code> : Affichage d&rsquo;un échantillon des données de l&rsquo;objet</li><li>Onglet <code>Detail</code>: Affichage du détail des informations concernant l&rsquo;objet</li><li>Onglet <code>Permissions</code> : Gestion des droits sur l&rsquo;objet</li><li>Onglet <code>History</code> : Affichage de l&rsquo;historique des versions de l&rsquo;objet (lorsque c&rsquo;est une table au format Delta uniquement)</li><li>Onglet <code>Lineage</code> : Affichage des informations de Data Lineage liées à l&rsquo;objet</li><li>Informations supplémentaires :<ul><li>Il est possible de créer une requête ou un dashboard directement à partir de Data Explorer en cliquant sur <code>Create</code>et en sélectionnant l&rsquo;une des options (<code>Query</code> ou <code>Quick dashboard</code>)</li><li>Il est possible de renommer ou supprimer un objet en cliquant sur le bouton avec les 3 points et en sélectionnant l&rsquo;une des options (<code>Rename</code> ou <code>Delete</code>)</li><li>L&rsquo;en-tête de l&rsquo;écran permet d&rsquo;afficher des informations sur l&rsquo;objet comme le type, le format des données, le nom du propriétaire, le poids des données et le commentaire</li></ul></li></ul><p>Écran de l&rsquo;onglet <code>Columns</code> de l&rsquo;interface <code>Table</code> :
<a href=/blog/web/20230512_databricks_unity_catalog_datalineage_10.png><img src=/blog/web/20230512_databricks_unity_catalog_datalineage_10.png alt=schema_10></a></p><p>Écran de l&rsquo;onglet <code>Sample Data</code> de l&rsquo;interface <code>Table</code> :
<a href=/blog/web/20230512_databricks_unity_catalog_datalineage_11.png><img src=/blog/web/20230512_databricks_unity_catalog_datalineage_11.png alt=schema_11></a></p><p>Écran de l&rsquo;onglet <code>Detail</code> de l&rsquo;interface <code>Table</code> :
<a href=/blog/web/20230512_databricks_unity_catalog_datalineage_12.png><img src=/blog/web/20230512_databricks_unity_catalog_datalineage_12.png alt=schema_12></a></p><p>Écran de l&rsquo;onglet <code>History</code> de l&rsquo;interface <code>Table</code> :
<a href=/blog/web/20230512_databricks_unity_catalog_datalineage_13.png><img src=/blog/web/20230512_databricks_unity_catalog_datalineage_13.png alt=schema_13></a></p><h1 id=data-lineage>Data Lineage</h1><h2 id=synthèse-1>Synthèse</h2><p>Cette fonctionnalité est activée par défaut lors de la mise en place de la solution Unity Catalog.</p><p>L&rsquo;accès aux données de la fonctionnalité Data Lineage proposée par la solution Unity Catalog peut se faire de 3 façons différentes :</p><ol><li>Accéder à l&rsquo;onglet <code>Lineage</code>d&rsquo;un objet (Table ou Vue) avec l&rsquo;outil Data Explorer</li><li>Utilisation de Databricks REST API pour extraire des informations à partir de la solution Unity Catalog</li><li>Utilisation d&rsquo;un outil de gouvernance de données qui à un connecteur Databricks permettant d&rsquo;extraire les informations de la solution Unity Catalog vers une application tierce</li></ol><p>Nous allons nous concentrer sur l&rsquo;utilisation de l&rsquo;outil Data Explorer pour découvrir quelles sont les informations capturées par défaut par la solution Unity Catalog.
Pour accéder aux informations de la fonctionnalité Data Lineage :</p><ol><li>Allez sur <code>Workspace Databricks page > Data</code></li><li>Cliquez sur le catalogue souhaité</li><li>Cliquez sur le schéma souhaité</li><li>Cliquez sur l&rsquo;objet (table ou vue) souhaité</li><li>Cliquez sur l&rsquo;option <code>Lineage</code></li></ol><p>Contrainte pour que les informations de Data Lineage soient capturées pour un objet :</p><ul><li>L&rsquo;objet doit être défini dans un catalogue du Metastore</li><li>Les requêtes doivent utiliser l&rsquo;API Dataframe de Spark ou l&rsquo;interface Databricks SQL</li><li>La capture des informations se basant sur les traitements utilisant l&rsquo;API Structured Streaming entre les tables Delta n&rsquo;est supportée qu&rsquo;à partir du Runtime 11.3 LTS (DBR)</li><li>Pour accéder aux informations de Data Lineage sur les objets (tables ou vues), l&rsquo;utilisateur doit avoir le droit <code>SELECT</code> sur ces objets.</li></ul><p>Fonctionnement :</p><ul><li>La capture des informations de Data Lineage est faite à partir des logs d&rsquo;exécution des différents outils (notebooks, requêtes sql, workflow, &mldr;) sur les 30 derniers jours (période glissante)<ul><li>Cela signifie que les informations de Data Lineage concernant les logs d&rsquo;exécution des traitements de plus de 30 jours ne sont pas disponible</li></ul></li><li>La capture se fait jusqu&rsquo;à la granularité de la colonne de chaque objet</li></ul><p>Limitation :</p><ul><li>Lorsque qu&rsquo;un objet est renommé, les informations de Data Lineage ne sont plus visibles<ul><li>La capture des informations de Data Lineage est faite par rapport au nom de l&rsquo;objet et non pas à l&rsquo;identifiant unique de la table</li><li>Pour avoir à nouveau les informations de Data Lineage, il faut attendre l&rsquo;exécution des traitements liés à l&rsquo;objet</li></ul></li><li>Lorsqu&rsquo;une colonne est renommée, les informations de Data Lineage ne sont plus visibles sur la colonne de l&rsquo;objet de la même manière que pour le renommage d&rsquo;un objet</li><li>Remarque :<ul><li>Il est possible de renommer à nouveau l&rsquo;objet (table ou vue) ou la colonne avec l&rsquo;ancien nom pour retrouver l&rsquo;ensemble des informations de Data lineage déjà capturé</li><li>Lors du renommage d&rsquo;un objet (pour un objet managé dans le Metastore), l&rsquo;identifiant de l&rsquo;objet (et le chemin de stockage) ne change pas. Seulement le nom de l&rsquo;objet ou de la colonne est modifié.</li></ul></li></ul><p>Pour chaque objet, les informations du Data Lineage sont constitués des éléments suivants :</p><ul><li>Affichage du graphe complet (ensemble des éléments sources et cible en partant de l&rsquo;objet) et possibilité de naviguer dedans</li><li>Option &ldquo;Upstream&rdquo; : Permet de filtrer l&rsquo;ensemble des éléments utiliser comme source de l&rsquo;alimentation de l&rsquo;objet (1er niveau)</li><li>Option &ldquo;Downstream&rdquo; : Permet de filtrer l&rsquo;ensemble des éléments utilisant les données de l&rsquo;objet (1er niveau)</li></ul><p>Les éléments qui peuvent être capturés par Unity Catalog pour un objet (Table ou Vue) sont :</p><ul><li>Les tables : L&rsquo;ensemble des objets (Tables, Vues) dans le Metastore liés à l&rsquo;objet concerné</li><li>Les notebooks : L&rsquo;ensemble des notebooks ayant utilisé l&rsquo;objet concerné (alimentation ou lecture)</li><li>Les workflows : L&rsquo;ensemble des workflows ayant un traitement utilisant l&rsquo;objet concerné (alimentation ou lecture)</li><li>Les pipelines : L&rsquo;ensemble des pipelines ayant un traitement utilisant l&rsquo;objet concerné (alimentation ou lecture)</li><li>Les dashboards : L&rsquo;ensemble des dashboards composé des requêtes SQL utilisant l&rsquo;objet concerné</li><li>Les requêtes : L&rsquo;ensemble des requêtes SQL (format notebook utilisant le SQL Warehouse) ayant utilisé l&rsquo;objet concerné</li><li>Les chemins d&rsquo;accès aux données : L&rsquo;ensemble des chemins d&rsquo;accès aux données externes utilisé par l&rsquo;objet concerné</li></ul><h2 id=visualisation>Visualisation</h2><p>Visualisation du Data Lineage à partir de la table <code>ctg_ipp.sch_bronze.fct_transactions_raw</code> en se limitant uniquement au lien de 1er niveau :
<a href=/blog/web/20230512_databricks_unity_catalog_datalineage_20.png><img src=/blog/web/20230512_databricks_unity_catalog_datalineage_20.png alt=schema_20></a></p><p>Visualisation du Data Lineage à partir de la colonne <code>quantity</code> de la table <code>ctg_ipp.sch_bronze.fct_transactions_raw</code> :
<a href=/blog/web/20230512_databricks_unity_catalog_datalineage_21.png><img src=/blog/web/20230512_databricks_unity_catalog_datalineage_21.png alt=schema_21></a></p><p>Visualisation du Data Lineage à partir de la table <code>ctg_ipp.sch_bronze.fct_transactions_raw</code> en prenant l&rsquo;ensemble des liens jusqu&rsquo;aux vues du schéma <code>ctg_ipp.sch_gold_v</code>
<a href=/blog/web/20230512_databricks_unity_catalog_datalineage_22.png><img src=/blog/web/20230512_databricks_unity_catalog_datalineage_22.png alt=schema_22></a></p><p>Affichage de la liste des données sources utilisées pour l&rsquo;alimentation de la table <code>ctg_ipp.sch_bronze.fct_transactions_raw</code> :
<a href=/blog/web/20230512_databricks_unity_catalog_datalineage_23.png><img src=/blog/web/20230512_databricks_unity_catalog_datalineage_23.png alt=schema_23></a></p><p>Affichage de la liste des objets dont l&rsquo;une des sources de données est la table <code>ctg_ipp.sch_bronze.fct_transactions_raw</code> :
<a href=/blog/web/20230512_databricks_unity_catalog_datalineage_24.png><img src=/blog/web/20230512_databricks_unity_catalog_datalineage_24.png alt=schema_24></a></p><h2 id=export-des-données-de-data-linage-avec-databricks-rest-api>Export des données de Data Linage avec Databricks REST API</h2><p>Pré-requis :</p><ul><li>Avoir l&rsquo;outil <code>Curl</code> installé</li><li>Avoir l&rsquo;outil <code>jq</code> installé</li></ul><p>Préparation des accès à l&rsquo;API REST et des variables d&rsquo;environnements :</p><ol><li>Création d&rsquo;un fichier <code>.netrc</code> permettant de gérer les accès à l&rsquo;API REST :</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4># Create the folder where the .netrc file will be stored</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>mkdir ~/.databricks
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#6272a4># Create the .netrc file</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;machine &lt;url workspace databricks without https://&gt;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#f1fa8c>login token
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span><span style=color:#f1fa8c>password &lt;token user databricks&gt;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span><span style=color:#f1fa8c>&#34;</span> &gt; ~/.databricks/.netrc
</span></span></code></pre></div><ol start=2><li>Création des variables d&rsquo;environnements et des alias :</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4># Create an alias to use the tool curl with .netrc file</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#8be9fd;font-style:italic>alias</span> dbx-api<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#39;curl --netrc-file ~/.databricks/.netrc&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#6272a4># Create an environment variable with Databricks API Url</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;&lt;url workspace databricks with https://&gt;&#34;</span>
</span></span></code></pre></div><p>Récupération des informations au niveau de l&rsquo;objet <code>ctg_ipp.sch_silver.fct_transactions</code> :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4># 1. Get the list of upstreams elements from an object</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>dbx-api -X GET -H <span style=color:#f1fa8c>&#39;Content-Type: application/json&#39;</span> <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.0/lineage-tracking/table-lineage -d <span style=color:#f1fa8c>&#39;{&#34;table_name&#34;: &#34;ctg_ipp.sch_silver.fct_transactions&#34;, &#34;include_entity_lineage&#34;: true}}&#39;</span> | jq <span style=color:#f1fa8c>&#39;.upstreams[]&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#6272a4># 2. Get the list of downstreams elements from an object</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>dbx-api -X GET -H <span style=color:#f1fa8c>&#39;Content-Type: application/json&#39;</span> <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.0/lineage-tracking/table-lineage -d <span style=color:#f1fa8c>&#39;{&#34;table_name&#34;: &#34;ctg_ipp.sch_silver.fct_transactions&#34;, &#34;include_entity_lineage&#34;: true}}&#39;</span> | jq <span style=color:#f1fa8c>&#39;.downstreams[]&#39;</span>
</span></span></code></pre></div><p>Résultat au format JSON de la liste des éléments utilisés pour l&rsquo;alimentation de l&rsquo;objet <code>ctg_ipp.sch_silver.fct_transactions</code> :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>  <span style=color:#ff79c6>&#34;tableInfo&#34;</span>: {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#ff79c6>&#34;name&#34;</span>: <span style=color:#f1fa8c>&#34;fct_transactions_raw&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#ff79c6>&#34;catalog_name&#34;</span>: <span style=color:#f1fa8c>&#34;ctg_ipp&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#ff79c6>&#34;schema_name&#34;</span>: <span style=color:#f1fa8c>&#34;sch_bronze&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#ff79c6>&#34;table_type&#34;</span>: <span style=color:#f1fa8c>&#34;TABLE&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>  },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>  <span style=color:#ff79c6>&#34;queryInfos&#34;</span>: [
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>      <span style=color:#ff79c6>&#34;workspace_id&#34;</span>: <span style=color:#bd93f9>1198890856567221</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>      <span style=color:#ff79c6>&#34;query_id&#34;</span>: <span style=color:#f1fa8c>&#34;40af215d-e21d-4933-b207-c478b78a38d6&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>  ]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>}
</span></span></code></pre></div><p>Résultat au format JSON de la liste des éléments utilisant l&rsquo;objet <code>ctg_ipp.sch_silver.fct_transactions</code> :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>  <span style=color:#ff79c6>&#34;tableInfo&#34;</span>: {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#ff79c6>&#34;name&#34;</span>: <span style=color:#f1fa8c>&#34;fct_transactions_detail&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#ff79c6>&#34;catalog_name&#34;</span>: <span style=color:#f1fa8c>&#34;ctg_ipp&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#ff79c6>&#34;schema_name&#34;</span>: <span style=color:#f1fa8c>&#34;sch_gold_v&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#ff79c6>&#34;table_type&#34;</span>: <span style=color:#f1fa8c>&#34;PERSISTED_VIEW&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>  },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>  <span style=color:#ff79c6>&#34;queryInfos&#34;</span>: [
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>      <span style=color:#ff79c6>&#34;workspace_id&#34;</span>: <span style=color:#bd93f9>1198890856567221</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>      <span style=color:#ff79c6>&#34;query_id&#34;</span>: <span style=color:#f1fa8c>&#34;40af215d-e21d-4933-b207-c478b78a38d6&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>      <span style=color:#ff79c6>&#34;workspace_id&#34;</span>: <span style=color:#bd93f9>1198890856567221</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>      <span style=color:#ff79c6>&#34;query_id&#34;</span>: <span style=color:#f1fa8c>&#34;bf2570b5-bfd8-444d-b2a7-d896192f063f&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>  ]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>  <span style=color:#ff79c6>&#34;tableInfo&#34;</span>: {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>    <span style=color:#ff79c6>&#34;name&#34;</span>: <span style=color:#f1fa8c>&#34;fct_transactions_agg_day&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>    <span style=color:#ff79c6>&#34;catalog_name&#34;</span>: <span style=color:#f1fa8c>&#34;ctg_ipp&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>    <span style=color:#ff79c6>&#34;schema_name&#34;</span>: <span style=color:#f1fa8c>&#34;sch_gold&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>    <span style=color:#ff79c6>&#34;table_type&#34;</span>: <span style=color:#f1fa8c>&#34;TABLE&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>  },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>  <span style=color:#ff79c6>&#34;queryInfos&#34;</span>: [
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>      <span style=color:#ff79c6>&#34;workspace_id&#34;</span>: <span style=color:#bd93f9>1198890856567221</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>      <span style=color:#ff79c6>&#34;query_id&#34;</span>: <span style=color:#f1fa8c>&#34;40af215d-e21d-4933-b207-c478b78a38d6&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>    },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>      <span style=color:#ff79c6>&#34;workspace_id&#34;</span>: <span style=color:#bd93f9>1198890856567221</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>      <span style=color:#ff79c6>&#34;query_id&#34;</span>: <span style=color:#f1fa8c>&#34;bf2570b5-bfd8-444d-b2a7-d896192f063f&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>  ]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>}
</span></span></code></pre></div><p>Récupération des informations au niveau de la colonne <code>quantity</code> de l&rsquo;objet <code>ctg_ipp.sch_silver.fct_transactions</code> :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4># 1. Get the list of upstreams columns from a column</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>dbx-api -X GET -H <span style=color:#f1fa8c>&#39;Content-Type: application/json&#39;</span> <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.0/lineage-tracking/column-lineage -d <span style=color:#f1fa8c>&#39;{&#34;table_name&#34;: &#34;ctg_ipp.sch_silver.fct_transactions&#34;, &#34;column_name&#34;: &#34;quantity&#34;}}&#39;</span> | jq <span style=color:#f1fa8c>&#39;.upstream_cols[]&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#6272a4># 2. Get the list of downstreams columns from a column</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>dbx-api -X GET -H <span style=color:#f1fa8c>&#39;Content-Type: application/json&#39;</span> <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.0/lineage-tracking/column-lineage -d <span style=color:#f1fa8c>&#39;{&#34;table_name&#34;: &#34;ctg_ipp.sch_silver.fct_transactions&#34;, &#34;column_name&#34;: &#34;quantity&#34;}}&#39;</span> | jq <span style=color:#f1fa8c>&#39;.downstream_cols[]&#39;</span>
</span></span></code></pre></div><p>Résultat au format JSON de la liste des colonnes utilisées pour l&rsquo;alimentation de la colonne <code>quantity</code> de l&rsquo;objet <code>ctg_ipp.sch_silver.fct_transactions</code> :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>  <span style=color:#ff79c6>&#34;name&#34;</span>: <span style=color:#f1fa8c>&#34;quantity&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>  <span style=color:#ff79c6>&#34;catalog_name&#34;</span>: <span style=color:#f1fa8c>&#34;ctg_ipp&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>  <span style=color:#ff79c6>&#34;schema_name&#34;</span>: <span style=color:#f1fa8c>&#34;sch_bronze&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>  <span style=color:#ff79c6>&#34;table_name&#34;</span>: <span style=color:#f1fa8c>&#34;fct_transactions_raw&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>  <span style=color:#ff79c6>&#34;table_type&#34;</span>: <span style=color:#f1fa8c>&#34;TABLE&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>  <span style=color:#ff79c6>&#34;path&#34;</span>: <span style=color:#f1fa8c>&#34;s3://s3-dbx-metastore-uc/metastore-sandbox/13a746fa-c056-4b32-b6db-9d31c0d1eecf/tables/66cf0444-e436-4936-9106-1f930a884f23&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>}
</span></span></code></pre></div><p>Résultat au format JSON de la liste des colonnes utilisant la colonne <code>quantity</code> de l&rsquo;objet <code>ctg_ipp.sch_silver.fct_transactions</code> :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>  <span style=color:#ff79c6>&#34;name&#34;</span>: <span style=color:#f1fa8c>&#34;quantity&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>  <span style=color:#ff79c6>&#34;catalog_name&#34;</span>: <span style=color:#f1fa8c>&#34;ctg_ipp&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>  <span style=color:#ff79c6>&#34;schema_name&#34;</span>: <span style=color:#f1fa8c>&#34;sch_gold&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>  <span style=color:#ff79c6>&#34;table_name&#34;</span>: <span style=color:#f1fa8c>&#34;fct_transactions_agg_day&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>  <span style=color:#ff79c6>&#34;table_type&#34;</span>: <span style=color:#f1fa8c>&#34;TABLE&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>  <span style=color:#ff79c6>&#34;path&#34;</span>: <span style=color:#f1fa8c>&#34;s3://s3-dbx-metastore-uc/metastore-sandbox/13a746fa-c056-4b32-b6db-9d31c0d1eecf/tables/9c724ab7-e48b-40fb-8105-a8bc292b591c&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>}
</span></span></code></pre></div><h1 id=suppression-des-éléments>Suppression des éléments</h1><p>Vous trouverez, ci-dessous, l&rsquo;ensemble des instructions nécessaires pour nettoyer l&rsquo;environnement.</p><p>Suppression des éléments de Unity Catalog en utilisant les instructions SQL :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>-- Delete the Catalog with CASCADE option (to delete all objects)
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>DROP</span> <span style=color:#ff79c6>CATALOG</span> <span style=color:#ff79c6>IF</span> <span style=color:#ff79c6>EXISTS</span> ctg_ipp <span style=color:#ff79c6>CASCADE</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#ff79c6>DROP</span> <span style=color:#ff79c6>CATALOG</span> <span style=color:#ff79c6>IF</span> <span style=color:#ff79c6>EXISTS</span> ctg_ext <span style=color:#ff79c6>CASCADE</span>;
</span></span></code></pre></div><p>Suppression des données utilisées sur la ressource AWS S3 :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4># Delete all files stored in the AWS S3 resource</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>aws s3 rm <span style=color:#f1fa8c>&#34;s3://s3-demo-data-uc/demo/&#34;</span> --recursive 
</span></span></code></pre></div><h1 id=conclusion>Conclusion</h1><p>L&rsquo;outil Data Explorer permet de faciliter l&rsquo;exploration des données au sein du Metastore de la solution Unity Catalog et de gérer les droits d&rsquo;accès sur les objets sans connaître les commandes SQL.</p><p>Les informations du Data Lineage capturées par la solution Unity Catalog permettent d&rsquo;avoir un certain nombre d&rsquo;informations sur le cycle de vie des données ainsi que sur la liste des éléments utilisant un objet spécifique.
Cela permet d&rsquo;avoir facilement une liste des éléments (notebooks, workflows, pipelines, requêtes,&mldr;) utilisant l&rsquo;objet et par conséquent pouvant être impactés en cas de modification de l&rsquo;objet.
Cela permet aussi de permettre la visualisation et la navigation en se basant sur les informations de Data Lineage (liens entre les objets jusqu&rsquo;au niveau des colonnes).</p><p>Point d&rsquo;attention : La contrainte des 30 derniers jours (glissant) pour la capture des informations peut être très limitante dans le cadre d&rsquo;une application ayant des traitements avec une fréquence supérieur eou égale au mois.</p></div></article></div></div><footer><div class="container-fluid prag-bg-primary prag-foot">Généré avec <a href=https://gohugo.io/>Hugo</a>
&nbsp; - &nbsp;
<a href=https://en.wikipedia.org/wiki/WTFPL>WTFPL license</a> © 2018–2023</div></footer></body></html>