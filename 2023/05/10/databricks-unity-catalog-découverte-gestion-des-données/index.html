<!doctype html><html lang=fr><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta http-equiv=x-ua-compatible content="IE=edge"><meta charset=utf-8><meta name=robots content="noindex, nofollow, noarchive, nosnipper, noodp, noydir"><meta name=google content="notranslate, noimageindex"><meta name=slurp content="notranslate, noimageindex"><meta name=msnbot content="notranslate, noimageindex"><meta name=bingbot content="notranslate, noimageindex"><meta name=generator content="Hugo 0.111.3"><link rel=stylesheet href=https://www.pragmatias.fr/css/bootstrap.min.css><link rel=stylesheet href=https://www.pragmatias.fr/css/pragmatias.css><script src=https://www.pragmatias.fr/js/jquery-3.6.0.slim.min.js></script>
<script src=https://www.pragmatias.fr/js/popper.min.js></script>
<script src=https://www.pragmatias.fr/js/bootstrap.bundle.min.js></script>
<link rel=alternate type=application/rss+xml href=https://www.pragmatias.fr/feed.xml><title>Databricks : Unity Catalog - Découverte - Gestion des données</title><body><div class="navbar navbar-expand-md prag-bg-primary prag-header" role=navigation><div class="container-fluid justify-content-center"><div class=navbar-brand><a href=https://www.pragmatias.fr/blog/><img src=/images/logo_pragmatias.svg alt=pragmatias></a></div><button class="navbar-toggler justify-content-end prag-navbar" type=button data-toggle=collapse data-target=#navbarSupportedContent1,#navbarSupportedContent2 aria-controls=navbarSupportedContent1 aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent1><ul class="navbar-nav text-center"><li class=nav-item><a class=nav-link href=https://www.pragmatias.fr/blog/>Blog</a></li><li class=nav-item><a class=nav-link href=https://www.pragmatias.fr/tags/>Tags</a></li><li class=nav-item><a class=nav-link href=https://www.pragmatias.fr/archives/>Archives</a></li></ul></div><div class="collapse navbar-collapse justify-content-md-end" id=navbarSupportedContent2><ul class="navbar-nav flex-row justify-content-center"><li class=nav-item><a href=https://www.pragmatias.fr/en/2023/05/10/databricks-unity-catalog-first-step-data-and-rights-management/ class="prag_header_svg mr-1 ml-1"><img src=/images/united-kingdom-flag-round-xs-24.png alt=English></a></li><li class=nav-item><a href=https://www.pragmatias.fr/feed.xml title="Pragmatias Blog" class="prag_header_svg mr-1 ml-1"><svg height="24" style="enable-background:new 0 0 508.52 508.52" viewBox="0 0 508.52 508.52" width="24" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path style="fill-rule:evenodd;clip-rule:evenodd;fill:" d="M254.26.0C113.845.0.0 113.845.0 254.26s113.845 254.26 254.26 254.26 254.26-113.845 254.26-254.26C508.52 113.813 394.675.0 254.26.0zM137.141 412.441c-22.852.0-41.413-18.434-41.413-41.285.0-22.693 18.561-41.349 41.413-41.349 22.915.0 41.444 18.656 41.476 41.349C178.618 393.976 160.088 412.441 137.141 412.441zM241.197 412.791c0-39.029-15.16-75.674-42.62-103.071-27.46-27.524-63.978-42.716-102.785-42.716V207.38c113.177.0 205.315 92.137 205.315 205.41h-59.91zM347.001 412.727c0-138.603-112.669-251.399-251.145-251.399v-59.624c171.435.0 310.96 139.589 310.96 311.023H347.001z"/></svg></a></li><li class=nav-item><a href=mailto:contact@pragmatias.fr title=Mail class="prag_header_svg mr-1 ml-1"><svg height="24" style="enable-background:new 0 0 299.997 299.997" viewBox="0 0 299.997 299.997" width="24" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path style="fill-rule:evenodd;clip-rule:evenodd;fill:" d="M149.996.0C67.157.0.001 67.158.001 149.997c0 82.837 67.156 150 149.995 150s150-67.163 150-150C299.996 67.158 232.835.0 149.996.0zM149.999 52.686l88.763 55.35H61.236l88.763-55.35zm89.869 143.737h-.009c0 8.878-7.195 16.072-16.072 16.072H76.211c-8.878.0-16.072-7.195-16.072-16.072v-84.865c0-.939.096-1.852.252-2.749l84.808 52.883c.104.065.215.109.322.169.112.062.226.122.34.179.599.309 1.216.558 1.847.721.065.018.13.026.195.041.692.163 1.393.265 2.093.265h.005c.005.0.01.0.01.0.7.0 1.401-.099 2.093-.265.065-.016.13-.023.195-.041.63-.163 1.245-.412 1.847-.721.114-.057.228-.117.34-.179.106-.06.218-.104.322-.169l84.808-52.883c.156.897.252 1.808.252 2.749v84.865z"/></svg></a></li><li><a href=https://github.com/pragmatias/ title=github class="prag_header_svg mr-1 ml-1"><svg height="24" style="enable-background:new 0 0 438.549 438.549" viewBox="0 0 438.549 438.549" width="24" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path style="fill-rule:evenodd;clip-rule:evenodd;fill:" d="M409.132 114.573c-19.608-33.596-46.205-60.194-79.798-79.8C295.736 15.166 259.057 5.365 219.271 5.365c-39.781.0-76.472 9.804-110.063 29.408-33.596 19.605-60.192 46.204-79.8 79.8C9.803 148.168.0 184.854.0 224.63c0 47.78 13.94 90.745 41.827 128.906 27.884 38.164 63.906 64.572 108.063 79.227 5.14.954 8.945.283 11.419-1.996 2.475-2.282 3.711-5.14 3.711-8.562.0-.571-.049-5.708-.144-15.417-.098-9.709-.144-18.179-.144-25.406l-6.567 1.136c-4.187.767-9.469 1.092-15.846 1-6.374-.089-12.991-.757-19.842-1.999-6.854-1.231-13.229-4.086-19.13-8.559-5.898-4.473-10.085-10.328-12.56-17.556l-2.855-6.57c-1.903-4.374-4.899-9.233-8.992-14.559-4.093-5.331-8.232-8.945-12.419-10.848l-1.999-1.431c-1.332-.951-2.568-2.098-3.711-3.429-1.142-1.331-1.997-2.663-2.568-3.997-.572-1.335-.098-2.43 1.427-3.289s4.281-1.276 8.28-1.276l5.708.853c3.807.763 8.516 3.042 14.133 6.851 5.614 3.806 10.229 8.754 13.846 14.842 4.38 7.806 9.657 13.754 15.846 17.847 6.184 4.093 12.419 6.136 18.699 6.136s11.704-.476 16.274-1.423c4.565-.952 8.848-2.383 12.847-4.285 1.713-12.758 6.377-22.559 13.988-29.41-10.848-1.14-20.601-2.857-29.264-5.14-8.658-2.286-17.605-5.996-26.835-11.14-9.235-5.137-16.896-11.516-22.985-19.126-6.09-7.614-11.088-17.61-14.987-29.979-3.901-12.374-5.852-26.648-5.852-42.826.0-23.035 7.52-42.637 22.557-58.817-7.044-17.318-6.379-36.732 1.997-58.24 5.52-1.715 13.706-.428 24.554 3.853 10.85 4.283 18.794 7.952 23.84 10.994 5.046 3.041 9.089 5.618 12.135 7.708 17.705-4.947 35.976-7.421 54.818-7.421s37.117 2.474 54.823 7.421l10.849-6.849c7.419-4.57 16.18-8.758 26.262-12.565 10.088-3.805 17.802-4.853 23.134-3.138 8.562 21.509 9.325 40.922 2.279 58.24 15.036 16.18 22.559 35.787 22.559 58.817.0 16.178-1.958 30.497-5.853 42.966-3.9 12.471-8.941 22.457-15.125 29.979-6.191 7.521-13.901 13.85-23.131 18.986-9.232 5.14-18.182 8.85-26.84 11.136-8.662 2.286-18.415 4.004-29.263 5.146 9.894 8.562 14.842 22.077 14.842 40.539v60.237c0 3.422 1.19 6.279 3.572 8.562 2.379 2.279 6.136 2.95 11.276 1.995 44.163-14.653 80.185-41.062 108.068-79.226 27.88-38.161 41.825-81.126 41.825-128.906C438.536 184.851 428.728 148.168 409.132 114.573z"/></svg></a></li></ul></div></div></div><div id=content><div class=container-fluid><article class="blog-post blog-post-with-toc"><header><h2 class=blog-post-title>Databricks : Unity Catalog - Découverte - Gestion des données</h2><div class=blog-post-date><span>Dernière modification : 10 Mai 2023</span></div><div class=blog-post-date>Temps de lecture : 23 minute(s) - 4757 mots</div><div class=blog-post-tags><strong>Tags:</strong>
<a href=https://www.pragmatias.fr/tags/databricks/>Databricks</a>
<a href=https://www.pragmatias.fr/tags/unity-catalog/>Unity Catalog</a></div></header><aside class=prag-toc><h1 class=prag-toc-head>Sommaire</h1><div class=prag-toc-body><nav id=TableOfContents><ol><li><a href=#unity-catalog-et-la-hiérarchie-des-objets>Unity Catalog et la hiérarchie des objets</a></li><li><a href=#préparation-des-éléments>Préparation des éléments</a><ol><li><a href=#synthèse>Synthèse</a></li><li><a href=#mise-en-place>Mise en place</a><ol><li><a href=#mise-en-place-dun-jeu-de-données-sur-la-ressource-aws-s3>Mise en place d&rsquo;un jeu de données sur la ressource AWS S3</a></li><li><a href=#mise-en-place-des-contenants-sur-le-metastore-unity-catalog>Mise en place des contenants sur le Metastore Unity Catalog</a></li></ol></li></ol></li><li><a href=#gestion-des-groupes>Gestion des groupes</a><ol><li><a href=#synthèse-1>Synthèse</a></li><li><a href=#mise-en-pratique>Mise en pratique</a></li></ol></li><li><a href=#gestion-des-droits>Gestion des droits</a><ol><li><a href=#synthèse-2>Synthèse</a></li><li><a href=#mise-en-pratique-1>Mise en pratique</a></li></ol></li><li><a href=#gestion-du-stockage>Gestion du stockage</a><ol><li><a href=#synthèse-3>Synthèse</a></li><li><a href=#mise-en-pratique-2>Mise en pratique</a></li></ol></li><li><a href=#suppression-des-éléments>Suppression des éléments</a></li><li><a href=#conclusion>Conclusion</a></li><li><a href=#ressources>Ressources</a><ol><li><a href=#creation-dun-sql-warehouse>Creation d&rsquo;un SQL Warehouse</a></li></ol></li></ol></nav></div></aside><a id=showTopBtn href=# class=prag-sticky-bot><svg height="24" id="Layer_1" style="enable-background:new 0 0 438.533 438.533" viewBox="0 0 438.533 438.533" width="24" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path style="fill-rule:evenodd;clip-rule:evenodd;fill:" d="M409.133 109.203c-19.608-33.592-46.205-60.189-79.798-79.796C295.736 9.801 259.058.0 219.273.0c-39.781.0-76.47 9.801-110.063 29.407-33.595 19.604-60.192 46.201-79.8 79.796C9.801 142.8.0 179.489.0 219.267c0 39.78 9.804 76.463 29.407 110.062 19.607 33.592 46.204 60.189 79.799 79.798 33.597 19.605 70.283 29.407 110.063 29.407s76.47-9.802 110.065-29.407c33.593-19.602 60.189-46.206 79.795-79.798 19.603-33.596 29.403-70.284 29.403-110.062C438.533 179.485 428.732 142.795 409.133 109.203zM361.449 231.831l-25.981 25.981c-3.613 3.613-7.901 5.42-12.847 5.42-4.948.0-9.229-1.807-12.847-5.42l-53.954-53.961v143.32c0 4.948-1.813 9.232-5.428 12.847-3.613 3.62-7.898 5.427-12.847 5.427h-36.547c-4.948.0-9.231-1.807-12.847-5.427-3.617-3.614-5.426-7.898-5.426-12.847v-143.32l-53.959 53.961c-3.431 3.425-7.708 5.133-12.85 5.133-5.14.0-9.423-1.708-12.85-5.133l-25.981-25.981c-3.422-3.429-5.137-7.714-5.137-12.852.0-5.137 1.709-9.419 5.137-12.847l103.356-103.353 25.981-25.981c3.427-3.425 7.71-5.14 12.847-5.14 5.142.0 9.423 1.715 12.849 5.14l25.98 25.981 103.35 103.353c3.432 3.427 5.14 7.71 5.14 12.847C366.589 224.117 364.881 228.402 361.449 231.831z"/></svg></a><script>$(document).ready(function(){$("#showTopBtn").removeClass("prag-sticky-bot"),$("#showTopBtn").addClass("prag-sticky-hide"),$(function(){$(window).scroll(function(){$(this).scrollTop()>900?($("#showTopBtn").addClass("prag-sticky-bot"),$("#showTopBtn").removeClass("prag-sticky-hide")):($("#showTopBtn").addClass("prag-sticky-hide"),$("#showTopBtn").removeClass("prag-sticky-bot"))})})})</script><div class=blog-post-main><p>Nous allons découvrir la gestion des données par la solution <a href=https://docs.databricks.com/data-governance/unity-catalog/index.html>Unity Catalog</a> et plus précisément la gestion des droits (Groupes et Utilisateurs) et la gestion du stockage (Tables).</p><p>Nous allons utiliser un Account Databricks sur AWS pour réaliser cette démonstration.</p><p><em>Note : Nous allons garder des termes techniques en anglais pour faciliter la compréhension</em></p><h1 id=unity-catalog-et-la-hiérarchie-des-objets>Unity Catalog et la hiérarchie des objets</h1><p>Unity Catalog est la solution de Databricks permettant d&rsquo;avoir une gouvernance unifiée et centralisée pour l&rsquo;ensemble des données gérées par les ressources Databricks ainsi que de sécuriser et faciliter la gestion et le partage des données à l&rsquo;ensemble des acteurs internes et externes d&rsquo;une organisation.</p><p>Vous pourrez avec une vue d&rsquo;ensemble plus complète en parcourant la <a href=https://docs.databricks.com/data-governance/unity-catalog/index.html>documentation officielle</a></p><p>Rappel concernant la hiérarchie des objets :
<a href=/blog/web/20230510_databricks_unity_catalog_schema_01.png><img src=/blog/web/20230510_databricks_unity_catalog_schema_01.png alt=schema_01></a></p><p>Les différents objets sont :</p><ul><li>Storage Credential : Cet objet est associé directement au Metastore et permet de stocker les accès à un cloud provider (par exemple AWS S3) permettant à la solution Unity Catalog de gérer les droits sur les données.</li><li>External Location : Cet objet est associé au Metastore et permet de stocker le chemin vers un cloud provider (par exemple une ressource AWS S3) en combinaison avec un Storage Credential pour gérer les accès aux données</li><li>Metastore : Objet du plus haut niveau pouvant contenir des métadonnées</li><li>Catalog : Objet de 1er niveau permettant d&rsquo;organiser les données par Schema (aussi nommé Base de données)</li><li>Schema : Objet de 2ème et dernier niveau permettant d&rsquo;organiser les données (contient les tables, les vues et les fonctions)</li><li>Table : Objet permettant de définir la structure et le stockage des données.</li><li>View : Objet permettant d&rsquo;encapsuler une requête utilisant un ou plusieurs objets (table ou vue)</li><li>Function : Objet permettant de définir des opérations sur les données</li></ul><p>Lorsque vous souhaitez accéder à un objet (par exemple une table), il sera nécessaire de renseigner le nom du Catalog et le nom du Schema où est défini l&rsquo;objet.
Exemple : <code>select * from catalog.schema.table</code></p><h1 id=préparation-des-éléments>Préparation des éléments</h1><p>Pour cette découverte, nous allons mettre en place un certain nombre d&rsquo;éléments permettant de manipuler les différents concepts.</p><h2 id=synthèse>Synthèse</h2><p>Concernant les ressources Databricks :</p><ul><li>La solution Unity Catalog doit être activée au niveau de l&rsquo;Account Databricks</li><li>Un Metastore Unity Catalog doit être rattaché au Workspace Databricks</li><li>Un SQL Warehouse doit exister dans le Workspace Databricks</li></ul><p>Concernant les groupes et utilisateurs,
Nous allons reproduire les éléments suivants :
<a href=/blog/web/20230510_databricks_unity_catalog_schema_02.png><img src=/blog/web/20230510_databricks_unity_catalog_schema_02.png alt=schema_02></a></p><p>Pré-requis :</p><ul><li>Un utilisateur avec les droits d&rsquo;administration sur l&rsquo;Account Databricks et sur le Workspace Databricks</li><li>Il ne doit pas exister de groupe nommé <code>grp_demo</code> au niveau de l&rsquo;Account Databricks et au niveau du Workspace Databricks</li><li>Il ne doit pas exister d&rsquo;utilisateur nommé <code>john.do.dbx@gmail.com</code> au niveau de l&rsquo;Account Databricks et au niveau du Workspace Databricks</li></ul><p>Synthèse des actions qui seront réalisées :</p><ul><li>Création d&rsquo;un groupe nommé <code>grp_demo</code> au niveau de l&rsquo;Account Databricks.</li><li>Création d&rsquo;un utilisateur nommé <code>john.do.dbx@gmail.com</code> au niveau de l&rsquo;Account Databricks.</li><li>Ajout du groupe <code>grp_demo</code> créé au niveau de l&rsquo;Account Databricks dans le Workspace Databricks</li><li>Ajout des droits sur le Workspace Databricks sur le groupe <code>grp_demo</code></li><li>Ajout des droits nécessaires sur les objets de l&rsquo;Unity Catalog au niveau du Workspace Databricks sur le groupe <code>grp_demo</code></li></ul><p>Concernant les objets d&rsquo;Unity Catalog,
Nous allons reproduire les éléments suivants :
<a href=/blog/web/20230510_databricks_unity_catalog_schema_03.png><img src=/blog/web/20230510_databricks_unity_catalog_schema_03.png alt=schema_03></a></p><p>Pré-requis :</p><ul><li>Existence d&rsquo;un Metastore nommé <code>metastore-sandbox</code> avec le Storage Credential nommé <code>sc-metastore-sandbox</code> permettant de stocker les données par défaut dans la ressource AWS S3 nommé <code>s3-dbx-metastore-uc</code></li><li>Création d&rsquo;une ressource AWS S3 nommée <code>s3-demo-data-uc</code></li><li>Création d&rsquo;un rôle AWS IAM nommé <code>role-databricks-demo-data-uc</code> et d&rsquo;une politique AWS IAM nommée <code>policy-databricks-demo-data-uc</code> permettant au rôle global Databricks de gérer l&rsquo;accès à la ressource AWS S3 <code>s3-demo-data-uc</code></li><li>Création d&rsquo;un Storage Credential nommé <code>sc-demo-data-uc</code> permettant au rôle global Databricks de gérer l&rsquo;accès à la ressource AWS S3 <code>s3-demo-data-uc</code></li></ul><p>Synthèse des actions qui seront réalisées :</p><ul><li>Création d&rsquo;un External Storage pour pouvoir accéder avec Unity Catalog aux données de la ressource AWS S3 nommée <code>s3-demo-data-uc</code></li><li>Création du Catalog <code>ctg_ipp</code> qui contiendra l&rsquo;ensemble des éléments managés (stockés sur la ressource AWS S3 nommée <code>s3-dbx-metastore-uc</code> associée au Metastore <code>metastore-sandbox</code>)</li><li>Création du Catalog <code>ctg_ext</code> qui contiendra l&rsquo;ensemble des éléments externes (stockés sur la ressource AWS S3 nommée <code>s3-demo-data-uc</code>)</li><li>Création du Schema <code>ctg_ipp.sch_bronze</code> qui permettra de créer les objets managés par Unity Catalog pour accéder aux données stockées sur la ressource AWS S3 nommée <code>s3-dbx-metastore-uc</code> (au format Delta uniquement)</li><li>Création du Schema <code>ctg_ext.sch_ref</code> qui permettra de créer les objets pour accéder aux données stockées sur la ressource AWS S3 nommée <code>s3-demo-data-uc</code> (sous forme de fichier CSV ou de fichier Delta)</li></ul><h2 id=mise-en-place>Mise en place</h2><h3 id=mise-en-place-dun-jeu-de-données-sur-la-ressource-aws-s3>Mise en place d&rsquo;un jeu de données sur la ressource AWS S3</h3><p>Contenu du fichier <code>ref_products.csv</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>id,lib,brand,os,last_maj
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>1,Pixel 7 Pro,Google,Android,2023-01-01 09:00:00
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>2,Iphone 14,Apple,IOS,2023-01-01 09:00:00
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>3,Galaxy S23,Samsung,Android,2023-01-01 09:00:00
</span></span></code></pre></div><p>Contenu du fichier <code>fct_transactions.csv</code> :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>id_trx,ts_trx,id_products,id_shop,id_client,quantity
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>1,2023-04-01 09:00:00,1,2,1,1
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>2,2023-04-01 11:00:00,1,1,1,3
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>3,2023-04-03 14:00:00,1,2,1,1
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>4,2023-04-05 08:00:00,3,1,2,9
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>5,2023-04-06 10:00:00,1,2,1,3
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>6,2023-04-06 12:00:00,2,2,1,1
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>7,2023-04-10 18:30:00,2,1,2,11
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9</span><span>8,2023-04-10 18:30:00,3,1,2,2
</span></span></code></pre></div><p>Réalisation de la copie des données vers le répertoire <code>demo</code>de la ressource AWS S3 nommée <code>s3-demo-data-uc</code> avec l&rsquo;outil AWS CLI:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>aws s3 cp ref_products.csv s3://s3-demo-data-uc/demo/ref_products.csv 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>aws s3 cp fct_transactions.csv s3://s3-demo-data-uc/demo/fct_transactions.csv 
</span></span></code></pre></div><h3 id=mise-en-place-des-contenants-sur-le-metastore-unity-catalog>Mise en place des contenants sur le Metastore Unity Catalog</h3><p>Les étapes sont les suivantes :
Note : Utilisation d&rsquo;un utilisateur avec les droits d&rsquo;administration sur le Metastore</p><ol><li>Création d&rsquo;un External Location pour permettre aux utilisateurs de stocker des données dans la ressource AWS S3 nommée <code>s3-demo-data-uc</code></li><li>Création des Catalog <code>ctg_ipp</code> et <code>ctg_ext</code></li><li>Création des Schema <code>ctg_ipp.sch_bronze</code> et <code>ctg_ext.sch_ref</code></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>-- 1. Create external location to access data from s3-demo-data-uc resource
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>EXTERNAL</span> <span style=color:#ff79c6>LOCATION</span> <span style=color:#ff79c6>IF</span> <span style=color:#ff79c6>NOT</span> <span style=color:#ff79c6>EXISTS</span> el_demo_data_uc
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>URL <span style=color:#f1fa8c>&#39;s3://s3-demo-data-uc&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#ff79c6>WITH</span> (<span style=color:#ff79c6>STORAGE</span> CREDENTIAL <span style=color:#ff79c6>`</span>sc<span style=color:#ff79c6>-</span>demo<span style=color:#ff79c6>-</span><span style=color:#ff79c6>data</span><span style=color:#ff79c6>-</span>uc<span style=color:#ff79c6>`</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#ff79c6>COMMENT</span> <span style=color:#f1fa8c>&#39;External Location to access demo data&#39;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#6272a4>-- 2. Create Catalog ctg_ipp
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>CATALOG</span> <span style=color:#ff79c6>IF</span> <span style=color:#ff79c6>NOT</span> <span style=color:#ff79c6>EXISTS</span> ctg_ipp
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#ff79c6>COMMENT</span> <span style=color:#f1fa8c>&#39;Catalog for managed data&#39;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#6272a4>-- 2. Create Catalog ctg_ext (for external data)
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>CATALOG</span> <span style=color:#ff79c6>IF</span> <span style=color:#ff79c6>NOT</span> <span style=color:#ff79c6>EXISTS</span> ctg_ext
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    <span style=color:#ff79c6>COMMENT</span> <span style=color:#f1fa8c>&#39;Catalog for external data&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#6272a4>-- 3. Create Schema sch_bronze in the Catalog ctg_ipp to store managed data
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>SCHEMA</span> <span style=color:#ff79c6>IF</span> <span style=color:#ff79c6>NOT</span> <span style=color:#ff79c6>EXISTS</span> ctg_ipp.sch_bronze
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    <span style=color:#ff79c6>COMMENT</span> <span style=color:#f1fa8c>&#39;Schema for Bronze Data&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#6272a4>-- 3. Create Schema sch_ref in the Catalog ctg_ext to store external data
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>SCHEMA</span> <span style=color:#ff79c6>IF</span> <span style=color:#ff79c6>NOT</span> <span style=color:#ff79c6>EXISTS</span> ctg_ext.sch_ref
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>    <span style=color:#ff79c6>COMMENT</span> <span style=color:#f1fa8c>&#39;Schema for External Data&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>;
</span></span></code></pre></div><h1 id=gestion-des-groupes>Gestion des groupes</h1><h2 id=synthèse-1>Synthèse</h2><p>Un groupe est un objet permettant de gérer les droits d&rsquo;accès et de regrouper des utilisateurs ou d&rsquo;autres groupes.
Cela permet de mettre en place une organisation des accès par rapport à des équipes ou des profils plutôt qu&rsquo;en passant directement par des utilisateurs.</p><p>Il existe deux types de groupes :</p><ul><li>Un groupe au niveau Account Databricks permet de gérer les accès aux données en utilisant la solution Unity Catalog (centralisation)</li><li>Un groupe local au niveau Workspace Databricks permet de gérer les accès au niveau du workspace uniquement et n&rsquo;est pas compatible avec Unity Catalog (cela est principalement utilisé avec Hive Metastore et pour les droits liés au Workspace Databricks)</li></ul><p>Quota : On peut avoir jusqu&rsquo;à une combinaison de 10 000 utilisateurs et 5 000 groupes dans un Account Databricks</p><p>Lorsqu&rsquo;un Metastore Unity Catalog est rattaché à un Workspace Databricks, il n&rsquo;est plus possible de créer un groupe local directement à partir de l&rsquo;interface du Workspace Databricks.</p><p>Dans le cadre de la gestion des accès avec Unity Catalog, les recommandations sont les suivantes :</p><ul><li>Gérer l&rsquo;ensemble des droits en s&rsquo;appuyant sur les groupes définis au niveau de l&rsquo;Account Databricks</li><li>La création d&rsquo;un groupe doit se faire au niveau de l&rsquo;Account Databricks pour être ajouté au niveau d&rsquo;un Workspace Databricks</li><li>L&rsquo;ajout et la suppression d&rsquo;un membre (utilisateur ou groupe) d&rsquo;un groupe doit se faire au niveau de l&rsquo;Account Databricks</li><li>La création d&rsquo;un utilisateur peut se faire au niveau du Workspace Databricks. Il sera automatiquement ajouté au niveau de l&rsquo;Account Databricks (Attention : il est fortement recommandé de gérer les utilisateurs et groupes en se basant sur un IdP (Identity provider) (Azure Active Directory, AWS IAM, &mldr;) pour avoir une gestion centralisée et sécurisée des comptes Databricks)</li><li>La gestion des accès aux données se fait au niveau du Workspace Databricks (par l&rsquo;administrateur du Workspace Databricks ou le propriétaire des objets)</li><li>Il est recommandé de toujours appliquer des droits au niveau des groupes et non pas des utilisateurs pour faciliter la gestion des droits dans le temps<ul><li>Vous pouvez gérer des groupes sur plusieurs niveaux pour organiser les droits et les utilisateurs</li></ul></li><li>Lors de l&rsquo;import (création) d&rsquo;un groupe au niveau du Workspace Databricks, l&rsquo;administrateur du Workspace doit définir les droits (Entitlements) du groupe sur le Workspace Databricks</li><li>Si vous voulez donner les même droits que l&rsquo;utilisateur <code>john.do.dbx@gmail.com</code> à un autre utilisateur, il suffira d&rsquo;ajouter cet autre utilisateur dans les même groupes que l&rsquo;utilisateur <code>john.do.dbx@gmail.com</code></li></ul><p>Concernant la suppression d&rsquo;un groupe :</p><ul><li>Si vous supprimez le groupe du Workspace Databricks, il existera toujours au niveau de l&rsquo;Account Databricks</li><li>Si vous supprimez le groupe de l&rsquo;Account Databricks, il sera automatiquement supprimé de l&rsquo;ensemble des Workspace Databricks</li></ul><h2 id=mise-en-pratique>Mise en pratique</h2><p>Pré-requis :</p><ul><li>Avoir un compte ayant le rôle/droit d&rsquo;administration de l&rsquo;Account Databricks</li><li>Avoir un compte ayant le rôle/droit d&rsquo;administration du Workspace Databricks</li><li>Avoir un SQL Warehouse existant sur le Workspace Databricks (pour que les utilisateurs puissent exécuter des requêtes SQL sur Databricks)</li></ul><p>Pour la création du groupe et de l&rsquo;utilisateur, il faut réaler les actions suivantes au niveau de l&rsquo;Account Databricks :</p><ol><li>Création d&rsquo;un utilisateur nommé <code>john.do.dbx@gmail.com</code></li><li>Création d&rsquo;un groupe nommé <code>grp_demo</code> et ajout de l&rsquo;utilisateur <code>john.do.dbx@gmail.com</code> dans le groupe <code>grp_demo</code></li></ol><p>Pour que l&rsquo;utilisateur puisse accéder aux ressources du Workspace Databricks, il faut réaliser les actions suivantes au niveau du Workspace Databricks :
3. Import du groupe <code>grp_demo</code> dans le Workspace Databricks
4. Ajout des droits au niveau du Workspace Databricks sur le groupe</p><p>Détail des actions à réaliser :</p><ol><li>Etape n°1<ol><li>Allez dans <code>Account Administration page > User Management > Users</code></li><li>Cliquez sur <code>Add User</code></li><li>Renseignez les informations <code>Email</code>, <code>First name</code> et <code>Last name</code> et cliquez sur <code>Send invite</code></li></ol></li><li>Etape n°2<ol><li>Allez dans <code>Account Administration page > User Management > Groups</code></li><li>Cliquez sur <code>Add Group</code></li><li>Renseignez les informations <code>Group name</code> et cliquez sur <code>save</code></li><li>Cliquez sur <code>Add members</code> pour ajouter l&rsquo;utilisateur <code>john.do.dbx@gmail.com</code></li></ol></li><li>Etape n°3<ol><li>Allez dans <code>Workspace page > username > Admin Settings > Groups</code></li><li>Cliquez sur <code>Add Group</code></li><li>Choisissez le groupe (parmi la liste des groupes qui existent au niveau de l&rsquo;Account Databricks) et cliquez sur <code>Add</code></li></ol></li><li>Etape n°4 :<ol><li>Allez sur <code>Workspace page > username > Admin Settings > Groups</code></li><li>Cliquez sur le groupe</li><li>Cliquez sur <code>Entitlements</code><ol><li>Cochez l&rsquo;option <code>Workspace access</code> pour donner l&rsquo;accès au Workspace Databricks à l&rsquo;ensemble des utilisateurs du groupe</li><li>Cochez l&rsquo;option <code>Databricks SQL access</code> pour donner l&rsquo;accès aux ressources SQL du Workspace Databricks à l&rsquo;ensemble des utilisateurs du groupe</li></ol></li></ol></li></ol><p>Si vous voulez donner l&rsquo;accès à un SQL Warehouse à un groupe, il faut suivre les étapes suivantes :</p><ol><li>Allez sur <code>Workspace page > SQL > SQL Warehouses</code></li><li>Cliquez sur le buttons sous forme de 3 points and choisissez l&rsquo;option <code>Permissions</code></li><li>Ajoutez le groupe et choisissez l&rsquo;option <code>Can use</code></li></ol><p>Note : Il est aussi possible d&rsquo;ajouter le groupe au niveau du Workspace Databricks avec l&rsquo;outil Databricks CLI</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4># Add a group in the Workspace Databricks (the group must exist at the Account Databricks level)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>databricks groups create --group-name <span style=color:#f1fa8c>&#34;grp_demo&#34;</span>
</span></span></code></pre></div><h1 id=gestion-des-droits>Gestion des droits</h1><h2 id=synthèse-2>Synthèse</h2><p>La gestion des droits se fait en s&rsquo;appuyant sur la syntaxe SQL ANSI et plus spécifiquement avec les instructions <a href=https://docs.databricks.com/sql/language-manual/security-grant.html>GRANT</a> et <a href=https://docs.databricks.com/sql/language-manual/security-revoke.html>REVOKE</a>.</p><p>Vous trouverez une liste exhaustive des droits pouvant être gérer avec Unity Catalog sur la <a href=https://docs.databricks.com/sql/language-manual/sql-ref-privileges.html#privilege-types>documentation officielle</a></p><p>Pour donner un droit à un groupe ou un utilisateur, la syntaxe est la suivante :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>GRANT</span> <span style=color:#ff79c6>&lt;</span>Rights <span style=color:#ff79c6>with</span> comma separator<span style=color:#ff79c6>&gt;</span> <span style=color:#ff79c6>ON</span> <span style=color:#ff79c6>&lt;</span><span style=color:#ff79c6>Type</span> <span style=color:#ff79c6>Object</span><span style=color:#ff79c6>&gt;</span> <span style=color:#ff79c6>&lt;</span>Name <span style=color:#ff79c6>Object</span><span style=color:#ff79c6>&gt;</span> <span style=color:#ff79c6>TO</span> <span style=color:#ff79c6>&lt;</span><span style=color:#ff79c6>Group</span> <span style=color:#ff79c6>or</span> <span style=color:#ff79c6>User</span><span style=color:#ff79c6>&gt;</span>;
</span></span></code></pre></div><p>Pour supprimer un droit à un groupe ou un utilisateur, la syntaxe est la suivante :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>REVOKE</span> <span style=color:#ff79c6>&lt;</span>Rights <span style=color:#ff79c6>with</span> comma separator<span style=color:#ff79c6>&gt;</span> <span style=color:#ff79c6>ON</span> <span style=color:#ff79c6>&lt;</span><span style=color:#ff79c6>Type</span> <span style=color:#ff79c6>Object</span><span style=color:#ff79c6>&gt;</span> <span style=color:#ff79c6>&lt;</span>Name <span style=color:#ff79c6>Object</span><span style=color:#ff79c6>&gt;</span> <span style=color:#ff79c6>FROM</span> <span style=color:#ff79c6>&lt;</span><span style=color:#ff79c6>Group</span> <span style=color:#ff79c6>or</span> <span style=color:#ff79c6>User</span><span style=color:#ff79c6>&gt;</span>;
</span></span></code></pre></div><p>Point d&rsquo;attention : Il est indispensable d&rsquo;avoir le droit de <code>USE/USAGE</code> sur le Catalog et le Schema pour accéder à une table même si on a déjà le droit de <code>SELECT</code> dessus sinon l&rsquo;utilisateur (ou le groupe) n&rsquo;aura pas la possible de voir le contenu du Catalog et du Schema par défaut.</p><p>Par exemple : Si le propriétaire de la table <code>ctg_ext.sch_ref.tbl_demo</code> donne le droit de <code>SELECT</code>au groupe <code>grp_demo</code> alors les utilisateurs du groupe <code>grp_demo</code>ne pourront pas lire les données de la table <code>tbl_demo</code> tant qu&rsquo;ils n&rsquo;auront pas le droit <code>USE</code> sur le Catalog <code>ctg_ext</code> et sur le Schema <code>sch_ref</code>.</p><p>Il est possible de gérer les droits au niveau de chaque objet (table/vue) mais il est recommandé d&rsquo;organiser les données et les droits au niveau des objets Schema lorsque l&rsquo;organisation le permet pour faciliter la gestion des droits d&rsquo;accès aux données aux différentes équipes et profils de l&rsquo;organisation.</p><h2 id=mise-en-pratique-1>Mise en pratique</h2><p>Nous avons déjà créé les Catalog et les Schema avec un compte d&rsquo;administration et nous voulons donner la possibilité à l&rsquo;utilisateur <code>john.do.dbx@gmail.com</code> de gérer les objets dans les différents Catalog et Schema.</p><p>Par défaut, le groupe <code>grp_demo</code> n&rsquo;a aucun droit sur les Catalog du Metastore (et ne peut pas les visualiser).</p><p>Nous allons faire les actions nécessaires pour nous assurer que les droits seront suffisants pour pouvoir faire les manipulations suivantes :</p><ol><li>Création des nouveaux schémas dans le Catalog <code>ctg_ipp</code></li><li>Création des tables dans l&rsquo;ensemble des Schema des Catalog <code>ctg_ipp</code> et <code>ctg_ext</code></li></ol><p>Les actions à réaliser sont les suivantes :</p><ol><li>Donner les droits de visualisation sur les Catalog</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>-- Right to view the Catalog ctg_ipp
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>GRANT</span> <span style=color:#ff79c6>USAGE</span> <span style=color:#ff79c6>ON</span> <span style=color:#ff79c6>CATALOG</span> ctg_ipp <span style=color:#ff79c6>TO</span> grp_demo;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#6272a4>-- Right to view the Catalog ctg_ext
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>GRANT</span> <span style=color:#ff79c6>USAGE</span> <span style=color:#ff79c6>ON</span> <span style=color:#ff79c6>CATALOG</span> ctg_ext <span style=color:#ff79c6>TO</span> grp_demo;
</span></span></code></pre></div><ol start=2><li>Donner les droits de création de schéma au niveau du Catalog <code>ctg_ipp</code></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>-- Right to create new Schema in Catalog ctg_ipp
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>GRANT</span> USE <span style=color:#ff79c6>SCHEMA</span>, <span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>SCHEMA</span> <span style=color:#ff79c6>ON</span> <span style=color:#ff79c6>CATALOG</span> ctg_ipp <span style=color:#ff79c6>TO</span> grp_demo;
</span></span></code></pre></div><ol start=3><li>Donner les droits d&rsquo;accès et de création des objets dans le Schema <code>ctg_ext.sch_ref</code> ainsi que les droits d&rsquo;accès pour créer des tables externes (External Table) en se basant sur le stockage défini dans l&rsquo;objet External Location nommé <code>el_demo_data_uc</code> :</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>-- Rights to create objects in the Schema ctg_ext.sch_ref
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>GRANT</span> USE <span style=color:#ff79c6>SCHEMA</span>, <span style=color:#ff79c6>SELECT</span> , <span style=color:#ff79c6>MODIFY</span>, <span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>TABLE</span> <span style=color:#ff79c6>ON</span> <span style=color:#ff79c6>SCHEMA</span> ctg_ext.sch_ref <span style=color:#ff79c6>TO</span> grp_demo;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#6272a4>-- Right to create External tables with the External Location
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>GRANT</span> <span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>EXTERNAL</span> <span style=color:#ff79c6>TABLE</span> <span style=color:#ff79c6>ON</span> <span style=color:#ff79c6>EXTERNAL</span> <span style=color:#ff79c6>LOCATION</span> <span style=color:#ff79c6>`</span>el_demo_data_uc<span style=color:#ff79c6>`</span> <span style=color:#ff79c6>TO</span> grp_demo;
</span></span></code></pre></div><ol start=4><li>Donner tous les droits sur le Schema <code>ctg_ipp.sch_bronze</code></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>-- All privileges on the Schema ctg_ipp.sch_bronze
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>GRANT</span> <span style=color:#ff79c6>ALL</span> <span style=color:#ff79c6>PRIVILEGES</span> <span style=color:#ff79c6>ON</span> <span style=color:#ff79c6>SCHEMA</span> ctg_ipp.sch_bronze <span style=color:#ff79c6>TO</span> grp_demo;
</span></span></code></pre></div><p>Si on souhaite qu&rsquo;un utilisateur puisse créer lui même l&rsquo;objet <code>External Location</code> pour mettre en place les accès vers une nouvelle ressource AWS S3, il faut lui donner les droits suivants :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>-- Right on the Metastore for the group
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>GRANT</span> <span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>EXTERNAL</span> <span style=color:#ff79c6>LOCATION</span> <span style=color:#ff79c6>ON</span> METASTORE <span style=color:#ff79c6>TO</span> grp_demo;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#6272a4>-- Right on the Storage Credential to the group
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>GRANT</span> <span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>EXTERNAL</span> <span style=color:#ff79c6>LOCATION</span> <span style=color:#ff79c6>ON</span> <span style=color:#ff79c6>STORAGE</span> CREDENTIAL <span style=color:#ff79c6>`</span>sc<span style=color:#ff79c6>-</span>demo<span style=color:#ff79c6>-</span><span style=color:#ff79c6>data</span><span style=color:#ff79c6>-</span>uc<span style=color:#ff79c6>`</span> <span style=color:#ff79c6>TO</span> grp_demo;
</span></span></code></pre></div><p>Exemple de requête permettant de récupérer l&rsquo;ensemble des droits données au groupe <code>grp_demo</code> sur les objets des Catalog <code>ctg_ipp</code>et <code>ctg_ext</code> :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>-- How to get all the existing privileges for a group ?
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4>-- Get privileges from Catalog
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>select</span> <span style=color:#f1fa8c>&#39;GRANT &#39;</span><span style=color:#ff79c6>||</span><span style=color:#ff79c6>replace</span>(privilege_type,<span style=color:#f1fa8c>&#39;_&#39;</span>,<span style=color:#f1fa8c>&#39; &#39;</span>)<span style=color:#ff79c6>||</span><span style=color:#f1fa8c>&#39; ON CATALOG &#39;</span><span style=color:#ff79c6>||</span><span style=color:#ff79c6>catalog_name</span><span style=color:#ff79c6>||</span><span style=color:#f1fa8c>&#39; TO &#39;</span><span style=color:#ff79c6>||</span>grantee<span style=color:#ff79c6>||</span><span style=color:#f1fa8c>&#39;;&#39;</span> <span style=color:#ff79c6>as</span> grant_query
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#ff79c6>from</span> <span style=color:#ff79c6>system</span>.INFORMATION_SCHEMA.CATALOG_PRIVILEGES
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#ff79c6>where</span> grantee<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#39;grp_demo&#39;</span> 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#ff79c6>and</span> grantor <span style=color:#ff79c6>&lt;&gt;</span> <span style=color:#f1fa8c>&#39;System user&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#ff79c6>and</span> <span style=color:#ff79c6>catalog_name</span> <span style=color:#ff79c6>in</span> (<span style=color:#f1fa8c>&#39;ctg_ipp&#39;</span>,<span style=color:#f1fa8c>&#39;ctg_ext&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#ff79c6>and</span> inherited_from <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;NONE&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#ff79c6>order</span> <span style=color:#ff79c6>by</span> <span style=color:#ff79c6>catalog_name</span>,privilege_type
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#6272a4>-- Get privileges from Schema
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>select</span> <span style=color:#f1fa8c>&#39;GRANT &#39;</span><span style=color:#ff79c6>||</span><span style=color:#ff79c6>replace</span>(privilege_type,<span style=color:#f1fa8c>&#39;_&#39;</span>,<span style=color:#f1fa8c>&#39; &#39;</span>)<span style=color:#ff79c6>||</span><span style=color:#f1fa8c>&#39; ON SCHEMA &#39;</span><span style=color:#ff79c6>||</span><span style=color:#ff79c6>catalog_name</span><span style=color:#ff79c6>||</span><span style=color:#f1fa8c>&#39;.&#39;</span><span style=color:#ff79c6>||</span><span style=color:#ff79c6>schema_name</span><span style=color:#ff79c6>||</span><span style=color:#f1fa8c>&#39; TO &#39;</span><span style=color:#ff79c6>||</span>grantee<span style=color:#ff79c6>||</span><span style=color:#f1fa8c>&#39;;&#39;</span> <span style=color:#ff79c6>as</span> grant_query
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#ff79c6>from</span> <span style=color:#ff79c6>system</span>.INFORMATION_SCHEMA.SCHEMA_PRIVILEGES
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#ff79c6>where</span> grantee<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#39;grp_demo&#39;</span> 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>  <span style=color:#ff79c6>and</span> grantor <span style=color:#ff79c6>&lt;&gt;</span> <span style=color:#f1fa8c>&#39;System user&#39;</span> 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>  <span style=color:#ff79c6>and</span> <span style=color:#ff79c6>catalog_name</span> <span style=color:#ff79c6>in</span> (<span style=color:#f1fa8c>&#39;ctg_ipp&#39;</span>,<span style=color:#f1fa8c>&#39;ctg_ext&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>  <span style=color:#ff79c6>and</span> inherited_from <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;NONE&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#ff79c6>order</span> <span style=color:#ff79c6>by</span> <span style=color:#ff79c6>catalog_name</span>, <span style=color:#ff79c6>schema_name</span>,privilege_type;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#6272a4>-- Get privileges from Table
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>select</span> <span style=color:#f1fa8c>&#39;GRANT &#39;</span><span style=color:#ff79c6>||</span><span style=color:#ff79c6>replace</span>(privilege_type,<span style=color:#f1fa8c>&#39;_&#39;</span>,<span style=color:#f1fa8c>&#39; &#39;</span>)<span style=color:#ff79c6>||</span><span style=color:#f1fa8c>&#39; ON TABLE &#39;</span><span style=color:#ff79c6>||</span>table_catalog<span style=color:#ff79c6>||</span><span style=color:#f1fa8c>&#39;.&#39;</span><span style=color:#ff79c6>||</span>table_schema<span style=color:#ff79c6>||</span><span style=color:#f1fa8c>&#39;.&#39;</span><span style=color:#ff79c6>||</span><span style=color:#ff79c6>table_name</span><span style=color:#ff79c6>||</span><span style=color:#f1fa8c>&#39; TO &#39;</span><span style=color:#ff79c6>||</span>grantee<span style=color:#ff79c6>||</span><span style=color:#f1fa8c>&#39;;&#39;</span>  <span style=color:#ff79c6>as</span> grant_query
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#ff79c6>from</span> <span style=color:#ff79c6>system</span>.INFORMATION_SCHEMA.TABLE_PRIVILEGES
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span><span style=color:#ff79c6>where</span> grantee <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;grp_demo&#39;</span> 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>  <span style=color:#ff79c6>and</span> grantor <span style=color:#ff79c6>&lt;&gt;</span> <span style=color:#f1fa8c>&#39;System user&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>  <span style=color:#ff79c6>and</span> table_catalog <span style=color:#ff79c6>in</span> (<span style=color:#f1fa8c>&#39;ctg_ipp&#39;</span>,<span style=color:#f1fa8c>&#39;ctg_ext&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>  <span style=color:#ff79c6>and</span> inherited_from <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;NONE&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span><span style=color:#ff79c6>order</span> <span style=color:#ff79c6>by</span> table_catalog,table_schema,<span style=color:#ff79c6>table_name</span>,privilege_type;
</span></span></code></pre></div><h1 id=gestion-du-stockage>Gestion du stockage</h1><h2 id=synthèse-3>Synthèse</h2><p>L&rsquo;objet Table permet de définir la structure et le stockage des données.</p><p>La création des tables et des vues se font obligatoirement dans un schéma.</p><p>Par défaut, si l&rsquo;on ne précise rien lors de la création des objets Catalog et Schema, l&rsquo;ensemble des données seront gérées par Unity Catalog en se basant sur le stockage (ressource AWS S3) défini au niveau du Metastore.
Si l&rsquo;option <code>MANAGED LOCATION</code> est défini au niveau du Catalog alors l&rsquo;ensemble des éléments (Schema et Table) utilisera cette option de stockage par défaut au lieu du stockage défini au niveau du Metastore.
Si l&rsquo;option <code>MANAGED LOCATION</code> est défini au niveau du Schema alors l&rsquo;ensemble des éléments (Table) utilisera cette option de stockage par défaut au lieu du stockage défini au niveau du Metastore.</p><p>Exemple de syntaxe :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>-- Catalog creation
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>CATALOG</span> XXX
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    MANAGED <span style=color:#ff79c6>LOCATION</span> <span style=color:#f1fa8c>&#39;s3://YYYYYYYYY&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#ff79c6>COMMENT</span> <span style=color:#f1fa8c>&#39;ZZZZZZZZ&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#6272a4>-- Schema creation
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>SCHEMA</span> XXX
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    MANAGED <span style=color:#ff79c6>LOCATION</span> <span style=color:#f1fa8c>&#39;s3://YYYYYYYYY&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#ff79c6>COMMENT</span> <span style=color:#f1fa8c>&#39;ZZZZZZZZ&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>;
</span></span></code></pre></div><p>Le Schema et le Catalog ne sont que des enveloppes logiques pour organiser les données.
Il n&rsquo;y a pas de création de répertoire lors de la création de ces objets.</p><p>Il existe deux types de tables :</p><ul><li>Managed Table (table managée) : Les métadonnées et les données sont gérées par Unity Catalog et le format de stockage utilisé est le format Delta.</li><li>External Table (table externe) : Uniquement les métadonnées sont gérées par Unity Catalog. Le format de stockage peut être l&rsquo;un des formats suivants &ldquo;Delta, CSV, JSON, Avro, Parquet, ORC ou Texte&rdquo;</li></ul><p>Concernant les tables managées (Managed Table) :</p><ul><li>Lorsque l&rsquo;on crée une Managed Table, les données sont créées dans un sous répertoire du stockage défini au niveau du Metastore (dans le cas ou l&rsquo;option &ldquo;MANAGED LOCATION&rdquo; n&rsquo;est pas défini au niveau du Catalog ou du Schema parent)</li><li>Le chemin sera la suivante <code>&lt;Metastore S3 Path>/&lt;Metastore ID>/tables/&lt;table ID></code>,<ul><li>Exemple : <code>s3://s3-dbx-metastore-uc/metastore-sandbox/13a746fa-c056-4b32-b6db-9d31c0d1eecf/tables/5c725019-fe8f-4778-a97c-c640eaf9b13e</code><ul><li>Metastore S3 Path : <code>s3-dbx-metastore-uc</code></li><li>Metastore ID : <code>13a746fa-c056-4b32-b6db-9d31c0d1eecf</code></li><li>Table ID : <code>5c725019-fe8f-4778-a97c-c640eaf9b13e</code></li></ul></li><li>Du point de vue du stockage, l&rsquo;ensemble des données des Managed Table au niveau du Metastore seront stockés par défaut dans le sous-répertoire <code>tables/</code> avec un identifiant unique défini lors de leur création.</li></ul></li><li>Lors de la suppression de la table, les métadonnées ainsi que les données (fichiers) seront supprimées</li></ul><p>Concernant les tables externes (External Table) :</p><ul><li>Lorsque l&rsquo;on crée une External Table, on doit indiquer le chemin complet d&rsquo;accès aux données (Unity Catalog gère les droits en se basant sur un objet Storace Credential et un objet External Location)<ul><li>Si des fichiers existent déjà, alors il faut que la définition de la table (format de données sources, schéma, etc &mldr;) soit compatible avec la donnée existante</li><li>Si aucun fichier n&rsquo;existe, alors les éléments de log du format Delta seront créés dans le sous répertoire <code>_log_delta</code> du chemin défini et les fichiers de données seront créés lors de l&rsquo;ajout de données dans la table.</li></ul></li><li>Lors de la suppression de la table, uniquement les métadonnées sont supprimées. Les données (fichiers) ne sont pas impactées par la suppression.</li><li>Quelques restrictions :<ul><li>Si la table se source à partir d&rsquo;un fichier csv, aucune autre action que la lecture ne sera permise</li><li>Si la table se source à partir des données (fichiers) de type CSV (ou autres format hors Delta) (écrit par un traitement spark par exemple), il sera possible de faire des insertions mais pas de mise à jour ou de suppression</li><li>Si la table se source à partir des données au format Delta alors il sera possible de faire exactement les mêmes actions qu&rsquo;avec une Managed Table</li><li>Il n&rsquo;est pas possible de définir deux tables externes différentes utilisant exactement les mêmes fichiers de données comme stockage externe</li></ul></li></ul><h2 id=mise-en-pratique-2>Mise en pratique</h2><p>Création d&rsquo;une External Table et d&rsquo;une Managed Table :</p><ol><li>Création d&rsquo;une External Table nommée <code>ref_products</code> dans le Schema <code>sch_ref</code> du Catalog <code>ctg_ext</code> à partir d&rsquo;un fichier csv nommé <code>ref_products.csv</code></li><li>Création d&rsquo;une Managed Table nommée <code>fct_transactions</code> dans le Schema <code>sch_bronze</code> du Catalog <code>ctg_ipp</code></li><li>Insertion des données dans la table <code>fct_transactions</code> à partir d&rsquo;un fichier CSV nommé <code>fct_transactions.csv</code></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>-- 1. Creation of external table ref_products
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>TABLE</span> ctg_ext.sch_ref.ref_products (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    id <span style=color:#8be9fd;font-style:italic>int</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    ,lib string
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    ,brand string
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    ,os string
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    ,last_maj <span style=color:#ff79c6>timestamp</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#ff79c6>USING</span> CSV
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#ff79c6>OPTIONS</span> (path <span style=color:#f1fa8c>&#34;s3://s3-demo-data-uc/demo/ref_products.csv&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        <span style=color:#ff79c6>delimiter</span> <span style=color:#f1fa8c>&#34;,&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        header <span style=color:#f1fa8c>&#34;true&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#ff79c6>COMMENT</span> <span style=color:#f1fa8c>&#39;Product referential (external)&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#6272a4>-- 2. Creation of managed table fct_transactions
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>TABLE</span> ctg_ipp.sch_bronze.fct_transactions (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    id_trx string
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    ,ts_trx string
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>    ,id_products string
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>    ,id_shop string
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>    ,id_client string
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>    ,quantity string
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span><span style=color:#ff79c6>COMMENT</span> <span style=color:#f1fa8c>&#39;Bronze Transactions Data&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span><span style=color:#6272a4>-- 3. Insert data from CSV files into the fct_transactions table
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>COPY</span> <span style=color:#ff79c6>INTO</span> ctg_ipp.sch_bronze.fct_transactions
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>  <span style=color:#ff79c6>FROM</span> <span style=color:#f1fa8c>&#39;s3://s3-demo-data-uc/demo/fct_transactions.csv&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>  FILEFORMAT <span style=color:#ff79c6>=</span> CSV
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>  FORMAT_OPTIONS (<span style=color:#f1fa8c>&#39;encoding&#39;</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;utf8&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>                ,<span style=color:#f1fa8c>&#39;inferSchema&#39;</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;false&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>                ,<span style=color:#f1fa8c>&#39;nullValue&#39;</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;N/A&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>                ,<span style=color:#f1fa8c>&#39;mergeSchema&#39;</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;false&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>                ,<span style=color:#f1fa8c>&#39;delimiter&#39;</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;,&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>                ,<span style=color:#f1fa8c>&#39;header&#39;</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;true&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>                ,<span style=color:#f1fa8c>&#39;mode&#39;</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;failfast&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>;
</span></span></code></pre></div><p>Exemple d&rsquo;erreur lors de la mise à jour des données d&rsquo;une External Table basée sur un fichier CSV
4. Mise à jour des données de la table <code>ref_products</code> en erreur
5. Suppression d&rsquo;une données de la table <code>ref_products</code> en erreur</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>-- 4. Error : Try to update the data in the ref_products table
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>UPDATE</span> ctg_ext.sch_ref.ref_products
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#ff79c6>SET</span> last_maj <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>current_timestamp</span>()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#ff79c6>WHERE</span> id <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#6272a4>-- Result : UPDATE destination only supports Delta sources
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#6272a4></span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#6272a4>-- 5. Error : Try to delete the data from ref_products table
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>DELETE</span> <span style=color:#ff79c6>FROM</span> ctg_ext.sch_ref.ref_products
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#ff79c6>WHERE</span> id <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#6272a4>-- Result : Could not verify permissions for DeleteFromTable
</span></span></span></code></pre></div><p>Exemple de la gestion du stockage des données pour une External Table (au format Delta) lors de sa création et de sa suppression :
6. Création d&rsquo;une table externe avec la propriété <code>appendOnly</code>
7. Vérification de l&rsquo;existence des fichiers sur la ressource AWS S3
8. Insertion d&rsquo;une donnée en passant par le Metastore Unity Catalog
9. Vérification de la liste des fichiers sur la ressource AWS S3
10. Visualisation de l&rsquo;historique des données Delta
11. Suppression des données sans utiliser la table du Metastore Unity Catalog (la propriété <code>appendOnly</code> bloque la réalisation de cette action)
12. Suppression de la table externe
13. Vérification de l&rsquo;existence des fichiers avec S3</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4>-- 6. Create an external table named &#34;ext_tbl&#34; in schema &#34;ctg_ext.sch_ref&#34; in the location &#34;s3://s3-demo-data-uc/demo/ext_tbl&#34; with the delta properties &#34;appendOnly&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>TABLE</span> ctg_ext.sch_ref.ext_tbl (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    col1 <span style=color:#8be9fd;font-style:italic>int</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    ,col2 <span style=color:#ff79c6>timestamp</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#ff79c6>COMMENT</span> <span style=color:#f1fa8c>&#39;Test External Table with TBLProperties&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#ff79c6>LOCATION</span> <span style=color:#f1fa8c>&#39;s3://s3-demo-data-uc/demo/ext_tbl&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>TBLPROPERTIES(<span style=color:#f1fa8c>&#39;delta.appendOnly&#39;</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;true&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#6272a4>-- 7. Check if the file exists on AWS S3 (with AWS CLI)
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#6272a4>-- aws s3 ls s3://s3-demo-data-uc/demo/ --recursive | grep &#34;ext_tbl&#34; | sed &#39;s/[[:space:]][[:space:]]*/|/g&#39; | cut -d &#34;|&#34; -f 4
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#6272a4></span><span style=color:#6272a4>/* Result : 
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#6272a4>demo/ext_tbl/_delta_log/
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#6272a4>demo/ext_tbl/_delta_log/.s3-optimization-0
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#6272a4>demo/ext_tbl/_delta_log/.s3-optimization-1
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#6272a4>demo/ext_tbl/_delta_log/.s3-optimization-2
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#6272a4>demo/ext_tbl/_delta_log/00000000000000000000.crc
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#6272a4>demo/ext_tbl/_delta_log/00000000000000000000.json
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#6272a4>*/</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span><span style=color:#6272a4>-- 8. Insert Data into the &#34;ext_tbl&#34; table
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>INSERT</span> <span style=color:#ff79c6>INTO</span> ctg_ext.sch_ref.ext_tbl <span style=color:#ff79c6>VALUES</span> (<span style=color:#bd93f9>1</span>,<span style=color:#ff79c6>current_timestamp</span>());
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span><span style=color:#6272a4>-- 9. Check if the file exists on AWS S3 (with AWS CLI)
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span><span style=color:#6272a4>-- aws s3 ls s3://s3-demo-data-uc/demo/ --recursive | grep &#34;ext_tbl&#34; | sed &#39;s/[[:space:]][[:space:]]*/|/g&#39; | cut -d &#34;|&#34; -f 4
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span><span style=color:#6272a4></span><span style=color:#6272a4>/* Result : 
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span><span style=color:#6272a4>demo/ext_tbl/_delta_log/
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span><span style=color:#6272a4>demo/ext_tbl/_delta_log/.s3-optimization-0
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span><span style=color:#6272a4>demo/ext_tbl/_delta_log/.s3-optimization-1
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span><span style=color:#6272a4>demo/ext_tbl/_delta_log/.s3-optimization-2
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span><span style=color:#6272a4>demo/ext_tbl/_delta_log/00000000000000000000.crc
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span><span style=color:#6272a4>demo/ext_tbl/_delta_log/00000000000000000000.json
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span><span style=color:#6272a4>demo/ext_tbl/_delta_log/00000000000000000001.crc
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span><span style=color:#6272a4>demo/ext_tbl/_delta_log/00000000000000000001.json
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span><span style=color:#6272a4>demo/ext_tbl/part-00000-097fb1f5-1d7e-464a-a65b-1303bd06e2b0.c000.snappy.parquet
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span><span style=color:#6272a4>*/</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span><span style=color:#6272a4>-- 10. Check Delta History
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>DESCRIBE</span> HISTORY ctg_ext.sch_ref.ext_tbl;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span><span style=color:#6272a4>/* Result : 
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span><span style=color:#6272a4>Version 1 : WRITE
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span><span style=color:#6272a4>Version 0 : CREATE TABLE
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span><span style=color:#6272a4>*/</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span><span style=color:#6272a4>-- 11. Delete data without using the Unity Catalog Table
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>DELETE</span> <span style=color:#ff79c6>FROM</span> DELTA.<span style=color:#ff79c6>`</span>s3:<span style=color:#ff79c6>//</span>s3<span style=color:#ff79c6>-</span>demo<span style=color:#ff79c6>-</span><span style=color:#ff79c6>data</span><span style=color:#ff79c6>-</span>uc<span style=color:#ff79c6>/</span>demo<span style=color:#ff79c6>/</span>ext_tbl<span style=color:#ff79c6>`</span> <span style=color:#ff79c6>WHERE</span> col1 <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span><span style=color:#6272a4>/* Result : This table is configured to only allow appends.*/</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span><span style=color:#6272a4>-- 12. Delete the table &#34;ext_tbl&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>DROP</span> <span style=color:#ff79c6>TABLE</span> ctg_ext.sch_ref.ext_tbl;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57</span><span><span style=color:#6272a4>-- 13. Check if the file exists on AWS S3 (with AWS CLI)
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58</span><span><span style=color:#6272a4>-- aws s3 ls s3://s3-demo-data-uc/demo/ --recursive | grep &#34;ext_tbl&#34; | sed &#39;s/[[:space:]][[:space:]]*/|/g&#39; | cut -d &#34;|&#34; -f 4
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59</span><span><span style=color:#6272a4></span><span style=color:#6272a4>/* Result : 
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60</span><span><span style=color:#6272a4>demo/ext_tbl/_delta_log/
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61</span><span><span style=color:#6272a4>demo/ext_tbl/_delta_log/.s3-optimization-0
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62</span><span><span style=color:#6272a4>demo/ext_tbl/_delta_log/.s3-optimization-1
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63</span><span><span style=color:#6272a4>demo/ext_tbl/_delta_log/.s3-optimization-2
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64</span><span><span style=color:#6272a4>demo/ext_tbl/_delta_log/00000000000000000000.crc
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65</span><span><span style=color:#6272a4>demo/ext_tbl/_delta_log/00000000000000000000.json
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66</span><span><span style=color:#6272a4>demo/ext_tbl/_delta_log/00000000000000000001.crc
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67</span><span><span style=color:#6272a4>demo/ext_tbl/_delta_log/00000000000000000001.json
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68</span><span><span style=color:#6272a4>demo/ext_tbl/part-00000-097fb1f5-1d7e-464a-a65b-1303bd06e2b0.c000.snappy.parquet
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69</span><span><span style=color:#6272a4>*/</span>
</span></span></code></pre></div><p>Remarques :</p><ul><li>Lors de la création de la table, uniquement le sous-répertoire <code>_delta_log</code> est créé pour contenir les informations de la version n°0</li><li>Lorsque l&rsquo;on positionne une propriété avec l’option “TBLPROPERTIES” sur la table externe, elle est aussi enregistrée sur le stockage.</li><li>Après la suppression de la table, les données ne sont plus accessible en passant par la table mais sont toujours accessible en passant par le chemin sur la ressource AWS S3</li></ul><p>Concernant les propriétés pouvant être utilisées avec le format Delta :
Vous pourrez trouver plus d&rsquo;information dans la <a href=https://docs.databricks.com/sql/language-manual/sql-ref-syntax-ddl-tblproperties.html>documentation officielle</a></p><h1 id=suppression-des-éléments>Suppression des éléments</h1><p>Vous trouverez ci-dessous l&rsquo;ensemble des instructions nécessaires pour nettoyer l&rsquo;environnement.</p><p>Suppression des éléments de Unity Catalog en utilisant les instructions SQL :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>-- Delete the Catalog with CASCADE option (to delete all objects)
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>DROP</span> <span style=color:#ff79c6>CATALOG</span> <span style=color:#ff79c6>IF</span> <span style=color:#ff79c6>EXISTS</span> ctg_ipp <span style=color:#ff79c6>CASCADE</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#ff79c6>DROP</span> <span style=color:#ff79c6>CATALOG</span> <span style=color:#ff79c6>IF</span> <span style=color:#ff79c6>EXISTS</span> ctg_ext <span style=color:#ff79c6>CASCADE</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#6272a4>-- Delete the External Location
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>DROP</span> <span style=color:#ff79c6>EXTERNAL</span> <span style=color:#ff79c6>LOCATION</span> <span style=color:#ff79c6>IF</span> <span style=color:#ff79c6>EXISTS</span> el_demo_data_uc <span style=color:#ff79c6>force</span>;
</span></span></code></pre></div><p>Note concernant la suppression de l&rsquo;objet <code>External Location</code> :</p><ul><li>Il faut obligatoirement en être le propriétaire</li><li>Il ne faut pas qu&rsquo;il soit déjà utilisé par une table, sinon il faut utiliser l&rsquo;option <code>force</code></li></ul><p>Suppression des données utilisées sur la ressource AWS S3 :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4># Delete all files stored in the AWS S3 resource</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>aws s3 rm <span style=color:#f1fa8c>&#34;s3://s3-demo-data-uc/demo/&#34;</span> --recursive 
</span></span></code></pre></div><p>Suppression du groupe à partir de l&rsquo;Account Databricks (cela supprimera automatiquement le groupe au niveau du Workspace Databricks) :</p><ol><li>Allez sur <code>Account Databricks page > User management > Groups</code></li><li>Utilisez la barre de recherche pour trouver le groupe voulu</li><li>Cliquez sur le bouton avec les 3 points associés au groupe et sélectionnez l&rsquo;option <code>Delete</code></li><li>Cliquez sur <code>Confirm Delete</code></li></ol><p>Suppression de l&rsquo;utilisateur au niveau de l&rsquo;Account Databricks :</p><ol><li>Allez sur <code>Account Databricks page > User management > Users</code></li><li>Utilisez la barre de recherche pour trouver l&rsquo;utilisateur voulu</li><li>Cliquez sur le nom de l&rsquo;utilisateur</li><li>Cliquez sur le bouton avec les 3 points et sélectionnez l&rsquo;option <code>Delete user</code></li><li>Cliquez sur <code>Confirm Delete</code></li></ol><h1 id=conclusion>Conclusion</h1><p>Nous avons pu voir un premier aperçu de quelques fonctionnalités de la solution Unity Catalog, concernant principalement la gestion des droits et du stockage avec External Table (tables externes) et Managed Table (tables managées).</p><p>La gestion des droits est simplifiée par l&rsquo;usage de la syntaxe SQL ANSI, l&rsquo;utilisation des groupes d&rsquo;utilisateurs et la centralisation de la gestion des accès au sein d&rsquo;Unity Catalog.</p><p>La gestion des groupes nécessite d&rsquo;être Administrateur sur l&rsquo;Account Databricks (création et suppression des groupes, ajout et suppression des utilisateurs dans les groupes) et Administrateur sur le Workspace Databricks pour ajouter ou supprimer des groupes existant au niveau de l&rsquo;Account Databricks dans le Workspace Databricks.</p><p>Point d&rsquo;attention : La gestion des droits et des groupes ne sont pas compatible entre Unity Catalog et Hive Metastore, il est recommandé de migrer les éléments de Hive Metastore vers Unity Catalog en recréant les accès/éléments nécessaires.</p><p>Si l&rsquo;on souhaite mettre en place un fonctionnement ouvert des données en minimisant l&rsquo;utilisation de Databricks, il est possible d&rsquo;utiliser Unity Catalog avec des tables externes au format Delta pour pouvoir utiliser le maximum de fonctionnalité tout en utilisant d&rsquo;autres outils pour accéder directement aux données Delta (AWS EMR, AWS Glue, AWS Athena, &mldr;).</p><p>Néanmoins, si l&rsquo;on souhaite utiliser la solution Unity Catalog, il est fortement recommandé de centraliser l&rsquo;ensemble de la gouvernance des données afin de pouvoir gérer l&rsquo;ensemble des accès au sein de la solution Unity Catalog.</p><p>A partir de la solution Unity Catalog, il est possible d&rsquo;accéder aux données en utilisant des Clusters, des SQL Warehouse ou la fonctionnalité de Delta Sharing pour multiplier les usages possibles des données.</p><h1 id=ressources>Ressources</h1><h2 id=creation-dun-sql-warehouse>Creation d&rsquo;un SQL Warehouse</h2><p>Databricks CLI ne permet pas de gérer les SQL Warehouses pour le moment, par conséquent nous pouvons utiliser <a href=https://docs.databricks.com/sql/api/sql-endpoints.html>Databricks API REST</a> pour le faire.</p><p>Pré-requis :</p><ul><li>Avoir l&rsquo;outil <code>Curl</code> installé</li></ul><p>Réalisation des actions :</p><ol><li>Création d&rsquo;un fichier <code>.netrc</code> permettant de gérer les accès à l&rsquo;API REST :</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4># Create the folder where the .netrc file will be stored</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>mkdir ~/.databricks
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#6272a4># Create the .netrc file</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;machine &lt;url workspace databricks without https://&gt;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#f1fa8c>login token
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#f1fa8c>password &lt;token user databricks&gt;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#f1fa8c>&#34;</span> &gt; ~/.databricks/.netrc
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#6272a4># Create an alias to use the tool curl with .netrc file</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;alias dbx-api=&#39;curl --netrc-file ~/.databricks/.netrc&#39;&#34;</span> &gt;&gt; ~/.alias 
</span></span></code></pre></div><ol start=2><li>Création d&rsquo;un warehouse</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;&lt;url workspace databricks&gt;&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#6272a4># Get the list of the existing SQL Warehouses (check if the SQL Warehouse exists)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>dbx-api -X GET <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.0/sql/warehouses/ | jq .
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#6272a4># Create the temporary config file for the SQL Warehouse</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>cat &gt; tmp_databricks_create_warehouse.json <span style=color:#f1fa8c>&lt;&lt;EOF
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#f1fa8c>{
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#f1fa8c>  &#34;name&#34;: &#34;DEMO_WH_XXS&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#f1fa8c>  &#34;cluster_size&#34;: &#34;2X-Small&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#f1fa8c>  &#34;min_num_clusters&#34;: 1,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#f1fa8c>  &#34;max_num_clusters&#34;: 1,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#f1fa8c>  &#34;auto_stop_mins&#34;: 20,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#f1fa8c>  &#34;auto_resume&#34;: true,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#f1fa8c>  &#34;tags&#34;: {
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#f1fa8c>    &#34;custom_tags&#34;: [
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#f1fa8c>      {
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#f1fa8c>        &#34;key&#34;: &#34;owner&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#f1fa8c>        &#34;value&#34;: &#34;admin@tech.demo&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#f1fa8c>      },
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#f1fa8c>      {
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#f1fa8c>        &#34;key&#34;: &#34;project&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span><span style=color:#f1fa8c>        &#34;value&#34;: &#34;databricks-demo&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span><span style=color:#f1fa8c>      }
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span><span style=color:#f1fa8c>    ]
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span><span style=color:#f1fa8c>  },
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span><span style=color:#f1fa8c>  &#34;spot_instance_policy&#34;:&#34;COST_OPTIMIZED&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span><span style=color:#f1fa8c>  &#34;enable_photon&#34;: &#34;true&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span><span style=color:#f1fa8c>  &#34;enable_serverless_compute&#34;: &#34;false&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span><span style=color:#f1fa8c>  &#34;warehouse_type&#34;: &#34;CLASSIC&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span><span style=color:#f1fa8c>  &#34;channel&#34;: {
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span><span style=color:#f1fa8c>    &#34;name&#34;: &#34;CHANNEL_NAME_CURRENT&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span><span style=color:#f1fa8c>  }
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span><span style=color:#f1fa8c>}
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span><span style=color:#f1fa8c>EOF</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span><span style=color:#6272a4># Creation of the SQL Warehouse</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>dbx-api -X POST -H <span style=color:#f1fa8c>&#34;Content-Type: application/json&#34;</span> -d <span style=color:#f1fa8c>&#34;@tmp_databricks_create_warehouse.json&#34;</span> <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.0/sql/warehouses/ 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span><span style=color:#6272a4># Delete the temporary config file</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>rm tmp_databricks_create_warehouse.json
</span></span></code></pre></div><p>Quelques actions pouvant être utiles :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4># Export the SQL Warehouse ID</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>SQL_WH_ID</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;&lt;SQL Warehouse ID&gt;&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#6272a4># Check the state of the SQL Warehouse</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>dbx-api -X GET <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.0/sql/warehouses/<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>SQL_WH_ID</span><span style=color:#f1fa8c>}</span> | jq <span style=color:#f1fa8c>&#39;.state&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#6272a4># Stop the SQL Warehouse (by default, it starts at creation)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>dbx-api -X POST <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.0/sql/warehouses/<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>SQL_WH_ID</span><span style=color:#f1fa8c>}</span>/stop
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#6272a4># Start the SQL Warehouse</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>dbx-api -X POST <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.0/sql/warehouses/<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>SQL_WH_ID</span><span style=color:#f1fa8c>}</span>/start
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#6272a4># Delete the SQL Warehouse</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>dbx-api -X DELETE <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.0/sql/warehouses/<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>SQL_WH_ID</span><span style=color:#f1fa8c>}</span>
</span></span></code></pre></div></div></article></div></div><footer><div class="container-fluid prag-bg-primary prag-foot">Généré avec <a href=https://gohugo.io/>Hugo</a>
&nbsp; - &nbsp;
<a href=https://en.wikipedia.org/wiki/WTFPL>WTFPL license</a> © 2018–2023</div></footer></body></html>