<!doctype html><html lang=fr><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta http-equiv=x-ua-compatible content="IE=edge"><meta charset=utf-8><meta name=robots content="noindex, nofollow, noarchive, nosnipper, noodp, noydir"><meta name=google content="notranslate, noimageindex"><meta name=slurp content="notranslate, noimageindex"><meta name=msnbot content="notranslate, noimageindex"><meta name=bingbot content="notranslate, noimageindex"><meta name=generator content="Hugo 0.111.3"><link rel=stylesheet href=https://www.pragmatias.fr/css/bootstrap.min.css><link rel=stylesheet href=https://www.pragmatias.fr/css/pragmatias.css><script src=https://www.pragmatias.fr/js/jquery-3.6.0.slim.min.js></script>
<script src=https://www.pragmatias.fr/js/popper.min.js></script>
<script src=https://www.pragmatias.fr/js/bootstrap.bundle.min.js></script>
<link rel=alternate type=application/rss+xml href=https://www.pragmatias.fr/feed.xml><title>Databricks : Unity Catalog - Découverte - Partie 4 - Delta Sharing</title><body><div class="navbar navbar-expand-md prag-bg-primary prag-header" role=navigation><div class="container-fluid justify-content-center"><div class=navbar-brand><a href=https://www.pragmatias.fr/blog/><img src=/images/logo_pragmatias.svg alt=pragmatias></a></div><button class="navbar-toggler justify-content-end prag-navbar" type=button data-toggle=collapse data-target=#navbarSupportedContent1,#navbarSupportedContent2 aria-controls=navbarSupportedContent1 aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent1><ul class="navbar-nav text-center"><li class=nav-item><a class=nav-link href=https://www.pragmatias.fr/blog/>Blog</a></li><li class=nav-item><a class=nav-link href=https://www.pragmatias.fr/tags/>Tags</a></li><li class=nav-item><a class=nav-link href=https://www.pragmatias.fr/archives/>Archives</a></li></ul></div><div class="collapse navbar-collapse justify-content-md-end" id=navbarSupportedContent2><ul class="navbar-nav flex-row justify-content-center"><li class=nav-item><a href=https://www.pragmatias.fr/en/2023/05/21/databricks-unity-catalog-first-step-part-4-delta-sharing/ class="prag_header_svg mr-1 ml-1"><img src=/images/united-kingdom-flag-round-xs-24.png alt=English></a></li><li class=nav-item><a href=https://www.pragmatias.fr/feed.xml title="Pragmatias Blog" class="prag_header_svg mr-1 ml-1"><svg height="24" style="enable-background:new 0 0 508.52 508.52" viewBox="0 0 508.52 508.52" width="24" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path style="fill-rule:evenodd;clip-rule:evenodd;fill:" d="M254.26.0C113.845.0.0 113.845.0 254.26s113.845 254.26 254.26 254.26 254.26-113.845 254.26-254.26C508.52 113.813 394.675.0 254.26.0zM137.141 412.441c-22.852.0-41.413-18.434-41.413-41.285.0-22.693 18.561-41.349 41.413-41.349 22.915.0 41.444 18.656 41.476 41.349C178.618 393.976 160.088 412.441 137.141 412.441zM241.197 412.791c0-39.029-15.16-75.674-42.62-103.071-27.46-27.524-63.978-42.716-102.785-42.716V207.38c113.177.0 205.315 92.137 205.315 205.41h-59.91zM347.001 412.727c0-138.603-112.669-251.399-251.145-251.399v-59.624c171.435.0 310.96 139.589 310.96 311.023H347.001z"/></svg></a></li><li class=nav-item><a href=mailto:contact@pragmatias.fr title=Mail class="prag_header_svg mr-1 ml-1"><svg height="24" style="enable-background:new 0 0 299.997 299.997" viewBox="0 0 299.997 299.997" width="24" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path style="fill-rule:evenodd;clip-rule:evenodd;fill:" d="M149.996.0C67.157.0.001 67.158.001 149.997c0 82.837 67.156 150 149.995 150s150-67.163 150-150C299.996 67.158 232.835.0 149.996.0zM149.999 52.686l88.763 55.35H61.236l88.763-55.35zm89.869 143.737h-.009c0 8.878-7.195 16.072-16.072 16.072H76.211c-8.878.0-16.072-7.195-16.072-16.072v-84.865c0-.939.096-1.852.252-2.749l84.808 52.883c.104.065.215.109.322.169.112.062.226.122.34.179.599.309 1.216.558 1.847.721.065.018.13.026.195.041.692.163 1.393.265 2.093.265h.005c.005.0.01.0.01.0.7.0 1.401-.099 2.093-.265.065-.016.13-.023.195-.041.63-.163 1.245-.412 1.847-.721.114-.057.228-.117.34-.179.106-.06.218-.104.322-.169l84.808-52.883c.156.897.252 1.808.252 2.749v84.865z"/></svg></a></li><li><a href=https://github.com/pragmatias/ title=github class="prag_header_svg mr-1 ml-1"><svg height="24" style="enable-background:new 0 0 438.549 438.549" viewBox="0 0 438.549 438.549" width="24" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path style="fill-rule:evenodd;clip-rule:evenodd;fill:" d="M409.132 114.573c-19.608-33.596-46.205-60.194-79.798-79.8C295.736 15.166 259.057 5.365 219.271 5.365c-39.781.0-76.472 9.804-110.063 29.408-33.596 19.605-60.192 46.204-79.8 79.8C9.803 148.168.0 184.854.0 224.63c0 47.78 13.94 90.745 41.827 128.906 27.884 38.164 63.906 64.572 108.063 79.227 5.14.954 8.945.283 11.419-1.996 2.475-2.282 3.711-5.14 3.711-8.562.0-.571-.049-5.708-.144-15.417-.098-9.709-.144-18.179-.144-25.406l-6.567 1.136c-4.187.767-9.469 1.092-15.846 1-6.374-.089-12.991-.757-19.842-1.999-6.854-1.231-13.229-4.086-19.13-8.559-5.898-4.473-10.085-10.328-12.56-17.556l-2.855-6.57c-1.903-4.374-4.899-9.233-8.992-14.559-4.093-5.331-8.232-8.945-12.419-10.848l-1.999-1.431c-1.332-.951-2.568-2.098-3.711-3.429-1.142-1.331-1.997-2.663-2.568-3.997-.572-1.335-.098-2.43 1.427-3.289s4.281-1.276 8.28-1.276l5.708.853c3.807.763 8.516 3.042 14.133 6.851 5.614 3.806 10.229 8.754 13.846 14.842 4.38 7.806 9.657 13.754 15.846 17.847 6.184 4.093 12.419 6.136 18.699 6.136s11.704-.476 16.274-1.423c4.565-.952 8.848-2.383 12.847-4.285 1.713-12.758 6.377-22.559 13.988-29.41-10.848-1.14-20.601-2.857-29.264-5.14-8.658-2.286-17.605-5.996-26.835-11.14-9.235-5.137-16.896-11.516-22.985-19.126-6.09-7.614-11.088-17.61-14.987-29.979-3.901-12.374-5.852-26.648-5.852-42.826.0-23.035 7.52-42.637 22.557-58.817-7.044-17.318-6.379-36.732 1.997-58.24 5.52-1.715 13.706-.428 24.554 3.853 10.85 4.283 18.794 7.952 23.84 10.994 5.046 3.041 9.089 5.618 12.135 7.708 17.705-4.947 35.976-7.421 54.818-7.421s37.117 2.474 54.823 7.421l10.849-6.849c7.419-4.57 16.18-8.758 26.262-12.565 10.088-3.805 17.802-4.853 23.134-3.138 8.562 21.509 9.325 40.922 2.279 58.24 15.036 16.18 22.559 35.787 22.559 58.817.0 16.178-1.958 30.497-5.853 42.966-3.9 12.471-8.941 22.457-15.125 29.979-6.191 7.521-13.901 13.85-23.131 18.986-9.232 5.14-18.182 8.85-26.84 11.136-8.662 2.286-18.415 4.004-29.263 5.146 9.894 8.562 14.842 22.077 14.842 40.539v60.237c0 3.422 1.19 6.279 3.572 8.562 2.379 2.279 6.136 2.95 11.276 1.995 44.163-14.653 80.185-41.062 108.068-79.226 27.88-38.161 41.825-81.126 41.825-128.906C438.536 184.851 428.728 148.168 409.132 114.573z"/></svg></a></li></ul></div></div></div><div id=content><div class=container-fluid><article class="blog-post blog-post-with-toc"><header><h2 class=blog-post-title>Databricks : Unity Catalog - Découverte - Partie 4 - Delta Sharing</h2><div class=blog-post-date><span>Dernière modification : 21 Mai 2023</span></div><div class=blog-post-date>Temps de lecture : 44 minute(s) - 9160 mots</div><div class=blog-post-tags><strong>Tags:</strong>
<a href=https://www.pragmatias.fr/tags/databricks/>Databricks</a>
<a href=https://www.pragmatias.fr/tags/unity-catalog/>Unity Catalog</a></div></header><aside class=prag-toc><h1 class=prag-toc-head>Sommaire</h1><div class=prag-toc-body><nav id=TableOfContents><ol><li><a href=#quest-ce-quest-le-data-sharing>Qu&rsquo;est ce qu&rsquo;est le Data Sharing</a></li><li><a href=#unity-catalog-et-la-hiérarchie-des-objets>Unity Catalog et la hiérarchie des objets</a></li><li><a href=#quest-ce-que-la-fonctionnalité-delta-sharing>Qu’est ce que la fonctionnalité Delta Sharing</a></li><li><a href=#quest-ce-que-les-logs-daudit>Qu’est ce que les Logs d&rsquo;audit</a></li><li><a href=#préparation-de-lenvironnement>Préparation de l&rsquo;environnement</a><ol><li><a href=#contexte>Contexte</a></li><li><a href=#schématisation-de-lenvironnement>Schématisation de l&rsquo;environnement</a></li><li><a href=#variable-denvironnement>Variable d&rsquo;environnement</a></li><li><a href=#mise-en-place-dun-jeu-de-données-sur-la-ressource-aws-s3>Mise en place d&rsquo;un jeu de données sur la ressource AWS S3</a></li><li><a href=#mise-en-place-des-objets-dans-le-metastore-unity-catalog-aws>Mise en place des objets dans le Metastore Unity Catalog (AWS)</a></li><li><a href=#création-dun-notebook-pour-pouvoir-le-partager>Création d&rsquo;un notebook pour pouvoir le partager</a></li></ol></li><li><a href=#configuration-des-logs-daudit-sur-le-metastore>Configuration des Logs d&rsquo;audit sur le Metastore</a></li><li><a href=#activation-du-delta-sharing-sur-le-metastore>Activation du Delta Sharing sur le Metastore</a></li><li><a href=#création-dun-partage-share-sur-le-metastore>Création d&rsquo;un partage (Share) sur le Metastore</a></li><li><a href=#partage-des-données-avec-un-metastore-unity-catalog-sur-azure>Partage des données avec un Metastore Unity Catalog sur Azure</a><ol><li><a href=#configuration-unity-catalog-sur-azure>Configuration Unity Catalog sur Azure</a></li><li><a href=#mise-en-place-dun-destinataire-recipient-databricks-to-databricks>Mise en place d&rsquo;un destinataire (Recipient) Databricks-to-Databricks</a></li><li><a href=#accès-par-le-metastore-unity-catalog-azure>Accès par le Metastore Unity Catalog Azure</a></li><li><a href=#lecture-des-logs-daudits>Lecture des logs d&rsquo;audits</a></li></ol></li><li><a href=#partage-des-données-en-open-sharing>Partage des données en Open Sharing</a><ol><li><a href=#access-par-script-python>Access par script python</a></li><li><a href=#lecture-des-logs-daudit>Lecture des logs d&rsquo;audit</a></li></ol></li><li><a href=#suppression-des-éléments>Suppression des éléments</a></li><li><a href=#conclusion>Conclusion</a></li></ol></nav></div></aside><a id=showTopBtn href=# class=prag-sticky-bot><svg height="24" id="Layer_1" style="enable-background:new 0 0 438.533 438.533" viewBox="0 0 438.533 438.533" width="24" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path style="fill-rule:evenodd;clip-rule:evenodd;fill:" d="M409.133 109.203c-19.608-33.592-46.205-60.189-79.798-79.796C295.736 9.801 259.058.0 219.273.0c-39.781.0-76.47 9.801-110.063 29.407-33.595 19.604-60.192 46.201-79.8 79.796C9.801 142.8.0 179.489.0 219.267c0 39.78 9.804 76.463 29.407 110.062 19.607 33.592 46.204 60.189 79.799 79.798 33.597 19.605 70.283 29.407 110.063 29.407s76.47-9.802 110.065-29.407c33.593-19.602 60.189-46.206 79.795-79.798 19.603-33.596 29.403-70.284 29.403-110.062C438.533 179.485 428.732 142.795 409.133 109.203zM361.449 231.831l-25.981 25.981c-3.613 3.613-7.901 5.42-12.847 5.42-4.948.0-9.229-1.807-12.847-5.42l-53.954-53.961v143.32c0 4.948-1.813 9.232-5.428 12.847-3.613 3.62-7.898 5.427-12.847 5.427h-36.547c-4.948.0-9.231-1.807-12.847-5.427-3.617-3.614-5.426-7.898-5.426-12.847v-143.32l-53.959 53.961c-3.431 3.425-7.708 5.133-12.85 5.133-5.14.0-9.423-1.708-12.85-5.133l-25.981-25.981c-3.422-3.429-5.137-7.714-5.137-12.852.0-5.137 1.709-9.419 5.137-12.847l103.356-103.353 25.981-25.981c3.427-3.425 7.71-5.14 12.847-5.14 5.142.0 9.423 1.715 12.849 5.14l25.98 25.981 103.35 103.353c3.432 3.427 5.14 7.71 5.14 12.847C366.589 224.117 364.881 228.402 361.449 231.831z"/></svg></a><script>$(document).ready(function(){$("#showTopBtn").removeClass("prag-sticky-bot"),$("#showTopBtn").addClass("prag-sticky-hide"),$(function(){$(window).scroll(function(){$(this).scrollTop()>900?($("#showTopBtn").addClass("prag-sticky-bot"),$("#showTopBtn").removeClass("prag-sticky-hide")):($("#showTopBtn").addClass("prag-sticky-hide"),$("#showTopBtn").removeClass("prag-sticky-bot"))})})})</script><div class=blog-post-main><p>Nous allons découvrir la fonctionnalité <a href=https://www.databricks.com/fr/product/delta-sharing>Delta Sharing</a> proposée par Databricks dans la solution <a href=https://docs.databricks.com/data-governance/unity-catalog/index.html>Unity Catalog</a>.</p><p>Nous allons utiliser un Account Databricks sur AWS comme fournisseur (Provider) et un Account Databricks sur Azure comme destinataire (Recipient) du partage des objets avec la fonctionnalité Delta Sharing pour cette découverte.</p><p><em>Note n°1 : Nous allons garder des termes techniques en anglais pour faciliter la compréhension.</em></p><p><em>Note n°2 : Les informations de ce papier concernent la période Mars/Avril 2023.</em></p><h1 id=quest-ce-quest-le-data-sharing>Qu&rsquo;est ce qu&rsquo;est le Data Sharing</h1><p>Le Data Sharing est une pratique qui consiste à partager des données entre différents partenaires.</p><p>Cela peut être pour des besoins réglementaires ou contractuels mais aussi pour valoriser et monétiser ses données et ses produits.</p><p>Il y a un enjeu de sécurité et de gouvernance des données très fort lorsque l&rsquo;on souhaite partager des données avec des partenaires ou concurrents afin d&rsquo;éviter tout risque de fuite de données et de garantir la traçabilité des actions concernant l&rsquo;utilisation des données.</p><p>On peut retrouver l&rsquo;usage du Data Sharing lors de la mise en place d&rsquo;un Data Mesh pour le partage des données des différents produits entre les différentes équipes.</p><p>Il est aussi assez courant de mettre en place une interface en REST API afin de permettre aux partenaires externes de récupérer les données en gérant les droits d&rsquo;accès directement par l&rsquo;API REST mais il existe des solutions permettant de grandement faciliter et sécuriser ce partage de données.
De plus, l&rsquo;interface REST API n&rsquo;est pas forcément le moyen le plus efficace lorsqu&rsquo;il s&rsquo;agit d&rsquo;échanger des données volumineuses entre des partenaires (par exemple dans le cadre d’un Data Lake ou d’un Lakehouse).</p><p>Parmi les solutions existantes, nous allons nous intéresser à la fonctionnalité &ldquo;Delta Sharing&rdquo; proposée par Databricks avec la solution Unity Catalog afin de mettre en place un partage de données avec des partenaires externes.</p><h1 id=unity-catalog-et-la-hiérarchie-des-objets>Unity Catalog et la hiérarchie des objets</h1><p>Unity Catalog est la solution de Databricks permettant d&rsquo;avoir une gouvernance unifiée et centralisée pour l&rsquo;ensemble des données gérées par les ressources Databricks ainsi que de sécuriser et faciliter la gestion et le partage des données à l&rsquo;ensemble des acteurs internes et externes d&rsquo;une organisation.</p><p>Vous pourrez avec une vue d&rsquo;ensemble plus complète en parcourant la <a href=https://docs.databricks.com/data-governance/unity-catalog/index.html>documentation officielle</a>.</p><p>Rappel concernant la hiérarchie des objets :
<a href=/blog/web/20230521_blog_article_unity_catalog_dela_sharing_00.png><img src=/blog/web/20230521_blog_article_unity_catalog_dela_sharing_00.png alt=schema_00></a></p><p>Les différents objets sont :</p><ul><li>Storage Credential : Cet objet est associé directement au Metastore et permet de stocker les accès à un cloud provider (par exemple AWS S3) permettant à la solution Unity Catalog de gérer les droits sur les données.</li><li>External Location : Cet objet est associé au Metastore et permet de stocker le chemin vers un cloud provider (par exemple une ressource AWS S3) en combinaison avec un Storage Credential pour gérer les accès aux données</li><li>Metastore : Objet du plus haut niveau pouvant contenir des métadonnées</li><li>Catalog (Catalogue) : Objet de 1er niveau permettant d&rsquo;organiser les données par schéma (aussi nommé Base de données)</li><li>Schema (Schéma) : Objet de 2ème et dernier niveau permettant d&rsquo;organiser les données (contient les tables, les vues et les fonctions)</li><li>Table : Objet permettant de définir la structure et le stockage des données.</li><li>Share (Partage) : Un regroupement logique des tables que l&rsquo;on souhaite partager.</li><li>Recipient (Destinataire) : Un objet qui identifie un partenaire (ou groupe d&rsquo;utilisateurs) qui aura accès au partage des données.</li><li>Provider (Fournisseur) : Un objet qui représente un partenaire qui partage des données.</li></ul><p>Lorsque vous souhaitez accéder à un objet (par exemple une table), il sera nécessaire de renseigner le nom du catalogue et le nom du schéma où est défini l&rsquo;objet.
Exemple : <code>select * from catalog.schema.table</code></p><p>Note : Les notions de partage (Share), destinataire (Recipient) et fournisseur (Provider) sont spécifiques à la fonctionnalité Delta Sharing.</p><h1 id=quest-ce-que-la-fonctionnalité-delta-sharing>Qu’est ce que la fonctionnalité Delta Sharing</h1><p>Cette fonctionnalité s&rsquo;appuie sur un <a href=https://github.com/delta-io/delta-sharing/blob/main/PROTOCOL.md>protocol ouvert</a> développé par Databricks pour permettre le partage de données de manière sécurisée entre plusieurs plateformes.</p><p>Cette fonctionnalité se base sur la solution Unity Catalog afin de centraliser la gouvernance des données (gestion des catalogues et des droits sur les données).</p><p>Le Delta Sharing Server est géré par la solution Unity Catalog et permet de donner à un destinataire l&rsquo;accès direct au données sur le stockage sans passer par un cluster ou un SQL Warehouse</p><p>Schématisation du fonctionnement du Delta Sharing :
<a href=/blog/web/20230521_blog_article_unity_catalog_dela_sharing_20.png><img src=/blog/web/20230521_blog_article_unity_catalog_dela_sharing_20.png alt=schema_20></a>
Le fonctionnement est le suivant :</p><ol><li>Le destinataire (Recipient) demande la lecture d&rsquo;une table partagée</li><li>Le fournisseur (Provider) (avec le Delta Sharing Serveur géré par Unity Catalog) va contrôler l&rsquo;accès à la table partagée</li><li>Le fournisseur (Provider) va envoyer les liens d&rsquo;accès (valide sur un temps très court) vers le stockage où se trouve réellement la donnée (sans passer par un Cluster ou SQL Warehouse)</li><li>Le destinataire (Recipient) va accéder directement au stockage pour récupérer en lecture seule les données de la table partagée</li></ol><p>Les trois grand cas d&rsquo;utilisation mis en avant par Databricks pour l&rsquo;utilisation de cette fonctionnalité :</p><ul><li>Partage des données en interne (filiales, équipes)<ul><li>Créer un Data Mesh pour échanger des données des différents produits entre différentes filiales, équipes, applications</li></ul></li><li>Partage des données en externe (entreprises)<ul><li>Partagez des données avec des partenaires et fournisseurs, qu&rsquo;ils soient ou non sur la plateforme Databricks</li></ul></li><li>Monétisation des données<ul><li>Distribuez et monétisez vos produits (données) avec des clients qui sont ou non sur la plateforme Databricks</li></ul></li></ul><p>Quelques avantages de cette fonctionnalité :</p><ul><li>Un fournisseur peut facilement définir des partages sur une version ou une partition spécifique d&rsquo;une table</li><li>Les tables sont partagés en direct et peuvent être mise à jour par le fournisseur seulement</li><li>Tous les clients qui peuvent lire des données parquets peuvent accéder aux données partagées</li><li>Le transfert des données s&rsquo;appuient uniquement sur les ressources S3/ADLS/GCS, par conséquent le transfert est extrêmement efficace et peu coûteux</li></ul><p>Il est possible d&rsquo;utiliser la fonctionnalité &ldquo;Delta Sharing&rdquo; de trois façon différentes :</p><ol><li><a href=https://docs.databricks.com/data-sharing/share-data-open.html>Open Sharing</a><ol><li>Cela permet à n&rsquo;importe quel client n&rsquo;utilisant pas Databricks avec la solution Unity Catalog d&rsquo;accéder aux données partagés</li><li>Il est nécessaire d&rsquo;utiliser une librairies spécifiques pour pouvoir lire des données en passant pour le Delta Sharing</li><li>Les destinataires de ce type de partage se base sur la durée de vie d&rsquo;un Token Databricks (définie au niveau du Metastore Unity Catalog du fournisseur)</li></ol></li><li><a href=https://docs.databricks.com/data-sharing/share-data-databricks.html>Databricks-to-Databricks Sharing</a><ol><li>Cela correspond au partage de données entre deux Metastores de la solution Unity Catalog (dans le même Account Databricks ou dans des Accounts Databricks différents (AWS, Azure ou GCP))</li><li>Un des avantages de ce type de partage est que ni le destinataire (Recipient), ni le fournisseur (Provider) n&rsquo;a besoin de gérer un Token Databricks pour l&rsquo;accès aux données partagées.</li><li>La sécurité de ce partage (incluant la vérification des accès, l&rsquo;authentification et l&rsquo;audit) est gérée entièrement à travers la fonctionnalité Delta Sharing et la plateforme Databricks.</li><li>Il est aussi possible de partager des notebooks en lecture seul</li></ol></li><li>Marketplace :<ol><li>Cela correspond au fait de se déclarer comme partenaire Databricks afin de pouvoir proposer ces données partagées sur la Marketplace Databricks. Nous n&rsquo;allons pas développer cette méthode de partage dans le cadre de cette découverte.</li></ol></li></ol><p>Les objets spécifique à cette fonctionnalité qui ont été mis en place dans la solution Unity Catalog sont :</p><ul><li><code>Provider</code> (Fournisseur) : Cela permet de définir le fournisseur de données pour le destinataire</li><li><code>Recipient</code> (Destinataire) : Cela permet de définir les différents destinataires (équivalent d&rsquo;utilisateur) pour gérer les droits d&rsquo;accès sur les données partagées</li><li><code>Share</code> (Partage) : C&rsquo;est une collection de tables et de notebooks en lecture seule permettant de partager des données provenant d&rsquo;un Metastore à des destinataires<ul><li>Le partage (Share) des notebooks ne concernent que des destinataires utilisant aussi la solution Unity Catalog</li></ul></li></ul><p>Information concernant les partages (Share) :</p><ul><li>C&rsquo;est une enveloppe logique qui permet de regrouper l&rsquo;ensemble des objets (tables delta et notebooks) que l&rsquo;on souhaite partager en lecture seul.</li><li>Unity Catalog écrit les informations concernant les partages (Share) dans le répertoire du stockage (AWS S3) suivant : <code>s3://s3-dbx-metastore-uc/metastore-sandbox/&lt;Metastore ID>/delta-sharing/shares/&lt;Share ID>/*</code></li><li>Il est possible d&rsquo;ajouter l&rsquo;ensemble des tables du Metastore dans un partage (Share)<ul><li>Il faut uniquement avoir les droits de <code>SELECT</code> et <code>USE</code> sur les objets que l&rsquo;on souhaite ajouter dans le partage (Share)</li></ul></li><li>Les droits d&rsquo;accès au partage (Share) ne peuvent être donnés qu’aux destinataires (Recipient) définis</li><li>Le nom d&rsquo;un partage (Share) peut être un nom déjà utilisé par un catalogue ou un schéma (pas de restriction, mais il est recommandé d&rsquo;avoir un nom différent pour faciliter la gestion des partages)</li><li>Il est possible de partager uniquement des tables Delta qu&rsquo;elles soient managées ou externes<ul><li>Il est possible de définir une notion de partition se basant sur les partitions existantes de la table Delta pour limiter automatiquement l&rsquo;accès aux données en fonction des propriétés de chaque destinaires (Recipient)<ul><li>La gestion des partitions au niveau du partage (Share) peut être extrêmement pratique si vous avez défini des partitions sur une information comme le pays, une période ou un identifiant lié au destinataire (Recipient) pour limiter automatiquement l&rsquo;accès aux données.</li><li>Cela permet de définir une seule fois les contraintes sur les partitions au niveau du partage (Share) et de pouvoir définir les propriétés de chaque destinataire (Recipient)</li></ul></li><li>Il est possible de définir si l&rsquo;historique d&rsquo;une table Delta est partagée ou non</li><li>Il est possible de définir si le Change Data Feed d&rsquo;une table Delta est partagée ou non</li></ul></li><li>Il est recommandé de mettre en place des alias pour chaque objets ajoutés au partage (Share)<ul><li>Lorsque l&rsquo;on ne défini pas d&rsquo;alias pour le nom du schéma alors c&rsquo;est le nom du schéma source qui sera utilisé</li><li>Lorsque l&rsquo;on ne défini pas d&rsquo;alias pour le nom du schéma et de la table alors c&rsquo;est le nom du schéma source et de la table source qui seront utilisés</li><li>Il n&rsquo;est pas possible de mettre à jour un alias après ajout de l&rsquo;objet dans le partage. (Il est nécessaire d&rsquo;enlever et d&rsquo;ajouter à nouveau l&rsquo;objet pour modifier l&rsquo;alias)</li></ul></li><li>Information spécifique au partage d&rsquo;un notebook (dans le cas d&rsquo;un partage Databricks-to-Databricks uniquement) :<ul><li>Lors du partage du notebook, il est en réalité exporté au format HTML vers un répertoire du stockage (AWS S3) managé de Unity Catalog (et plus précisément le répertoire <code>s3://s3-dbx-metastore-uc/metastore-sandbox/&lt;Metastore ID>/delta-sharing/shares/&lt;Share ID>/notebooks_files/*</code>), ce qui a pour effet de garder un version figée du notebook que l&rsquo;on souhaite partager.</li><li>Lorsque le notebook qui a été partagé est modifié, cela n&rsquo;a pas d&rsquo;impact sur le notebook partagé. Il faut l&rsquo;enlever et l&rsquo;ajouter à nouveau au partage (Share) pour partager la dernière version du notebook.</li></ul></li></ul><p>Information concernant les destinataires (Recipient) :</p><ul><li>C&rsquo;est un objet au niveau du Metastore qui permet de définir un accès pour un partenaire/client</li><li>La gestion des accès en lecture sur le partage (Share) se fait sur l&rsquo;objet destinataire (Recipient)</li><li>Un destinataire (Recipient) peut accéder à l&rsquo;ensemble des partages (Share) d&rsquo;un Metastore en fonction des droits données par les propriétaires des partages (Share)</li><li>Un destinataire (Recipient) ne peut pas accéder aux catalogues du Metatore Unity Catalog, uniquement aux partages autorisés.</li><li>Pour pouvoir créer un destinataire (Recipient), il est nécessaire d&rsquo;activer la fonctionnalité Delta Sharing au niveau du Metastore</li><li>Il existe deux types de destinataire (Recipient)<ul><li>Open Sharing : le destinataire (Recipient) utilise un Token Databricks dont la durée de validité est définie au niveau du Metastore</li><li>Databricks-to-Databricks Sharing : le destinataire (Recipient) utilise un Identifiant de partage du Metastore (pas de durée de validité)</li></ul></li><li>Les utilisateurs d&rsquo;un Metastore ne peuvent pas accéder aux partages du même Metastore</li></ul><p>Liens concernant quelques connecteurs permettant d&rsquo;accéder aux données partagées sans passer par une ressource Databricks :</p><ul><li><a href=https://github.com/delta-io/delta-sharing#python-connector>Python & Pandas</a></li><li><a href=https://github.com/delta-io/delta-sharing#apache-spark-connector>Apache spark</a></li><li><a href=https://learn.microsoft.com/en-us/power-query/connectors/delta-sharing>Power BI</a></li><li><a href=https://github.com/databrickslabs/delta-sharing-java-connector>Java</a></li></ul><h1 id=quest-ce-que-les-logs-daudit>Qu’est ce que les Logs d&rsquo;audit</h1><p>Lorsque l&rsquo;on est fournisseur (Provider) de données, il est indispensable de pouvoir tracer l&rsquo;utilisation de nos données par les différents destinataires (Recipient) définis.</p><p>Cela peut permettre de définir les règles de facturation lorsque l&rsquo;on souhaite monétiser l&rsquo;accès aux données mais aussi de simplement tracer l&rsquo;utilisation des objets partagés.</p><p>Quelques exemples d&rsquo;évènements capturés au niveau du Metastore de la solution Unity Catalog (non exhaustif) :</p><ul><li>Action de création/suppression d&rsquo;un partage (Share)</li><li>Action de création/suppression d&rsquo;un destinataire (Recipient)</li><li>Action de demande d&rsquo;accès d&rsquo;un destinataire (Recipient)</li><li>Exécution d&rsquo;une requête sur un objet partagé</li><li>Résultat de la requête (métadonnées) sur un objet partagé</li></ul><p>Pour ce faire, il est nécessaire de mettre en place la récupération des logs d&rsquo;audit pour les évènements/actions liés au Metastore de la solution Unity Catalog.</p><p>La récupération des logs d&rsquo;audit nécessite la mise en place d&rsquo;une configuration de log au niveau de l&rsquo;Account Databricks.</p><p>Quelques informations :</p><ul><li>Les logs d&rsquo;audit ne sont pas récupérés en temps réel, mais toutes les X minutes et stockés dans la ressource AWS S3 indiqué au niveau de la configuration de log dans l&rsquo;Account Databricks.</li><li>Les fichiers des logs d&rsquo;audit sont au format JSON.</li><li>Les fichiers de logs d&rsquo;audit concernant le Metastore Unity Catalog sont stockés dans un sous répertoire nommé <code>workspace=0</code><ul><li>Lorsque vous allez mettre en place la configuration de logs, il faudra faire attention à ne pas filtrer d&rsquo;identifiant de Workspace Databricks ou à prendre en compte l&rsquo;identifiant de Workspace Databricks avec la valeur <code>0</code> sinon vous ne récupérerez pas les logs concernant les évènements liés au Métastore Unity Catalog.</li></ul></li><li>Vous ne pourrez pas mettre à jour ou supprimer une configuration de log au niveau de l&rsquo;Account Databricks, vous pourrez uniquement la désactiver et en créer une nouvelle (même si vous utiliser le même nom, l&rsquo;identifiant de configuration sera différent avec un identifiant unique)</li></ul><p>Tous les événements tracés au niveau account et plus spécifiquement concernant Unity Catalog sont tracés dans la logs d’audit et peuvent faire l&rsquo;objet d&rsquo;une analyse. Nous avons volontairement limité notre analyse à deux types d&rsquo;actions pour cette démonstration.</p><p>Vous trouverez une liste exhaustive des actions/événements que vous pourrez analyser sur la <a href=https://docs.databricks.com/administration-guide/account-settings/audit-logs.html#events>documentation officielle</a>.</p><h1 id=préparation-de-lenvironnement>Préparation de l&rsquo;environnement</h1><p>Nous allons mettre en place un ensemble d&rsquo;éléments nous permettant de découvrir plus en détail la fonctionnalité Delta Sharing de la solution Unity Catalog.</p><h2 id=contexte>Contexte</h2><p>Pré-requis :</p><ul><li>Existence d&rsquo;une ressource AWS S3 nommée <code>s3-dbx-metastore-uc</code></li><li>Existence d&rsquo;une ressource AWS S3 nommée <code>s3-demo-data-uc</code></li><li>Existence d&rsquo;un Metastore nommé <code>metastore-sandbox</code> avec le Storage Credential nommé <code>sc-metastore-sandbox</code> permettant de stocker les données par défaut dans la ressource AWS S3 nommée <code>s3-dbx-metastore-uc</code></li><li>Existence d&rsquo;un rôle AWS IAM nommé <code>role-databricks-demo-data-uc</code> et d&rsquo;une politique AWS IAM nommée <code>policy-databricks-demo-data-uc</code> permettant au rôle global Databricks de gérer l&rsquo;accès à la ressource AWS S3 nommée <code>s3-demo-data-uc</code></li><li>Existence d&rsquo;un Storage Credential nommé <code>sc-demo-data-uc</code> et d&rsquo;un External Location nommé <code>el_demo_data_uc</code> permettant au rôle global Databricks de gérer l&rsquo;accès à la ressource AWS S3 nommée <code>s3-demo-data-uc</code></li><li>Existence du groupe <code>grp_demo</code></li><li>Existence de l&rsquo;utilisateur <code>john.do.dbx@gmail.com</code> dans le groupe <code>grp_demo</code></li><li>Existence d&rsquo;un SQL Warehouse avec le droit d&rsquo;utilisation pour le groupe <code>grp_demo</code></li></ul><p>Mise en place des droits pour le groupe <code>grp_demo</code> :</p><ol><li>Donner le droit de créer des catalogues au niveau du Metastore pour le groupe <code>grp_demo</code></li><li>Donner le droit de lire les fichiers externes à partir de l&rsquo;objet External Location nommé <code>el_demo_data_uc</code></li><li>Donner le droit de créer un espace de partage (Share) au niveau du Metastore pour le groupe <code>grp_demo</code></li><li>Donner le droit de créer un destinataire (Recipient) au niveau du Metastore pour le groupe <code>grp_demo</code></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>-- 1. Give Create Catalog right on Metastore to grp_demo
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>GRANT</span> <span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>CATALOG</span> <span style=color:#ff79c6>ON</span> METASTORE <span style=color:#ff79c6>TO</span> grp_demo;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#6272a4>-- 2. Give Read Files right on el_demo_data_uc location to grp_demo
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>GRANT</span> <span style=color:#ff79c6>READ</span> FILES <span style=color:#ff79c6>ON</span> <span style=color:#ff79c6>EXTERNAL</span> <span style=color:#ff79c6>LOCATION</span> <span style=color:#ff79c6>`</span>el_demo_data_uc<span style=color:#ff79c6>`</span> <span style=color:#ff79c6>TO</span> grp_demo;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#6272a4>-- 3. Give Create share right on Metastore to grp_demo
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>GRANT</span> CREATE_SHARE <span style=color:#ff79c6>ON</span> METASTORE <span style=color:#ff79c6>TO</span> grp_demo;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#6272a4>-- 4. Give Create recipient right on Metastore to grp_demo
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>GRANT</span> CREATE_RECIPIENT <span style=color:#ff79c6>ON</span> METASTORE <span style=color:#ff79c6>TO</span> grp_demo;
</span></span></code></pre></div><h2 id=schématisation-de-lenvironnement>Schématisation de l&rsquo;environnement</h2><p>Concernant les éléments sur AWS
Schématisation des objets au niveau du Metastore Unity Catalog sur AWS:
<a href=/blog/web/20230521_blog_article_unity_catalog_dela_sharing_21.png><img src=/blog/web/20230521_blog_article_unity_catalog_dela_sharing_21.png alt=schema_21></a>
Liste des éléments :</p><ul><li>Metastore <code>metastore-sandbox</code> : Metastore principal au niveau de l&rsquo;Account Databricks AWS</li><li>Storage Credential <code>sc-metastore-sandbox</code> : Information de connexion pour gérer les droits d&rsquo;accès à la ressource AWS nommée <code>s3-dbx-metastore-uc</code></li><li>Storage Credential <code>sc-demo-data-uc</code> et External Location <code>el-demo-data-uc</code>: Information de connexion pour gérer les droits d&rsquo;accès à la ressource AWS nommé <code>s3-demo-data-uc</code></li><li>Catalogue <code>ctg_mng</code> : Enveloppe pour gérer les données managées</li><li>Catalogue <code>ctg_ext</code>: Enveloppe pour gérer les données externes</li></ul><p>Schématisation de l&rsquo;ensemble des objets que nous allons mettre en place et utilisés sur le Metastore Unity Catalog sur AWS :
<a href=/blog/web/20230521_blog_article_unity_catalog_dela_sharing_22.png><img src=/blog/web/20230521_blog_article_unity_catalog_dela_sharing_22.png alt=schema_22></a>
Liste des éléments :</p><ul><li>Catalogue <code>ctg_mng</code> et Schéma <code>sch_mng</code> : Enveloppe logique pour organiser et gérer les données managées</li><li>Catalogue <code>ctg_ext</code> et Schéma <code>sch_ext</code> : Enveloppe logique pour organiser et gérer les données externes</li><li>Table <code>fct_transactions_mng</code> : Table managée par Unity Catalog contenant les informations de transactions et partitionné sur la colonne <code>id_client</code></li><li>Table <code>fct_transactions_ext</code> : Table externe contenant les informations de transactions non partitionné mais avec le Change Data Feed activé dans la ressource AWS S3 nommée <code>s3-demo-data-uc/data/fct_transactions_ext</code></li><li>Table <code>fct_transactions_csv</code> : Table externe permettant d&rsquo;accéder directement au fichier source CSV des transactions de la ressource AWS S3 nommée <code>s3-demo-data-uc/demo/fct_transactions.csv</code></li><li>Table <code>audit_logs_json</code> : Table externe permettant d&rsquo;accéder directement à l&rsquo;ensemble des fichiers de logs d&rsquo;audits en se basant sur les données de la ressource AWS S3 nommé <code>s3_demo_data_uc/dbx_logs/account</code></li><li>Partage <code>share_aws_dbx</code> : Enveloppe logique permettant d&rsquo;organiser et gérer les objets partagés<ul><li>L&rsquo;Alias du schéma <code>sch_share</code> permet de regrouper les objets des différents catalogues et schémas dans un seul schéma logique pour le partage des données</li><li>L&rsquo;Alias de la table <code>fct_trx_mng</code> permet de mettre à disposition les données de la table <code>fct_transactions_mng</code> sans avoir à communiquer le nom de table</li><li>L&rsquo;Alias de la table <code>fct_trx_ext</code> permet de mettre à disposition les données de la table <code>fct_transactions_ext</code> sans avoir à communiquer le nom de la table</li></ul></li><li>Destinataire <code>rcp_azure_dbx</code> : Object permettant aux utilisateurs du Metastore Unity Catalog Azure d&rsquo;accéder aux données du partage <code>share_aws_dbx</code></li><li>Destinataire <code>rcp_open_all</code> : Object permettant aux utilisateurs n&rsquo;utilisant pas de Metastore Unity Catalog d&rsquo;accéder aux données du partage <code>share_aws_dbx</code></li></ul><p>Concernant les éléments sur Azure :
Schématisation de l&rsquo;ensemble des éléments que nous allons mettre en place et utilisés sur le Metastore Unity Catalog sur Azure :
<a href=/blog/web/20230521_blog_article_unity_catalog_dela_sharing_23.png><img src=/blog/web/20230521_blog_article_unity_catalog_dela_sharing_23.png alt=schema_23></a></p><p>Liste des éléments :</p><ul><li>Metastore <code>metastore-az</code>: Metastore principal au niveau de l&rsquo;Account Databricks Azure</li><li>Storage Credential <code>sc-metastore-az</code>: Information de connexion pour gérer les droits d&rsquo;accès à la ressource Azure ADLS Gen2 nommée <code>adls-dbx-metastore-uc</code></li><li>Catalogue <code>ctg_aws</code> : Enveloppe permettant de se synchroniser avec le partage <code>share_aws_dbx</code> et d&rsquo;avoir accès à l&rsquo;ensemble des éléments du schéma partagé <code>sch_share</code></li></ul><h2 id=variable-denvironnement>Variable d&rsquo;environnement</h2><p>Afin de faciliter la mise en place des différents éléments tout au long de cette découverte, nous allons mettre en place un certain nombre de variables d&rsquo;environnements pour l&rsquo;utilisation de Databricks REST API.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4># Alias using the netrc file from databricks</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#8be9fd;font-style:italic>alias</span> dbx-api<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#39;curl --netrc-file ~/.databricks/.netrc&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#6272a4>########################################</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#6272a4>############# AWS ######################</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#6272a4>########################################</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#6272a4># Url for Account Access</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>DBX_API_ACCOUNT_URL</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;https://accounts.cloud.databricks.com&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#6272a4># Url for Workspace Access</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;&lt;Workspace Databricks AWS URL&gt;&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#6272a4># Account ID</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>DBX_ACCOUNT_ID</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;&lt;Account Databricks ID&gt;&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#6272a4># AWS Metastore Name</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>DBX_METASTORE_NAME</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;metastore-sandbox&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#6272a4># AWS Share Name</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>DBX_SHARE_NAME</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;share_aws_dbx&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#6272a4># AWS Provider Name</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>DBX_PROVIDER_NAME</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;dbx_aws_sharing&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#6272a4># AWS Recipient for Databricks to Databricks Sharing</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>DBX_RECIPIENT_DBX</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;rcp_azure_dbx&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#6272a4># AWS Recipient for Open Sharing</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>DBX_RECIPIENT_OPEN</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;rcp_open_all&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span><span style=color:#6272a4>########################################</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span><span style=color:#6272a4>############# Azure ####################</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span><span style=color:#6272a4>########################################</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span><span style=color:#6272a4># Name of the ADLS Gen2 Storage</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>AZ_ADLS2_NAME</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;adls-dbx-metastore-uc&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span><span style=color:#6272a4># Name of the Container in the ADLS Gen2 Storage</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>AZ_ADLS2_CONTAINER_NAME</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;metastoredbx&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span><span style=color:#6272a4># Name of the Resource Group</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>AZ_RG_NAME</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;&lt;Azure Resource Group Name&gt;&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span><span style=color:#6272a4># Region</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>AZ_REGION</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;francecentral&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span><span style=color:#6272a4># Tags</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>AZ_TAGS</span><span style=color:#ff79c6>=(</span><span style=color:#f1fa8c>&#34;owner=john&#34;</span> <span style=color:#f1fa8c>&#34;project=databricks&#34;</span> <span style=color:#f1fa8c>&#34;TTL=7&#34;</span> <span style=color:#f1fa8c>&#34;environment=demo&#34;</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span><span style=color:#6272a4># Azure Databricks Access Connector Name</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>AZ_DBX_CONNECTOR_NAME</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;DBXAccessConnectorUC&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span><span style=color:#6272a4># Azure Workspace Databricks URL</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>DBX_AZ_API_URL</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;&lt;Azure Workspace Databricks URL&gt;&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span><span style=color:#6272a4># Azure Workspace Databricks ID</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>DBX_AZ_WORKSPACE_ID</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;&lt;Azure Workspace Databricks ID&gt;&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span><span style=color:#6272a4># Azure Metastore Name</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>DBX_AZ_METASTORE_NAME</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;metastore-az&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span><span style=color:#6272a4># Azure Storage Credential Name</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>DBX_AZ_METASTORE_SC_NAME</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;sc-metastore-az&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span><span style=color:#6272a4># Azure Metastore ADLS Gen2 Path</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>DBX_AZ_ADLS2_METASTORE_PATH</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_ADLS2_CONTAINER_NAME</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>@</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_ADLS2_NAME</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>.dfs.core.windows.net/</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_ADLS2_CONTAINER_NAME</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span>
</span></span></code></pre></div><h2 id=mise-en-place-dun-jeu-de-données-sur-la-ressource-aws-s3>Mise en place d&rsquo;un jeu de données sur la ressource AWS S3</h2><p>Contenu du fichier <code>fct_transactions.csv</code> :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>id_trx,ts_trx,id_product,id_shop,id_client,quantity
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>1,2023-04-01 09:00:00,1,2,1,1
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>2,2023-04-01 11:00:00,1,1,1,3
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>3,2023-04-03 14:00:00,1,2,1,1
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>4,2023-04-05 08:00:00,3,1,2,9
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>5,2023-04-06 10:00:00,1,2,1,3
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>6,2023-04-06 12:00:00,2,2,1,1
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>7,2023-04-10 18:30:00,2,1,2,11
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9</span><span>8,2023-04-10 18:30:00,3,1,2,2
</span></span></code></pre></div><p>Réalisation de la copie des données vers le répertoire <code>demo</code>de la ressource AWS S3 nommée <code>s3-demo-data-uc</code> avec l&rsquo;outil AWS CLI:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>aws s3 cp fct_transactions.csv s3://s3-demo-data-uc/demo/fct_transactions.csv 
</span></span></code></pre></div><h2 id=mise-en-place-des-objets-dans-le-metastore-unity-catalog-aws>Mise en place des objets dans le Metastore Unity Catalog (AWS)</h2><ol><li>Création des Catalogues</li></ol><ul><li><code>ctg_mng</code> : Catalogue permettant de gérer les éléments managés par Unity Catalog</li><li><code>ctg_ext</code> : Catalogue permettant de gérer les éléments externes</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>-- Create Catalog (for managed data)
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>CATALOG</span> <span style=color:#ff79c6>IF</span> <span style=color:#ff79c6>NOT</span> <span style=color:#ff79c6>EXISTS</span> ctg_mn
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>    <span style=color:#ff79c6>COMMENT</span> <span style=color:#f1fa8c>&#39;Catalog for managed data&#39;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#6272a4>-- Create Catalog (for external data)
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>CATALOG</span> <span style=color:#ff79c6>IF</span> <span style=color:#ff79c6>NOT</span> <span style=color:#ff79c6>EXISTS</span> ctg_ext
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>    <span style=color:#ff79c6>COMMENT</span> <span style=color:#f1fa8c>&#39;Catalog for external data&#39;</span>;
</span></span></code></pre></div><ol start=2><li>Création des schémas
La liste des schémas est la suivante :</li></ol><ul><li><code>ctg_ext.sch_ext</code> : Schéma permettant de regrouper les tables externes</li><li><code>ctg_mng.sch_mng</code> : Schéma permettant de stocker les données managées</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>-- Create Schema for external data
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>SCHEMA</span> <span style=color:#ff79c6>IF</span> <span style=color:#ff79c6>NOT</span> <span style=color:#ff79c6>EXISTS</span> ctg_ext.sch_ext
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>    <span style=color:#ff79c6>COMMENT</span> <span style=color:#f1fa8c>&#39;Schema for external data&#39;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#6272a4>-- Create Schema for managed data
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>SCHEMA</span> <span style=color:#ff79c6>IF</span> <span style=color:#ff79c6>NOT</span> <span style=color:#ff79c6>EXISTS</span> ctg_mng.sch_mng
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>    <span style=color:#ff79c6>COMMENT</span> <span style=color:#f1fa8c>&#39;Schema for managed Data&#39;</span>;
</span></span></code></pre></div><ol start=3><li>Création des tables</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>-- External table
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>TABLE</span> ctg_ext.sch_ext.fct_transactions_csv (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    id_trx <span style=color:#8be9fd;font-style:italic>integer</span> <span style=color:#ff79c6>not</span> <span style=color:#ff79c6>null</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    ,ts_trx <span style=color:#ff79c6>timestamp</span> <span style=color:#ff79c6>not</span> <span style=color:#ff79c6>null</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    ,id_product <span style=color:#8be9fd;font-style:italic>integer</span> <span style=color:#ff79c6>not</span> <span style=color:#ff79c6>null</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    ,id_shop <span style=color:#8be9fd;font-style:italic>integer</span> <span style=color:#ff79c6>not</span> <span style=color:#ff79c6>null</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    ,id_client <span style=color:#8be9fd;font-style:italic>integer</span> <span style=color:#ff79c6>not</span> <span style=color:#ff79c6>null</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    ,quantity <span style=color:#8be9fd;font-style:italic>integer</span> <span style=color:#ff79c6>not</span> <span style=color:#ff79c6>null</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#ff79c6>USING</span> CSV
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#ff79c6>OPTIONS</span> (path <span style=color:#f1fa8c>&#34;s3://s3-demo-data-uc/demo/fct_transactions.csv&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        <span style=color:#ff79c6>delimiter</span> <span style=color:#f1fa8c>&#34;,&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>        header <span style=color:#f1fa8c>&#34;true&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>        ;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#6272a4>-- External table with Change data feed activated
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>TABLE</span> ctg_ext.sch_ext.fct_transactions_ext (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    id_trx <span style=color:#8be9fd;font-style:italic>integer</span> <span style=color:#ff79c6>not</span> <span style=color:#ff79c6>null</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    ,ts_trx <span style=color:#ff79c6>timestamp</span> <span style=color:#ff79c6>not</span> <span style=color:#ff79c6>null</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>    ,id_product <span style=color:#8be9fd;font-style:italic>integer</span> <span style=color:#ff79c6>not</span> <span style=color:#ff79c6>null</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>    ,id_shop <span style=color:#8be9fd;font-style:italic>integer</span> <span style=color:#ff79c6>not</span> <span style=color:#ff79c6>null</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>    ,id_client <span style=color:#8be9fd;font-style:italic>integer</span> <span style=color:#ff79c6>not</span> <span style=color:#ff79c6>null</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>    ,quantity <span style=color:#8be9fd;font-style:italic>integer</span> <span style=color:#ff79c6>not</span> <span style=color:#ff79c6>null</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>    ,ts_tech <span style=color:#ff79c6>timestamp</span> <span style=color:#ff79c6>not</span> <span style=color:#ff79c6>null</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span><span style=color:#ff79c6>LOCATION</span> <span style=color:#f1fa8c>&#39;s3://s3-demo-data-uc/data/fct_transactions_delta&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span><span style=color:#ff79c6>COMMENT</span> <span style=color:#f1fa8c>&#39;External Delta Table for Transaction Data&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>TBLPROPERTIES (delta.enableChangeDataFeed <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>true</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span><span style=color:#6272a4>-- Managed table with column partition (id_client)
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>TABLE</span> ctg_mng.sch_mng.fct_transactions_mng (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>    id_trx <span style=color:#8be9fd;font-style:italic>integer</span> <span style=color:#ff79c6>not</span> <span style=color:#ff79c6>null</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>    ,ts_trx <span style=color:#ff79c6>timestamp</span> <span style=color:#ff79c6>not</span> <span style=color:#ff79c6>null</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>    ,id_product <span style=color:#8be9fd;font-style:italic>integer</span> <span style=color:#ff79c6>not</span> <span style=color:#ff79c6>null</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>    ,id_shop <span style=color:#8be9fd;font-style:italic>integer</span> <span style=color:#ff79c6>not</span> <span style=color:#ff79c6>null</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>    ,id_client <span style=color:#8be9fd;font-style:italic>integer</span> <span style=color:#ff79c6>not</span> <span style=color:#ff79c6>null</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>    ,quantity <span style=color:#8be9fd;font-style:italic>integer</span> <span style=color:#ff79c6>not</span> <span style=color:#ff79c6>null</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>    ,ts_tech <span style=color:#ff79c6>timestamp</span> <span style=color:#ff79c6>not</span> <span style=color:#ff79c6>null</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>PARTITIONED <span style=color:#ff79c6>BY</span> (id_client)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span><span style=color:#ff79c6>COMMENT</span> <span style=color:#f1fa8c>&#39;Managed Data Table for Transaction Data&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>;
</span></span></code></pre></div><ol start=4><li>Alimentation des tables</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>-- Truncate table
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>DELETE</span> <span style=color:#ff79c6>FROM</span> ctg_ext.sch_ext.fct_transactions_ext;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#ff79c6>DELETE</span> <span style=color:#ff79c6>FROM</span> ctg_mng.sch_mng.fct_transactions_mng;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#6272a4>-- Add data in the external table
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>INSERT</span> <span style=color:#ff79c6>INTO</span> ctg_ext.sch_ext.fct_transactions_ext (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    id_trx
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    ,ts_trx
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    ,id_product
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    ,id_shop
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    ,id_client
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    ,quantity
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    ,ts_tech
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#ff79c6>SELECT</span> id_trx
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    ,ts_trx
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    ,id_product
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    ,id_shop
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    ,id_client
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    ,quantity
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>    ,<span style=color:#ff79c6>current_timestamp</span>() <span style=color:#ff79c6>as</span> ts_tech
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#ff79c6>FROM</span> ctg_ext.sch_ext.fct_transactions_csv;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span><span style=color:#6272a4>-- Add data in the managed table 
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>INSERT</span> <span style=color:#ff79c6>INTO</span> ctg_mng.sch_mng.fct_transactions_mng (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>    id_trx
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>    ,ts_trx
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>    ,id_product
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>    ,id_shop
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>    ,id_client
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>    ,quantity
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>    ,ts_tech
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span><span style=color:#ff79c6>SELECT</span> id_trx
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>    ,ts_trx
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>    ,id_product
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>    ,id_shop
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>    ,id_client
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>    ,quantity
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>    ,<span style=color:#ff79c6>current_timestamp</span>() <span style=color:#ff79c6>as</span> ts_tech
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span><span style=color:#ff79c6>FROM</span> ctg_ext.sch_ext.fct_transactions_csv;
</span></span></code></pre></div><h2 id=création-dun-notebook-pour-pouvoir-le-partager>Création d&rsquo;un notebook pour pouvoir le partager</h2><p>Nous allons importer un notebook scala nommé <code>read_demo_data_nbk_scala</code> dans le répertoire <code>Shared</code> du Workspace Databricks AWS avec Databricks REST API :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>dbx-api -X POST <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.0/workspace/import -H <span style=color:#f1fa8c>&#39;Content-Type: application/json&#39;</span> -d <span style=color:#f1fa8c>&#34;{ 
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#f1fa8c>    \&#34;path\&#34;: \&#34;/Shared/read_demo_data_nbk_scala\&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#f1fa8c>    \&#34;content\&#34;: \&#34;Ly8gRGF0YWJyaWNrcyBub3RlYm9vayBzb3VyY2UKdmFsIGRmID0gc3BhcmsudGFibGUoImN0Z19tbnQuc2NoX21uZy5mY3RfdHJhbnNhY3Rpb25zX21uZyIpCgovLyBDT01NQU5EIC0tLS0tLS0tLS0KCmRpc3BsYXkoZGYp\&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#f1fa8c>    \&#34;language\&#34;: \&#34;SCALA\&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#f1fa8c>    \&#34;overwrite\&#34;: \&#34;true\&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#f1fa8c>    \&#34;format\&#34;:\&#34;SOURCE\&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span><span style=color:#f1fa8c>}&#34;</span>
</span></span></code></pre></div><p>Contenu du notebook importé :
<a href=/blog/web/20230521_blog_article_unity_catalog_dela_sharing_01.png><img src=/blog/web/20230521_blog_article_unity_catalog_dela_sharing_01.png alt=schema_01></a></p><h1 id=configuration-des-logs-daudit-sur-le-metastore>Configuration des Logs d&rsquo;audit sur le Metastore</h1><p>Nous allons commencer par la configuration des logs d&rsquo;audit afin de pouvoir garder la trace de l&rsquo;ensemble des évènements liés au Metastore Unity Catalog dans le cadre du Delta Sharing.</p><p>Il est possible de capturer l&rsquo;ensemble des évènements au niveau de l&rsquo;Account Databricks ou au niveau de chaque Workspace Databricks.
Dans notre cas, nous allons nous intéresser à l&rsquo;Account Databricks car c&rsquo;est à ce niveau que les évènements liés au Metastore Unity Catalog sont capturés.</p><p>Pour cette démonstration, nous allons nous intéresser uniquement aux évènements concernant les requêtes des destinataires (Recipient) sur les objets partagés mais les logs d&rsquo;audit contiennent beaucoup plus d&rsquo;informations.</p><p>Objectifs :</p><ul><li>Nous souhaitons capturer les logs d&rsquo;audit dans la ressource AWS S3 nommée <code>s3-demo-data-uc/dbx_logs</code></li><li>Nous ne souhaitons pas filtrer d&rsquo;identifiant de Workspace Databricks afin de capturer l&rsquo;ensemble des logs d&rsquo;audit proposés par Databricks</li></ul><p>Vous devez suivre les étapes suivantes : (en s&rsquo;appuyant sur la <a href=https://docs.databricks.com/administration-guide/account-settings/audit-logs.html#configure-audit-log-delivery>documentation officielle</a>)</p><ol><li>Création d&rsquo;un rôle AWS IAM et d&rsquo;une politique AWS IAM pour que Databricks puisse accéder (et écrire) dans la ressource AWS S3 nommée <code>s3-demo-data-uc/dbx_logs</code></li><li>Création d&rsquo;un Credential Databricks au niveau de l&rsquo;Account Databricks pour stocker les informations de connexion (rôle AWS IAM créé)</li><li>Création d&rsquo;un Storage Databricks au niveau de l&rsquo;Account Databricks pour stocker le chemin de la ressource AWS S3 nommée <code>dbx_logs</code></li><li>Création de la configuration de log au niveau de l&rsquo;Account Databricks en se basant sur le Credential Databricks et le Storage Databricks</li></ol><h1 id=activation-du-delta-sharing-sur-le-metastore>Activation du Delta Sharing sur le Metastore</h1><p>La gestion (création et suppression) des partages (Share) ne nécessite pas l&rsquo;activation de la fonctionnalité Delta Sharing sur le Metastore.
L&rsquo;activation de la fonctionnalité Delta Sharing est obligatoire uniquement lorsque l&rsquo;on veut gérer les destinataires (Recipient) et configurer l&rsquo;accès aux objets partagés.</p><p>Pour activer cette fonctionnalité, il faut réaliser l&rsquo;action suivante :</p><ol><li>Mise à jour de la configuration du Metastore avec les informations suivantes :<ul><li>L&rsquo;information <code>delta_sharing_scope</code> doit être valorisée avec la valeur <code>INTERNAL_AND_EXTERNAL</code><ul><li>La valeur <code>INTERNAL</code> signifie que la fonctionnalité est désactivée</li></ul></li><li>L&rsquo;information <code>delta_sharing_recipient_token_lifetime_in_seconds</code> doit être valorisée avec le nombre de seconde de validité du Token Databricks (par exemple avec la valeur <code>86400</code> pour une journée)<ul><li>Le destinataire utilisant un Token Databricks pourra accéder aux objets partagés uniquement durant le temps de validité du Token Databricks</li></ul></li><li>L&rsquo;information <code>delta_sharing_organization_name</code> doit être valorisée avec le nom représentant votre organisation en tant que fournisseur (Provider) (par exemple : <code>dbx_aws_sharing</code>)<ul><li>C&rsquo;est le nom que les destinataires (Recipient), utilisant Databricks, verront comme fournisseur (Provider) du partage (Share)</li></ul></li></ul></li></ol><p>Réalisation de l&rsquo;action avec Databricks REST API :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4># Get the Metastore ID (databricks)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>TMP_DBX_METASTORE_ID</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>`</span>dbx-api -X GET <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.1/unity-catalog/metastores | jq -r <span style=color:#f1fa8c>&#39;.metastores[]|select(.name==$ENV.DBX_METASTORE_NAME)|.metastore_id&#39;</span><span style=color:#f1fa8c>`</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#6272a4># Update the Metastore configuration to activate Delta Sharing (external)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>dbx-api -X PATCH <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.1/unity-catalog/metastores/<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>TMP_DBX_METASTORE_ID</span><span style=color:#f1fa8c>}</span> -H <span style=color:#f1fa8c>&#39;Content-Type: application/json&#39;</span> -d <span style=color:#f1fa8c>&#34;{
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#f1fa8c>    \&#34;delta_sharing_scope\&#34;: \&#34;INTERNAL_AND_EXTERNAL\&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span><span style=color:#f1fa8c>    \&#34;delta_sharing_recipient_token_lifetime_in_seconds\&#34;: \&#34;86400\&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span><span style=color:#f1fa8c>    \&#34;delta_sharing_organization_name\&#34;: \&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_PROVIDER_NAME</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>\&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9</span><span><span style=color:#f1fa8c>}&#34;</span>
</span></span></code></pre></div><h1 id=création-dun-partage-share-sur-le-metastore>Création d&rsquo;un partage (Share) sur le Metastore</h1><p>La création d&rsquo;un partage (Share) peut se faire avec Databricks REST API ou directement avec des commandes SQL.</p><p>La création d&rsquo;un partage (Share) nécessite les droits suivants sur le Metastore :</p><ul><li>Droit de création des objets Share sur le Metastore</li><li>Droit d&rsquo;utilisation des catalogs et schémas contenant les données à partager</li><li>Droit de lecture des tables contenant les données à partager</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>GRANT</span> CREATE_SHARE <span style=color:#ff79c6>ON</span> METASTORE <span style=color:#ff79c6>TO</span> grp_demo;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#ff79c6>GRANT</span> USE, USE <span style=color:#ff79c6>SCHEMA</span>, <span style=color:#ff79c6>SELECT</span> <span style=color:#ff79c6>ON</span> <span style=color:#ff79c6>CATALOG</span> ctg_mng <span style=color:#ff79c6>TO</span> grp_demo;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#ff79c6>GRANT</span> USE, USE <span style=color:#ff79c6>SCHEMA</span>, <span style=color:#ff79c6>SELECT</span> <span style=color:#ff79c6>ON</span> <span style=color:#ff79c6>CATALOG</span> ctg_ext <span style=color:#ff79c6>TO</span> grp_demo;
</span></span></code></pre></div><p>La création du partage (Share) permet de définir l&rsquo;ensemble des données à partager :</p><ol><li>Créer le partage (Share) <code>share_aws_dbx</code> au niveau du Metastore Unity Catalog</li><li>Ajouter la table <code>ctg_ext.sch_ext.fct_transactions_ext</code> en utilisant l&rsquo;alias <code>sch_share.fct_trx_ext</code><ol><li>Activer le Change Data Feed dans le partage de données (option <code>cdf_enable : true</code>)</li><li>Autoriser l&rsquo;accès à partir de la version n°0 de l&rsquo;historique des données (option <code>start_version : 0</code>)</li></ol></li><li>Ajouter la table <code>ctg_mng.sch_mng.fct_transactions_mng</code> en utilisant l&rsquo;alias <code>sch_share.fct_trx_mng</code><ol><li>Autoriser l&rsquo;accès uniquement à la dernière version des données (pas d&rsquo;accès à l&rsquo;historique) (option <code>history_data_sharing_status : false</code>)</li><li>Ajouter une gestion des partitions pour n&rsquo;autoriser l&rsquo;accès aux données uniquement pour la partition (id_client) qui est égale à la valeur de la propriété nommée <code>ìd_client</code> associé au destinataire (Recipient) lors de sa création. (Chaque destinataire aura une valeur différente pour la propriété <code>id_client</code> afin de mettre en évidence cette stratégie d&rsquo;accès qui ne pourra pas être contourné par le destinataire)</li></ol></li><li>Ajouter le notebook <code>/Shared/read_demo_data_nbk_scala</code> dans le partage (Share) manuellement (l&rsquo;API ne fonctionnait pas lors de nos tests)</li></ol><p>Utilisation de Databricks REST API :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4># 1. Create share</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>dbx-api -X POST -H <span style=color:#f1fa8c>&#39;Content-Type: application/json&#39;</span> <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.1/unity-catalog/shares -d <span style=color:#f1fa8c>&#34;{\&#34;name\&#34;: \&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_SHARE_NAME</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>\&#34;, \&#34;comment\&#34;: \&#34;Share DBX AWS Data\&#34;}&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#6272a4># 2. Add table ctg_ext.sch_ext.fct_transactions_ext</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>dbx-api -X PATCH <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.1/unity-catalog/shares/share_aws_dbx -H <span style=color:#f1fa8c>&#39;Content-Type: application/json&#39;</span> -d <span style=color:#f1fa8c>&#39;{&#34;updates&#34;: [
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#f1fa8c>    {&#34;action&#34;: &#34;ADD&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#f1fa8c>    ,&#34;data_object&#34;: {
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#f1fa8c>        &#34;name&#34;: &#34;ctg_ext.sch_ext.fct_transactions_ext&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#f1fa8c>        &#34;data_object_type&#34;: &#34;TABLE&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#f1fa8c>        &#34;shared_as&#34;: &#34;sch_share.fct_trx_ext&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#f1fa8c>        &#34;cdf_enabled&#34;: true,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#f1fa8c>        &#34;start_version&#34;: 0,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#f1fa8c>        &#34;status&#34;: &#34;ACTIVE&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#f1fa8c>        }
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#f1fa8c>    }
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#f1fa8c>    ]
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#f1fa8c>}&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#6272a4># 3. Add table ctg_mng.sch_mng.fct_transactions_mng</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>dbx-api -X PATCH <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.1/unity-catalog/shares/share_aws_dbx -H <span style=color:#f1fa8c>&#39;Content-Type: application/json&#39;</span> -d <span style=color:#f1fa8c>&#39;{&#34;updates&#34;: [
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#f1fa8c>    {&#34;action&#34;: &#34;ADD&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span><span style=color:#f1fa8c>    ,&#34;data_object&#34;: {
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span><span style=color:#f1fa8c>        &#34;name&#34;: &#34;ctg_mng.sch_mng.fct_transactions_mng&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span><span style=color:#f1fa8c>        &#34;data_object_type&#34;: &#34;TABLE&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span><span style=color:#f1fa8c>        &#34;shared_as&#34;: &#34;sch_share.fct_trx_mng&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span><span style=color:#f1fa8c>        &#34;history_data_sharing_status&#34;: &#34;DISABLED&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span><span style=color:#f1fa8c>        &#34;status&#34;: &#34;ACTIVE&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span><span style=color:#f1fa8c>        &#34;partitions&#34;: [
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span><span style=color:#f1fa8c>        {
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span><span style=color:#f1fa8c>          &#34;values&#34;: [
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span><span style=color:#f1fa8c>            {
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span><span style=color:#f1fa8c>              &#34;name&#34;: &#34;id_client&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span><span style=color:#f1fa8c>              &#34;recipient_property_key&#34;: &#34;id_client&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span><span style=color:#f1fa8c>              &#34;op&#34;: &#34;EQUAL&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span><span style=color:#f1fa8c>            }
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span><span style=color:#f1fa8c>          ]
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span><span style=color:#f1fa8c>        }
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span><span style=color:#f1fa8c>        ]
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span><span style=color:#f1fa8c>        }
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span><span style=color:#f1fa8c>    }
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span><span style=color:#f1fa8c>    ]
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span><span style=color:#f1fa8c>}&#39;</span>
</span></span></code></pre></div><p>Utilisation des commandes SQL :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>-- 1. Create share
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>SHARE</span> <span style=color:#ff79c6>IF</span> <span style=color:#ff79c6>NOT</span> <span style=color:#ff79c6>EXISTS</span> share_aws_dbx <span style=color:#ff79c6>COMMENT</span> <span style=color:#f1fa8c>&#39;Share DBX AWS Data&#39;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#6272a4>-- 2. Add table ctg_ext.sch_ext.fct_transactions_ext
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#6272a4>-- With alias sch_share.fct_trx_ext
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#6272a4>-- With Change Data Feed and Historical Data
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>ALTER</span> <span style=color:#ff79c6>SHARE</span> share_aws_dbx
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#ff79c6>ADD</span> <span style=color:#ff79c6>TABLE</span> ctg_ext.sch_ext.fct_transactions_ext
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#ff79c6>COMMENT</span> <span style=color:#f1fa8c>&#39;Shared External Transactions data&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#ff79c6>AS</span> <span style=color:#f1fa8c>&#39;sch_share.fct_trx_ext&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#ff79c6>WITH</span> HISTORY;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#ff79c6>#</span> <span style=color:#bd93f9>3</span>. <span style=color:#ff79c6>Add</span> <span style=color:#ff79c6>table</span> ctg_mng.sch_mng.fct_transactions_mng
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#6272a4>-- With a specific rule on partition
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#6272a4>-- With alias sch_share.fct_trx_mng
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#6272a4>-- Without historical data (delta)
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>ALTER</span> <span style=color:#ff79c6>SHARE</span> share_aws_dbx
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#ff79c6>ADD</span> <span style=color:#ff79c6>TABLE</span> ctg_mng.sch_mng.fct_transactions_mng 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    <span style=color:#ff79c6>COMMENT</span> <span style=color:#f1fa8c>&#39;Shared Managed Transactions data&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    <span style=color:#ff79c6>AS</span> <span style=color:#f1fa8c>&#39;sch_share.fct_trx_mng&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>    PARTITION (id_client <span style=color:#ff79c6>=</span> CURRENT_RECIPIENT().id_client)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>    <span style=color:#ff79c6>WITHOUT</span> HISTORY;
</span></span></code></pre></div><p>Pour l&rsquo;étape n°4 de création du notebook, il n&rsquo;est pas possible de le faire directement avec les commandes SQL et nous n&rsquo;avons pas réussi à le faire en utilisant Databricks REST API, par conséquent nous allons le faire manuellement en utilisant Data Explorer :</p><ol><li>Allez sur <code>Workspace Databricks page > Data > Delta Sharing > Shared by me</code></li><li>Cliquez sur le partage (Share) souhaité <code>share_aws_dbx</code></li><li>Cliquez sur <code>Manage assets</code> et sélectionnez l&rsquo;option <code>Add notebook file</code></li><li>Renseignez l&rsquo;information <code>Notebook file</code> avec le chemin et le nom du fichier à partager <code>/Shared/read_demo_data_nbk_scala</code></li><li>Renseignez l&rsquo;information <code>Share as</code> avec le nom que vous voulez afficher dans le partage pour le notebook <code>shared_nbk</code></li></ol><p>Résultat de la création et de l&rsquo;ajout des éléments dans le Share :
<a href=/blog/web/20230521_blog_article_unity_catalog_dela_sharing_02.png><img src=/blog/web/20230521_blog_article_unity_catalog_dela_sharing_02.png alt=schema_02></a></p><h1 id=partage-des-données-avec-un-metastore-unity-catalog-sur-azure>Partage des données avec un Metastore Unity Catalog sur Azure</h1><p>Le fait de partager des données entre deux Metastore Unity Catalog est nommé &ldquo;Databricks-to-Databricks Sharing&rdquo;.</p><p>Pour réaliser ce partage Databricks-to-Databricks, nous allons utiliser un Metastore Unity Catalog sur un Account Databricks Azure dans la région France Central.
Pour rappel, le Metastore Unity Catalog principal (fournisseur) est sur un Account Databricks AWS dans la région eu-west-1 (Irlande)</p><h2 id=configuration-unity-catalog-sur-azure>Configuration Unity Catalog sur Azure</h2><p>Pour ce faire nous allons commencer par mettre en place un Metastore sur un Workspace Databricks sur Azure.</p><p>Pré-requis :</p><ul><li>Vous devez avoir installer l&rsquo;outil Azure CLI et configurez la connexion nécessaire à Azure</li><li>Vous devez avoir créé un Workspace Databricks dans un Ressource Groupe et votre compte doit avoir les droits d&rsquo;administration du Workspace Databricks.</li><li>Vous devez avoir les droits d&rsquo;administration de l&rsquo;Account Databricks Azure<ul><li>Ce droit peut être donné par un compte avec le rôle &ldquo;Azure AD Global Administrator&rdquo; en se connectant à l&rsquo;Account Databricks Azure</li></ul></li><li>Vous devez avoir les droits de créer les différentes ressources nécessaire dans un Ressource Groupe Azure</li></ul><p>Les étapes nécessaires pour mettre en place un Metastore Unity Catalog sur Azure sont les suivantes :</p><ol><li>Création d&rsquo;un stockage (ADLS Gen2 obligatoirement) dans la même région que le Metastore</li><li>Création d&rsquo;un connecteur d’accès Databricks</li><li>Assigne le connecteur d’accès Databricks avec le stockage créé</li><li>Création d&rsquo;un Metastore</li><li>Association du Metastore avec le Workspace Databricks</li><li>Création d&rsquo;un Credential Storage (pour la gestion des droits d&rsquo;accès)</li><li>Association du Credential Storage avec le Metastore</li></ol><p>Pour accélérer la démarche mais garder une approche pédagogique, nous allons utiliser Azure CLI et Databricks REST API pour réaliser les étapes :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4># 1. Create the ADLS GEN 2 storage for the Metastore</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4># BlobStorage Creation</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>az storage account create --name <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_ADLS2_NAME</span><span style=color:#f1fa8c>}</span> --resource-group <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_RG_NAME</span><span style=color:#f1fa8c>}</span> --access-tier Hot --kind StorageV2 --location <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_REGION</span><span style=color:#f1fa8c>}</span> --allow-blob-public-access <span style=color:#8be9fd;font-style:italic>false</span> --sku Standard_LRS --tags <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_TAGS</span><span style=color:#f1fa8c>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#6272a4># Remove useless features (blobstorage)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>az storage account blob-service-properties show --account-name <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_ADLS2_NAME</span><span style=color:#f1fa8c>}</span> --resource-group <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_RG_NAME</span><span style=color:#f1fa8c>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>az storage account blob-service-properties update --account-name <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_ADLS2_NAME</span><span style=color:#f1fa8c>}</span> --resource-group <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_RG_NAME</span><span style=color:#f1fa8c>}</span> --enable-change-feed <span style=color:#8be9fd;font-style:italic>false</span> --enable-delete-retention <span style=color:#8be9fd;font-style:italic>false</span> --enable-last-access-tracking <span style=color:#8be9fd;font-style:italic>false</span> --enable-restore-policy <span style=color:#8be9fd;font-style:italic>false</span> --enable-versioning <span style=color:#8be9fd;font-style:italic>false</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#6272a4># Remove useless features (filestorage)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>az storage account file-service-properties show --account-name <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_ADLS2_NAME</span><span style=color:#f1fa8c>}</span> --resource-group <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_RG_NAME</span><span style=color:#f1fa8c>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>az storage account file-service-properties update --account-name <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_ADLS2_NAME</span><span style=color:#f1fa8c>}</span> --resource-group <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_RG_NAME</span><span style=color:#f1fa8c>}</span> --enable-delete-retention <span style=color:#8be9fd;font-style:italic>false</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#6272a4># Activate ADLS Gen2</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>az storage account hns-migration start --type validation --name <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_ADLS2_NAME</span><span style=color:#f1fa8c>}</span> --resource-group <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_RG_NAME</span><span style=color:#f1fa8c>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>az storage account hns-migration start --type upgrade --name <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_ADLS2_NAME</span><span style=color:#f1fa8c>}</span> --resource-group <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_RG_NAME</span><span style=color:#f1fa8c>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#6272a4># Create a container in the ADLS Gen2 Storage</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>TMP_AZ_ADLS_KEY</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>`</span>az storage account keys list --account-name <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_ADLS2_NAME</span><span style=color:#f1fa8c>}</span> --resource-group <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_RG_NAME</span><span style=color:#f1fa8c>}</span> -o json | jq <span style=color:#f1fa8c>&#39;.[0]|.value&#39;</span><span style=color:#f1fa8c>`</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>az storage container create --name <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_ADLS2_CONTAINER_NAME</span><span style=color:#f1fa8c>}</span> --account-name <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_ADLS2_NAME</span><span style=color:#f1fa8c>}</span> --account-key <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>TMP_AZ_ADLS_KEY</span><span style=color:#f1fa8c>}</span> --public-access off --fail-on-exist
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#6272a4># 2. Create the databricks access-connector to manage access between Databricks and the ADLS2 Gen storage</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>az databricks access-connector create --name <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_DBX_CONNECTOR_NAME</span><span style=color:#f1fa8c>}</span> --resource-group <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_RG_NAME</span><span style=color:#f1fa8c>}</span> --location <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_REGION</span><span style=color:#f1fa8c>}</span> --identity-type SystemAssigned --tags <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_TAGS</span><span style=color:#f1fa8c>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span><span style=color:#6272a4># 3. Assign Storage Blob Data Contributor role to Databricks Access Connecter</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>TMP_AZ_ADLS_ID</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>`</span>az storage account show --name <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_ADLS2_NAME</span><span style=color:#f1fa8c>}</span> --resource-group <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_RG_NAME</span><span style=color:#f1fa8c>}</span> | jq -r <span style=color:#f1fa8c>&#39;.id&#39;</span><span style=color:#f1fa8c>`</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>TMP_AZ_DBX_CONNECTOR_PRINCIPAL_ID</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>`</span>az databricks access-connector show --resource-group <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_RG_NAME</span><span style=color:#f1fa8c>}</span> --name <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_DBX_CONNECTOR_NAME</span><span style=color:#f1fa8c>}</span> -o json | jq -r <span style=color:#f1fa8c>&#39;.identity.principalId&#39;</span><span style=color:#f1fa8c>`</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>az role assignment create --assignee-object-id <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>TMP_AZ_DBX_CONNECTOR_PRINCIPAL_ID</span><span style=color:#f1fa8c>}</span> --assignee-principal-type ServicePrincipal --role <span style=color:#f1fa8c>&#34;Storage Blob Data Contributor&#34;</span> --scope <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>TMP_AZ_ADLS_ID</span><span style=color:#f1fa8c>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span><span style=color:#6272a4># 4. Create the Metastore in Unity Catalog</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>dbx-api -X POST <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_AZ_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.1/unity-catalog/metastores -H <span style=color:#f1fa8c>&#39;Content-Type: application/json&#39;</span> -d <span style=color:#f1fa8c>&#34;{\&#34;name\&#34;:\&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_AZ_METASTORE_NAME</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>\&#34;, \&#34;region\&#34;: \&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_REGION</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>\&#34;, \&#34;storage_root\&#34;:\&#34;abfss://</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_AZ_ADLS2_METASTORE_PATH</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>\&#34;}&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span><span style=color:#6272a4># Get the Metastore ID</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>TMP_DBZ_AZ_METASTORE_ID</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>`</span>dbx-api -X GET <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_AZ_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.1/unity-catalog/metastores | jq -r <span style=color:#f1fa8c>&#39;.metastores[]|select(.name==$ENV.DBX_AZ_METASTORE_NAME)|.metastore_id&#39;</span><span style=color:#f1fa8c>`</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span><span style=color:#6272a4># 5. Assign the Metastore to the Workspace Databricks Azure</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span><span style=color:#6272a4># It&#39;s not possible to create the Storage Credential if the Metastore is not assigned to the Workspace Databricks</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>dbx-api -X PUT <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_AZ_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.1/unity-catalog/workspaces/<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_AZ_WORKSPACE_ID</span><span style=color:#f1fa8c>}</span>/metastore -H <span style=color:#f1fa8c>&#39;Content-Type: application/json&#39;</span> -d <span style=color:#f1fa8c>&#34;{\&#34;metastore_id\&#34;:\&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>TMP_DBZ_AZ_METASTORE_ID</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>\&#34;,\&#34;default_catalog_name\&#34;:\&#34;main\&#34;}&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span><span style=color:#6272a4># 6. Create the Storage Credential (for Unity Catalog)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span><span style=color:#6272a4># Get the databricks access connector id</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>TMP_AZ_DBX_CONNECTOR_ID</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>`</span>az databricks access-connector show --resource-group <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_RG_NAME</span><span style=color:#f1fa8c>}</span> --name <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_DBX_CONNECTOR_NAME</span><span style=color:#f1fa8c>}</span> -o json | jq -r <span style=color:#f1fa8c>&#39;.id&#39;</span><span style=color:#f1fa8c>`</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span><span style=color:#6272a4># Create the Storage Credential</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span>dbx-api -X POST -H <span style=color:#f1fa8c>&#39;Content-Type: application/json&#39;</span> <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_AZ_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.0/unity-catalog/storage-credentials --data <span style=color:#f1fa8c>&#34;{
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span><span style=color:#f1fa8c>  \&#34;name\&#34;: \&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_AZ_METASTORE_SC_NAME</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>\&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span><span style=color:#f1fa8c>  \&#34;comment\&#34;: \&#34;storage credential for the Metastore\&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span><span style=color:#f1fa8c>  \&#34;azure_managed_identity\&#34;: {
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span><span style=color:#f1fa8c>    \&#34;access_connector_id\&#34;: \&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>TMP_AZ_DBX_CONNECTOR_ID</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>\&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span><span style=color:#f1fa8c>  }
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span><span style=color:#f1fa8c>}&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57</span><span><span style=color:#6272a4># 7. Assign the Storage Credential to the Metastore</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58</span><span><span style=color:#6272a4># Get the Storage Credential id </span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>TMP_DBX_AZ_METASTORE_SC_ID</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>`</span>dbx-api -X GET <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_AZ_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.1/unity-catalog/storage-credentials | jq -r <span style=color:#f1fa8c>&#39;.storage_credentials[]|select(.name==$ENV.DBX_AZ_METASTORE_SC_NAME)|.id&#39;</span><span style=color:#f1fa8c>`</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61</span><span><span style=color:#6272a4># Update Metastore configuration with the Storage Credential</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62</span><span>dbx-api -X PATCH <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_AZ_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.1/unity-catalog/metastores/<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>TMP_DBZ_AZ_METASTORE_ID</span><span style=color:#f1fa8c>}</span> -H <span style=color:#f1fa8c>&#39;Content-Type: application/json&#39;</span> -d <span style=color:#f1fa8c>&#34;{\&#34;storage_root_credential_id\&#34;: \&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>TMP_DBX_AZ_METASTORE_SC_ID</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>\&#34;}&#34;</span>
</span></span></code></pre></div><p>Si la création du <code>Databricks Access Connector</code> (étape n°2) ne fonctionne pas avec l&rsquo;outil Azure CLI, vous pouvez le faire manuellement de la manière suivante :</p><ol><li>Allez sur <code>Microsoft Azure page > Resource Group</code></li><li>Cliquez sur le resource groupe souhaité</li><li>Cliquez sur <code>Create</code></li><li>Renseignez l&rsquo;information <code>Search the Marketplace</code> avec la valeur <code>access connector for azure databricks</code></li><li>Cliquez sur <code>Create > Access Connector for Azure Databricks</code></li><li>Cliquez sur <code>Create</code></li><li>Renseignez les informations <code>Subscription</code> , <code>Resource group</code>, <code>Name</code> et <code>Region</code> avec les valeurs souhaitées</li><li>Cliquez sur <code>Review + create</code></li><li>Cliquez sur <code>Create</code></li></ol><p>Note : concernant la ressource SQL Warehouse sur Azure, un SQL Warehouse 2X-Small nécessite d&rsquo;avoir une valeur de 8 au minimum pour le quota nommé <code>Total Regional Spot vCPUs</code></p><h2 id=mise-en-place-dun-destinataire-recipient-databricks-to-databricks>Mise en place d&rsquo;un destinataire (Recipient) Databricks-to-Databricks</h2><p>Afin de pouvoir partager les données avec un destinataire utilisant un Metastore Unity Catalog, nous devons réaliser les actions suivantes :</p><ol><li>Demander l&rsquo;identifiant de partage du Metastore Unity Catalog (sharing identifier) du destinataire (Recipient)</li><li>Créer un destinataire (Recipient) <code>rcp_azure_dbx</code> sur le Metastore Unity Catalog AWS du fournisseur (Provider) en utilisant l&rsquo;identifiant de partage (sharing identifier) communiqué correspondant au Metastore Unity Catalog Azure du destinaire (Recipient)</li><li>Donner les droits de lecture au destinataire (Recipient) <code>rcp_azure_dbx</code> sur les éléments du partage (Share) nommé <code>share_aws_dbx</code></li></ol><p>Détail des étapes :</p><ol><li>Demander l&rsquo;identifiant de partage du Metastore Unity Catalog (sharing identifier) du destinataire (Recipient)</li></ol><p>L&rsquo;identifiant de partage est une chaîne de caractères composées des informations suivantes : <code>&lt;Metastore Cloud Provider>:&lt;Metastore Region>:&lt;Metastore ID></code></p><p>Il existe plusieurs moyen d&rsquo;avoir cet identifiant pour le destinataire:</p><ul><li>Le 1er moyen (qui est le plus simple) est de se connecter sur le Worspace Databricks et d&rsquo;exécuter la commande <code>select current_metastore()</code> sur un SQL Warehouse (ou <code>spark.sql("select current_metastore()")</code> dans un notebook attaché à un cluster ayant les droits d&rsquo;accès à au Metastore Unity Catalog)</li><li>Le 2ème moyen est l&rsquo;utilisation de Databricks REST API</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4># Get Metastore Sharing ID</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>dbx-api -X GET <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_AZ_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.1/unity-catalog/metastores  | jq -r <span style=color:#f1fa8c>&#39;.metastores[]|select(.name==$ENV.DBX_AZ_METASTORE_NAME)|.cloud+&#34;:&#34;+.region+&#34;:&#34;+.metastore_id&#39;</span>
</span></span></code></pre></div><ul><li>Le 3ème moyen est d&rsquo;utiliser l&rsquo;outil Data Explorer<ol><li>Allez dans <code>Workspace Databricks page > Data > Delta Sharing > Shared with me</code></li><li>Cliquez sur <code>Copy sharing identifier</code></li></ol></li></ul><p>Une fois l&rsquo;identifiant de partage récupéré, il faut l&rsquo;envoyer au fournisseur (Provider) du partage (share).</p><ol start=2><li>Créer un destinataire (Recipient) <code>rcp_azure_dbx</code> sur le Metastore Unity Catalog AWS du fournisseur (Provider) en utilisant l&rsquo;identifiant de partage (sharing identifier) communiqué correspondant au Metastore Unity Catalog Azure du destinataire (Recipient)</li></ol><p>Remarque : Nous allons mettre en place une propriété <code>id_client : 1</code> pour utiliser les partitions de l&rsquo;objet partagé dont l&rsquo;alias est <code>sch_share.fct_trx_mng</code></p><p>La création d&rsquo;un destinaire (Recipient) nécessite les droits suivants sur le Metastore :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>GRANT</span> CREATE_RECIPIENT <span style=color:#ff79c6>ON</span> METASTORE <span style=color:#ff79c6>TO</span> grp_demo;
</span></span></code></pre></div><p>Pour créer un destinataire (Recipient) à partir de Databricks REST API :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4># Get the Azure Metastore Sharing Identifier</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>TMP_AZ_METASTORE_SHARING_ID</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>`</span>dbx-api -X GET <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_AZ_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.1/unity-catalog/metastores  | jq -r <span style=color:#f1fa8c>&#39;.metastores[]|select(.name==$ENV.DBX_AZ_METASTORE_NAME)|.cloud+&#34;:&#34;+.region+&#34;:&#34;+.metastore_id&#39;</span><span style=color:#f1fa8c>`</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#6272a4># Create Recipient for Databricks-to-Databricks Share</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>dbx-api -X POST <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.1/unity-catalog/recipients -H <span style=color:#f1fa8c>&#39;Content-Type: application/json&#39;</span> -d <span style=color:#f1fa8c>&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#f1fa8c>{
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#f1fa8c>      \&#34;name\&#34;: \&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_RECIPIENT_DBX</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>\&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#f1fa8c>      \&#34;authentication_type\&#34;: \&#34;DATABRICKS\&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#f1fa8c>      \&#34;data_recipient_global_metastore_id\&#34;: \&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>TMP_AZ_METASTORE_SHARING_ID</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>\&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#f1fa8c>      \&#34;properties_kvpairs\&#34;: {
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#f1fa8c>        \&#34;properties\&#34;: {\&#34;id_client\&#34;: \&#34;1\&#34;}
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#f1fa8c>      },
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#f1fa8c>      \&#34;comment\&#34; : \&#34;Recipient Databricks (share data between databricks metastore)\&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#f1fa8c>    }
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#f1fa8c>&#34;</span>
</span></span></code></pre></div><p>Pour créer un destinataire (Recipient) à partir des commandes SQL :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>-- A recipient created for Databricks to Databricks sharing with a id_client properties
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>CREATE</span> RECIPIENT rcp_azure_dbx
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#ff79c6>USING</span> ID <span style=color:#f1fa8c>&#39;&lt;Metastore Azure Sharing identifier&gt;&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>PROPERTIES ( id_client <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span><span style=color:#6272a4>-- To get the detail of the recipient
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>DESCRIBE</span> RECIPIENT rcp_azure_dbx;
</span></span></code></pre></div><ol start=3><li>Donner les droits de lecture au destinataire (Recipient) <code>rcp_azure_dbx</code> sur les éléments du partage (Share) nommé <code>share_aws_dbx</code></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>GRANT</span> <span style=color:#ff79c6>SELECT</span> <span style=color:#ff79c6>ON</span> <span style=color:#ff79c6>SHARE</span> share_aws_dbx <span style=color:#ff79c6>TO</span> RECIPIENT rcp_azure_dbx;
</span></span></code></pre></div><p>A partir de cette dernière étape, le destinataire (Recipient) <code>rcp_azure_dbx</code> pourra accéder aux objets du partage (Share) en utilisant sont Metastore Unity Catalog avec son Workspace Databricks Azure.</p><p>Note : Il faut parfois attendre quelques secondes ou minutes pour voir apparaître le nouveau fournisseur (Provider) nommé <code>dbx_aws_sharing</code> au niveau du Metastore Unity Catalog Azure après la création du destinataire (Recipient) <code>rcp_azure_dbx</code></p><p>Le résultat devrait être le suivant :
<a href=/blog/web/20230521_blog_article_unity_catalog_dela_sharing_03.png><img src=/blog/web/20230521_blog_article_unity_catalog_dela_sharing_03.png alt=schema_03></a></p><h2 id=accès-par-le-metastore-unity-catalog-azure>Accès par le Metastore Unity Catalog Azure</h2><p>Une fois le partage Databricks-to-Databricks mis en place, il faut qu&rsquo;un administrateur du Metastore Unity Catalog Azure puisse créer un catalogue en utilisant les informations du partage (Share) afin de pouvoir rendre accessible les objets du partage (Share) aux utilisateurs du Metastore.</p><p>Pour ce faire, il suffit uniquement d&rsquo;utiliser la commande SQL de création d&rsquo;un catalogue et de donner les droits d&rsquo;utilisation et de lecture sur le catalogue comme pour n&rsquo;importe quel autre catalogue du Metastore Unity Catalog.</p><p>La différence étant que les objets du catalogue liés au partage (Share) ne pourront être utilisés qu&rsquo;en lecture seule et les données sont stockées dans la ressource AWS S3 du fournisseur (Provider) et non pas dans la ressource Azure ADLS Gen2 du destinataire (Recipient)</p><p>Création du catalogue avec une commande SQL</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>CATALOG</span> <span style=color:#ff79c6>IF</span> <span style=color:#ff79c6>NOT</span> <span style=color:#ff79c6>EXISTS</span> ctg_aws
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#ff79c6>USING</span> <span style=color:#ff79c6>SHARE</span> <span style=color:#ff79c6>`</span>dbx_aws_sharing<span style=color:#ff79c6>`</span>.share_aws_dbx
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#ff79c6>COMMENT</span> <span style=color:#f1fa8c>&#39;Shared data from AWS Metastore&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>;
</span></span></code></pre></div><p>Remarque : Lors de la mise en place du partage Databricks-to-Databricks, il n&rsquo;y a pas besoin de partager d&rsquo;information de connexion entre les deux Metastore. Nous avons utilisé uniquement un identifiant de partage lié au Metastore du destinataire (Recipient), ce qui a pour effet de simplifier et sécuriser les échanges et la mise en place du partage (Share).</p><p>Exemple d&rsquo;accès aux données à partir d&rsquo;une requête sur un SQL Warehouse en passant par le Workspace Databricks Azure :</p><ol><li><p>Lorsque l&rsquo;on accède à l&rsquo;objet <code>sch_share.fct_trx_mng</code>, on ne voit que les informations dont la colonne <code>id_client</code> est égale à la valeur <code>1</code> car le destinataire n&rsquo;a le droit d&rsquo;accéder qu&rsquo;à cette partition des données comme défini par le fournisseur (Provider) lors de la création du destinataire (Recipient)
<a href=/blog/web/20230521_blog_article_unity_catalog_dela_sharing_04.png><img src=/blog/web/20230521_blog_article_unity_catalog_dela_sharing_04.png alt=schema_04></a></p></li><li><p>Lorsque que l&rsquo;on accède à l&rsquo;objet <code>sch_share.fct_trx_ext</code>, on peut voir l&rsquo;ensemble des données.
<a href=/blog/web/20230521_blog_article_unity_catalog_dela_sharing_05.png><img src=/blog/web/20230521_blog_article_unity_catalog_dela_sharing_05.png alt=schema_05></a></p></li></ol><p>Concernant l&rsquo;accès au notebook partagé :
Pour accéder au notebook <code>shared_nbk</code>, il faut utiliser l&rsquo;outil Data Explorer :</p><ol><li>Aller dans <code>Workspace Databricks page > Data</code></li><li>Sélectionner le catalogue (à partir des objets partagés)</li><li>Cliquez sur l&rsquo;onglet <code>Other assets</code></li><li>Cliquez sur le notebook souhaité</li></ol><p>Remarque : Vous ne pourrez voir que les cellules du notebook au format HTML en lecture seule et vous pourrez cloner le notebook dans votre Workspace Databricks.</p><p>Visualisation de la liste des notebooks partagés avec l&rsquo;outil Data Explorer
<a href=/blog/web/20230521_blog_article_unity_catalog_dela_sharing_06.png><img src=/blog/web/20230521_blog_article_unity_catalog_dela_sharing_06.png alt=schema_06></a></p><p>Visualisation du notebook <code>shared_nbk</code> avec l&rsquo;outil Data Explorer
<a href=/blog/web/20230521_blog_article_unity_catalog_dela_sharing_07.png><img src=/blog/web/20230521_blog_article_unity_catalog_dela_sharing_07.png alt=schema_07></a></p><h2 id=lecture-des-logs-daudits>Lecture des logs d&rsquo;audits</h2><p>Pour accéder plus facilement aux logs d&rsquo;audit, nous allons créer une table externe nommée <code>ctg_ext.sch_ext.audit_logs_json</code> basée sur le répertoire <code>s3://s3-demo-data-uc/dbx_logs/account</code> qui contient l&rsquo;ensemble des fichiers de logs au format JSON avec les informations des évènements liés à l&rsquo;Account Databricks (et aux différents Workspace Databricks).</p><p>Nous allons nous intéresser uniquement aux actions <code>deltaSharingQueriedTable</code> et <code>deltaSharingQueryTable</code> au niveau de l&rsquo;Account Databricks concernant le destinataire (Recipient) <code>rcp_azure_dbx</code> pour mettre en évidence quelques informations que nous pouvons récupérer facilement à partir des logs d&rsquo;audit pour suivre l&rsquo;accès aux objets partagés.</p><p>Les étapes sont les suivantes :</p><ol><li>Création de la table externe <code>ctg_ext.sch_ext.audit_logs_json</code> pour accéder facilement aux fichiers JSON de la ressource AWS S3 nommée <code>s3://s3-demo-data-uc/dbx_logs/account</code></li><li>Récupération des informations concernant les actions <code>deltaSharingQueryTable</code> pour le destinataire (Recipient) <code>rcp_azure_dbx</code></li><li>Récupération des informations concernant les actions <code>deltaSharingQueriedTable</code> pour le destinataire (Recipient) <code>rcp_azure_dbx</code></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>-- 1. Create ctg_ext.sch_ext.audit_logs_json from JSON files
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>TABLE</span> ctg_ext.sch_ext.audit_logs_json
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#ff79c6>USING</span> JSON
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#ff79c6>OPTIONS</span> (path <span style=color:#f1fa8c>&#34;s3://s3-demo-data-uc/dbx_logs/account&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#6272a4>-- 2. Get deltaSharingQueryTable action informations from rcp_azure_dbx recipient
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>select</span> requestId
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>,requestParams.recipient_name
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>,requestParams.<span style=color:#ff79c6>share</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>,requestParams.<span style=color:#ff79c6>schema</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>,requestParams.name
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>,requestParams.user_agent
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>,response.statusCode
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>,serviceName
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>,sourceIPAddress
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>,<span style=color:#8be9fd;font-style:italic>date</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#ff79c6>from</span> ctg_ext.sch_ext.audit_logs_json 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#ff79c6>where</span> actionName <span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#39;deltaSharingQueryTable&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#ff79c6>and</span> auditLevel <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;ACCOUNT_LEVEL&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#ff79c6>and</span> requestParams.recipient_name <span style=color:#ff79c6>in</span> (<span style=color:#f1fa8c>&#39;rcp_azure_dbx&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#ff79c6>order</span> <span style=color:#ff79c6>by</span> <span style=color:#ff79c6>timestamp</span> <span style=color:#ff79c6>asc</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span><span style=color:#6272a4>-- 3. Get deltaSharingQueriedTable action informations from rcp_azure_dbx recipient
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>select</span> requestId
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>,requestParams.recipient_name
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>,response.<span style=color:#ff79c6>result</span>:numRecords
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>,response.<span style=color:#ff79c6>result</span>:tableName
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>,response.<span style=color:#ff79c6>result</span>:deltaSharingPartitionFilteringAccessed
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>,serviceName
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>,sourceIPAddress
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>,userAgent
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span><span style=color:#ff79c6>from</span> ctg_ext.sch_ext.audit_logs_json 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span><span style=color:#ff79c6>where</span> actionName <span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#39;deltaSharingQueriedTable&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span><span style=color:#ff79c6>and</span> auditLevel <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;ACCOUNT_LEVEL&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span><span style=color:#ff79c6>and</span> requestParams.recipient_name <span style=color:#ff79c6>in</span> (<span style=color:#f1fa8c>&#39;rcp_azure_dbx&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span><span style=color:#ff79c6>order</span> <span style=color:#ff79c6>by</span> <span style=color:#ff79c6>timestamp</span> <span style=color:#ff79c6>asc</span>
</span></span></code></pre></div><p>Résultat de l&rsquo;étape n°2 concernant les actions <code>deltaSharingQueryTable</code> :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>requestId,recipient_name,share,schema,name,user_agent,statusCode,serviceName,sourceIPAddress
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>CgsI3ceeowYQhsLgAzoQSHf2V13IQFqodUiz6jKNJw==,rcp_azure_dbx,share_aws_dbx,sch_share,fct_trx_mng,Delta-Sharing-Unity-Catalog-Databricks-Auth/1.0 Linux/5.4.0-1107-azure-fips OpenJDK_64-Bit_Server_VM/11.0.18+10-jvmci-22.3-b13 java/11.0.18 scala/2.12.15 java_vendor/GraalVM_Community,200,unityCatalog,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>CgsI78eeowYQvvjMFjoQvIDzt07UQ3mzAJR99KJGpg==,rcp_azure_dbx,share_aws_dbx,sch_share,fct_trx_ext,Delta-Sharing-Unity-Catalog-Databricks-Auth/1.0 Linux/5.4.0-1107-azure-fips OpenJDK_64-Bit_Server_VM/11.0.18+10-jvmci-22.3-b13 java/11.0.18 scala/2.12.15 java_vendor/GraalVM_Community,200,unityCatalog,
</span></span></code></pre></div><p>Cette requête nous permet d&rsquo;accéder aux informations des demandes de requêtes exécutées sur les objets partagés (le nom du destinataire, le nom du partage, le nom du schéma, le nom de la table, etc &mldr;)</p><p>Résultat de la requête n°3 concernant les actions <code>deltaSharingQueriedTable</code> :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>requestId,recipient_name,numRecords,tableName,deltaSharingPartitionFilteringAccessed,serviceName,sourceIPAddress,userAgent
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>d8140290-4a65-44a2-aac0-31c7feaf4aac,rcp_azure_dbx,5,fct_trx_mng,true,unityCatalog,,Delta-Sharing-Unity-Catalog-Databricks-Auth/1.0 Linux/5.4.0-1107-azure-fips OpenJDK_64-Bit_Server_VM/11.0.18+10-jvmci-22.3-b13 java/11.0.18 scala/2.12.15 java_vendor/GraalVM_Community
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>854c0522-aaca-465c-8f7d-1684a003e8e1,rcp_azure_dbx,8,fct_trx_ext,false,unityCatalog,,Delta-Sharing-Unity-Catalog-Databricks-Auth/1.0 Linux/5.4.0-1107-azure-fips OpenJDK_64-Bit_Server_VM/11.0.18+10-jvmci-22.3-b13 java/11.0.18 scala/2.12.15 java_vendor/GraalVM_Community
</span></span></code></pre></div><p>Cette requête nous permet d&rsquo;accéder aux informations du résultat des requêtes exécutées sur les objets partagés.
On peut voir que la requête sur la table <code>fct_trx_mng</code> a l&rsquo;option <code>deltaSharingPartitionFilteringAccessed</code> activée et ne retourne que 5 lignes (ce qui correspond au filtre sur les partitions) et que la requête sur la table <code>fct_trx_ext</code> retourne 8 lignes.
On peut aussi avoir d&rsquo;autres informations comme l&rsquo;adresse ip, l&rsquo;agent de l&rsquo;outil qui a exécuté la requête (Databricks dans notre cas) et bien d&rsquo;autres informations.</p><h1 id=partage-des-données-en-open-sharing>Partage des données en Open Sharing</h1><p>Afin de pouvoir partager les données avec un destinataire n&rsquo;utilisant pas de Metastore Unity Catalog (nommé Open Sharing), nous devons réaliser les actions suivantes :</p><ol><li>Créer un destinataire (Recipient) <code>rcp_open_all</code> basé sur un Token Databricks (qui aura une durée de vie définie au niveau du Metastore)</li><li>Donner les droits de lecture au destinataire (Recipient) <code>rcp_open_all</code> sur les objets du partage (Share) <code>share_aws_dbx</code></li><li>Récupérer l&rsquo;URL d&rsquo;activation pour l&rsquo;envoyer au destinataire (Recipient) <code>rcp_open_all</code></li><li>Le destinataire (Recipient) doit se connecter à l&rsquo;URL indiquée et télécharger le fichier de configuration nommé <code>config.share</code> pour pouvoir se connecter au partage (Share) <code>share_aws_dbx</code> du fournisseur (Provider)</li></ol><p>Détail des étapes :</p><ol><li>Créer un destinataire (Recipient) <code>rcp_open_all</code> basé sur un Token Databricks</li></ol><p>Remarque : Nous allons mettre en place une propriété <code>id_client : 2</code> pour utiliser les partitions de l&rsquo;objet partagé dont l&rsquo;alias est <code>sch_share.fct_trx_mng</code></p><p>La création d&rsquo;un destinataire (Recipient) nécessite les droits suivants sur le Metastore :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>GRANT</span> CREATE_RECIPIENT <span style=color:#ff79c6>ON</span> METASTORE <span style=color:#ff79c6>TO</span> <span style=color:#f1fa8c>&#39;grp_demo&#39;</span>;
</span></span></code></pre></div><p>Pour créer un destinataire (Recipient) à partir de Databricks REST API :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4># Create Recipient for Token Open Sharing</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>dbx-api -X POST <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.1/unity-catalog/recipients -H <span style=color:#f1fa8c>&#39;Content-Type: application/json&#39;</span> -d <span style=color:#f1fa8c>&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#f1fa8c>{
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#f1fa8c>      \&#34;name\&#34;: \&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_RECIPIENT_OPEN</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>\&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#f1fa8c>      \&#34;authentication_type\&#34;: \&#34;TOKEN\&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#f1fa8c>      \&#34;properties_kvpairs\&#34;: {
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#f1fa8c>        \&#34;properties\&#34;: {\&#34;id_client\&#34;: \&#34;2\&#34;}
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#f1fa8c>      },
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#f1fa8c>      \&#34;comment\&#34;: \&#34;Give access to shared data for external tools\&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#f1fa8c>    }
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#f1fa8c>&#34;</span>
</span></span></code></pre></div><p>Pour créer un destinataire (Recipient) à partir des commandes SQL :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>-- A recipient created for sharing outside of Databricks with a id_client properties
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>CREATE</span> RECIPIENT rcp_open_all
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#ff79c6>COMMENT</span> <span style=color:#f1fa8c>&#39;Give access to shared data for external tools&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>PROPERTIES ( id_client <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>2</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>;
</span></span></code></pre></div><ol start=2><li>Donner les droits de lecture au destinataire (Recipient) <code>rcp_open_all</code> sur les objets du partage (Share) <code>share_aws_dbx</code></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>GRANT</span> <span style=color:#ff79c6>SELECT</span> <span style=color:#ff79c6>ON</span> <span style=color:#ff79c6>SHARE</span> share_aws_dbx <span style=color:#ff79c6>TO</span> RECIPIENT rcp_open_all;
</span></span></code></pre></div><ol start=3><li>Récupérer l&rsquo;URL d&rsquo;activation pour l&rsquo;envoyer au destinataire (Recipient) <code>rcp_open_all</code>
La récupération de l&rsquo;URL peut se faire en SQL avec la commande :</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>-- Get the activation url (activation_link parameter)
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>DESCRIBE</span> RECIPIENT rcp_open_all;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#6272a4>-- activation_link : https://ireland.cloud.databricks.com/delta_sharing/retrieve_config.html?XXXXXXXXXXXXX
</span></span></span></code></pre></div><p>La récupération de l&rsquo;URL peut aussi se faire avec Databricks REST API :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>dbx-api -X GET <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.1/unity-catalog/recipients/<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_RECIPIENT_OPEN</span><span style=color:#f1fa8c>}</span> | jq -r <span style=color:#f1fa8c>&#39;.tokens[0].activation_url&#39;</span>
</span></span></code></pre></div><ol start=4><li>Le destinataire (Recipient) doit se connecter à l&rsquo;URL indiquée et télécharger le fichier de configuration nommé <code>config.share</code> pour pouvoir se connecter au partage (Share) <code>share_aws_dbx</code> du fournisseur (Provider)</li></ol><p>Attention : Quelque soit la méthode utilisée, la récupération des informations de connexion ne pourra se faire qu&rsquo;une seule fois. Cela est géré par Databricks.</p><p>Il est possible de récupérer les informations avec Databricks REST API :
Note : écriture des informations de connexion dans le fichier <code>~/config.share</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4># Get the URL Activation Code (from Metastore Unity CAtalog AWS)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>TMP_DBX_RECIPIENT_OPEN_URL</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>`</span>dbx-api -X GET <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.1/unity-catalog/recipients/<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_RECIPIENT_OPEN</span><span style=color:#f1fa8c>}</span> | jq <span style=color:#f1fa8c>&#39;.tokens[0].activation_url&#39;</span> | sed <span style=color:#f1fa8c>&#34;s/.*?//&#34;</span> | sed <span style=color:#f1fa8c>&#39;s/&#34;//&#39;</span><span style=color:#f1fa8c>`</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#6272a4># Extract information to write the config.share file (instead of download from databricks activation page) from Public API</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>dbx-api -X GET <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.1/unity-catalog/public/data_sharing_activation/<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>TMP_DBX_RECIPIENT_OPEN_URL</span><span style=color:#f1fa8c>}</span> &gt; ~/config.share
</span></span></code></pre></div><p>Pour la récupération manuelle des informations de connexion <code>config.share</code>, il suffit d&rsquo;accéder à l&rsquo;URL d&rsquo;activation communiquée :
<a href=/blog/web/20230521_blog_article_unity_catalog_dela_sharing_08.png><img src=/blog/web/20230521_blog_article_unity_catalog_dela_sharing_08.png alt=schema_08></a></p><p>Informations :</p><ul><li>Vous ne pourrez accéder à l&rsquo;URL d&rsquo;activation et aux objets du partage (Share) que durant la durée de validité du Token Databricks</li><li>Il est possible d&rsquo;accéder à l&rsquo;URL d&rsquo;activation autant de fois que vous le souhaitez (durant la période de validité) mais le téléchargement du fichier de configuration <code>config.share</code> n&rsquo;est possible qu&rsquo;une seule fois<ul><li>C&rsquo;est par l&rsquo;intermédiaire de ce fichier de configuration <code>config.share</code> que vous allez pouvoir accéder aux objets partagés</li></ul></li><li>Il est possible de faire une rotation de Token Databricks pour réactiver l&rsquo;accès aux objets partagés, mais cela nécessite de récupérer un nouveau fichier de configuration <code>config.share</code> (les clés seront différentes)</li></ul><p>Exemple d&rsquo;une rotation de Token Databricks (si par exemple l&rsquo;activation n&rsquo;a pas pu se faire durant la période de validité initiale) avec Databricks REST API :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4># If you need to rotate the Databricks Token</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>dbx-api -X POST <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.1/unity-catalog/recipients/<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_RECIPIENT_OPEN</span><span style=color:#f1fa8c>}</span>/rotate-token -H <span style=color:#f1fa8c>&#39;Content-Type: application/json&#39;</span> -d <span style=color:#f1fa8c>&#39;{
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#f1fa8c>&#34;existing_token_expire_in_seconds&#34;: 0
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#f1fa8c>}&#39;</span>
</span></span></code></pre></div><p>A partir de l&rsquo;étape n°4, le destinataire (Recipient) peut accéder aux objets (tables delta uniquement) du partage (Share) en utilisant l&rsquo;outil souhaité en fonction des connecteurs <code>delta-sharing</code> disponible (python, java, spark, etc &mldr;)</p><h2 id=access-par-script-python>Access par script python</h2><p>Pré-requis : le fichier de configuration <code>config.share</code> a été récupéré en local <code>~/config.share</code></p><p>Installation de la librairie python <code>delta-sharing</code> proposé par Databricks</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>pip install delta-sharing
</span></span></code></pre></div><p>Exemple d&rsquo;un script python permettant d&rsquo;afficher le contenu des tables delta partagées :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>import</span> delta_sharing
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#ff79c6>from</span> tabulate <span style=color:#ff79c6>import</span> tabulate
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#6272a4># Define the profile file (config.share)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>profile_file <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;~/config.share&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#6272a4># Define the parameter to read data</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>read_share <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;share_aws_dbx&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>read_schema <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;sch_share&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>read_table_mng <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;fct_trx_mng&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>read_table_ext <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;fct_trx_ext&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#6272a4># Get the data from shared table fct_trx_mng</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>df_pandas_mng <span style=color:#ff79c6>=</span> delta_sharing<span style=color:#ff79c6>.</span>load_as_pandas(<span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>{0}</span><span style=color:#f1fa8c>#</span><span style=color:#f1fa8c>{1}</span><span style=color:#f1fa8c>.</span><span style=color:#f1fa8c>{2}</span><span style=color:#f1fa8c>.</span><span style=color:#f1fa8c>{3}</span><span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>.</span>format(profile_file,read_share,read_schema,read_table_mng))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#8be9fd;font-style:italic>print</span>(<span style=color:#f1fa8c>&#34;Table : [</span><span style=color:#f1fa8c>{0}</span><span style=color:#f1fa8c>.</span><span style=color:#f1fa8c>{1}</span><span style=color:#f1fa8c>.</span><span style=color:#f1fa8c>{2}</span><span style=color:#f1fa8c>]&#34;</span><span style=color:#ff79c6>.</span>format(read_share,read_schema,read_table_mng))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#8be9fd;font-style:italic>print</span>(tabulate(df_pandas_mng, headers <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;keys&#39;</span>, tablefmt <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;pretty&#39;</span>))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#6272a4># Get the data from shared table fct_trx_ext</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>df_pandas_ext <span style=color:#ff79c6>=</span> delta_sharing<span style=color:#ff79c6>.</span>load_as_pandas(<span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>{0}</span><span style=color:#f1fa8c>#</span><span style=color:#f1fa8c>{1}</span><span style=color:#f1fa8c>.</span><span style=color:#f1fa8c>{2}</span><span style=color:#f1fa8c>.</span><span style=color:#f1fa8c>{3}</span><span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>.</span>format(profile_file,read_share,read_schema,read_table_ext))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#8be9fd;font-style:italic>print</span>(<span style=color:#f1fa8c>&#34;Table : [</span><span style=color:#f1fa8c>{0}</span><span style=color:#f1fa8c>.</span><span style=color:#f1fa8c>{1}</span><span style=color:#f1fa8c>.</span><span style=color:#f1fa8c>{2}</span><span style=color:#f1fa8c>]&#34;</span><span style=color:#ff79c6>.</span>format(read_share,read_schema,read_table_ext))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#8be9fd;font-style:italic>print</span>(tabulate(df_pandas_ext, headers <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;keys&#39;</span>, tablefmt <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;pretty&#39;</span>))
</span></span></code></pre></div><p>Résultat du script :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span># Result :
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>Table : [share_aws_dbx.sch_share.fct_trx_mng]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>+---+--------+---------------------+------------+---------+-----------+----------+----------------------------+
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>|   | id_trx |       ts_trx        | id_product | id_shop | id_client | quantity |          ts_tech           |
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>+---+--------+---------------------+------------+---------+-----------+----------+----------------------------+
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>| 0 |   8    | 2023-04-10 18:30:00 |     3      |    1    |     2     |    2     | 2023-05-19 12:52:17.070000 |
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>| 1 |   7    | 2023-04-10 18:30:00 |     2      |    1    |     2     |    11    | 2023-05-19 12:52:17.070000 |
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>| 2 |   4    | 2023-04-05 08:00:00 |     3      |    1    |     2     |    9     | 2023-05-19 12:52:17.070000 |
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>+---+--------+---------------------+------------+---------+-----------+----------+----------------------------+
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>Table : [share_aws_dbx.sch_share.fct_trx_ext]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>+---+--------+---------------------+------------+---------+-----------+----------+----------------------------+
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>|   | id_trx |       ts_trx        | id_product | id_shop | id_client | quantity |          ts_tech           |
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>+---+--------+---------------------+------------+---------+-----------+----------+----------------------------+
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>| 0 |   1    | 2023-04-01 09:00:00 |     1      |    2    |     1     |    1     | 2023-05-19 12:52:06.195000 |
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>| 1 |   2    | 2023-04-01 11:00:00 |     1      |    1    |     1     |    3     | 2023-05-19 12:52:06.195000 |
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>| 2 |   3    | 2023-04-03 14:00:00 |     1      |    2    |     1     |    1     | 2023-05-19 12:52:06.195000 |
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>| 3 |   4    | 2023-04-05 08:00:00 |     3      |    1    |     2     |    9     | 2023-05-19 12:52:06.195000 |
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>| 4 |   5    | 2023-04-06 10:00:00 |     1      |    2    |     1     |    3     | 2023-05-19 12:52:06.195000 |
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>| 5 |   6    | 2023-04-06 12:00:00 |     2      |    2    |     1     |    1     | 2023-05-19 12:52:06.195000 |
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>| 6 |   7    | 2023-04-10 18:30:00 |     2      |    1    |     2     |    11    | 2023-05-19 12:52:06.195000 |
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>| 7 |   8    | 2023-04-10 18:30:00 |     3      |    1    |     2     |    2     | 2023-05-19 12:52:06.195000 |
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>+---+--------+---------------------+------------+---------+-----------+----------+----------------------------+
</span></span></code></pre></div><p>On peut voir que la premiere table delta <code>share_aws_dbx.sch_share.fct_trx_mng</code> ne retourne que les informations correspondant à la partition <code>id_client = 2</code> et la deuxième table delta <code>share_aws_dbx.sch_share.fct_trx_ext</code> retourne la totalité des lignes.</p><p>Avec ce script python, on peut voir qu&rsquo;il est extrêmement simple d&rsquo;accéder aux tables delta partagées.</p><p>Exemple d&rsquo;un script python pour lister les tables delta du partage (Share) avec l&rsquo;objet <code>SharingClient</code> :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>import</span> delta_sharing
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#6272a4># Define the profile file (config.share)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>profile_file <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;~/config.share&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#6272a4># Get the Client objet to managed the Sharing connexion</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>client <span style=color:#ff79c6>=</span> delta_sharing<span style=color:#ff79c6>.</span>SharingClient(profile_file)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#8be9fd;font-style:italic>print</span>(<span style=color:#f1fa8c>&#34;Listing of All the Tables :&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#ff79c6>for</span> element <span style=color:#ff79c6>in</span> client<span style=color:#ff79c6>.</span>list_all_tables():
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#8be9fd;font-style:italic>print</span>(<span style=color:#f1fa8c>&#34;  - </span><span style=color:#f1fa8c>{}</span><span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>.</span>format(element))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#8be9fd;font-style:italic>print</span>(<span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>Listing of Shares : &#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>l_shares <span style=color:#ff79c6>=</span> client<span style=color:#ff79c6>.</span>list_shares()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#ff79c6>for</span> element <span style=color:#ff79c6>in</span> l_shares:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    <span style=color:#8be9fd;font-style:italic>print</span>(<span style=color:#f1fa8c>&#34;  - </span><span style=color:#f1fa8c>{}</span><span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>.</span>format(element))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#8be9fd;font-style:italic>print</span>(<span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>Listing of Schema from Share [</span><span style=color:#f1fa8c>{}</span><span style=color:#f1fa8c>] : &#34;</span><span style=color:#ff79c6>.</span>format(l_shares[<span style=color:#bd93f9>0</span>]<span style=color:#ff79c6>.</span>name))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>l_schemas <span style=color:#ff79c6>=</span> client<span style=color:#ff79c6>.</span>list_schemas(l_shares[<span style=color:#bd93f9>0</span>])
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#ff79c6>for</span> element <span style=color:#ff79c6>in</span> l_schemas :
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>    <span style=color:#8be9fd;font-style:italic>print</span>(<span style=color:#f1fa8c>&#34;  - </span><span style=color:#f1fa8c>{}</span><span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>.</span>format(element))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#8be9fd;font-style:italic>print</span>(<span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>Listing of Tables from Schema [</span><span style=color:#f1fa8c>{}</span><span style=color:#f1fa8c>] from Share [</span><span style=color:#f1fa8c>{}</span><span style=color:#f1fa8c>] : &#34;</span><span style=color:#ff79c6>.</span>format(l_schemas[<span style=color:#bd93f9>0</span>]<span style=color:#ff79c6>.</span>name,l_shares[<span style=color:#bd93f9>0</span>]<span style=color:#ff79c6>.</span>name))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>l_tables <span style=color:#ff79c6>=</span> client<span style=color:#ff79c6>.</span>list_tables(l_schemas[<span style=color:#bd93f9>0</span>])
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span><span style=color:#ff79c6>for</span> element <span style=color:#ff79c6>in</span> l_tables :
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>    <span style=color:#8be9fd;font-style:italic>print</span>(<span style=color:#f1fa8c>&#34;  - </span><span style=color:#f1fa8c>{}</span><span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>.</span>format(element))
</span></span></code></pre></div><p>Résultat du script :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>Listing of All the Tables :
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>  - Table(name=&#39;fct_trx_ext&#39;, share=&#39;share_aws_dbx&#39;, schema=&#39;sch_share&#39;)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>  - Table(name=&#39;fct_trx_mng&#39;, share=&#39;share_aws_dbx&#39;, schema=&#39;sch_share&#39;)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>Listing of Shares : 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>  - Share(name=&#39;share_aws_dbx&#39;)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>Listing of Schema from Share [share_aws_dbx] : 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>  - Schema(name=&#39;sch_share&#39;, share=&#39;share_aws_dbx&#39;)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>Listing of Tables from Schema [sch_share] from Share [share_aws_dbx] : 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>  - Table(name=&#39;fct_trx_ext&#39;, share=&#39;share_aws_dbx&#39;, schema=&#39;sch_share&#39;)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>  - Table(name=&#39;fct_trx_mng&#39;, share=&#39;share_aws_dbx&#39;, schema=&#39;sch_share&#39;)
</span></span></code></pre></div><h2 id=lecture-des-logs-daudit>Lecture des logs d&rsquo;audit</h2><p>Nous allons utiliser la même procédure que pour la lecture des logs d&rsquo;audit du partage Databricks-to-Databricks Sharing.</p><p>Nous allons nous intéresser uniquement aux actions <code>deltaSharingQueriedTable</code> et <code>deltaSharingQueryTable</code> au niveau de l&rsquo;Account Databricks pour le destinataire (Recipient) <code>rcp_open_all</code> pour mettre en évidence quelques informations que nous pouvons récupérer facilement à partir des logs d&rsquo;audit pour suivre l&rsquo;accès aux objets partagés.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>-- 1. Create ctg_ext.sch_ext.audit_logs_json from JSON files
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>TABLE</span> ctg_ext.sch_ext.audit_logs_json
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#ff79c6>USING</span> JSON
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#ff79c6>OPTIONS</span> (path <span style=color:#f1fa8c>&#34;s3://s3-demo-data-uc/dbx_logs/account&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#6272a4>-- 2. Get deltaSharingQueryTable action informations from rcp_open_all recipient
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>select</span> requestId
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>,requestParams.recipient_name
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>,requestParams.<span style=color:#ff79c6>share</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>,requestParams.<span style=color:#ff79c6>schema</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>,requestParams.name
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>,requestParams.user_agent
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>,response.statusCode
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>,serviceName
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>,sourceIPAddress
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>,<span style=color:#8be9fd;font-style:italic>date</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#ff79c6>from</span> ctg_ext.sch_ext.audit_logs_json 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#ff79c6>where</span> actionName <span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#39;deltaSharingQueryTable&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#ff79c6>and</span> auditLevel <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;ACCOUNT_LEVEL&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#ff79c6>and</span> requestParams.recipient_name <span style=color:#ff79c6>in</span> (<span style=color:#f1fa8c>&#39;rcp_open_all&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#ff79c6>order</span> <span style=color:#ff79c6>by</span> <span style=color:#ff79c6>timestamp</span> <span style=color:#ff79c6>asc</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span><span style=color:#6272a4>-- 2. Get information from deltaSharingQueriedTable action from rcp_open_all recipient
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>select</span> requestId
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>,requestParams.recipient_name
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>,response.<span style=color:#ff79c6>result</span>:numRecords
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>,response.<span style=color:#ff79c6>result</span>:tableName
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>,response.<span style=color:#ff79c6>result</span>:deltaSharingPartitionFilteringAccessed
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>,serviceName
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>,sourceIPAddress
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>,userAgent
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span><span style=color:#ff79c6>from</span> ctg_ext.sch_ext.audit_logs_json 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span><span style=color:#ff79c6>where</span> actionName <span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#39;deltaSharingQueriedTable&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span><span style=color:#ff79c6>and</span> auditLevel <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;ACCOUNT_LEVEL&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span><span style=color:#ff79c6>and</span> requestParams.recipient_name <span style=color:#ff79c6>in</span> (<span style=color:#f1fa8c>&#39;rcp_open_all&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span><span style=color:#ff79c6>order</span> <span style=color:#ff79c6>by</span> <span style=color:#ff79c6>timestamp</span> <span style=color:#ff79c6>asc</span>
</span></span></code></pre></div><p>Résultat de l&rsquo;étape n°2 concernant les actions <code>deltaSharingQueryTable</code> :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>requestId,recipient_name,share,schema,name,user_agent,statusCode,serviceName,sourceIPAddress
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>d59abaa0-2829-4d4b-90ea-73e9f4ec11ee,rcp_open_all,share_aws_dbx,sch_share,fct_trx_mng,Delta-Sharing-Python/0.6.4 pandas/1.3.4 PyArrow/11.0.0 Python/3.11.3 System/macOS-13.3.1-arm64-arm-64bit,200,unityCatalog,86.247.59.138
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>0690bef9-413d-44ec-8541-4901273aa589,rcp_open_all,share_aws_dbx,sch_share,fct_trx_ext,Delta-Sharing-Python/0.6.4 pandas/1.3.4 PyArrow/11.0.0 Python/3.11.3 System/macOS-13.3.1-arm64-arm-64bit,200,unityCatalog,86.247.59.138
</span></span></code></pre></div><p>Cette requête nous permet d&rsquo;accéder aux informations des demandes de requêtes exécutées sur les objets partagés (le nom du destinataire, le nom du partage, le nom du schéma, le nom de la table, etc &mldr;)</p><p>Résultat de la requête n°3 concernant les actions <code>deltaSharingQueriedTable</code> :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>requestId,recipient_name,numRecords,tableName,deltaSharingPartitionFilteringAccessed,serviceName,sourceIPAddress,userAgent
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>88dc2822-63c1-4384-b706-82ab9d5f5d9a,rcp_open_all,3,fct_trx_mng,true,unityCatalog,86.247.59.138,Delta-Sharing-Python/0.6.4 pandas/1.3.4 PyArrow/11.0.0 Python/3.11.3 System/macOS-13.3.1-arm64-arm-64bit
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>2be8d1b6-936c-40d9-89c1-60d104e9f50f,rcp_open_all,8,fct_trx_ext,false,unityCatalog,86.247.59.138,Delta-Sharing-Python/0.6.4 pandas/1.3.4 PyArrow/11.0.0 Python/3.11.3 System/macOS-13.3.1-arm64-arm-64bit
</span></span></code></pre></div><p>Cette requête nous permet d&rsquo;accéder aux informations du résultat des requêtes exécutées sur les objets partagés.
On peut voir que la requête sur la table <code>fct_trx_mng</code> a l&rsquo;option <code>deltaSharingPartitionFilteringAccessed</code> activée et ne retourne que 3 lignes (ce qui correspond au filtre sur les partitions) et que la requête sur la table <code>fct_trx_ext</code> retourne 8 lignes.
On peut aussi avoir d&rsquo;autres informations comme l&rsquo;adresse ip, l&rsquo;agent de l&rsquo;outil qui a exécuté la requête (Python/pandas dans notre cas) et bien d&rsquo;autres informations.</p><h1 id=suppression-des-éléments>Suppression des éléments</h1><p>Vous trouverez, ci-dessous, l&rsquo;ensemble des instructions nécessaires pour nettoyer l&rsquo;environnement.</p><p>Suppression des destinataires (Recipient) (avec Databricks REST API) :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>dbx-api -X DELETE <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.1/unity-catalog/recipients/<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_RECIPIENT_DBX</span><span style=color:#f1fa8c>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>dbx-api -X DELETE <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.1/unity-catalog/recipients/<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_RECIPIENT_OPEN</span><span style=color:#f1fa8c>}</span>
</span></span></code></pre></div><p>Suppression du notebook importé (avec Databricks REST API) :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>dbx-api -X POST <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.0/workspace/delete -H <span style=color:#f1fa8c>&#39;Content-Type: application/json&#39;</span> -d <span style=color:#f1fa8c>&#39;{&#34;path&#34;: &#34;/Shared/read_demo_data_nbk_scala&#34;, &#34;recursive&#34;:&#34;false&#34;}&#39;</span>
</span></span></code></pre></div><p>Suppression du partage (Share) (avec Databricks REST API) :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4># Delete Share</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>dbx-api -X DELETE <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.1/unity-catalog/shares/<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_SHARE_NAME</span><span style=color:#f1fa8c>}</span>
</span></span></code></pre></div><p>Suppression des catalogues du Metastore Unity Catalog (avec des instructions SQL) :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>-- Delete the Catalog with CASCADE option (to delete all objects)
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>DROP</span> <span style=color:#ff79c6>CATALOG</span> <span style=color:#ff79c6>IF</span> <span style=color:#ff79c6>EXISTS</span> ctg_mng <span style=color:#ff79c6>CASCADE</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#ff79c6>DROP</span> <span style=color:#ff79c6>CATALOG</span> <span style=color:#ff79c6>IF</span> <span style=color:#ff79c6>EXISTS</span> ctg_ext <span style=color:#ff79c6>CASCADE</span>;
</span></span></code></pre></div><p>Désactivation du partage des données sur le Metastore Unity Catalog (avec Databricks REST API) :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4># Get the Metastore ID (databricks)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>TMP_DBX_METASTORE_ID</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>`</span>dbx-api -X GET <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.1/unity-catalog/metastores | jq -r <span style=color:#f1fa8c>&#39;.metastores[]|select(.name==$ENV.DBX_METASTORE_NAME)|.metastore_id&#39;</span><span style=color:#f1fa8c>`</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#6272a4># Update the Metastore configuration to deactivate Delta Sharing (external)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>dbx-api -X PATCH <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.1/unity-catalog/metastores/<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>TMP_DBX_METASTORE_ID</span><span style=color:#f1fa8c>}</span> -H <span style=color:#f1fa8c>&#39;Content-Type: application/json&#39;</span> -d <span style=color:#f1fa8c>&#34;{
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#f1fa8c>    \&#34;delta_sharing_scope\&#34;: \&#34;INTERNAL\&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span><span style=color:#f1fa8c>}&#34;</span>
</span></span></code></pre></div><p>Suppression des données utilisées sur la ressource AWS S3 (avec l&rsquo;outil AWS CLI) :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4># Delete all files stored in the AWS S3 resource</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>aws s3 rm <span style=color:#f1fa8c>&#34;s3://s3-demo-data-uc/demo/&#34;</span> --recursive 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>aws s3 rm <span style=color:#f1fa8c>&#34;s3://s3-demo-data-uc/data/&#34;</span> --recursive 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>aws s3 rm <span style=color:#f1fa8c>&#34;s3://s3-demo-data-uc/dbx_logs/&#34;</span> --recursive 
</span></span></code></pre></div><p>Suppression des éléments concernant l&rsquo;Account Databricks Azure (avec les outils Azure CLI et Databricks REST API) :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4># Delete Metastore</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>dbx-api -X DELETE <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_AZ_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.1/unity-catalog/metastores/<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBZ_AZ_METASTORE_ID</span><span style=color:#f1fa8c>}</span>  -H <span style=color:#f1fa8c>&#39;Content-Type: application/json&#39;</span> -d <span style=color:#f1fa8c>&#39;{&#34;force&#34;: &#34;true&#34;}&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#6272a4># Delete Databricks Access Connector</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>az databricks access-connector delete --resource-group <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_RG_NAME</span><span style=color:#f1fa8c>}</span> --name <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_DBX_CONNECTOR_NAME</span><span style=color:#f1fa8c>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span><span style=color:#6272a4># Delete ADLS Gen2 Storage</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>az storage account delete -n <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_ADLS2_NAME</span><span style=color:#f1fa8c>}</span> -g <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_RG_NAME</span><span style=color:#f1fa8c>}</span>
</span></span></code></pre></div><p>Note : Pensez à désactiver les logs d&rsquo;audit avec <a href=https://docs.databricks.com/api-explorer/account/logdelivery/patchstatus>Databricks REST API</a> si cela n&rsquo;est plus utile</p><h1 id=conclusion>Conclusion</h1><p>Avec la fonctionnalité Delta Sharing, la solution Unity Catalog permet de mettre en place une gouvernance et un partage des données de manière très simple et sécurisée avec des partenaires internes (équipes, filiales) et externes afin de mieux les valoriser et monétiser.</p><p>La gestion des objets partagés peut se faire uniquement avec des commandes SQL, ce qui rend très simple et efficace l&rsquo;administration des partages (Share) et la gestion des accès pour les différents destinataires (Recipient).</p><p>Le partage des données avec Delta Sharing ne nécessite pas l&rsquo;utilisation des ressources de calcul (Cluster Databricks ou SQL Warehouse) du fournisseur (Provider) pour accéder aux objets partagés.
Delta Sharing permet de partager les données, pouvant être volumineuses, de manière optimale et en limitant les coûts en donnant accès de manière transparente directement au stockage des données de manière sécurisée (AWS S3, Azure ADLS, GCP)</p><p>Cela permet de multiplier l&rsquo;usage possible des données sans avoir à les dupliquer et de pouvoir y accéder à partir d&rsquo;un très grand nombre d&rsquo;outils et de technologies (Spark, Python, Java, Scala, PowerBI et bien d&rsquo;autres dans le futur)</p><p>En s&rsquo;appuyant sur les Logs d&rsquo;audit, nous avons la possibilité de tracer l&rsquo;ensemble des évènements liés aux Metastores de la solution Unity Catalog au niveau de l&rsquo;Account Databricks et ainsi pouvoir analyser l&rsquo;usage des objets partagés par les différents destinataires (Recipient).</p><p>Au moment de l&rsquo;écriture de ce document (Avril/Mai 2023), il n&rsquo;était pas encore possible de partager d&rsquo;autres objets que des tables delta (managées ou externes) et des notebooks (uniquement pour le partage Databricks-to-Databricks) mais la roadmap de Databricks concernant les prochaines version confirme que l&rsquo;on pourra bientôt partagés bien plus de type d&rsquo;objets.</p><p>Cette fonctionnalité est encore récente mais devrait se rendre indispensable dans un futur proche pour tout ceux utilisant Databricks pour la gestion d’un Data Lake ou d’un Lakehouse afin de permettre de maximiser les usages des données par l&rsquo;ensemble des partenaires (interne et externe) et de maîtriser la gouvernance des données avec la solution Unity Catalog.</p></div></article></div></div><footer><div class="container-fluid prag-bg-primary prag-foot">Généré avec <a href=https://gohugo.io/>Hugo</a>
&nbsp; - &nbsp;
<a href=https://en.wikipedia.org/wiki/WTFPL>WTFPL license</a> © 2018–2023</div></footer></body></html>