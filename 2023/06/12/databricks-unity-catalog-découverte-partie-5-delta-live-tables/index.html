<!doctype html><html lang=fr><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta http-equiv=x-ua-compatible content="IE=edge"><meta charset=utf-8><meta name=robots content="noindex, nofollow, noarchive, nosnipper, noodp, noydir"><meta name=google content="notranslate, noimageindex"><meta name=slurp content="notranslate, noimageindex"><meta name=msnbot content="notranslate, noimageindex"><meta name=bingbot content="notranslate, noimageindex"><meta name=generator content="Hugo 0.113.0"><link rel=stylesheet href=https://www.pragmatias.fr/css/bootstrap.min.css><link rel=stylesheet href=https://www.pragmatias.fr/css/pragmatias.css><script src=https://www.pragmatias.fr/js/jquery-3.6.0.slim.min.js></script>
<script src=https://www.pragmatias.fr/js/popper.min.js></script>
<script src=https://www.pragmatias.fr/js/bootstrap.bundle.min.js></script>
<link rel=alternate type=application/rss+xml href=https://www.pragmatias.fr/feed.xml><title>Databricks : Unity Catalog - Découverte - Partie 5 - Delta Live Tables</title><body><div class="navbar navbar-expand-md prag-bg-primary prag-header" role=navigation><div class="container-fluid justify-content-center"><div class=navbar-brand><a href=https://www.pragmatias.fr/blog/><img src=/images/logo_pragmatias.svg alt=pragmatias></a></div><button class="navbar-toggler justify-content-end prag-navbar" type=button data-toggle=collapse data-target=#navbarSupportedContent1,#navbarSupportedContent2 aria-controls=navbarSupportedContent1 aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent1><ul class="navbar-nav text-center"><li class=nav-item><a class=nav-link href=https://www.pragmatias.fr/blog/>Blog</a></li><li class=nav-item><a class=nav-link href=https://www.pragmatias.fr/tags/>Tags</a></li><li class=nav-item><a class=nav-link href=https://www.pragmatias.fr/archives/>Archives</a></li></ul></div><div class="collapse navbar-collapse justify-content-md-end" id=navbarSupportedContent2><ul class="navbar-nav flex-row justify-content-center"><li class=nav-item><a href=https://www.pragmatias.fr/en/2023/06/12/databricks-unity-catalog-first-step-part-5-delta-live-tables/ class="prag_header_svg mr-1 ml-1"><img src=/images/united-kingdom-flag-round-xs-24.png alt=English></a></li><li class=nav-item><a href=https://www.pragmatias.fr/feed.xml title="Pragmatias Blog" class="prag_header_svg mr-1 ml-1"><svg height="24" style="enable-background:new 0 0 508.52 508.52" viewBox="0 0 508.52 508.52" width="24" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path style="fill-rule:evenodd;clip-rule:evenodd;fill:" d="M254.26.0C113.845.0.0 113.845.0 254.26s113.845 254.26 254.26 254.26 254.26-113.845 254.26-254.26C508.52 113.813 394.675.0 254.26.0zM137.141 412.441c-22.852.0-41.413-18.434-41.413-41.285.0-22.693 18.561-41.349 41.413-41.349 22.915.0 41.444 18.656 41.476 41.349C178.618 393.976 160.088 412.441 137.141 412.441zM241.197 412.791c0-39.029-15.16-75.674-42.62-103.071-27.46-27.524-63.978-42.716-102.785-42.716V207.38c113.177.0 205.315 92.137 205.315 205.41h-59.91zM347.001 412.727c0-138.603-112.669-251.399-251.145-251.399v-59.624c171.435.0 310.96 139.589 310.96 311.023H347.001z"/></svg></a></li><li class=nav-item><a href=mailto:contact@pragmatias.fr title=Mail class="prag_header_svg mr-1 ml-1"><svg height="24" style="enable-background:new 0 0 299.997 299.997" viewBox="0 0 299.997 299.997" width="24" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path style="fill-rule:evenodd;clip-rule:evenodd;fill:" d="M149.996.0C67.157.0.001 67.158.001 149.997c0 82.837 67.156 150 149.995 150s150-67.163 150-150C299.996 67.158 232.835.0 149.996.0zM149.999 52.686l88.763 55.35H61.236l88.763-55.35zm89.869 143.737h-.009c0 8.878-7.195 16.072-16.072 16.072H76.211c-8.878.0-16.072-7.195-16.072-16.072v-84.865c0-.939.096-1.852.252-2.749l84.808 52.883c.104.065.215.109.322.169.112.062.226.122.34.179.599.309 1.216.558 1.847.721.065.018.13.026.195.041.692.163 1.393.265 2.093.265h.005c.005.0.01.0.01.0.7.0 1.401-.099 2.093-.265.065-.016.13-.023.195-.041.63-.163 1.245-.412 1.847-.721.114-.057.228-.117.34-.179.106-.06.218-.104.322-.169l84.808-52.883c.156.897.252 1.808.252 2.749v84.865z"/></svg></a></li><li><a href=https://github.com/pragmatias/ title=github class="prag_header_svg mr-1 ml-1"><svg height="24" style="enable-background:new 0 0 438.549 438.549" viewBox="0 0 438.549 438.549" width="24" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path style="fill-rule:evenodd;clip-rule:evenodd;fill:" d="M409.132 114.573c-19.608-33.596-46.205-60.194-79.798-79.8C295.736 15.166 259.057 5.365 219.271 5.365c-39.781.0-76.472 9.804-110.063 29.408-33.596 19.605-60.192 46.204-79.8 79.8C9.803 148.168.0 184.854.0 224.63c0 47.78 13.94 90.745 41.827 128.906 27.884 38.164 63.906 64.572 108.063 79.227 5.14.954 8.945.283 11.419-1.996 2.475-2.282 3.711-5.14 3.711-8.562.0-.571-.049-5.708-.144-15.417-.098-9.709-.144-18.179-.144-25.406l-6.567 1.136c-4.187.767-9.469 1.092-15.846 1-6.374-.089-12.991-.757-19.842-1.999-6.854-1.231-13.229-4.086-19.13-8.559-5.898-4.473-10.085-10.328-12.56-17.556l-2.855-6.57c-1.903-4.374-4.899-9.233-8.992-14.559-4.093-5.331-8.232-8.945-12.419-10.848l-1.999-1.431c-1.332-.951-2.568-2.098-3.711-3.429-1.142-1.331-1.997-2.663-2.568-3.997-.572-1.335-.098-2.43 1.427-3.289s4.281-1.276 8.28-1.276l5.708.853c3.807.763 8.516 3.042 14.133 6.851 5.614 3.806 10.229 8.754 13.846 14.842 4.38 7.806 9.657 13.754 15.846 17.847 6.184 4.093 12.419 6.136 18.699 6.136s11.704-.476 16.274-1.423c4.565-.952 8.848-2.383 12.847-4.285 1.713-12.758 6.377-22.559 13.988-29.41-10.848-1.14-20.601-2.857-29.264-5.14-8.658-2.286-17.605-5.996-26.835-11.14-9.235-5.137-16.896-11.516-22.985-19.126-6.09-7.614-11.088-17.61-14.987-29.979-3.901-12.374-5.852-26.648-5.852-42.826.0-23.035 7.52-42.637 22.557-58.817-7.044-17.318-6.379-36.732 1.997-58.24 5.52-1.715 13.706-.428 24.554 3.853 10.85 4.283 18.794 7.952 23.84 10.994 5.046 3.041 9.089 5.618 12.135 7.708 17.705-4.947 35.976-7.421 54.818-7.421s37.117 2.474 54.823 7.421l10.849-6.849c7.419-4.57 16.18-8.758 26.262-12.565 10.088-3.805 17.802-4.853 23.134-3.138 8.562 21.509 9.325 40.922 2.279 58.24 15.036 16.18 22.559 35.787 22.559 58.817.0 16.178-1.958 30.497-5.853 42.966-3.9 12.471-8.941 22.457-15.125 29.979-6.191 7.521-13.901 13.85-23.131 18.986-9.232 5.14-18.182 8.85-26.84 11.136-8.662 2.286-18.415 4.004-29.263 5.146 9.894 8.562 14.842 22.077 14.842 40.539v60.237c0 3.422 1.19 6.279 3.572 8.562 2.379 2.279 6.136 2.95 11.276 1.995 44.163-14.653 80.185-41.062 108.068-79.226 27.88-38.161 41.825-81.126 41.825-128.906C438.536 184.851 428.728 148.168 409.132 114.573z"/></svg></a></li></ul></div></div></div><div id=content><div class=container-fluid><article class="blog-post blog-post-with-toc"><header><h2 class=blog-post-title>Databricks : Unity Catalog - Découverte - Partie 5 - Delta Live Tables</h2><div class=blog-post-date><span>Dernière modification : 12 Juin 2023</span></div><div class=blog-post-date>Temps de lecture : 32 minute(s) - 6728 mots</div><div class=blog-post-tags><strong>Tags:</strong>
<a href=https://www.pragmatias.fr/tags/databricks/>Databricks</a>
<a href=https://www.pragmatias.fr/tags/unity-catalog/>Unity Catalog</a></div></header><aside class=prag-toc><h1 class=prag-toc-head>Sommaire</h1><div class=prag-toc-body><nav id=TableOfContents><ol><li><a href=#quest-ce-que-delta-live-tables>Qu&rsquo;est ce que Delta Live Tables</a><ol><li><a href=#synthèse>Synthèse</a></li><li><a href=#concernant-les-objets>Concernant les objets</a></li><li><a href=#concernant-la-gestion-de-la-qualité-des-données>Concernant la gestion de la qualité des données</a></li><li><a href=#concernant-le-pipeline-dlt>Concernant le pipeline DLT</a></li></ol></li><li><a href=#fonctionnement-avec-unity-catalog>Fonctionnement avec Unity Catalog</a><ol><li><a href=#synthèse-1>Synthèse</a></li><li><a href=#concernant-la-gestion-des-objets-par-le-framework-dlt-lors-de-lexécution-du-pipeline-dlt>Concernant la gestion des objets par le framework DLT (lors de l&rsquo;exécution du pipeline DLT)</a></li><li><a href=#limitations>Limitations</a></li></ol></li><li><a href=#préparation-de-lenvironnement>Préparation de l&rsquo;environnement</a><ol><li><a href=#contexte>Contexte</a></li><li><a href=#schématisation-de-lenvironnement>Schématisation de l&rsquo;environnement</a></li><li><a href=#mise-en-place-dun-jeu-de-données>Mise en place d&rsquo;un jeu de données</a></li><li><a href=#mise-en-place-des-objets-dans-le-metastore-unity-catalog>Mise en place des objets dans le Metastore Unity Catalog</a></li><li><a href=#création-du-script-python-contenant-la-définition-des-objets-pour-le-framework-dlt>Création du script python contenant la définition des objets pour le framework DLT</a></li></ol></li><li><a href=#création-dun-pipeline-dlt>Création d&rsquo;un Pipeline DLT</a></li><li><a href=#exécution-et-visualisation-dun-pipeline-dlt>Exécution et Visualisation d&rsquo;un pipeline DLT</a><ol><li><a href=#exécution-du-pipeline-dlt>Exécution du pipeline DLT</a></li><li><a href=#visualisation-du-pipeline-dlt>Visualisation du pipeline DLT</a></li><li><a href=#visualisation-avec-unity-catalog>Visualisation avec Unity Catalog</a></li></ol></li><li><a href=#monitoring-dun-pipeline-dlt>Monitoring d&rsquo;un pipeline DLT</a></li><li><a href=#suppression-des-éléments>Suppression des éléments</a></li><li><a href=#conclusion>Conclusion</a></li></ol></nav></div></aside><a id=showTopBtn href=# class=prag-sticky-bot><svg height="24" id="Layer_1" style="enable-background:new 0 0 438.533 438.533" viewBox="0 0 438.533 438.533" width="24" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path style="fill-rule:evenodd;clip-rule:evenodd;fill:" d="M409.133 109.203c-19.608-33.592-46.205-60.189-79.798-79.796C295.736 9.801 259.058.0 219.273.0c-39.781.0-76.47 9.801-110.063 29.407-33.595 19.604-60.192 46.201-79.8 79.796C9.801 142.8.0 179.489.0 219.267c0 39.78 9.804 76.463 29.407 110.062 19.607 33.592 46.204 60.189 79.799 79.798 33.597 19.605 70.283 29.407 110.063 29.407s76.47-9.802 110.065-29.407c33.593-19.602 60.189-46.206 79.795-79.798 19.603-33.596 29.403-70.284 29.403-110.062C438.533 179.485 428.732 142.795 409.133 109.203zM361.449 231.831l-25.981 25.981c-3.613 3.613-7.901 5.42-12.847 5.42-4.948.0-9.229-1.807-12.847-5.42l-53.954-53.961v143.32c0 4.948-1.813 9.232-5.428 12.847-3.613 3.62-7.898 5.427-12.847 5.427h-36.547c-4.948.0-9.231-1.807-12.847-5.427-3.617-3.614-5.426-7.898-5.426-12.847v-143.32l-53.959 53.961c-3.431 3.425-7.708 5.133-12.85 5.133-5.14.0-9.423-1.708-12.85-5.133l-25.981-25.981c-3.422-3.429-5.137-7.714-5.137-12.852.0-5.137 1.709-9.419 5.137-12.847l103.356-103.353 25.981-25.981c3.427-3.425 7.71-5.14 12.847-5.14 5.142.0 9.423 1.715 12.849 5.14l25.98 25.981 103.35 103.353c3.432 3.427 5.14 7.71 5.14 12.847C366.589 224.117 364.881 228.402 361.449 231.831z"/></svg></a><script>$(document).ready(function(){$("#showTopBtn").removeClass("prag-sticky-bot"),$("#showTopBtn").addClass("prag-sticky-hide"),$(function(){$(window).scroll(function(){$(this).scrollTop()>900?($("#showTopBtn").addClass("prag-sticky-bot"),$("#showTopBtn").removeClass("prag-sticky-hide")):($("#showTopBtn").addClass("prag-sticky-hide"),$("#showTopBtn").removeClass("prag-sticky-bot"))})})})</script><div class=blog-post-main><p>Nous allons découvrir le framework <a href=https://www.databricks.com/product/delta-live-tables>Delta Live Tables</a> avec la solution <a href=https://docs.databricks.com/data-governance/unity-catalog/index.html>Unity Catalog</a> à la place du Hive Metastore.</p><p>Nous allons nous concentrer sur les éléments propres à la solution Unity Catalog.</p><p>L&rsquo;utilisation de la solution Unity Catalog avec le framework Delta Live Tables était en &ldquo;Public Preview&rdquo; lors de la rédaction de ce papier début Juin 2023.</p><p>Nous allons utiliser un Account Databricks sur AWS pour réaliser cette découverte.</p><p><em>Note : Nous allons garder des termes techniques en anglais pour faciliter la compréhension</em></p><h1 id=quest-ce-que-delta-live-tables>Qu&rsquo;est ce que Delta Live Tables</h1><h2 id=synthèse>Synthèse</h2><p>Delta Live Tables est un framework permettant de travailler de manière déclarative afin de définir l&rsquo;ensemble des éléments d&rsquo;un traitement ETL (pipeline).</p><p>Ce framework permet de travailler en <a href=https://docs.databricks.com/delta-live-tables/python-ref.html>Python</a> et en <a href=https://docs.databricks.com/delta-live-tables/sql-ref.html>SQL</a>.</p><p>Ce framework permet de définir des objets dans un script en Python ou dans un notebook en Python ou en SQL qui sera exécuté par un pipeline DLT (Delta Live Tables) en s&rsquo;appuyant sur la fonctionnalité &ldquo;Workflows&rdquo;.</p><p>Ce framework se base sur les trois types d&rsquo;objets suivant afin de gérer l&rsquo;orchestration de l&rsquo;ensemble des actions d&rsquo;un pipeline DLT :</p><ul><li><strong>Streaming Table</strong> : Cela correspond au terme SQL <code>STREAMING TABLE &lt;objet></code></li><li><strong>Materialized View</strong> : Cela correspond au terme SQL <code>LIVE TABLE &lt;objet></code></li><li><strong>View</strong> : Cela correspond au terme SQL <code>TEMPORARY LIVE VIEW &lt;objet></code> ou <code>TEMPORARY STREAMING LIVE VIEW &lt;objet></code></li></ul><p>Vous pourrez retrouver dans <a href=https://www.databricks.com/product/pricing/delta-live>ce lien</a> l&rsquo;ensemble des informations concernant le coût et les fonctionnalités accessibles par type d&rsquo;édition.
Une vision très synthétique des différentes éditions :</p><ul><li>DLT Core :<ul><li>Permet de gérer l&rsquo;ensemble des fonctionnalité de base</li></ul></li><li>DLT Pro :<ul><li>Permet de gérer l&rsquo;ensemble des fonctionnalités de l&rsquo;édition &ldquo;DLT Core&rdquo; et la gestion du Change Data Capture (CDC) ainsi que de l&rsquo;alimentation d&rsquo;un objet en Slow Changing Dimension (SCD) de type 2 (très utile pour simplifier la gestion des données d&rsquo;un référentiel lorsque l&rsquo;on souhaite garder l&rsquo;historique des changements)</li></ul></li><li>DLT Advanced :<ul><li>Permet de gérer l&rsquo;ensemble des fonctionnalités de l&rsquo;édition &ldquo;DLT Pro&rdquo; ainsi que toutes les fonctionnalités de gestion de la qualité des données (principalement la définition des contraintes (expectations) et leur observabilité (métriques))</li></ul></li></ul><h2 id=concernant-les-objets>Concernant les objets</h2><p>Concernant l&rsquo;objet <strong>Streaming Table</strong> :</p><ul><li>Cet objet permet de gérer la lecture d&rsquo;une source de données en streaming et pouvoir lire un enregistrement seulement une fois (Spark Structured Streaming)</li><li>La gestion des éléments (checkpoint, &mldr;) est géré par défaut par le framework DLT</li><li>La source de données doit être en &ldquo;append-only&rdquo;</li><li>Si la source de données est gérée avec <a href=https://docs.databricks.com/ingestion/auto-loader/index.html>Auto Loader</a>, une colonne supplémentaire nommée <code>_rescued_data</code> sera créée par défaut pour gérer les données mal formées.</li><li>Il est possible de définir des contraintes (expectations) au niveau de l&rsquo;objet</li><li>La lecture d&rsquo;un objet &ldquo;Streaming table&rdquo; dans un même pipeline DLT se fait par l&rsquo;utilisation de la syntaxe <code>STREAM(LIVE.&lt;object>)</code> (SQL) ou <code>dlt.read_stream("&lt;object>")</code> (Python)</li><li>Il est possible de définir l&rsquo;ingestion des données d&rsquo;un objet &ldquo;Streaming Table&rdquo; avec un processus de Slow Changing Dimension de type 2 automatiquement géré par le framework DLT<ul><li>Cela permet de très simplement mettre en place à partir d&rsquo;une source utilisant du CDC (Change Data Capture) ou du CDF (Change Data Feed) une gestion d&rsquo;historique pour des données de type référentiel</li></ul></li><li>Vu que les objets sont gérés par le framework DLT lors de l&rsquo;exécution d&rsquo;un pipeline DLT, il n&rsquo;est pas souhaitable de faire des modifications sur les données en dehors du pipeline DLT.<ul><li>Il est possible de faire des modifications (requête de type DML) avec certaines limitations sur les objets &ldquo;Streaming Table&rdquo; mais cela n&rsquo;est pas recommandé et toutes les opérations ne sont pas supportées.</li></ul></li></ul><p>Concernant l&rsquo;objet <strong>Materialized View</strong> :</p><ul><li>Cet objet permet de gérer le rafraîchissement des données d&rsquo;un objet en fonction de son état lors de l&rsquo;exécution du pipeline DLT, le framework DLT définit de ce qu&rsquo;il doit mettre à jour en fonction de l&rsquo;état des sources et de la cible.</li><li>Il est possible de définir des contraintes (expectations) au niveau de l&rsquo;objet</li><li>La lecture d&rsquo;un objet &ldquo;Materialized View&rdquo; dans un même pipeline DLT se fait par l&rsquo;utilisation de la syntaxe <code>LIVE.&lt;object></code> (SQL) ou <code>dlt.read("&lt;object>")</code> (Python)</li><li>Il n&rsquo;est pas possible d&rsquo;exécuter des requêtes de types DML (Update, Delete, Insert) dans un object &ldquo;Materialized View&rdquo; car l&rsquo;objet accessible n&rsquo;est pas défini comme une table Delta.</li><li>Pour accéder en lecture à un objet &ldquo;Materialized View&rdquo; en dehors du pipeline DLT, il faut utilisé un Cluster &ldquo;Shared&rdquo; ou un SQL Warehouse de type Pro ou Serverless (recommandé)</li></ul><p>Concernant l&rsquo;objet <strong>View</strong> :</p><ul><li>Cet objet permet de définir une vue temporaire (requête encapsulé) sur une source de données, cette vue n&rsquo;existera que durant l&rsquo;exécution du pipeline DLT</li><li>La requête encapsulé est exécutée à chaque lecture de l&rsquo;objet</li><li>Il est possible de définir des contraintes (expectations) au niveau de l&rsquo;objet</li></ul><h2 id=concernant-la-gestion-de-la-qualité-des-données>Concernant la gestion de la qualité des données</h2><p>La gestion de la qualité des données se fait en déclarant des contraintes (expectations) sur les objets :</p><ul><li>Syntaxe en SQL : <code>CONSTRAINT expectation_name EXPECT (expectation_expr) [ON VIOLATION { FAIL UPDATE | DROP ROW }]</code></li></ul><p>Lorsque l&rsquo;on défini une contrainte (expectation) sur un objet, le framework DLT fera le contrôle lors de l&rsquo;ingestion de l&rsquo;enregistrement et réalisera l&rsquo;action définie :</p><ul><li><code>CONSTRAINT expectation_name EXPECT (expectation_expr)</code> : Lorsqu&rsquo;il n&rsquo;y a pas d&rsquo;action défini, alors les enregistrements ne respectant pas la contrainte seront insérés dans l&rsquo;objet et une information sera ajoutée dans les logs d&rsquo;événement du pipeline DLT avec le nombre d&rsquo;enregistrements concernés pour cet objet.</li><li><code>CONSTRAINT expectation_name EXPECT (expectation_expr) ON VIOLATION FAIL UPDATE</code> : Lorsque l&rsquo;action définie est &ldquo;FAIL UPDATE&rdquo;, alors le pipeline DLT s&rsquo;arrêtera en erreur au premier enregistrement ne respectant pas la contrainte avec le message d&rsquo;erreur dans les logs d&rsquo;événement du pipeline DLT.</li><li><code>CONSTRAINT expectation_name EXPECT (expectation_expr) ON VIOLATION DROP ROW</code> : Lorsque l&rsquo;action définie est &ldquo;DROP ROW&rdquo;, alors les enregistrements ne respectant pas la contrainte ne seront pas insérés dans l&rsquo;objet et une information sera ajoutée dans les logs d&rsquo;événements du pipeline DLT avec le nombre d&rsquo;enregistrements concernés pour cet objet.</li></ul><h2 id=concernant-le-pipeline-dlt>Concernant le pipeline DLT</h2><p>Afin de pouvoir exécuter un script (Python) ou notebook (SQL ou Python) avec le framework DLT, il est nécessaire de créer un pipeline DLT en précisant l&rsquo;édition souhaitée.</p><p>La définition du pipeline DLT, se fait en utilisant la fonctionnalité &ldquo;Workflows&rdquo;.
L&rsquo;accès se fait de la manière suivante :</p><ol><li>Cliquez sur la vue &ldquo;Data Science & Engineering&rdquo; du menu latéral</li><li>Cliquez sur l&rsquo;option &ldquo;Workflows&rdquo; du menu latéral</li><li>Cliquez sur l&rsquo;onglet &ldquo;Delta Live Tables&rdquo;</li></ol><p><a href=/blog/web/20230612_databricks_unity_catalog_deltalivetables_01.png><img src=/blog/web/20230612_databricks_unity_catalog_deltalivetables_01.png alt=schema_01></a></p><p>A partir de cet écran, vous pourrez gérer les pipelines DLT (création, suppression, configuration, modification) et visualiser les différentes exécutions (dans la limite de la période de rétention des données d&rsquo;observabilité de l&rsquo;édition définie pour chaque pipeline)
<a href=/blog/web/20230612_databricks_unity_catalog_deltalivetables_02.png><img src=/blog/web/20230612_databricks_unity_catalog_deltalivetables_02.png alt=schema_02></a></p><p>Les informations utiles pour la création d&rsquo;un pipeline DLT :</p><ul><li>General :<ul><li>Product edition : Édition à choisir parmi DLT Core, DLT Pro et DLT Advanced, cela va définir les fonctionnalités utilisables ainsi qu&rsquo;un des critères du coûts de l&rsquo;exécution du pipeline DLT</li><li>Pipeline mode :<ul><li>Triggered : Permet de gérer l&rsquo;exécution en mode batch et par conséquent de couper le cluster après exécution du pipeline DLT</li><li>Continuous : Permet de gérer l&rsquo;exécution en mode streaming et par conséquent d&rsquo;exécuter le pipeline en continue pour traiter les données dès qu&rsquo;elles arrivent.</li></ul></li></ul></li><li>Source Code : Permet de définir le script (Python) ou le Notebook (Python ou SQL) devant être exécuter par le pipeline DLT</li><li>Destination<ul><li>Storage Option : Choisir Unity Catalog pour utiliser la solution Unity Catalog avec le framework DLT</li><li>Catalog : Définir le catalogue cible du pipeline DLT (catalogue qui contient le schéma cible du pipeline DLT)</li><li>Target schema : Définir le schéma cible du pipeline DLT (Schéma qui sera utilisé pour gérer les objets du pipeline DLT)</li></ul></li><li>Compute<ul><li>Cluster mode : Pour définir si vous voulez un nombre de worker fixe (Fixed size) ou qui s&rsquo;adapte à la charge de travail dans les limites indiquées (Enhanced autoscaling, Legacy autoscaling)</li><li>Workers : Permet de définir le nombre de workers si le mode est fixe ou le minimum et maximum de workers si le mode n&rsquo;est pas fixe</li></ul></li></ul><p>Les informations utiles après la création du pipeline DLT :</p><ul><li>Mode d&rsquo;exécution :<ul><li>Development : Dans ce mode, le cluster utilisée par le pipeline DLT ne s&rsquo;arrêtera qu&rsquo;après 2h (par défaut) pour éviter le temps de redémarrage d&rsquo;un cluster et il n&rsquo;y a pas de gestion de redémarrage automatique.<ul><li>Il est possible de modifier le temps d&rsquo;attention avant l&rsquo;arrêt du cluster en configurant le paramètre <code>pipelines.clusterShutdown.delay</code> avec la valeur souhaitée (par exemple &ldquo;300s&rdquo; pour 5 minutes)</li><li>Exemple : <code>{"configuration": {"pipelines.clusterShutdown.delay": "300s"}})</code></li></ul></li><li>Production : Dans ce mode, le cluster s&rsquo;arrête automatiquement après l&rsquo;exécution du pipeline DLT et il redémarre automatiquement en cas de problème technique (fuite mémoires, autorisations, démarrage, &mldr;)</li></ul></li><li>Schedule :<ul><li>Permet de définir une contrainte de déclenchement pour l&rsquo;exécution du pipeline DLT</li></ul></li><li>Exécution :<ul><li>Start : Pour exécuter le pipeline DLT en prenant en compte uniquement les nouvelles données disponibles</li><li>Start with Full refresh all : Pour exécuter le pipeline DLT en prenant en compte l&rsquo;ensemble des données disponibles</li><li>Select tables for refresh : Pour définir les objets que l&rsquo;on souhaite mettre à jour lors de l&rsquo;exécution du pipeline DLT (exécution partielle)</li></ul></li></ul><p>Attention :</p><ul><li>Il n&rsquo;est pas possible d&rsquo;exécuter en local ou avec un cluster Databricks le script ou notebook défini.<ul><li>Lorsque vous le ferez, vous aurez le message suivant : <code>This Delta Live Tables query is syntactically valid, but you must create a pipeline in order to define and populate your table.</code></li></ul></li><li>Un pipeline DLT correspond uniquement à un script ou un notebook, par conséquent si l&rsquo;on souhaite exécuter plusieurs scripts ou notebooks, il faut utiliser la fonctionnalité &ldquo;Job&rdquo; (de la fonctionnalité &ldquo;Workflows&rdquo;) pour orchestrer l&rsquo;exécution de plusieurs pipelines DLT.<ul><li>L&rsquo;exécution du &ldquo;Job&rdquo; permettra d&rsquo;exécuter les pipelines DLT avec les contraintes (et l&rsquo;orchestration) souhaitées</li></ul></li><li>Il n&rsquo;est possible d&rsquo;accéder à un objet avec la syntaxe du framework DLT qu&rsquo;au sein du même pipeline DLT, si on souhaite lire le contenu d&rsquo;un objet en dehors du pipeline DLT alors il sera accédé comme un objet externe et son utilisation ne sera pas tracé dans le graphe et dans les logs d&rsquo;événements du pipeline DLT<ul><li>Syntaxe pour accéder à un objet au sein du même pipeline DLT: <code>dlt.read(&lt;object>)</code> ou <code>dlt.read_stream(&lt;object>)</code> en Python et <code>LIVE.&lt;object></code> ou <code>STREAM(LIVE.&lt;object>)</code> en SQL.</li></ul></li></ul><p>Concernant la gestion des données associées à un pipeline DLT (maintenance) :</p><ul><li>Le framework DLT exécute une maintenance automatique de chaque objet (table Delta) mise à jour dans un délai de 24h après la dernière exécution d&rsquo;un pipeline DLT.<ul><li>Par défaut, le système exécute une opération complète OPTIMIZE, suivi d&rsquo;une opération de VACUUM</li><li>Si vous ne souhaitez pas qu&rsquo;une table Delta soit automatisée par défaut, il faut utiliser la propriété <code>pipelines.autoOptimize.managed = false</code> lors de la définition de l&rsquo;objet (TBLPROPERTIES).</li></ul></li><li>Lorsque vous supprimez le pipeline DLT, l&rsquo;ensemble des objets définis dans le pipeline DLT et se trouvant dans le schéma cible sera supprimé automatiquement.</li></ul><p>Limitations :</p><ul><li>Il n&rsquo;est pas possible de mixer l&rsquo;utilisation de Hive Metastore avec la solution Unity Catalog ou de faire le changement entre les deux metastores pour la cible du pipeline DLT après sa création.</li><li>Toutes les tables créées et mises à jour par un pipeline DLT sont des tables Delta</li><li>Les objets gérés par le framework DLT ne peuvent être définis qu&rsquo;une seule fois, cela signifie qu&rsquo;ils ne peuvent être la cible que dans un seul pipeline DLT uniquement (impossible de définir le même objet dans le même schéma cible dans deux pipelines DLT différents)</li><li>Un Workspace Databricks est limité à 100 mises à jours de pipeline DLT</li></ul><h1 id=fonctionnement-avec-unity-catalog>Fonctionnement avec Unity Catalog</h1><h2 id=synthèse-1>Synthèse</h2><p>Afin de pouvoir utiliser Unity Catalog, il faut préciser lors de la création du pipeline DLT que l&rsquo;on souhaite que la destination soit le metastore de la solution Unity Catalog ainsi que le catalogue et le schéma cible à utiliser.</p><p>Il n&rsquo;est pas possible d&rsquo;utiliser la notation recommandée des &ldquo;trois namespaces&rdquo; <code>catalogue.schema.objet</code> pour accéder à un objet géré par le framework DLT.
Les objets sont définis uniquement par leur nom et c&rsquo;est la définition du catalogue et du schéma cible au niveau du pipeline DLT qui permet de définir où seront créés les objets.
Note : il est possible d&rsquo;accéder en lecture aux objets non gérés par le framework DLT en utilisant la syntaxe spark classique (<code>spark.table("catalogue.schema.objet")</code>)</p><p>Afin de pouvoir utiliser Unity Catalog avec Delta Live Tables, il faut avoir les droits suivants pour le propriétaire du pipeline DLT :</p><ul><li>Vous devez avoir le droit &ldquo;USE CATALOG&rdquo; sur le catalogue cible</li><li>Vous devez avoir le droit &ldquo;USE SCHEMA&rdquo; sur le schéma cible</li><li>Vous devez avoir le droit &ldquo;CREATE MATERIALIZED VIEW&rdquo; dans le schéma cible pour pouvoir créer des objets &ldquo;Materialized View&rdquo;.</li><li>Vous devez avoir le droit &ldquo;CREATE TABLE&rdquo; dans le schéma cible pour pouvoir créer des objets &ldquo;Streaming table&rdquo;</li></ul><p>Conseil concernant l&rsquo;ingestion des fichiers :</p><ul><li>Lorsque l&rsquo;on souhaite récupérer des informations (métadonnées) concernant les fichiers ingérés, il n&rsquo;est pas possible d&rsquo;utiliser la fonction <code>input_file_name</code> qui n&rsquo;est pas supportée par Unity Catalog<ul><li>Il faut utiliser la colonne <code>_metadata</code> qui permet de récupérer les informations nécessaire, comme par exemple le nom du fichier <code>_metadata.file_name</code></li><li>Vous trouverez la liste des informations disponible dans la colonne <code>_metadata</code> sur la <a href=https://docs.databricks.com/ingestion/file-metadata-column.html>documentation officielle</a>.</li></ul></li></ul><h2 id=concernant-la-gestion-des-objets-par-le-framework-dlt-lors-de-lexécution-du-pipeline-dlt>Concernant la gestion des objets par le framework DLT (lors de l&rsquo;exécution du pipeline DLT)</h2><p>En réalité, lorsque l&rsquo;on défini un objet avec le framework DLT, un objet va être créé dans le schéma cible indiqué au niveau du pipeline DLT (avec un type spécifique qui ne sera pas directement une table Delta) et une table Delta va être créée dans un schéma interne (géré par le système et non accessible par défaut aux utilisateurs) pour gérer le stockage des données de l&rsquo;objet défini avec le framework DLT.
Le schéma interne se trouve dans le catalogue nommé <code>__databricks__internal</code> et dont le propriétaire est <code>System</code>.
Le schéma est nommé par défaut de la manière suivante : <code>__dlt_materialization_schema_&lt;pipeline_id></code>.
Dans ce schéma, se trouvera toutes les tables Delta dont le stockage est géré directement par le framework DLT (le propriétaire des tables Delta est celui du pipeline DLT) ainsi que la table Delta <code>__event_log</code> qui contiendra l&rsquo;ensemble des logs d&rsquo;événements des exécutions du pipeline DLT.
<a href=/blog/web/20230612_databricks_unity_catalog_deltalivetables_03.png><img src=/blog/web/20230612_databricks_unity_catalog_deltalivetables_03.png alt=schema_03></a></p><p>En prenant l&rsquo;exemple de la définition d&rsquo;un objet &ldquo;Streaming Table&rdquo; dans le schéma &ldquo;ctg.sch&rdquo; dans un pipeline DLT dont l&rsquo;identifiant est &ldquo;0000&rdquo;, la gestion des données se fera de la manière suivante :</p><ol><li>Création d&rsquo;une table Delta (avec un identifiant unique) dans un schéma interne géré par le système et nommé <code>__databricks__internal.__dlt_materialization_schema_0000</code><ol><li>Avec sous répertoire (au niveau du stockage des données Delta) <code>_dlt_metadata</code> contenant un répertoire <code>checkpoints</code> permettant de gérer les informations nécessaires à la gestion de l&rsquo;ingestion des données en streaming</li></ol></li><li>Création d&rsquo;un objet de type &ldquo;STREAMING_TABLE&rdquo; dans le schéma &ldquo;ctg.sch&rdquo; qui fait référence à la table Delta créée dans le schéma interne <code>__databricks__internal.__dlt_materialization_schema_0000</code><ol><li>Cela permet d&rsquo;accéder aux données de la table Delta interne avec certaines contraintes</li></ol></li></ol><p>En prenant l&rsquo;exemple de la définition d&rsquo;un objet &ldquo;Materialized View&rdquo; dans le schéma &ldquo;ctg.sch&rdquo; dans un pipeline DLT dont l&rsquo;identifiant est &ldquo;0000&rdquo;, la gestion des données se fera de la manière suivante :</p><ol><li>Création d&rsquo;une table Delta (avec un identifiant unique) dans un schéma interne géré par le système et nommé <code>__databricks__internal.__dlt_materialization_schema_0000</code><ol><li>Avec un sous répertoire (au niveau du stockage des données Delta) <code>_dlt_metadata</code> contenant un répertoire <code>_enzyme_log</code> pour les informations nécessaires au Projet Enzyme afin de gérer le rafraîchissement des données de l&rsquo;objet</li></ol></li><li>Création d&rsquo;un objet de type &ldquo;MATERIALIZED_VIEW&rdquo; dans le schéma &ldquo;ctg.sch&rdquo; qui fait référence à la table Delta créée dans le schéma interne <code>__databricks__internal.__dlt_materialization_schema_0000</code><ol><li>Cela permet d&rsquo;accéder aux données de la table Delta interne avec certaines contraintes</li></ol></li></ol><p>Note : L&rsquo;objet &ldquo;View&rdquo; ne nécessite pas de création d&rsquo;objet dans le schéma cible ou dans le schéma interne</p><h2 id=limitations>Limitations</h2><p>Il est aussi possible de profiter de la fonctionnalité de Data Lineage de la solution Unity Catalog avec les limitations suivantes :</p><ul><li>Il n&rsquo;y a pas la trace des objets sources qui ne sont pas définis dans un pipeline DLT par conséquent la vision du lineage est incomplet lorsque le pipeline DLT ne contient pas l&rsquo;ensemble des éléments.<ul><li>Par exemple, si il y a une source de données de type référentiel qui est utilisée comme source d&rsquo;un objet &ldquo;Materialized View&rdquo;, le lineage n&rsquo;aura pas l&rsquo;information de cette source</li></ul></li><li>Le lineage ne prend pas en compte les vues temporaires et cela peut empêcher de faire le lien entre les sources de la vue et l&rsquo;objet cible</li></ul><p>Limitations (non exhaustive) lors de l&rsquo;utilisation d&rsquo;Unity Catalog avec Delta Live Table :</p><ul><li>Il n&rsquo;est pas possible de modifier le propriétaire d&rsquo;un pipeline utilisant Unity Catalog</li><li>Les objets sont gérés/stockés uniquement dans le stockage par défaut du Metastore de Unity Catalog, il n&rsquo;est pas possible de définir un autre chemin (managé ou externe)</li><li>Il n&rsquo;est pas possible d&rsquo;utiliser le Delta Sharing avec les objets gérés par le framework DLT.</li><li>La lecture des logs des événements des pipelines DLT ne peut se faire que par pipeline DLT</li><li>L&rsquo;accès aux données de certains objets ne peut se faire qu&rsquo;en utilisant un SQL Warehouse (Pro ou Serverless) ou un Cluster (Shared)</li></ul><h1 id=préparation-de-lenvironnement>Préparation de l&rsquo;environnement</h1><h2 id=contexte>Contexte</h2><p>Pré-requis :</p><ul><li>Création du groupe <code>grp_demo</code></li><li>Création de l&rsquo;utilisateur <code>john.do.dbx@gmail.com</code> et ajout de l&rsquo;utilisateur dans le groupe <code>grp_demo</code></li><li>Création d&rsquo;un SQL Warehouse et donnez le droit d&rsquo;utilisation au groupe <code>grp_demo</code></li><li>Existence d&rsquo;un Metastore nommé <code>metastore-sandbox</code> avec le Storage Credential nommé <code>sc-metastore-sandbox</code> permettant de stocker les données par défaut dans la ressource AWS S3 nommée <code>s3-dbx-metastore-uc</code></li><li>Ajout du droit de création d&rsquo;un catalogue sur le Metastore Unity Catalog et du droit d&rsquo;accès aux fichiers</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>GRANT</span> <span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>CATALOG</span> <span style=color:#ff79c6>on</span> METASTORE <span style=color:#ff79c6>to</span> grp_demo;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#ff79c6>GRANT</span> <span style=color:#ff79c6>SELECT</span> <span style=color:#ff79c6>ON</span> <span style=color:#ff79c6>ANY</span> FILE <span style=color:#ff79c6>TO</span> grp_demo;
</span></span></code></pre></div><p>Afin de faciliter la réalisation des exemples, nous allons utiliser la liste suivante de variable d&rsquo;environnement :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4># Create an alias to use the tool curl with .netrc file</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#8be9fd;font-style:italic>alias</span> dbx-api<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#39;curl --netrc-file ~/.databricks/.netrc&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#6272a4># Create an environment variable with Databricks API URL</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;&lt;Workspace Databricks AWS URL&gt;&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#6272a4># Init local variables</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>LOC_PATH_SCRIPT</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;&lt;Local Path for the folder with the Python script&gt;&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>LOC_PATH_DATA</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;&lt;Local Path for the folder with the CSV files&gt;&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#6272a4># Name for DLT Script (Python)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>LOC_SCRIPT_DLT</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;dlt_pipeline.py&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#6272a4># List CSV files for the first execution</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>LOC_SCRIPT_DATA_1</span><span style=color:#ff79c6>=(</span>ref_products_20230501.csv ref_clients_20230501.csv fct_transactions_20230501.csv<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#6272a4># List CSV files for the second execution</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>LOC_SCRIPT_DATA_2</span><span style=color:#ff79c6>=(</span>ref_clients_20230601.csv fct_transactions_20230601.csv<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#6272a4># Init Databricks variables (Workspace)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#6272a4># Path to store the CSV files</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>DBX_PATH_DATA</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;dbfs:/mnt/dlt_demo/data&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#6272a4># Name for the DLT pipeline</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>DBX_DLT_PIPELINE_NAME</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;DLT_pipeline_demo&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#6272a4># DLT pipeline Target Catalog</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>DBX_UC_CATALOG</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;CTG_DLT_DEMO&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span><span style=color:#6272a4># DLT pipeline Target Schema</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>DBX_UC_SCHEMA</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;SCH_DLT_DEMO&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span><span style=color:#6272a4># Path to store the DLT Script (Python)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>DBX_USER_NBK_PATH</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;/Users/john.do.dbx@gmail.com&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span><span style=color:#6272a4># Init Pipeline variable</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>DBX_DLT_PIPELINE_ID</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;&#34;</span>
</span></span></code></pre></div><h2 id=schématisation-de-lenvironnement>Schématisation de l&rsquo;environnement</h2><p>Schématisation du pipeline DLT que nous allons mettre en place :
<a href=/blog/web/20230612_databricks_unity_catalog_deltalivetables_04.png><img src=/blog/web/20230612_databricks_unity_catalog_deltalivetables_04.png alt=schema_04></a></p><p>Détail du pipeline DLT :</p><ul><li>Récupération des données du référentiel Produit en streaming à partir de fichier CSV (ref_products_YYYYMMDD.csv) vers un objet &ldquo;Streaming Table&rdquo; nommé &ldquo;REF_PRODUCTS_RAW&rdquo;</li><li>Alimentation en streaming des données de l&rsquo;objet &ldquo;REF_PRODUCTS_RAW&rdquo; vers un objet &ldquo;Streaming Table&rdquo; nommé &ldquo;REF_PRODUCTS&rdquo;</li><li>Récupération des données du référentiel Client en streaming à partir de fichier CSV (ref_clients_YYYYMMDD.csv) vers un objet &ldquo;Streaming Table&rdquo; nommé &ldquo;REF_CLIENTS_RAW&rdquo; (avec l&rsquo;activation du Change Data Feed)</li><li>Alimentation en streaming des données de l&rsquo;objet &ldquo;REF_PRODUCTS_RAW&rdquo; vers un objet &ldquo;Streaming Table&rdquo; utilisant la fonctionnalité SCD Type 2 et nommé &ldquo;REF_CLIENTS&rdquo;<ul><li>En utilisant une vue nommé &ldquo;REF_CLIENTS_CAST&rdquo; pour transformer les données en amont</li></ul></li><li>Récupération des données de transactions en streaming à partir de fichier CSV (fct_transactions_YYYYMMDD.csv) vers un objet &ldquo;Streaming Table&rdquo; nommé &ldquo;FCT_TRX_RAW&rdquo;</li><li>Alimentation d&rsquo;un objet &ldquo;Streaming Table&rdquo; nommé &ldquo;FCT_TRX&rdquo; à partir de l&rsquo;objet &ldquo;FCT_TRX_RAW&rdquo; en appliquant une contrainte sur l&rsquo;information &ldquo;quantity&rdquo; qui ne doit pas être égale à 0.</li><li>Alimentation d&rsquo;un objet &ldquo;Materialized View&rdquo; nommé &ldquo;FCT_TRX_AGG_MONTH&rdquo; à partir des objets &ldquo;FCT_TRX&rdquo;, &ldquo;REF_CLIENTS&rdquo; et &ldquo;REF_PRODUCTS&rdquo; pour agréger les ventes par mois, clients et produits</li></ul><h2 id=mise-en-place-dun-jeu-de-données>Mise en place d&rsquo;un jeu de données</h2><p>Le jeu de données sera constitué de deux lots afin de réaliser deux exécutions et mettre en pratique le rafraîchissement des données.</p><p>Jeu de données pour le lot n°1 (1ère exécution du pipeline DLT) :<br>Contenu du fichier <code>ref_clients_20230501.csv</code> :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>id,lib,age,contact,phone,is_member,last_maj
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>1,Maxence,23,max1235@ter.tt,+33232301123,No,2023-01-01 11:01:02
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>2,Bruce,26,br_br@ter.tt,+33230033155,Yes,2023-01-01 13:01:00
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>3,Charline,40,ccccharline@ter.tt,+33891234192,Yes,2023-03-02 09:00:00
</span></span></code></pre></div><p>Contenu du fichier <code>ref_products_20230501.csv</code> :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>id,lib,brand,os,last_maj
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>1,Pixel 7 Pro,Google,Android,2023-01-01 09:00:00
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>2,Iphone 14,Apple,IOS,2023-01-01 09:00:00
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>3,Galaxy S23,Samsung,Android,2023-01-01 09:00:00
</span></span></code></pre></div><p>Contenu du fichier <code>fct_transactions_20230501.csv</code> :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>id_trx,ts_trx,id_product,id_shop,id_client,quantity
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>1,2023-04-01 09:00:00,1,2,1,1
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>2,2023-04-01 11:00:00,1,1,1,3
</span></span></code></pre></div><p>Jeu de données pour le lot n°2 (2ème exécution du pipeline DLT) :<br>Contenu du fichier <code>ref_clients_20230601.csv</code> :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>id,lib,age,contact,phone,is_member,last_maj
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>2,Bruce,26,br_br@ter.tt,+33990033100,Yes,2023-04-01 12:00:00
</span></span></code></pre></div><p>Contenu du fichier <code>fct_transactions_20230601.csv</code> :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>id_trx,ts_trx,id_product,id_shop,id_client,quantity
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>3,2023-04-03 14:00:00,1,2,1,1
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>4,2023-04-05 08:00:00,3,1,2,9
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>5,2023-04-06 10:00:00,1,2,1,3
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>6,2023-04-06 12:00:00,2,2,1,1
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>7,2023-01-01 13:00:00,1,2,1,0
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>8,2023-04-10 18:30:00,2,1,2,11
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>9,2023-04-10 18:30:00,3,1,2,2
</span></span></code></pre></div><h2 id=mise-en-place-des-objets-dans-le-metastore-unity-catalog>Mise en place des objets dans le Metastore Unity Catalog</h2><p>Étapes pour la création des objets nécessaires :</p><ol><li>Création d&rsquo;un catalogue nommé <code>ctg_dlt_demo</code></li><li>Création d&rsquo;un schéma nommé <code>sch_dlt_demo</code></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>-- 1. Create Catalog
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>CATALOG</span> <span style=color:#ff79c6>IF</span> <span style=color:#ff79c6>NOT</span> <span style=color:#ff79c6>EXISTS</span> ctg_dlt_demo
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#ff79c6>COMMENT</span> <span style=color:#f1fa8c>&#39;Catalog to store the dlt demo objects&#39;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#6272a4>-- 2. Create Schema
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>SCHEMA</span> <span style=color:#ff79c6>IF</span> <span style=color:#ff79c6>NOT</span> <span style=color:#ff79c6>EXISTS</span> ctg_dlt_demo.sch_dlt_demo
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span><span style=color:#ff79c6>COMMENT</span> <span style=color:#f1fa8c>&#39;Schema to store the dlt demo objects&#39;</span>;
</span></span></code></pre></div><h2 id=création-du-script-python-contenant-la-définition-des-objets-pour-le-framework-dlt>Création du script python contenant la définition des objets pour le framework DLT</h2><p>Le script est nommé <code>dlt_pipeline.py</code> et sera copié dans le Workspace Databricks pour pouvoir être utilisé par le pipeline DLT.</p><p>Le script Python contient le code suivant :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1</span><span><span style=color:#f1fa8c>&#34;&#34;&#34;Pipeline DLT demo&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2</span><span><span style=color:#ff79c6>import</span> dlt
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3</span><span><span style=color:#ff79c6>from</span> pyspark.sql.functions <span style=color:#ff79c6>import</span> col, current_timestamp, expr, <span style=color:#8be9fd;font-style:italic>sum</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5</span><span><span style=color:#6272a4># Folder to store data for the demo</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6</span><span>PATH_DATA <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;dbfs:/mnt/dlt_demo/data&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9</span><span><span style=color:#6272a4>###################</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10</span><span><span style=color:#6272a4>## Products Data ##</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11</span><span><span style=color:#6272a4>###################</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13</span><span><span style=color:#6272a4># Create the streaming table named REF_PRODUCTS_RAW</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14</span><span>@dlt.table(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15</span><span>  name<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;REF_PRODUCTS_RAW&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16</span><span>  comment<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;Raw Products Referential Data&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17</span><span>  table_properties<span style=color:#ff79c6>=</span>{<span style=color:#f1fa8c>&#34;quality&#34;</span> : <span style=color:#f1fa8c>&#34;bronze&#34;</span>},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18</span><span>  temporary<span style=color:#ff79c6>=</span><span style=color:#ff79c6>False</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19</span><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>get_products_raw</span>():
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20</span><span>    <span style=color:#ff79c6>return</span> spark<span style=color:#ff79c6>.</span>readStream<span style=color:#ff79c6>.</span>format(<span style=color:#f1fa8c>&#34;cloudFiles&#34;</span>) \
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21</span><span>                <span style=color:#ff79c6>.</span>option(<span style=color:#f1fa8c>&#34;cloudFiles.format&#34;</span>, <span style=color:#f1fa8c>&#34;csv&#34;</span>) \
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22</span><span>                <span style=color:#ff79c6>.</span>option(<span style=color:#f1fa8c>&#34;delimiter&#34;</span>,<span style=color:#f1fa8c>&#34;,&#34;</span>) \
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23</span><span>                <span style=color:#ff79c6>.</span>option(<span style=color:#f1fa8c>&#34;header&#34;</span>,<span style=color:#f1fa8c>&#34;true&#34;</span>) \
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24</span><span>                <span style=color:#ff79c6>.</span>load(PATH_DATA<span style=color:#ff79c6>+</span><span style=color:#f1fa8c>&#34;/ref_products_*.csv&#34;</span>) \
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25</span><span>                <span style=color:#ff79c6>.</span>select(<span style=color:#f1fa8c>&#34;*&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26</span><span>                        ,col(<span style=color:#f1fa8c>&#34;_metadata.file_name&#34;</span>)<span style=color:#ff79c6>.</span>alias(<span style=color:#f1fa8c>&#34;source_file&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27</span><span>                        ,current_timestamp()<span style=color:#ff79c6>.</span>alias(<span style=color:#f1fa8c>&#34;processing_time&#34;</span>))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29</span><span><span style=color:#6272a4># Create the streaming table named REF_PRODUCTS</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30</span><span>@dlt.table(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31</span><span>  name<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;REF_PRODUCTS&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32</span><span>  comment<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;Products Referential Data&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33</span><span>  table_properties<span style=color:#ff79c6>=</span>{<span style=color:#f1fa8c>&#34;quality&#34;</span> : <span style=color:#f1fa8c>&#34;silver&#34;</span>},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34</span><span>  temporary<span style=color:#ff79c6>=</span><span style=color:#ff79c6>False</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35</span><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>get_products</span>():
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36</span><span>   <span style=color:#ff79c6>return</span> dlt<span style=color:#ff79c6>.</span>read_stream(<span style=color:#f1fa8c>&#34;REF_PRODUCTS_RAW&#34;</span>) \
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37</span><span>            <span style=color:#ff79c6>.</span>where(<span style=color:#f1fa8c>&#34;_rescued_data is null&#34;</span>) \
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38</span><span>            <span style=color:#ff79c6>.</span>select(col(<span style=color:#f1fa8c>&#34;id&#34;</span>)<span style=color:#ff79c6>.</span>cast(<span style=color:#f1fa8c>&#34;INT&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39</span><span>                    ,col(<span style=color:#f1fa8c>&#34;lib&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40</span><span>                    ,col(<span style=color:#f1fa8c>&#34;brand&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41</span><span>                    ,col(<span style=color:#f1fa8c>&#34;os&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42</span><span>                    ,col(<span style=color:#f1fa8c>&#34;last_maj&#34;</span>)<span style=color:#ff79c6>.</span>cast(<span style=color:#f1fa8c>&#34;TIMESTAMP&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43</span><span>                    ,col(<span style=color:#f1fa8c>&#34;source_file&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44</span><span>                    ,col(<span style=color:#f1fa8c>&#34;processing_time&#34;</span>))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47</span><span><span style=color:#6272a4>###################</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48</span><span><span style=color:#6272a4>## Clients Data ##</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49</span><span><span style=color:#6272a4>##################</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51</span><span><span style=color:#6272a4># Create the streaming table named REF_CLIENTS_RAW</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52</span><span>@dlt.table(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53</span><span>  name<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;REF_CLIENTS_RAW&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54</span><span>  comment<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;Raw Clients Referential Data&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55</span><span>  table_properties<span style=color:#ff79c6>=</span>{<span style=color:#f1fa8c>&#34;quality&#34;</span> : <span style=color:#f1fa8c>&#34;bronze&#34;</span>, <span style=color:#f1fa8c>&#34;delta.enableChangeDataFeed&#34;</span> : <span style=color:#f1fa8c>&#34;true&#34;</span>},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56</span><span>  temporary<span style=color:#ff79c6>=</span><span style=color:#ff79c6>False</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57</span><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>get_products_raw</span>():
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58</span><span>    <span style=color:#ff79c6>return</span> spark<span style=color:#ff79c6>.</span>readStream<span style=color:#ff79c6>.</span>format(<span style=color:#f1fa8c>&#34;cloudFiles&#34;</span>) \
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59</span><span>                <span style=color:#ff79c6>.</span>option(<span style=color:#f1fa8c>&#34;cloudFiles.format&#34;</span>, <span style=color:#f1fa8c>&#34;csv&#34;</span>) \
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60</span><span>                <span style=color:#ff79c6>.</span>option(<span style=color:#f1fa8c>&#34;delimiter&#34;</span>,<span style=color:#f1fa8c>&#34;,&#34;</span>) \
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61</span><span>                <span style=color:#ff79c6>.</span>option(<span style=color:#f1fa8c>&#34;header&#34;</span>,<span style=color:#f1fa8c>&#34;true&#34;</span>) \
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62</span><span>                <span style=color:#ff79c6>.</span>load(PATH_DATA<span style=color:#ff79c6>+</span><span style=color:#f1fa8c>&#34;/ref_clients_*.csv&#34;</span>) \
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63</span><span>                <span style=color:#ff79c6>.</span>select(<span style=color:#f1fa8c>&#34;*&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64</span><span>                        ,col(<span style=color:#f1fa8c>&#34;_metadata.file_name&#34;</span>)<span style=color:#ff79c6>.</span>alias(<span style=color:#f1fa8c>&#34;source_file&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65</span><span>                        ,current_timestamp()<span style=color:#ff79c6>.</span>alias(<span style=color:#f1fa8c>&#34;processing_time&#34;</span>))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67</span><span><span style=color:#6272a4># Create the temporary view named REF_CLIENTS_RAW_CAST</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68</span><span>@dlt.view(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69</span><span>      name<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;REF_CLIENTS_RAW_CAST&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70</span><span>      ,comment<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;Temp view for Clients Raw Casting&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71</span><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>view_clients_cast</span>():
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72</span><span>  <span style=color:#ff79c6>return</span> dlt<span style=color:#ff79c6>.</span>read_stream(<span style=color:#f1fa8c>&#34;REF_CLIENTS_RAW&#34;</span>) \
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73</span><span>            <span style=color:#ff79c6>.</span>select(expr(<span style=color:#f1fa8c>&#34;cast(id as INT) as id&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74</span><span>                    ,col(<span style=color:#f1fa8c>&#34;lib&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75</span><span>                    ,expr(<span style=color:#f1fa8c>&#34;cast(age as INT) as age&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76</span><span>                    ,col(<span style=color:#f1fa8c>&#34;contact&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77</span><span>                    ,col(<span style=color:#f1fa8c>&#34;phone&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78</span><span>                    ,expr(<span style=color:#f1fa8c>&#34;(is_member = &#39;Yes&#39;) as is_member&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79</span><span>                    ,expr(<span style=color:#f1fa8c>&#34;cast(last_maj as timestamp) as last_maj&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80</span><span>                    ,col(<span style=color:#f1fa8c>&#34;source_file&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81</span><span>                    ,col(<span style=color:#f1fa8c>&#34;processing_time&#34;</span>))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83</span><span><span style=color:#6272a4># Create the streaming table named REF_CLIENTS (and using SCD Type 2 management)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84</span><span>dlt<span style=color:#ff79c6>.</span>create_streaming_table(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85</span><span>  name <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;REF_CLIENTS&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86</span><span>  comment <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;Clients Referential Data (SCD2)&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87</span><span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89</span><span><span style=color:#6272a4># Apply modification (for SCD Type 2 management) based on the temporary view</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90</span><span>dlt<span style=color:#ff79c6>.</span>apply_changes(target <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;REF_CLIENTS&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91</span><span>                source <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;REF_CLIENTS_RAW_CAST&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92</span><span>                keys <span style=color:#ff79c6>=</span> [<span style=color:#f1fa8c>&#34;id&#34;</span>],
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93</span><span>                sequence_by <span style=color:#ff79c6>=</span> col(<span style=color:#f1fa8c>&#34;last_maj&#34;</span>),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94</span><span>                stored_as_scd_type <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>2</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97</span><span><span style=color:#6272a4>#######################</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98</span><span><span style=color:#6272a4>## Transactions Data ##</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99</span><span><span style=color:#6272a4>#######################</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">100</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">101</span><span><span style=color:#6272a4># Create the streaming table named FCT_TRX_RAW</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">102</span><span>@dlt.table(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">103</span><span>    name<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;FCT_TRX_RAW&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">104</span><span>    comment<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;Raw Transactions Fact Data&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">105</span><span>    table_properties<span style=color:#ff79c6>=</span>{<span style=color:#f1fa8c>&#34;quality&#34;</span> : <span style=color:#f1fa8c>&#34;bronze&#34;</span>},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">106</span><span>    partition_cols<span style=color:#ff79c6>=</span>[<span style=color:#f1fa8c>&#34;dt_tech&#34;</span>],
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">107</span><span>    temporary<span style=color:#ff79c6>=</span><span style=color:#ff79c6>False</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">108</span><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>get_transactions_raw</span>():
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">109</span><span>    <span style=color:#ff79c6>return</span> spark<span style=color:#ff79c6>.</span>readStream<span style=color:#ff79c6>.</span>format(<span style=color:#f1fa8c>&#34;cloudFiles&#34;</span>) \
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">110</span><span>                <span style=color:#ff79c6>.</span>option(<span style=color:#f1fa8c>&#34;cloudFiles.format&#34;</span>, <span style=color:#f1fa8c>&#34;csv&#34;</span>) \
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">111</span><span>                <span style=color:#ff79c6>.</span>option(<span style=color:#f1fa8c>&#34;delimiter&#34;</span>,<span style=color:#f1fa8c>&#34;,&#34;</span>) \
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">112</span><span>                <span style=color:#ff79c6>.</span>option(<span style=color:#f1fa8c>&#34;header&#34;</span>,<span style=color:#f1fa8c>&#34;true&#34;</span>) \
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">113</span><span>                <span style=color:#ff79c6>.</span>load(PATH_DATA<span style=color:#ff79c6>+</span><span style=color:#f1fa8c>&#34;/fct_transactions_*.csv&#34;</span>) \
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">114</span><span>                <span style=color:#ff79c6>.</span>select(<span style=color:#f1fa8c>&#34;*&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">115</span><span>                        ,col(<span style=color:#f1fa8c>&#34;_metadata.file_name&#34;</span>)<span style=color:#ff79c6>.</span>alias(<span style=color:#f1fa8c>&#34;source_file&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">116</span><span>                        ,current_timestamp()<span style=color:#ff79c6>.</span>alias(<span style=color:#f1fa8c>&#34;processing_time&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">117</span><span>                        ,expr(<span style=color:#f1fa8c>&#34;current_date() as dt_tech&#34;</span>))\
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">118</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">119</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">120</span><span><span style=color:#6272a4># Create the streaming table named FCT_TRX (with expectation)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">121</span><span>@dlt.table(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">122</span><span>    name<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;FCT_TRX&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">123</span><span>    comment<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;Transactions Fact Data&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">124</span><span>    table_properties<span style=color:#ff79c6>=</span>{<span style=color:#f1fa8c>&#34;quality&#34;</span> : <span style=color:#f1fa8c>&#34;silver&#34;</span>},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">125</span><span>    partition_cols<span style=color:#ff79c6>=</span>[<span style=color:#f1fa8c>&#34;dt_trx&#34;</span>],
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">126</span><span>    temporary<span style=color:#ff79c6>=</span><span style=color:#ff79c6>False</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">127</span><span>@dlt.expect(<span style=color:#f1fa8c>&#34;valide quantity&#34;</span>,<span style=color:#f1fa8c>&#34;quantity &lt;&gt; 0&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">128</span><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>get_transactions</span>():
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">129</span><span>    <span style=color:#ff79c6>return</span> dlt<span style=color:#ff79c6>.</span>read_stream(<span style=color:#f1fa8c>&#34;FCT_TRX_RAW&#34;</span>) \
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">130</span><span>                <span style=color:#ff79c6>.</span>where(<span style=color:#f1fa8c>&#34;_rescued_data IS NULL&#34;</span>) \
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">131</span><span>                <span style=color:#ff79c6>.</span>select(expr(<span style=color:#f1fa8c>&#34;cast(id_trx as INT) as id_trx&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">132</span><span>                        ,expr(<span style=color:#f1fa8c>&#34;cast(ts_trx as timestamp) as ts_trx&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">133</span><span>                        ,expr(<span style=color:#f1fa8c>&#34;cast(id_product as INT) as id_product&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">134</span><span>                        ,expr(<span style=color:#f1fa8c>&#34;cast(id_shop as INT) as id_shop&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">135</span><span>                        ,expr(<span style=color:#f1fa8c>&#34;cast(id_client as INT) as id_client&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">136</span><span>                        ,expr(<span style=color:#f1fa8c>&#34;cast(quantity as DOUBLE) as quantity&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">137</span><span>                        ,col(<span style=color:#f1fa8c>&#34;source_file&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">138</span><span>                        ,col(<span style=color:#f1fa8c>&#34;processing_time&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">139</span><span>                        ,col(<span style=color:#f1fa8c>&#34;dt_tech&#34;</span>)) \
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">140</span><span>                <span style=color:#ff79c6>.</span>withColumn(<span style=color:#f1fa8c>&#34;_invalid_data&#34;</span>,expr(<span style=color:#f1fa8c>&#34;not(coalesce(quantity,0) &lt;&gt; 0)&#34;</span>)) \
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">141</span><span>                <span style=color:#ff79c6>.</span>withColumn(<span style=color:#f1fa8c>&#34;dt_trx&#34;</span>,expr(<span style=color:#f1fa8c>&#34;cast(ts_trx  as date)&#34;</span>))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">142</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">143</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">144</span><span><span style=color:#6272a4># Create the Materialized View named FCT_TRX_AGG_MONTH</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">145</span><span>@dlt.table(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">146</span><span>    name<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;FCT_TRX_AGG_MONTH&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">147</span><span>    comment<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;Transactions Fact Data Aggregate Month&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">148</span><span>    table_properties<span style=color:#ff79c6>=</span>{<span style=color:#f1fa8c>&#34;quality&#34;</span> : <span style=color:#f1fa8c>&#34;gold&#34;</span>},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">149</span><span>    partition_cols<span style=color:#ff79c6>=</span>[<span style=color:#f1fa8c>&#34;dt_month&#34;</span>],
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">150</span><span>    temporary<span style=color:#ff79c6>=</span><span style=color:#ff79c6>False</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">151</span><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>get_transactions_agg_month</span>():
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">152</span><span>    data_fct <span style=color:#ff79c6>=</span> dlt<span style=color:#ff79c6>.</span>read(<span style=color:#f1fa8c>&#34;FCT_TRX&#34;</span>)<span style=color:#ff79c6>.</span>where(<span style=color:#f1fa8c>&#34;not(_invalid_data)&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">153</span><span>    data_ref_products <span style=color:#ff79c6>=</span> dlt<span style=color:#ff79c6>.</span>read(<span style=color:#f1fa8c>&#34;REF_PRODUCTS&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">154</span><span>    data_ref_clients <span style=color:#ff79c6>=</span> dlt<span style=color:#ff79c6>.</span>read(<span style=color:#f1fa8c>&#34;REF_CLIENTS&#34;</span>)<span style=color:#ff79c6>.</span>where(<span style=color:#f1fa8c>&#34;__END_AT IS NULL&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">155</span><span>    <span style=color:#ff79c6>return</span> data_fct<span style=color:#ff79c6>.</span>alias(<span style=color:#f1fa8c>&#34;fct&#34;</span>)<span style=color:#ff79c6>.</span>join(data_ref_products<span style=color:#ff79c6>.</span>alias(<span style=color:#f1fa8c>&#34;rp&#34;</span>), data_fct<span style=color:#ff79c6>.</span>id_product <span style=color:#ff79c6>==</span> data_ref_products<span style=color:#ff79c6>.</span>id, how<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;inner&#34;</span>) \
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">156</span><span>                <span style=color:#ff79c6>.</span>join(data_ref_clients<span style=color:#ff79c6>.</span>alias(<span style=color:#f1fa8c>&#34;rc&#34;</span>),data_fct<span style=color:#ff79c6>.</span>id_client <span style=color:#ff79c6>==</span> data_ref_clients<span style=color:#ff79c6>.</span>id, how<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;inner&#34;</span>) \
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">157</span><span>                <span style=color:#ff79c6>.</span>withColumn(<span style=color:#f1fa8c>&#34;dt_month&#34;</span>,expr(<span style=color:#f1fa8c>&#34;cast(substring(cast(fct.dt_trx as STRING),0,7)||&#39;-01&#39; as date)&#34;</span>)) \
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">158</span><span>                <span style=color:#ff79c6>.</span>groupBy(<span style=color:#f1fa8c>&#34;dt_month&#34;</span>,<span style=color:#f1fa8c>&#34;rc.lib&#34;</span>,<span style=color:#f1fa8c>&#34;rc.contact&#34;</span>,<span style=color:#f1fa8c>&#34;rp.brand&#34;</span>) \
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">159</span><span>                <span style=color:#ff79c6>.</span>agg(<span style=color:#8be9fd;font-style:italic>sum</span>(<span style=color:#f1fa8c>&#34;fct.quantity&#34;</span>)<span style=color:#ff79c6>.</span>alias(<span style=color:#f1fa8c>&#34;sum_quantity&#34;</span>)) \
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">160</span><span>                <span style=color:#ff79c6>.</span>select(col(<span style=color:#f1fa8c>&#34;dt_month&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">161</span><span>                        ,col(<span style=color:#f1fa8c>&#34;rc.lib&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">162</span><span>                        ,col(<span style=color:#f1fa8c>&#34;rc.contact&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">163</span><span>                        ,col(<span style=color:#f1fa8c>&#34;rp.brand&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">164</span><span>                        ,col(<span style=color:#f1fa8c>&#34;sum_quantity&#34;</span>)<span style=color:#ff79c6>.</span>alias(<span style=color:#f1fa8c>&#34;quantity&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">165</span><span>                        ,expr(<span style=color:#f1fa8c>&#34;current_timestamp() as ts_tech&#34;</span>))
</span></span></code></pre></div><h1 id=création-dun-pipeline-dlt>Création d&rsquo;un Pipeline DLT</h1><p>Pour créer le pipeline DLT, nous allons suivre les étapes suivantes :</p><ol><li>Création d&rsquo;un répertoire dans le répertoire DBFS pour stocker les fichiers CSV</li><li>Copie du script Python sur le Workspace Databricks</li><li>Création du pipeline DLT (en prenant comme source le script Python copié sur le Workspace Databricks)</li><li>Récupération de l&rsquo;identifiant du pipeline DLT dans une variable d&rsquo;environnement nommée &ldquo;DBX_DLT_PIPELINE_NAME&rdquo;</li></ol><p>Utilisation de Databricks REST API :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4># 1. Create the directory to store CSV files (on the DBFS)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>dbx-api -X POST <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.0/dbfs/mkdirs -H <span style=color:#f1fa8c>&#39;Content-Type: application/json&#39;</span> -d <span style=color:#f1fa8c>&#34;{
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#f1fa8c>    \&#34;path\&#34;: \&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_PATH_DATA</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>\&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#f1fa8c>}&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#6272a4># 2. Copy the Python script into the Workspace</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>dbx-api -X POST <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.0/workspace/import -H <span style=color:#f1fa8c>&#39;Content-Type: application/json&#39;</span> -d <span style=color:#f1fa8c>&#34;{
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#f1fa8c>    \&#34;format\&#34;: \&#34;SOURCE\&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#f1fa8c>    \&#34;path\&#34;: \&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_USER_NBK_PATH</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>/</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>LOC_SCRIPT_DLT</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>\&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#f1fa8c>    \&#34;content\&#34; : \&#34;</span><span style=color:#ff79c6>$(</span>base64 -i <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>LOC_PATH_SCRIPT</span><span style=color:#f1fa8c>}</span>/<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>LOC_SCRIPT_DLT</span><span style=color:#f1fa8c>}</span><span style=color:#ff79c6>)</span><span style=color:#f1fa8c>\&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#f1fa8c>    \&#34;language\&#34;: \&#34;PYTHON\&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#f1fa8c>    \&#34;overwrite\&#34;: \&#34;true\&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#f1fa8c>}&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#6272a4># 3. Create the DLT Pipeline based on the Python script</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>dbx-api -X POST <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.0/pipelines -H <span style=color:#f1fa8c>&#39;Content-Type: application/json&#39;</span> -d <span style=color:#f1fa8c>&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#f1fa8c>{
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#f1fa8c>    \&#34;continuous\&#34;: false,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#f1fa8c>    \&#34;name\&#34;: \&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_DLT_PIPELINE_NAME</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>\&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#f1fa8c>    \&#34;channel\&#34;: \&#34;PREVIEW\&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#f1fa8c>    \&#34;catalog\&#34;: \&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_UC_CATALOG</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>\&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#f1fa8c>    \&#34;target\&#34;: \&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_UC_SCHEMA</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>\&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#f1fa8c>    \&#34;development\&#34;: true,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span><span style=color:#f1fa8c>    \&#34;photon\&#34;: false,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span><span style=color:#f1fa8c>    \&#34;edition\&#34;: \&#34;ADVANCED\&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span><span style=color:#f1fa8c>    \&#34;allow_duplicate_names\&#34;: \&#34;false\&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span><span style=color:#f1fa8c>    \&#34;dry_run\&#34;: false,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span><span style=color:#f1fa8c>    \&#34;configuration\&#34;: {
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span><span style=color:#f1fa8c>      \&#34;pipelines.clusterShutdown.delay\&#34;: \&#34;600s\&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span><span style=color:#f1fa8c>    },
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span><span style=color:#f1fa8c>    \&#34;clusters\&#34;: [
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span><span style=color:#f1fa8c>      {
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span><span style=color:#f1fa8c>        \&#34;label\&#34;: \&#34;default\&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span><span style=color:#f1fa8c>        \&#34;num_workers\&#34;: 1
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span><span style=color:#f1fa8c>      }
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span><span style=color:#f1fa8c>    ],
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span><span style=color:#f1fa8c>    \&#34;libraries\&#34;: [
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span><span style=color:#f1fa8c>      {
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span><span style=color:#f1fa8c>        \&#34;notebook\&#34;: {
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span><span style=color:#f1fa8c>          \&#34;path\&#34;: \&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_USER_NBK_PATH</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>/</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>LOC_SCRIPT_DLT</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>\&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span><span style=color:#f1fa8c>        }
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span><span style=color:#f1fa8c>      }
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span><span style=color:#f1fa8c>    ]
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span><span style=color:#f1fa8c>}&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span><span style=color:#6272a4># 4. Retrieve the Pipeline ID</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>DBX_DLT_PIPELINE_ID</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>`</span>dbx-api -X GET <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.0/pipelines | jq -r <span style=color:#f1fa8c>&#39;.statuses[]|select(.name==$ENV.DBX_DLT_PIPELINE_NAME)|.pipeline_id&#39;</span><span style=color:#f1fa8c>`</span>
</span></span></code></pre></div><h1 id=exécution-et-visualisation-dun-pipeline-dlt>Exécution et Visualisation d&rsquo;un pipeline DLT</h1><h2 id=exécution-du-pipeline-dlt>Exécution du pipeline DLT</h2><p>Afin de pouvoir réaliser la 1ère exécution du pipeline DLT, il faut réaliser les actions suivantes :</p><ol><li>Copiez les données CSV du lot n°1 dans le répertoire DBFS (sur le Workspace Databricks)</li><li>Exécutez le pipeline DLT</li><li>Récupérez le statut du pipeline DLT</li></ol><p>Utilisation de Databricks REST API :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4># 1. Upload CSV Files (for execution)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#ff79c6>for</span> file in <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>LOC_SCRIPT_DATA_1</span><span style=color:#f1fa8c>}</span>; <span style=color:#ff79c6>do</span> 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    dbx-api -X POST <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.0/dbfs/put -H <span style=color:#f1fa8c>&#39;Content-Type: application/json&#39;</span> -d <span style=color:#f1fa8c>&#34;{
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#f1fa8c>        \&#34;path\&#34;: \&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_PATH_DATA</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>/</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>file</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>\&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#f1fa8c>        \&#34;contents\&#34;: \&#34;</span><span style=color:#ff79c6>$(</span>base64 -i <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>LOC_PATH_DATA</span><span style=color:#f1fa8c>}</span>/<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>file</span><span style=color:#f1fa8c>}</span><span style=color:#ff79c6>)</span><span style=color:#f1fa8c>\&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#f1fa8c>        \&#34;overwrite\&#34;: \&#34;true\&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#f1fa8c>        }&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#ff79c6>done</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#6272a4># 2. Execute the DLT Pipeline</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>dbx-api -X POST <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.0/pipelines/<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_DLT_PIPELINE_ID</span><span style=color:#f1fa8c>}</span>/updates -H <span style=color:#f1fa8c>&#39;Content-Type: application/json&#39;</span> -d <span style=color:#f1fa8c>&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#f1fa8c>{
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#f1fa8c>    \&#34;full_refresh\&#34;: false,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#f1fa8c>    \&#34;cause\&#34;: \&#34;USER_ACTION\&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#f1fa8c>}&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#6272a4># 3. Retrieve the status of the DLT Pipeline execution</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>dbx-api -X GET <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.0/pipelines/<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_DLT_PIPELINE_ID</span><span style=color:#f1fa8c>}</span>/events | jq <span style=color:#f1fa8c>&#39;.events[0]|.details&#39;</span>
</span></span></code></pre></div><p>Afin de pouvoir réaliser la 2ème exécution du pipeline DLT, il faut réaliser les actions suivantes :</p><ol><li>Copiez les données CSV du lot n°2 dans le répertoire DBFS (sur le Workspace Databricks)</li><li>Exécutez le pipeline DLT</li><li>Récupérez le statut du pipeline DLT</li></ol><p>Utilisation de Databricks REST API :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4># 1. Upload CSV Files (for execution)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#ff79c6>for</span> file in <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>LOC_SCRIPT_DATA_2</span><span style=color:#f1fa8c>}</span>; <span style=color:#ff79c6>do</span> 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    dbx-api -X POST <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.0/dbfs/put -H <span style=color:#f1fa8c>&#39;Content-Type: application/json&#39;</span> -d <span style=color:#f1fa8c>&#34;{
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#f1fa8c>        \&#34;path\&#34;: \&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_PATH_DATA</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>/</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>file</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>\&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#f1fa8c>        \&#34;contents\&#34;: \&#34;</span><span style=color:#ff79c6>$(</span>base64 -i <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>LOC_PATH_DATA</span><span style=color:#f1fa8c>}</span>/<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>file</span><span style=color:#f1fa8c>}</span><span style=color:#ff79c6>)</span><span style=color:#f1fa8c>\&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#f1fa8c>        \&#34;overwrite\&#34;: \&#34;true\&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#f1fa8c>        }&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#ff79c6>done</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#6272a4># 2. Execute the DLT Pipeline</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>dbx-api -X POST <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.0/pipelines/<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_DLT_PIPELINE_ID</span><span style=color:#f1fa8c>}</span>/updates -H <span style=color:#f1fa8c>&#39;Content-Type: application/json&#39;</span> -d <span style=color:#f1fa8c>&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#f1fa8c>{
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#f1fa8c>    \&#34;full_refresh\&#34;: false,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#f1fa8c>    \&#34;cause\&#34;: \&#34;USER_ACTION\&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#f1fa8c>}&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#6272a4># 3. Retrieve the status of the DLT Pipeline execution</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>dbx-api -X GET <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.0/pipelines/<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_DLT_PIPELINE_ID</span><span style=color:#f1fa8c>}</span>/events | jq <span style=color:#f1fa8c>&#39;.events[0]|.details&#39;</span>
</span></span></code></pre></div><h2 id=visualisation-du-pipeline-dlt>Visualisation du pipeline DLT</h2><p>Résultat après la 1ère exécution du pipeline DLT :
<a href=/blog/web/20230612_databricks_unity_catalog_deltalivetables_05.png><img src=/blog/web/20230612_databricks_unity_catalog_deltalivetables_05.png alt=schema_05></a></p><p>Détail de l&rsquo;objet &ldquo;FCT_TRX&rdquo; (avec la contrainte sur l&rsquo;information &ldquo;quantity&rdquo;) :
<a href=/blog/web/20230612_databricks_unity_catalog_deltalivetables_06.png><img src=/blog/web/20230612_databricks_unity_catalog_deltalivetables_06.png alt=schema_06></a></p><p>Détail de l&rsquo;objet &ldquo;REF_CLIENTS&rdquo; (alimenté par le processus SCD de type 2) :
<a href=/blog/web/20230612_databricks_unity_catalog_deltalivetables_07.png><img src=/blog/web/20230612_databricks_unity_catalog_deltalivetables_07.png alt=schema_07></a></p><p>Résultat après la 2ème exécution du pipeline DLT :
<a href=/blog/web/20230612_databricks_unity_catalog_deltalivetables_08.png><img src=/blog/web/20230612_databricks_unity_catalog_deltalivetables_08.png alt=schema_08></a></p><p>Détail de l&rsquo;objet &ldquo;FCT_TRX&rdquo; (avec la contrainte sur l&rsquo;information &ldquo;quantity&rdquo;) :
<a href=/blog/web/20230612_databricks_unity_catalog_deltalivetables_09.png><img src=/blog/web/20230612_databricks_unity_catalog_deltalivetables_08.png alt=schema_09></a></p><p>Détail de l&rsquo;objet &ldquo;REF_CLIENTS&rdquo; (alimenté par le processus SCD de type 2) :
<a href=/blog/web/20230612_databricks_unity_catalog_deltalivetables_10.png><img src=/blog/web/20230612_databricks_unity_catalog_deltalivetables_10.png alt=schema_10></a></p><p>Exemple de l&rsquo;onglet contenant les logs d&rsquo;évènements de la 2ème exécution du pipeline DLT:
<a href=/blog/web/20230612_databricks_unity_catalog_deltalivetables_11.png><img src=/blog/web/20230612_databricks_unity_catalog_deltalivetables_11.png alt=schema_11></a></p><p>Remarque :</p><ul><li>Le graphe du pipeline DLT permet de très facilement visualiser le lineage des données ainsi que le nombre d&rsquo;enregistrement traités (ou supprimés) lors de chaque étape (objet)</li><li>Lorsque nous cliquons sur un objet, nous pouvons avoir des métriques sur l&rsquo;objet (nombre d&rsquo;enregistrements écrits et supprimés, nombre d&rsquo;enregistrements violant une contrainte, schéma de l&rsquo;objet, date et heure d&rsquo;exécution, durée, &mldr;)</li><li>En bas de l&rsquo;écran, nous avons accès à l&rsquo;ensemble des logs d&rsquo;événements de l&rsquo;exécution du pipeline DLT et il est possible de les filtrer sur les options &ldquo;All&rdquo;, &ldquo;Info&rdquo;, &ldquo;Warning&rdquo; et &ldquo;Error&rdquo; ou sur la description des événements.</li><li>Il est possible de choisir l&rsquo;exécution que l&rsquo;on souhaite visualiser en la sélectionnant dans la liste déroulante (par timestamp d&rsquo;exécution et contenant le dernier statut d&rsquo;exécution).</li></ul><h2 id=visualisation-avec-unity-catalog>Visualisation avec Unity Catalog</h2><p>Visualisation des objets du schéma &ldquo;sch_dlt_demo&rdquo; dans le catalogue &ldquo;ctg_dlt_demo&rdquo; :
<a href=/blog/web/20230612_databricks_unity_catalog_deltalivetables_12.png><img src=/blog/web/20230612_databricks_unity_catalog_deltalivetables_12.png alt=schema_12></a></p><p>Visualisation des détails pour l&rsquo;objet &ldquo;FCT_TRX&rdquo; qui est un objet &ldquo;Streaming Table&rdquo; :
<a href=/blog/web/20230612_databricks_unity_catalog_deltalivetables_13.png><img src=/blog/web/20230612_databricks_unity_catalog_deltalivetables_13.png alt=schema_13></a></p><p>Visualisation des détails pour l&rsquo;objet &ldquo;FCT_TRX_AGG_MONTH&rdquo; qui est un objet &ldquo;Materialized View&rdquo; :
<a href=/blog/web/20230612_databricks_unity_catalog_deltalivetables_14.png><img src=/blog/web/20230612_databricks_unity_catalog_deltalivetables_14.png alt=schema_14></a></p><p>Remarque :</p><ul><li>Nous pouvons voir que l&rsquo;information &ldquo;Storage Location&rdquo; n&rsquo;existe pas car ce ne sont pas réellement des tables Delta mais cela peut être vu comme des objets logiques.</li></ul><p>Concernant le Data Lineage :
Visualisation du lineage en partant de l&rsquo;objet &ldquo;REF_CLIENTS&rdquo; :
<a href=/blog/web/20230612_databricks_unity_catalog_deltalivetables_15.png><img src=/blog/web/20230612_databricks_unity_catalog_deltalivetables_15.png alt=schema_15></a>
Remarque :</p><ul><li>Nous pouvons observer qu&rsquo;il y a des informations pour les objets définis dans le pipeline DLT à l&rsquo;exception de la source de données de l&rsquo;objet &ldquo;REF_CLIENTS&rdquo; qui se nomme &ldquo;REF_CLIENTS_RAW&rdquo;</li><li>Nous pouvons observer qu&rsquo;il n&rsquo;y a aucune information sur les sources de données (fichiers CSV)</li></ul><p>Visualisation du lineage en partant de l&rsquo;objet &ldquo;REF_CLIENTS_RAW&rdquo; :
<a href=/blog/web/20230612_databricks_unity_catalog_deltalivetables_16.png><img src=/blog/web/20230612_databricks_unity_catalog_deltalivetables_16.png alt=schema_16></a>
Remarque :</p><ul><li>Nous pouvons observer que l&rsquo;objet &ldquo;REF_CLIENTS_RAW&rdquo; n&rsquo;a aucune information de lineage alors qu&rsquo;il est la source de l&rsquo;alimentation de l&rsquo;objet &ldquo;REF_CLIENTS&rdquo; dans le pipeline DLT</li></ul><p>Concernant les objets internes :
Attention : Pour pouvoir les visualiser, il faut avoir les droits suivants</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>GRANT</span> USE_CATALOG <span style=color:#ff79c6>ON</span> <span style=color:#ff79c6>CATALOG</span> __databricks_internal <span style=color:#ff79c6>TO</span> <span style=color:#ff79c6>&lt;</span><span style=color:#ff79c6>user</span> <span style=color:#ff79c6>or</span> <span style=color:#ff79c6>group</span><span style=color:#ff79c6>&gt;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#ff79c6>GRANT</span> USE_SCHEMA <span style=color:#ff79c6>ON</span> <span style=color:#ff79c6>SCHEMA</span> __databricks_internal.__dlt_materialization_schema_<span style=color:#ff79c6>&lt;</span>pipeline_id<span style=color:#ff79c6>&gt;</span> <span style=color:#ff79c6>TO</span> <span style=color:#ff79c6>&lt;</span><span style=color:#ff79c6>user</span> <span style=color:#ff79c6>or</span> <span style=color:#ff79c6>group</span><span style=color:#ff79c6>&gt;</span>;
</span></span></code></pre></div><p>Visualisation du catalogue interne <code>__databricks_internal</code> avec Data Explorer :
<a href=/blog/web/20230612_databricks_unity_catalog_deltalivetables_17.png><img src=/blog/web/20230612_databricks_unity_catalog_deltalivetables_17.png alt=schema_17></a></p><p>Visualisation des détails pour l&rsquo;objet interne &ldquo;FCT_TRX&rdquo; (qui contient les données d&rsquo;un objet &ldquo;Streaming Table&rdquo;) :
<a href=/blog/web/20230612_databricks_unity_catalog_deltalivetables_18.png><img src=/blog/web/20230612_databricks_unity_catalog_deltalivetables_18.png alt=schema_18></a></p><p>Visualisation des détails pour l&rsquo;objet &ldquo;FCT_TRX_AGG_MONTH&rdquo; (qui contient les données d&rsquo;un objet &ldquo;Materialized View&rdquo;) :
<a href=/blog/web/20230612_databricks_unity_catalog_deltalivetables_19.png><img src=/blog/web/20230612_databricks_unity_catalog_deltalivetables_19.png alt=schema_19></a></p><p>Remarque :</p><ul><li>Nous pouvons observer que ce sont des tables Delta classiques</li></ul><h1 id=monitoring-dun-pipeline-dlt>Monitoring d&rsquo;un pipeline DLT</h1><p>Le monitoring d&rsquo;un pipeline DLT s&rsquo;appuie sur les logs d&rsquo;événements liés à l&rsquo;exécution du pipeline DLT, incluant les logs d&rsquo;audit, de qualité des données et de lineage.
Cela permet d&rsquo;analyser les exécutions et l&rsquo;état des pipelines DLT.</p><p>L&rsquo;objet interne <code>__event_log</code> est une table Delta qui contient un sous répertoire nommé <code>_dlt_metadata</code> et contenant un répertoire <code>_autoloader</code> avec les informations permettant de gérer le chargement des données par le système avec Auto Loader.</p><p>Il y a quatre méthodes d&rsquo;accès aux logs des événements concernant l&rsquo;exécution des pipelines DLT :</p><ol><li>La 1ère méthode consiste à utiliser l&rsquo;interface utilisateurs du Workspace Databricks<ol><li>Cliquez sur l&rsquo;option &ldquo;Workflows&rdquo; dans le menu latéral</li><li>Cliquez sur l&rsquo;onglet &ldquo;Delta Live Tables&rdquo;</li><li>Sélectionnez le pipeline DLT voulu</li><li>Sélectionnez l&rsquo;exécution du pipeline DLT voulu (trié par timestamp de début décroissant)</li><li>L&rsquo;ensemble des logs d&rsquo;événements se trouve dans l&rsquo;onglet en bas de l&rsquo;interface</li></ol></li><li>La 2ème méthode est d&rsquo;utiliser l&rsquo;<a href=https://docs.databricks.com/api/workspace/pipelines/listpipelineevents>API REST Databricks</a></li><li>La 3ème méthode est d&rsquo;utiliser la fonction <code>event_log(&lt;pipeline_id)</code> (table valued function), c&rsquo;est la méthode recommandée par Databricks</li><li>La 4ème méthode est d&rsquo;accéder à la table Delta <code>__event_log</code> se trouvant dans le schéma interne lié au pipeline DLT<ol><li>Cette méthode nécessite d&rsquo;avoir le droit &ldquo;USE&rdquo; sur le schéma interne et sur le catalogue interne correspondant</li></ol></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>GRANT</span> USE_CATALOG <span style=color:#ff79c6>ON</span> <span style=color:#ff79c6>CATALOG</span> __databricks_internal <span style=color:#ff79c6>TO</span> <span style=color:#ff79c6>&lt;</span><span style=color:#ff79c6>user</span> <span style=color:#ff79c6>or</span> <span style=color:#ff79c6>group</span><span style=color:#ff79c6>&gt;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#ff79c6>GRANT</span> USE_SCHEMA <span style=color:#ff79c6>ON</span> <span style=color:#ff79c6>SCHEMA</span> __databricks_internal.__dlt_materialization_schema_<span style=color:#ff79c6>&lt;</span>pipeline_id<span style=color:#ff79c6>&gt;</span> <span style=color:#ff79c6>TO</span> <span style=color:#ff79c6>&lt;</span><span style=color:#ff79c6>user</span> <span style=color:#ff79c6>or</span> <span style=color:#ff79c6>group</span><span style=color:#ff79c6>&gt;</span>;
</span></span></code></pre></div><p>Le stockage des logs d&rsquo;événements des pipelines DLT est physiquement séparé pour chaque pipeline DLT et il n&rsquo;existe pas de vue par défaut qui permet d&rsquo;avoir une vue agrégée des logs d’événements.
Vous trouverez le détail du schéma dans la <a href=https://docs.databricks.com/delta-live-tables/observability.html#event-log-schema>documentation officielle</a></p><p>Les types d&rsquo;événements existant sont les suivants (non exhaustif) :</p><ul><li>user_action : Information concernant les actions utilisateurs (création d&rsquo;un pipeline DLT, exécution d&rsquo;un pipeline DLT, arrêt manuel d&rsquo;un pipeline DLT)</li><li>create_update : Information concernant la demande d&rsquo;exécution du pipeline DLT (origine de la demande)</li><li>update_progress : Information concernant les étapes d&rsquo;exécution du pipeline DLT (WAITING_FOR_RESOURCES, INITIALIZING, SETTING_UP_TABLES, RUNNING, COMPLETED, FAILED)</li><li>flow_definition : Information concernant la définition des objets (Type de mise à jour (INCREMENTAL, CHANGE, COMPLETE), schéma de l&rsquo;objet, &mldr;)</li><li>dataset_definition : Information concernant la définition des objets (schéma, stockage, type, &mldr;)</li><li>graph_created : Information concernant la création du graphe lors de l&rsquo;exécution du pipeline DLT</li><li>planning_information : Information concernant la planification des rafraîchissements pour les objets &ldquo;Materialized View&rdquo;</li><li>flow_progress : Information concernant les étapes d&rsquo;exécutions de l&rsquo;ensemble des éléments définis dans le pipeline DLT (QUEUED, STARTING, RUNNING, COMPLETED, FAILED)</li><li>cluster_resources : Information sur la gestion des ressources du cluster du pipeline DLT</li><li>maintenance_progress : Information concernant les opérations de maintenance sur les données dans un délai de 24h après l&rsquo;exécution du pipeline DLT</li></ul><p>Attention :</p><ul><li>Lorsque vous supprimez un pipeline DLT, les logs d&rsquo;événements ne seront plus accessibles en utilisant la fonction <code>event_log(&lt;pipeline_id)</code> mais seront toujours accessible en accédant directement à la table Delta “__event_log” concernée (tant qu&rsquo;elle ne sera pas supprimée)</li><li>Les métriques ne sont pas capturées pour les objets &ldquo;Streaming Table&rdquo; mis à jour avec le processus de Slow Changing Dimension (SCD) de Type 2 géré par le framework DLT<ul><li>Néanmoins, il est possible d&rsquo;avoir des métriques en accédant à l&rsquo;historique de la table Delta interne directement</li></ul></li><li>Lorsqu&rsquo;il y a des enregistrements ne respectant pas les contraintes sur un objet, nous avons accès aux métriques sur le nombre d&rsquo;enregistrements mais pas le détail des enregistrements concernés.</li></ul><p>Il est très simple de mettre en place des tableaux de bord ou des exports basés sur les événements pour centraliser les informations à partir de l&rsquo;API REST Databricks, de SQL Warehouse ou en ajoutant un traitement (dans un Job) après l&rsquo;exécution de chaque pipeline DLT permettant de récupérer les informations nécessaires.</p><p>Nous allons nous appuyer sur la 3ème méthode pour donner des exemples de requête permettant d&rsquo;analyser le pipeline DLT :</p><p>1/ Exemple de requête permettant de récupérer l&rsquo;ensemble des informations pour la dernière exécution du pipeline DLT</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>with</span> updid (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>  <span style=color:#ff79c6>select</span> row_number() over (<span style=color:#ff79c6>order</span> <span style=color:#ff79c6>by</span> ts_start_pipeline <span style=color:#ff79c6>desc</span>) <span style=color:#ff79c6>as</span> num_exec_desc
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>        ,update_id
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>        ,ts_start_pipeline
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>  <span style=color:#ff79c6>from</span> (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#ff79c6>select</span> origin.update_id <span style=color:#ff79c6>as</span> update_id,<span style=color:#ff79c6>min</span>(<span style=color:#ff79c6>timestamp</span>) <span style=color:#ff79c6>as</span> ts_start_pipeline
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#ff79c6>from</span> event_log(<span style=color:#f1fa8c>&#39;a64f295a-1655-43ca-9543-f1dd1e73009c&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#ff79c6>where</span> origin.update_id <span style=color:#ff79c6>is</span> <span style=color:#ff79c6>not</span> <span style=color:#ff79c6>null</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#ff79c6>group</span> <span style=color:#ff79c6>by</span> origin.update_id
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>  )
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#ff79c6>select</span> l.<span style=color:#ff79c6>*</span> 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#ff79c6>from</span> event_log(<span style=color:#f1fa8c>&#39;a64f295a-1655-43ca-9543-f1dd1e73009c&#39;</span>) l
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#ff79c6>where</span> l.origin.update_id <span style=color:#ff79c6>=</span> (<span style=color:#ff79c6>select</span> update_id <span style=color:#ff79c6>from</span> updid <span style=color:#ff79c6>where</span> num_exec_desc <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#ff79c6>order</span> <span style=color:#ff79c6>by</span> <span style=color:#ff79c6>timestamp</span> <span style=color:#ff79c6>desc</span>
</span></span></code></pre></div><p>Résultat :
<a href=/blog/web/20230612_databricks_unity_catalog_deltalivetables_20.png><img src=/blog/web/20230612_databricks_unity_catalog_deltalivetables_20.png alt=schema_20></a></p><p>2/ Exemple de requête permettant de récupérer le nombre de ligne écrites pour chaque objet lors des deux exécutions du pipeline DLT :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>with</span> updid (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>  <span style=color:#ff79c6>select</span> row_number() over (<span style=color:#ff79c6>order</span> <span style=color:#ff79c6>by</span> ts_start_pipeline <span style=color:#ff79c6>desc</span>) <span style=color:#ff79c6>as</span> num_exec_desc
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>        ,update_id
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>        ,ts_start_pipeline
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>  <span style=color:#ff79c6>from</span> (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#ff79c6>select</span> origin.update_id <span style=color:#ff79c6>as</span> update_id,<span style=color:#ff79c6>min</span>(<span style=color:#ff79c6>timestamp</span>) <span style=color:#ff79c6>as</span> ts_start_pipeline
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#ff79c6>from</span> event_log(<span style=color:#f1fa8c>&#39;a64f295a-1655-43ca-9543-f1dd1e73009c&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#ff79c6>where</span> origin.update_id <span style=color:#ff79c6>is</span> <span style=color:#ff79c6>not</span> <span style=color:#ff79c6>null</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#ff79c6>group</span> <span style=color:#ff79c6>by</span> origin.update_id
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>  )
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#ff79c6>select</span> l.origin.flow_name
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>  ,u.ts_start_pipeline
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>  ,<span style=color:#ff79c6>sum</span>(l.details:[<span style=color:#f1fa8c>&#39;flow_progress&#39;</span>][<span style=color:#f1fa8c>&#39;metrics&#39;</span>][<span style=color:#f1fa8c>&#39;num_output_rows&#39;</span>]) <span style=color:#ff79c6>as</span> num_output_rows
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>  ,<span style=color:#ff79c6>sum</span>(l.details:[<span style=color:#f1fa8c>&#39;flow_progress&#39;</span>][<span style=color:#f1fa8c>&#39;metrics&#39;</span>][<span style=color:#f1fa8c>&#39;num_upserted_rows&#39;</span>]) <span style=color:#ff79c6>as</span> num_upserted_rows
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>  ,<span style=color:#ff79c6>sum</span>(l.details:[<span style=color:#f1fa8c>&#39;flow_progress&#39;</span>][<span style=color:#f1fa8c>&#39;metrics&#39;</span>][<span style=color:#f1fa8c>&#39;num_deleted_rows&#39;</span>]) <span style=color:#ff79c6>as</span> num_deleted_rows
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#ff79c6>from</span> event_log(<span style=color:#f1fa8c>&#39;a64f295a-1655-43ca-9543-f1dd1e73009c&#39;</span>) l
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#ff79c6>inner</span> <span style=color:#ff79c6>join</span> updid u
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#ff79c6>on</span> (l.origin.update_id <span style=color:#ff79c6>=</span> u.update_id)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#ff79c6>and</span> event_type <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;flow_progress&#39;</span> 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#ff79c6>and</span> details:[<span style=color:#f1fa8c>&#39;flow_progress&#39;</span>][<span style=color:#f1fa8c>&#39;metrics&#39;</span>] <span style=color:#ff79c6>is</span> <span style=color:#ff79c6>not</span> <span style=color:#ff79c6>null</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#ff79c6>group</span> <span style=color:#ff79c6>by</span> l.origin.flow_name
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>  ,u.ts_start_pipeline
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span><span style=color:#ff79c6>order</span> <span style=color:#ff79c6>by</span> l.origin.flow_name
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>  ,u.ts_start_pipeline
</span></span></code></pre></div><p>Remarque :</p><ul><li>Lorsque l&rsquo;objet est de type &ldquo;Streaming Table&rdquo;, les métriques sont capturées avec l&rsquo;événement qui a le statut &ldquo;RUNNING&rdquo;<ul><li>Cas particulier pour un objet &ldquo;Streaming Table&rdquo; utilisant le processus du SCD Type 2 dont les métriques ne sont pas capturés</li></ul></li><li>Lorsque l&rsquo;objet est de type &ldquo;Materialized View&rdquo;, les métriques sont capturés avec l&rsquo;événement qui a le statut &ldquo;COMPLETED&rdquo;</li><li>Lorsque l&rsquo;objet est de type &ldquo;View&rdquo;, aucune métrique n&rsquo;est capturée</li></ul><p>Résultat :
<a href=/blog/web/20230612_databricks_unity_catalog_deltalivetables_21.png><img src=/blog/web/20230612_databricks_unity_catalog_deltalivetables_21.png alt=schema_21></a></p><p>Commentaire :</p><ul><li>Nous pouvons observer que les objets &ldquo;REF_PRODUCTS&rdquo; et &ldquo;REF_PRODUCTS_RAW&rdquo; n&rsquo;avaient pas de nouvelle données lors de la deuxième exécution</li><li>Nous pouvons observer que l&rsquo;objet &ldquo;REF_CLIENT&rdquo; n&rsquo;a pas d&rsquo;information alors que l&rsquo;objet source &ldquo;REF_CLIENT_RAW&rdquo; a récupéré uniquement les nouvelles données lors de chaque exécution du pipeline DLT</li></ul><p>3/ Exemple de requête pour récupérer le nombre d&rsquo;enregistrements ne respectant pas les contraintes pour l&rsquo;objet &ldquo;FCT_TRX&rdquo; lors de chaque exécution du pipeline DLT :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>with</span> updid (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>  <span style=color:#ff79c6>select</span> row_number() over (<span style=color:#ff79c6>order</span> <span style=color:#ff79c6>by</span> ts_start_pipeline <span style=color:#ff79c6>desc</span>) <span style=color:#ff79c6>as</span> num_exec_desc
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>        ,update_id
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>        ,ts_start_pipeline
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>  <span style=color:#ff79c6>from</span> (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#ff79c6>select</span> origin.update_id <span style=color:#ff79c6>as</span> update_id,<span style=color:#ff79c6>min</span>(<span style=color:#ff79c6>timestamp</span>) <span style=color:#ff79c6>as</span> ts_start_pipeline
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#ff79c6>from</span> event_log(<span style=color:#f1fa8c>&#39;a64f295a-1655-43ca-9543-f1dd1e73009c&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#ff79c6>where</span> origin.update_id <span style=color:#ff79c6>is</span> <span style=color:#ff79c6>not</span> <span style=color:#ff79c6>null</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#ff79c6>group</span> <span style=color:#ff79c6>by</span> origin.update_id
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>  )
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#ff79c6>select</span> flow_name
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>  ,metrics.name
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>  ,ts_start_pipeline
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>  ,<span style=color:#ff79c6>sum</span>(metrics.passed_records) <span style=color:#ff79c6>as</span> passed_records
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>  ,<span style=color:#ff79c6>sum</span>(metrics.failed_records) <span style=color:#ff79c6>as</span> failed_records
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#ff79c6>from</span> (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>  <span style=color:#ff79c6>select</span> l.origin.flow_name <span style=color:#ff79c6>as</span> flow_name
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    ,u.ts_start_pipeline <span style=color:#ff79c6>as</span> ts_start_pipeline
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    ,explode(from_json(l.details:[<span style=color:#f1fa8c>&#39;flow_progress&#39;</span>][<span style=color:#f1fa8c>&#39;data_quality&#39;</span>][<span style=color:#f1fa8c>&#39;expectations&#39;</span>][<span style=color:#ff79c6>*</span>], <span style=color:#f1fa8c>&#39;array&lt;struct&lt;name string, passed_records int, failed_records int &gt;&gt;&#39;</span>)) <span style=color:#ff79c6>as</span> metrics
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>  <span style=color:#ff79c6>from</span> event_log(<span style=color:#f1fa8c>&#39;a64f295a-1655-43ca-9543-f1dd1e73009c&#39;</span>) l
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>  <span style=color:#ff79c6>inner</span> <span style=color:#ff79c6>join</span> updid u
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>  <span style=color:#ff79c6>on</span> (l.origin.update_id <span style=color:#ff79c6>=</span> u.update_id)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>  <span style=color:#ff79c6>and</span> event_type <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;flow_progress&#39;</span> 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>  <span style=color:#ff79c6>and</span> origin.flow_name <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;fct_trx&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>  <span style=color:#ff79c6>and</span> details:[<span style=color:#f1fa8c>&#39;flow_progress&#39;</span>][<span style=color:#f1fa8c>&#39;data_quality&#39;</span>] <span style=color:#ff79c6>is</span> <span style=color:#ff79c6>not</span> <span style=color:#ff79c6>null</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>) wrk
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span><span style=color:#ff79c6>group</span> <span style=color:#ff79c6>by</span> flow_name
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>  ,metrics.name
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>  ,ts_start_pipeline
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span><span style=color:#ff79c6>order</span> <span style=color:#ff79c6>by</span> flow_name
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>  ,metrics.name
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>  ,ts_start_pipeline
</span></span></code></pre></div><p>Résultat :
<a href=/blog/web/20230612_databricks_unity_catalog_deltalivetables_22.png><img src=/blog/web/20230612_databricks_unity_catalog_deltalivetables_22.png alt=schema_22></a></p><p>4/ Exemple de requête pour récupérer les dates de début et de fin de chaque exécution du pipeline DLT :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>with</span> updid (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>  <span style=color:#ff79c6>select</span> row_number() over (<span style=color:#ff79c6>order</span> <span style=color:#ff79c6>by</span> ts_start_pipeline <span style=color:#ff79c6>desc</span>) <span style=color:#ff79c6>as</span> num_exec_desc
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>        ,update_id
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>        ,ts_start_pipeline
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>  <span style=color:#ff79c6>from</span> (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#ff79c6>select</span> origin.update_id <span style=color:#ff79c6>as</span> update_id,<span style=color:#ff79c6>min</span>(<span style=color:#ff79c6>timestamp</span>) <span style=color:#ff79c6>as</span> ts_start_pipeline
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#ff79c6>from</span> event_log(<span style=color:#f1fa8c>&#39;a64f295a-1655-43ca-9543-f1dd1e73009c&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#ff79c6>where</span> origin.update_id <span style=color:#ff79c6>is</span> <span style=color:#ff79c6>not</span> <span style=color:#ff79c6>null</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#ff79c6>group</span> <span style=color:#ff79c6>by</span> origin.update_id
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>  )
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#ff79c6>select</span> update_id
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>,start_time
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>,end_time
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>,end_time <span style=color:#ff79c6>-</span> start_time <span style=color:#ff79c6>as</span> duration
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>,last_state
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#ff79c6>from</span> (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>  <span style=color:#ff79c6>select</span> l.origin.update_id <span style=color:#ff79c6>as</span> update_id
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    ,<span style=color:#ff79c6>min</span>(l.<span style=color:#ff79c6>timestamp</span>) over (partition <span style=color:#ff79c6>by</span> l.origin.update_id) <span style=color:#ff79c6>as</span> start_time
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    ,<span style=color:#ff79c6>max</span>(l.<span style=color:#ff79c6>timestamp</span>) over (partition <span style=color:#ff79c6>by</span> l.origin.update_id) <span style=color:#ff79c6>as</span> end_time
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>    ,row_number() over (partition <span style=color:#ff79c6>by</span> l.origin.update_id <span style=color:#ff79c6>order</span> <span style=color:#ff79c6>by</span> <span style=color:#ff79c6>timestamp</span> <span style=color:#ff79c6>desc</span>) <span style=color:#ff79c6>as</span> num
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>    ,l.details:[<span style=color:#f1fa8c>&#39;update_progress&#39;</span>][<span style=color:#f1fa8c>&#39;state&#39;</span>] <span style=color:#ff79c6>as</span> last_state
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>  <span style=color:#ff79c6>from</span> event_log(<span style=color:#f1fa8c>&#39;a64f295a-1655-43ca-9543-f1dd1e73009c&#39;</span>) l
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>  <span style=color:#ff79c6>inner</span> <span style=color:#ff79c6>join</span> updid u
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>  <span style=color:#ff79c6>on</span> (l.origin.update_id <span style=color:#ff79c6>=</span> u.update_id)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>  <span style=color:#ff79c6>and</span> event_type <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;update_progress&#39;</span> 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>) wrk
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span><span style=color:#ff79c6>where</span> num <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span><span style=color:#ff79c6>order</span> <span style=color:#ff79c6>by</span> update_id
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>,start_time <span style=color:#ff79c6>asc</span>
</span></span></code></pre></div><p>Résultat :
<a href=/blog/web/20230612_databricks_unity_catalog_deltalivetables_23.png><img src=/blog/web/20230612_databricks_unity_catalog_deltalivetables_23.png alt=schema_23></a></p><h1 id=suppression-des-éléments>Suppression des éléments</h1><p>Suppression du pipeline DLT</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>dbx-api -X DELETE <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.0/pipelines/<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_DLT_PIPELINE_ID</span><span style=color:#f1fa8c>}</span>
</span></span></code></pre></div><p>Suppression du script Python du Workspace Databricks</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>dbx-api -X POST <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.0/workspace/delete -H <span style=color:#f1fa8c>&#39;Content-Type: application/json&#39;</span> -d <span style=color:#f1fa8c>&#34;{
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#f1fa8c>    \&#34;path\&#34;: \&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_USER_NBK_PATH</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>/</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>LOC_SCRIPT_DLT</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>\&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#f1fa8c>    \&#34;recursive\&#34;: \&#34;false\&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#f1fa8c>}&#34;</span>
</span></span></code></pre></div><p>Suppression des fichiers de données du DBFS du Workspace Databricks</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>dbx-api -X POST <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.0/dbfs/delete -H <span style=color:#f1fa8c>&#39;Content-Type: application/json&#39;</span> -d <span style=color:#f1fa8c>&#34;{
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#f1fa8c>    \&#34;path\&#34;: \&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_PATH_DATA</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>\&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#f1fa8c>    \&#34;recursive\&#34;: \&#34;true\&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#f1fa8c>}&#34;</span>
</span></span></code></pre></div><p>Suppression du catalogue &ldquo;CTG_DLT_DEMO&rdquo; du Metastore Unity Catalog :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>-- Delete the Catalog with CASCADE option (to delete all objects)
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>DROP</span> <span style=color:#ff79c6>CATALOG</span> <span style=color:#ff79c6>IF</span> <span style=color:#ff79c6>EXISTS</span> CTG_DLT_DEMO <span style=color:#ff79c6>CASCADE</span>;
</span></span></code></pre></div><p>Attention :</p><ul><li>La suppression du pipeline DLT va supprimer l&rsquo;ensemble des objets du schéma cible mais ne supprimera pas automatiquement les tables Delta du schéma interne</li><li>Vous devez supprimer manuellement les tables Delta internes pour que le schéma interne associé au pipeline DLT supprimé soit lui-même supprimé lors de l&rsquo;opération de maintenance automatique</li></ul><p>Suppression des tables Delta du schéma interne :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4># Get the list of tables (with full_name)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>list_tables</span><span style=color:#ff79c6>=(</span><span style=color:#f1fa8c>`</span>dbx-api -X GET <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.1/unity-catalog/tables -H <span style=color:#f1fa8c>&#39;Content-Type: application/json&#39;</span> -d <span style=color:#f1fa8c>&#34;{
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#f1fa8c>    \&#34;catalog_name\&#34;: \&#34;__databricks_internal\&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#f1fa8c>    \&#34;schema_name\&#34;: \&#34;__dlt_materialization_schema_</span><span style=color:#ff79c6>$(</span><span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_DLT_PIPELINE_ID</span><span style=color:#f1fa8c>}</span> | sed <span style=color:#f1fa8c>&#39;s/-/_/g&#39;</span><span style=color:#ff79c6>)</span><span style=color:#f1fa8c>\&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#f1fa8c>}&#34;</span> | jq -r <span style=color:#f1fa8c>&#39;.tables[]|.full_name&#39;</span><span style=color:#f1fa8c>`</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#6272a4># Delete tables</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#ff79c6>for</span> table in <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>list_tables</span><span style=color:#f1fa8c>}</span>; <span style=color:#ff79c6>do</span> 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    dbx-api -X DELETE <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.1/unity-catalog/tables/<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>table</span><span style=color:#f1fa8c>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#ff79c6>done</span>
</span></span></code></pre></div><h1 id=conclusion>Conclusion</h1><p>Le framework DLT permet d&rsquo;être très efficace dans la création et l&rsquo;exécution d&rsquo;un pipeline ETL et de pouvoir facilement ajouter une gestion de la qualité de la donnée (sous réserve d&rsquo;utiliser l&rsquo;édition Advanced).</p><p>Le fait de pouvoir visualiser le graphe et les métriques associées aux objets d&rsquo;une exécution précise du pipeline DLT est extrêmement pratique pour une analyse rapide.
De plus, l&rsquo;accès aux logs d&rsquo;événements (stockés dans une table Delta) nous permet de récupérer beaucoup d&rsquo;informations et de pouvoir faire des analyses et des tableaux de bords très simplement.</p><p>Lors de POC ou de traitement d&rsquo;ingestion ETL spécifique, il est très pratique de pouvoir s&rsquo;appuyer sur le framework DLT mais dans le cadre d&rsquo;un projet nécessitant de gérer de nombreux objets et schémas, on se retrouve beaucoup trop limité pour pouvoir utiliser le framework DLT.</p><p>En l&rsquo;état (preview public), les limitations sont trop importantes pour nous permettre de recommander l&rsquo;utilisation du framework DLT avec Unity Catalog pour des projets importants :</p><ul><li>Le lineage est incomplet si l&rsquo;objet n&rsquo;est pas géré dans le pipeline DLT ou si on utilise des objets de type &ldquo;View&rdquo;</li><li>On ne peut avoir qu&rsquo;un seul schéma cible pour l&rsquo;ensemble des éléments d&rsquo;un pipeline DLT</li><li>Certaines opérations (gestion SCD Type 1 et 2) n&rsquo;ont pas de métriques capturées dans les logs d&rsquo;événements</li><li>Pas d&rsquo;agrégations des logs d&rsquo;événements de l&rsquo;ensemble des pipelines par défaut si l&rsquo;on souhaite faire des analyses sur l&rsquo;ensemble des pipelines DLT</li></ul><p>A mon humble opinion, il est encore un peu tôt pour utiliser le framework DLT en s&rsquo;appuyant sur la solution Unity Catalog pour gérer l&rsquo;ensemble des processus ETL pour la gestion des données d&rsquo;une entreprise, mais j&rsquo;ai hâte de voir les futurs améliorations apportées par Databricks pour en faire un outil central et performant pour gérer les processus ETL tout en profitant de l&rsquo;ensemble des fonctionnalités de la solution Unity Catalog (Data Lineage, Delta Sharing, &mldr;).</p></div></article></div></div><footer><div class="container-fluid prag-bg-primary prag-foot">Généré avec <a href=https://gohugo.io/>Hugo</a>
&nbsp; - &nbsp;
<a href=https://en.wikipedia.org/wiki/WTFPL>WTFPL license</a> © 2018–2023</div></footer></body></html>