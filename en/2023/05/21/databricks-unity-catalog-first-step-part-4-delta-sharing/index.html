<!doctype html><html lang=en><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta charset=utf-8><meta name=robots content="noindex, nofollow, noarchive, nosnipper, noodp, noydir"><meta name=google content="notranslate, noimageindex"><meta name=slurp content="notranslate, noimageindex"><meta name=msnbot content="notranslate, noimageindex"><meta name=bingbot content="notranslate, noimageindex"><meta name=generator content="Hugo 0.125.1"><link rel=stylesheet href=https://www.pragmatias.fr//css/bootstrap.min.css><link rel=stylesheet href=https://www.pragmatias.fr//css/pragmatias.css><script src=https://www.pragmatias.fr//js/jquery-3.6.0.slim.min.js></script><script src=https://www.pragmatias.fr//js/popper.min.js></script><script src=https://www.pragmatias.fr//js/bootstrap.bundle.min.js></script><link rel=alternate type=application/rss+xml href=https://www.pragmatias.fr/en/feed.xml><title>Databricks : Unity Catalog - First Step - Part 4 - Delta Sharing</title><body><div class="navbar navbar-expand-md prag-bg-primary prag-header" role=navigation><div class="container-fluid justify-content-center"><div class=navbar-brand><a href=https://www.pragmatias.fr/en/blog/><img src=/images/logo_pragmatias.svg alt=pragmatias></a></div><button class="navbar-toggler justify-content-end prag-navbar" type=button data-toggle=collapse data-target=#navbarSupportedContent1,#navbarSupportedContent2 aria-controls=navbarSupportedContent1 aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent1><ul class="navbar-nav text-center"><li class=nav-item><a class=nav-link href=https://www.pragmatias.fr/en/blog/>Blog</a></li><li class=nav-item><a class=nav-link href=https://www.pragmatias.fr/en/tags/>Tags</a></li><li class=nav-item><a class=nav-link href=https://www.pragmatias.fr/en/archives/>Archives</a></li></ul></div><div class="collapse navbar-collapse justify-content-md-end" id=navbarSupportedContent2><ul class="navbar-nav flex-row justify-content-center"><li class=nav-item><a href=https://www.pragmatias.fr/2023/05/21/databricks-unity-catalog-d%C3%A9couverte-partie-4-delta-sharing/ class="prag_header_svg mr-1 ml-1"><img src=/images/france-flag-round-xs-24.png alt=FranÃ§ais></a></li><li class=nav-item><a href=https://www.pragmatias.fr/en/feed.xml title="Pragmatias Blog" class="prag_header_svg mr-1 ml-1"><svg height="24" style="enable-background:new 0 0 508.52 508.52" viewBox="0 0 508.52 508.52" width="24" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path style="fill-rule:evenodd;clip-rule:evenodd;fill:" d="M254.26.0C113.845.0.0 113.845.0 254.26s113.845 254.26 254.26 254.26 254.26-113.845 254.26-254.26C508.52 113.813 394.675.0 254.26.0zM137.141 412.441c-22.852.0-41.413-18.434-41.413-41.285.0-22.693 18.561-41.349 41.413-41.349 22.915.0 41.444 18.656 41.476 41.349C178.618 393.976 160.088 412.441 137.141 412.441zM241.197 412.791c0-39.029-15.16-75.674-42.62-103.071-27.46-27.524-63.978-42.716-102.785-42.716V207.38c113.177.0 205.315 92.137 205.315 205.41h-59.91zM347.001 412.727c0-138.603-112.669-251.399-251.145-251.399v-59.624c171.435.0 310.96 139.589 310.96 311.023H347.001z"/></svg></a></li><li class=nav-item><a href=mailto:contact@pragmatias.fr title=Mail class="prag_header_svg mr-1 ml-1"><svg height="24" style="enable-background:new 0 0 299.997 299.997" viewBox="0 0 299.997 299.997" width="24" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path style="fill-rule:evenodd;clip-rule:evenodd;fill:" d="M149.996.0C67.157.0.001 67.158.001 149.997c0 82.837 67.156 150 149.995 150s150-67.163 150-150C299.996 67.158 232.835.0 149.996.0zM149.999 52.686l88.763 55.35H61.236l88.763-55.35zm89.869 143.737h-.009c0 8.878-7.195 16.072-16.072 16.072H76.211c-8.878.0-16.072-7.195-16.072-16.072v-84.865c0-.939.096-1.852.252-2.749l84.808 52.883c.104.065.215.109.322.169.112.062.226.122.34.179.599.309 1.216.558 1.847.721.065.018.13.026.195.041.692.163 1.393.265 2.093.265h.005c.005.0.01.0.01.0.7.0 1.401-.099 2.093-.265.065-.016.13-.023.195-.041.63-.163 1.245-.412 1.847-.721.114-.057.228-.117.34-.179.106-.06.218-.104.322-.169l84.808-52.883c.156.897.252 1.808.252 2.749v84.865z"/></svg></a></li><li><a href=https://github.com/pragmatias/ title=github class="prag_header_svg mr-1 ml-1"><svg height="24" style="enable-background:new 0 0 438.549 438.549" viewBox="0 0 438.549 438.549" width="24" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path style="fill-rule:evenodd;clip-rule:evenodd;fill:" d="M409.132 114.573c-19.608-33.596-46.205-60.194-79.798-79.8C295.736 15.166 259.057 5.365 219.271 5.365c-39.781.0-76.472 9.804-110.063 29.408-33.596 19.605-60.192 46.204-79.8 79.8C9.803 148.168.0 184.854.0 224.63c0 47.78 13.94 90.745 41.827 128.906 27.884 38.164 63.906 64.572 108.063 79.227 5.14.954 8.945.283 11.419-1.996 2.475-2.282 3.711-5.14 3.711-8.562.0-.571-.049-5.708-.144-15.417-.098-9.709-.144-18.179-.144-25.406l-6.567 1.136c-4.187.767-9.469 1.092-15.846 1-6.374-.089-12.991-.757-19.842-1.999-6.854-1.231-13.229-4.086-19.13-8.559-5.898-4.473-10.085-10.328-12.56-17.556l-2.855-6.57c-1.903-4.374-4.899-9.233-8.992-14.559-4.093-5.331-8.232-8.945-12.419-10.848l-1.999-1.431c-1.332-.951-2.568-2.098-3.711-3.429-1.142-1.331-1.997-2.663-2.568-3.997-.572-1.335-.098-2.43 1.427-3.289s4.281-1.276 8.28-1.276l5.708.853c3.807.763 8.516 3.042 14.133 6.851 5.614 3.806 10.229 8.754 13.846 14.842 4.38 7.806 9.657 13.754 15.846 17.847 6.184 4.093 12.419 6.136 18.699 6.136s11.704-.476 16.274-1.423c4.565-.952 8.848-2.383 12.847-4.285 1.713-12.758 6.377-22.559 13.988-29.41-10.848-1.14-20.601-2.857-29.264-5.14-8.658-2.286-17.605-5.996-26.835-11.14-9.235-5.137-16.896-11.516-22.985-19.126-6.09-7.614-11.088-17.61-14.987-29.979-3.901-12.374-5.852-26.648-5.852-42.826.0-23.035 7.52-42.637 22.557-58.817-7.044-17.318-6.379-36.732 1.997-58.24 5.52-1.715 13.706-.428 24.554 3.853 10.85 4.283 18.794 7.952 23.84 10.994 5.046 3.041 9.089 5.618 12.135 7.708 17.705-4.947 35.976-7.421 54.818-7.421s37.117 2.474 54.823 7.421l10.849-6.849c7.419-4.57 16.18-8.758 26.262-12.565 10.088-3.805 17.802-4.853 23.134-3.138 8.562 21.509 9.325 40.922 2.279 58.24 15.036 16.18 22.559 35.787 22.559 58.817.0 16.178-1.958 30.497-5.853 42.966-3.9 12.471-8.941 22.457-15.125 29.979-6.191 7.521-13.901 13.85-23.131 18.986-9.232 5.14-18.182 8.85-26.84 11.136-8.662 2.286-18.415 4.004-29.263 5.146 9.894 8.562 14.842 22.077 14.842 40.539v60.237c0 3.422 1.19 6.279 3.572 8.562 2.379 2.279 6.136 2.95 11.276 1.995 44.163-14.653 80.185-41.062 108.068-79.226 27.88-38.161 41.825-81.126 41.825-128.906C438.536 184.851 428.728 148.168 409.132 114.573z"/></svg></a></li></ul></div></div></div><div id=content><div class=container-fluid><article class="blog-post blog-post-with-toc"><header><h2 class=blog-post-title>Databricks : Unity Catalog - First Step - Part 4 - Delta Sharing</h2><div class=blog-post-date><span>Last update : 21 May 2023</span></div><div class=blog-post-date>Reading time : 42 minute(s) - 8756 words</div><div class=blog-post-tags><strong>Tags:</strong>
<a href=https://www.pragmatias.fr/en/tags/databricks/>Databricks</a>
<a href=https://www.pragmatias.fr/en/tags/unity-catalog/>Unity Catalog</a></div></header><aside class=prag-toc><h1 class=prag-toc-head>Summary</h1><div class=prag-toc-body><nav id=TableOfContents><ol><li><a href=#whats-data-sharing>What&rsquo;s Data Sharing</a></li><li><a href=#unity-catalog-and-the-object-hierarchy>Unity Catalog and the object hierarchy</a></li><li><a href=#whats-the-delta-sharing-feature>What&rsquo;s the Delta Sharing feature</a></li><li><a href=#what-are-the-audit-logs>What are the Audit Logs</a></li><li><a href=#set-up-the-environment>Set-up the environment</a><ol><li><a href=#context>Context</a></li><li><a href=#diagram-of-the-environment>Diagram of the environment</a></li><li><a href=#environment-variable>Environment variable</a></li><li><a href=#setting-up-a-dataset-on-the-aws-s3-resource>Setting up a dataset on the AWS S3 resource</a></li><li><a href=#setting-up-the-objects-on-the-unity-catalog-metastore>Setting up the objects on the Unity Catalog Metastore</a></li><li><a href=#creating-a-notebook-to-be-able-to-share-it>Creating a notebook to be able to share it</a></li></ol></li><li><a href=#configuring-the-audit-logs-on-the-metastore>Configuring the audit logs on the Metastore</a></li><li><a href=#activate-the-delta-sharing-feature-on-the-metastore>Activate the Delta Sharing feature on the Metastore</a></li><li><a href=#create-a-share-in-the-metastore>Create a share in the Metastore</a></li><li><a href=#sharing-data-with-a-unity-catalog-metastore-on-azure>Sharing data with a Unity Catalog Metastore on Azure</a><ol><li><a href=#unity-catalog-setup-on-azure>Unity Catalog setup on Azure</a></li><li><a href=#setting-up-a-databricks-to-databricks-recipient>Setting up a Databricks-to-Databricks recipient</a></li><li><a href=#access-through-the-unity-catalog-metastore-on-azure>Access through the Unity Catalog Metastore on Azure</a></li><li><a href=#reading-audit-logs>Reading audit logs</a></li></ol></li><li><a href=#data-sharing-in-open-sharing>Data sharing in Open Sharing</a><ol><li><a href=#access-by-python-script>Access by python script</a></li><li><a href=#lecture-des-logs-daudit>Lecture des logs d&rsquo;audit</a></li></ol></li><li><a href=#clean-environment>Clean environment</a></li><li><a href=#conclusion>Conclusion</a></li></ol></nav></div></aside><a id=showTopBtn href=# class=prag-sticky-bot><svg height="24" id="Layer_1" style="enable-background:new 0 0 438.533 438.533" viewBox="0 0 438.533 438.533" width="24" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path style="fill-rule:evenodd;clip-rule:evenodd;fill:" d="M409.133 109.203c-19.608-33.592-46.205-60.189-79.798-79.796C295.736 9.801 259.058.0 219.273.0c-39.781.0-76.47 9.801-110.063 29.407-33.595 19.604-60.192 46.201-79.8 79.796C9.801 142.8.0 179.489.0 219.267c0 39.78 9.804 76.463 29.407 110.062 19.607 33.592 46.204 60.189 79.799 79.798 33.597 19.605 70.283 29.407 110.063 29.407s76.47-9.802 110.065-29.407c33.593-19.602 60.189-46.206 79.795-79.798 19.603-33.596 29.403-70.284 29.403-110.062C438.533 179.485 428.732 142.795 409.133 109.203zM361.449 231.831l-25.981 25.981c-3.613 3.613-7.901 5.42-12.847 5.42-4.948.0-9.229-1.807-12.847-5.42l-53.954-53.961v143.32c0 4.948-1.813 9.232-5.428 12.847-3.613 3.62-7.898 5.427-12.847 5.427h-36.547c-4.948.0-9.231-1.807-12.847-5.427-3.617-3.614-5.426-7.898-5.426-12.847v-143.32l-53.959 53.961c-3.431 3.425-7.708 5.133-12.85 5.133-5.14.0-9.423-1.708-12.85-5.133l-25.981-25.981c-3.422-3.429-5.137-7.714-5.137-12.852.0-5.137 1.709-9.419 5.137-12.847l103.356-103.353 25.981-25.981c3.427-3.425 7.71-5.14 12.847-5.14 5.142.0 9.423 1.715 12.849 5.14l25.98 25.981 103.35 103.353c3.432 3.427 5.14 7.71 5.14 12.847C366.589 224.117 364.881 228.402 361.449 231.831z"/></svg>
</a><script>$(document).ready(function(){$("#showTopBtn").removeClass("prag-sticky-bot"),$("#showTopBtn").addClass("prag-sticky-hide"),$(function(){$(window).scroll(function(){$(this).scrollTop()>900?($("#showTopBtn").addClass("prag-sticky-bot"),$("#showTopBtn").removeClass("prag-sticky-hide")):($("#showTopBtn").addClass("prag-sticky-hide"),$("#showTopBtn").removeClass("prag-sticky-bot"))})})})</script><div class=blog-post-main><p>We are going to discover the <a href=https://www.databricks.com/fr/product/delta-sharing>Delta Sharing</a> functionality offered by Databricks with the <a href=https://docs.databricks.com/data-governance/unity-catalog/index.html>Unity Catalog</a> solution.</p><p>We are going to use a Databricks Account on AWS as a provider and a Databricks Account on Azure as a recipient for the sharing of objects with the Delta Sharing functionality for this discovery.</p><p><em>Note: Work is based on the state of the Unity Catalog solution at the end of Q1 2023 on AWS and Azure.</em></p><h1 id=whats-data-sharing>What&rsquo;s Data Sharing</h1><p>Data Sharing is a practice that consists in sharing data between different partners.</p><p>This can be for regulatory or contractual needs, but also to enhance and monetize data and products.</p><p>There is a very strong security and data governance issue when sharing data with partners or competitors in order to avoid any risk of data leakage and to guarantee the traceability of actions regarding the data usage.</p><p>We can use the Data Sharing when setting up a Data Mesh to share data from different products between different teams.</p><p>It is also common to set up a REST API interface to allow external partners to retrieve data by managing access rights directly through it, but there are solutions that greatly facilitate and secure this data sharing.
The REST API interface is not necessarily the most efficient way to exchange large dataset between partners (for example in the context of a Data Lake or a Lakehouse).</p><p>Among the existing solutions, we are going to focus on the &ldquo;Delta Sharing&rdquo; functionality proposed by Databricks with the Unity Catalog solution in order to set up a data sharing with external partners.</p><h1 id=unity-catalog-and-the-object-hierarchy>Unity Catalog and the object hierarchy</h1><p>Unity Catalog is the Databricks solution that allows to have a unified and centralized governance for all the data managed by the Databricks resources as well as to secure and facilitate the management and the sharing of the data to all the internal and external actors of an organization.</p><p>You can get a more complete overview by reading the <a href=https://docs.databricks.com/data-governance/unity-catalog/index.html>official documentation</a></p><p>Reminder concerning the hierarchy of objects :
<a href=/blog/web/20230521_blog_article_unity_catalog_dela_sharing_00.png><img alt=schema_00 src=/blog/web/20230521_blog_article_unity_catalog_dela_sharing_00.png></a></p><p>The objects are :</p><ul><li>Storage Credential : This object is directly associated with the Metastore and is used to store access to a cloud provider (for example AWS S3) allowing the Unity Catalog solution to manage data rights</li><li>External Location : This object is associated with the Metastore and allows you to store the path to a cloud provider (for example an AWS S3 resource) in combination with a Storage Credential to manage data access</li><li>Metastore : Top-level object that can contain metadata</li><li>Catalog : 1st level object allowing to organize data by Schema (also called Database)</li><li>Schema : 2nd and last level object used to organize data (contains tables, views and functions)</li><li>Table : Object used to define the structure and storage of data.</li><li>Share : A logical grouping of the tables you want to share.</li><li>Recipient : An object that identifies a partner (or group of users) who will have access to the shared data.</li><li>Provider : An object that represents a partner who is sharing data.</li></ul><p>When you want to access an object (for example a table), it will be necessary to use the name of the Catalog and the name of the Schema where the object is defined.
Example : <code>select * from catalog.schema.table</code></p><p>Note: The concepts of Share, Recipient and Provider are specific to the Delta Sharing feature.</p><h1 id=whats-the-delta-sharing-feature>What&rsquo;s the Delta Sharing feature</h1><p>This functionality is based on an <a href=https://github.com/delta-io/delta-sharing/blob/main/PROTOCOL.md>open protocol</a> developed by Databricks to allow the sharing of data in a secure way between several platforms.</p><p>This functionality is based on the Unity Catalog solution in order to centralize data governance (catalog management and data rights).</p><p>The Delta Sharing Server is managed by the Unity Catalog solution and allows a recipient to have direct access to the data on the storage without going through a cluster or a SQL Warehouse</p><p>Diagram of how Delta Sharing works :
<a href=/blog/web/20230521_blog_article_unity_catalog_dela_sharing_20.png><img alt=schema_20 src=/blog/web/20230521_blog_article_unity_catalog_dela_sharing_20.png></a>
The operation is as follows:</p><ol><li>The recipient requests the reading of a shared table</li><li>The provider (with the Delta Sharing Server managed by Unity Catalog) will control access to the shared table</li><li>The provider will send the access links (valid for a very short period) to the storage where the data is actually located (without going through a cluster or SQL Warehouse)</li><li>The recipient will directly access the storage to retrieve the data from the shared table in read-only mode</li></ol><p>The three main use cases, according to Databricks, for the use of this functionality :</p><ul><li>Internal Data Sharing (subsidiaries, teams)<ul><li>Create a Data Mesh to exchange data from different products between different subsidiaries, teams, applications</li></ul></li><li>External Data Sharing (companies)<ul><li>Share data with partners and suppliers, whether or not they are on the Databricks platform</li></ul></li><li>Data monetization<ul><li>Distribute and monetize your products (data) with customers who are or are not on the Databricks platform</li></ul></li></ul><p>Some benefits of this feature:</p><ul><li>A provider can easily define shares on a specific version or partition of a delta table</li><li>Tables are shared live and can be updated by the provider only</li><li>All clients that can read parquet data can access the shared data</li><li>Data transfer relies on S3/ADLS/GCS resources only, therefore transfer is extremely efficient and inexpensive</li></ul><p>The &ldquo;Delta Sharing&rdquo; feature can be used in three different ways:</p><ol><li><a href=https://docs.databricks.com/data-sharing/share-data-open.html>Open Sharing</a><ol><li>This allows any client not using Databricks with the Unity Catalog solution to access the shared data</li><li>It is necessary to use a specific library to be able to read data through Delta Sharing</li><li>The recipients of this type of sharing are based on the lifetime of a Databricks token (defined in the Unity Catalog Metastore of the supplier)</li></ol></li><li><a href=https://docs.databricks.com/data-sharing/share-data-databricks.html>Databricks-to-Databricks Sharing</a><ol><li>This corresponds to the sharing of data between two Metastores of the Unity Catalog solution (in the same Databricks Account or in different Databricks Accounts (AWS, Azure or GCP))</li><li>One of the advantages of this type of sharing is that neither the Recipient nor the Provider needs to manage a Databricks token to access the shared data.</li><li>The security of this sharing (including access verification, authentication and audit) is managed entirely through the Delta Sharing functionality and the Databricks platform.</li><li>It is also possible to share read-only notebooks</li></ol></li><li>Marketplace:<ol><li>This corresponds to the fact of declaring oneself as a Databricks partner in order to be able to propose these shared data on the Databricks Marketplace. We are not going to develop this sharing method in the context of this discovery.</li></ol></li></ol><p>The objects specific to this functionality that have been implemented in the Unity Catalog solution are :</p><ul><li><code>Provider</code>: This defines the data provider for the recipient</li><li><code>Recipient</code> : This allows you to define the different recipients (users) to manage access rights on the shared data</li><li><code>Share</code>: This is a collection of read-only tables and notebooks that allow data from a Metastore to be shared with recipients<ul><li>The sharing of notebooks only concerns recipients who also use the Unity Catalog solution</li></ul></li></ul><p>Information about shares :</p><ul><li>This is a logical wrapper that allows you to group all the objects (delta tables and notebooks) that you want to share in read-only mode.</li><li>Unity Catalog writes the information about the shares in the following storage directory (AWS S3): <code>s3://s3-dbx-metastore-uc/metastore-sandbox/&lt;Metastore ID>/delta-sharing/shares/&lt;Share ID>/*</code></li><li>It is possible to add all the tables of the Metastore in a share<ul><li>You only need to have <code>SELECT</code> and <code>USE</code> rights on the objects you want to add in the share</li></ul></li><li>Access rights to the share can only be given to the defined recipients</li><li>The name of a share can be a name already used by a catalog or a schema (no restriction, but it is recommended to have a different name to facilitate the shares management)</li><li>It is possible to share only Delta tables whether they are managed or external<ul><li>It is possible to define a shared partition based on the existing partitions of the Delta table to automatically limit data access according to the properties of each recipient<ul><li>Managing partitions at the share level can be extremely useful if you have defined partitions on information such as country, period or recipient ID to automatically limit access to data.</li><li>This allows you to set constraints on partitions at the share level only once and to be able to set properties for each recipient (Recipient)</li></ul></li><li>It is possible to define whether the history of a Delta table is shared or not</li><li>It is possible to define whether the Change Data Feed of a Delta table is shared or not</li></ul></li><li>It is recommended to set up aliases for each object added to the share<ul><li>When no alias is defined for the schema name, the source schema name will be used</li><li>When no alias is defined for the name of the schema and the name of the table then the name of the source schema and the name of the source table will be used</li><li>It is not possible to update an alias after adding the object to the share. (It is necessary to remove and add the object again to modify the alias)</li></ul></li><li>Information specific to notebook sharing (in the case of Databricks-to-Databricks sharing only):<ul><li>When the notebook is shared, it is actually exported in HTML format to a directory in Unity Catalog&rsquo;s managed storage (AWS S3) (specifically the <code>s3://s3-dbx-metastore-uc/metastore-sandbox/&lt;Metastore ID>/delta-sharing/shares/&lt;Share ID>/notebooks_files/*</code> directory), which has the effect of keeping a specific version of the notebook that is to be shared.</li><li>When the notebook that has been shared is modified, this has no impact on the shared notebook. You have to remove it and add it again to the share to share the latest version of the notebook.</li></ul></li></ul><p>Information about recipients :</p><ul><li>This is an object at the Metastore level that allows you to define access for a partner/customer</li><li>Read access to the share is managed on the recipient object</li><li>A recipient can access all the shares in a Metastore according to the rights given by the share owners</li><li>A recipient cannot access Metatore Unity Catalogs, only authorized shares.</li><li>In order to create a recipient it is necessary to activate the Delta Sharing feature for the Metastore</li><li>There are two types of recipient :<ul><li>Open Sharing : the recipient uses a Databricks token whose validity period is defined at the Metastore level</li><li>Databricks-to-Databricks Sharing : the recipient uses a Metastore sharing ID (no validity period)</li></ul></li><li>Users of a Metastore cannot access shares of the same Metastore</li></ul><p>Resources about some connectors allowing to access shared data without using a Databricks resource:</p><ul><li><a href=https://github.com/delta-io/delta-sharing#python-connector>Python & Pandas</a></li><li><a href=https://github.com/delta-io/delta-sharing#apache-spark-connector>Apache spark</a></li><li><a href=https://learn.microsoft.com/en-us/power-query/connectors/delta-sharing>Power BI</a></li><li><a href=https://github.com/databrickslabs/delta-sharing-java-connector>Java</a></li></ul><h1 id=what-are-the-audit-logs>What are the Audit Logs</h1><p>When you are a provider, it is essential to be able to track the use of your data by the recipients defined.</p><p>This can allow you to define billing rules when you want to monetize access to data, but also to simply track the use of shared objects.</p><p>Some examples of captured events in the Metastore of the Unity Catalog solution (not exhaustive):</p><ul><li>Create and Delete a share</li><li>Create and Delete a recipient</li><li>Request access from a recipient</li><li>Execute a query on a shared object from a recipient</li><li>Result (metadata) of the query on a shared object from a recipient</li></ul><p>To do this, it is necessary to set up the storage of audit logs for events related to the Metastore of the Unity Catalog solution.</p><p>The storage of audit logs requires the implementation of a log configuration at the level of the Databricks account.</p><p>Some informations :</p><ul><li>Audit logs are not retrieved in real time, but every X minutes and stored in storage resource specified at the log configuration level in the Account Databricks.</li><li>The audit log files are in JSON format.</li><li>The audit log files for the Metastore Unity Catalog are stored in a subdirectory named <code>workspace=0</code>.<ul><li>When you will set up the log configuration, you must be careful not to filter the Databricks Workspace identifier or to take into account the Databricks Workspace identifier with the value <code>0</code> otherwise you will not get the logs concerning the events related to the Unity Catalog Metastore.</li></ul></li><li>You will not be able to update or delete a log configuration at the Databricks Account level, you can only deactivate it and create a new one (even if you use the same name, the configuration identifier will be different with a unique identifier)</li></ul><p>All the events captured at the account level and more specifically concerning Unity Catalog are traced in the audit log and can be analyzed. We have voluntarily limited our analysis to two types of actions for this demonstration.</p><p>You will find an exhaustive list of actions/events that you can analyze in the <a href=https://docs.databricks.com/administration-guide/account-settings/audit-logs.html#events>official documentation</a>.</p><h1 id=set-up-the-environment>Set-up the environment</h1><p>We are going to set up a set of elements allowing us to discover in more detail the Delta Sharing functionality of the Unity Catalog solution.</p><h2 id=context>Context</h2><p>Prerequisite:</p><ul><li>Existence of an AWS S3 resource named <code>s3-dbx-metastore-uc</code></li><li>Existence of an AWS S3 resource named <code>s3-demo-data-uc</code></li><li>Existence of a Metastore named <code>metastore-sandbox</code> with the Storage Credential named <code>sc-metastore-sandbox</code> allowing to store the default data in the AWS S3 resource named <code>s3-dbx-metastore-uc</code></li><li>Existence of an AWS IAM role named <code>role-databricks-demo-data-uc</code> and an AWS IAM policy named <code>policy-databricks-demo-data-uc</code> allowing the global Databricks role to manage access to the AWS S3 resource named <code>s3-demo-data-uc</code></li><li>Existence of a Storage Credential named <code>sc-demo-data-uc</code> and an External Location named <code>el_demo_data_uc</code> allowing the global Databricks role to manage the access to the AWS S3 resource named <code>s3-demo-data-uc</code></li><li>Existence of the <code>grp_demo</code> group</li><li>Existence of the user <code>john.do.dbx@gmail.com</code> in the group <code>grp_demo</code></li><li>Existence of a SQL Warehouse with the right of use for the group <code>grp_demo</code></li></ul><p>Setting up rights for the <code>grp_demo</code> group :</p><ol><li>Give the right to create catalogs at the Metastore level for the <code>grp_demo</code> group</li><li>Give the right to read external files from the External Location object named <code>el_demo_data_uc</code>.</li><li>Give the right to create a share space at the Metastore level for the group <code>grp_demo</code>.</li><li>Give the right to create a recipient at the Metastore level for the group <code>grp_demo</code>.</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>-- 1. Give Create Catalog right on Metastore to grp_demo
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>GRANT</span> <span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>CATALOG</span> <span style=color:#ff79c6>ON</span> METASTORE <span style=color:#ff79c6>TO</span> grp_demo;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#6272a4>-- 2. Give Read Files right on el_demo_data_uc location to grp_demo
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>GRANT</span> <span style=color:#ff79c6>READ</span> FILES <span style=color:#ff79c6>ON</span> <span style=color:#ff79c6>EXTERNAL</span> <span style=color:#ff79c6>LOCATION</span> <span style=color:#ff79c6>`</span>el_demo_data_uc<span style=color:#ff79c6>`</span> <span style=color:#ff79c6>TO</span> grp_demo;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#6272a4>-- 3. Give Create share right on Metastore to grp_demo
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>GRANT</span> CREATE_SHARE <span style=color:#ff79c6>ON</span> METASTORE <span style=color:#ff79c6>TO</span> grp_demo;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#6272a4>-- 4. Give Create recipient right on Metastore to grp_demo
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>GRANT</span> CREATE_RECIPIENT <span style=color:#ff79c6>ON</span> METASTORE <span style=color:#ff79c6>TO</span> grp_demo;
</span></span></code></pre></div><h2 id=diagram-of-the-environment>Diagram of the environment</h2><p>Concerning the elements on AWS
Diagram of the objects in the Metastore Unity Catalog on AWS:
<a href=/blog/web/20230521_blog_article_unity_catalog_dela_sharing_21.png><img alt=schema_21 src=/blog/web/20230521_blog_article_unity_catalog_dela_sharing_21.png></a>
List of items:</p><ul><li>Metastore <code>metastore-sandbox</code> : Main metastore at the AWS Databricks Account level</li><li>Storage Credential <code>sc-metastore-sandbox</code> : Login information to manage access rights to the AWS resource named <code>s3-dbx-metastore-uc</code>.</li><li>Storage Credential <code>sc-demo-data-uc</code> and External Location <code>el-demo-data-uc</code>: Login information to manage access rights to the AWS resource named <code>s3-demo-data-uc</code>.</li><li>Catalog <code>ctg_mng</code>: Logical object to organize and manage managed data</li><li>Catalog <code>ctg_ext</code>: Logical object to organize and manage external data</li></ul><p>Diagram of all the objects that we will set up and use on the Unity Catalog Metastore on AWS:
<a href=/blog/web/20230521_blog_article_unity_catalog_dela_sharing_22.png><img alt=schema_22 src=/blog/web/20230521_blog_article_unity_catalog_dela_sharing_22.png></a>
List of items:</p><ul><li>Catalog <code>ctg_mng</code> and Schema <code>sch_mng</code> : Logical object to organize and manage managed data</li><li>Catalog <code>ctg_ext</code> and Schema <code>sch_ext</code> : Logical object to organize and manage external data</li><li>Table <code>fct_transactions_mng</code>: Unity Catalog managed table containing transaction information and partitioned on the <code>id_client</code> column</li><li>Table <code>fct_transactions_ext</code>: External table containing transaction information not partitioned but with the Change Data Feed enabled in the AWS S3 resource named <code>s3-demo-data-uc/data/fct_transactions_ext</code></li><li>Table <code>fct_transactions_csv</code> : External table allowing direct access to the CSV source file of the transactions in the AWS S3 resource named <code>s3-demo-data-uc/demo/fct_transactions.csv</code>.</li><li>Table <code>audit_logs_json</code> : External table allowing direct access to all the audit log files based on the data of the AWS S3 resource named <code>s3_demo_data_uc/dbx_logs/account</code></li><li>Sharing <code>share_aws_dbx</code> : Logical object to organize and manage shared objects<ul><li>The <code>sch_share</code> schema Alias allows you to group objects from different catalogs and schemas into a single logical schema for data sharing</li><li>The <code>fct_trx_mng</code> table alias allows you to make data from the <code>fct_transactions_mng</code> table available without having to communicate the table name</li><li>The Alias of the <code>fct_trx_ext</code> table allows you to provide the data of the <code>fct_transactions_ext</code> table without having to communicate the table name</li></ul></li><li>Recipient <code>rcp_azure_dbx</code> : Object allowing users of the Metastore Unity Catalog Azure to access the data of the <code>share_aws_dbx</code>share.</li><li>Recipient <code>rcp_open_all</code> : Object allowing users not using Metastore Unity Catalog to access data from the <code>share_aws_dbx</code> share</li></ul><p>Concerning the elements on Azure:
Diagram of all the elements that we will implement and use on the Unity Catalog Metastore on Azure:
<a href=/blog/web/20230521_blog_article_unity_catalog_dela_sharing_23.png><img alt=schema_23 src=/blog/web/20230521_blog_article_unity_catalog_dela_sharing_23.png></a>
List of elements :</p><ul><li>Metastore <code>metastore-az</code>: Main metastore at the Azure Databricks Account level</li><li>Storage Credential <code>sc-metastore-az</code>: Login information to manage access rights to the Azure ADLS Gen2 resource named <code>adls-dbx-metastore-uc</code>.</li><li>Catalog <code>ctg_aws</code>: Logical object to synchronize with the <code>share_aws_dbx</code> share and access all elements of the <code>sch_share</code> shared schema</li></ul><h2 id=environment-variable>Environment variable</h2><p>In order to facilitate the implementation of the various elements throughout this discovery, we will set up some environment variables to use with the Databricks REST API tool.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4># Alias using the netrc file from databricks</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#8be9fd;font-style:italic>alias</span> dbx-api<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#39;curl --netrc-file ~/.databricks/.netrc&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#6272a4>########################################</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#6272a4>############# AWS ######################</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#6272a4>########################################</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#6272a4># Url for Account Access</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>DBX_API_ACCOUNT_URL</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;https://accounts.cloud.databricks.com&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#6272a4># Url for Workspace Access</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;&lt;Workspace Databricks AWS URL&gt;&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#6272a4># Account ID</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>DBX_ACCOUNT_ID</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;&lt;Account Databricks ID&gt;&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#6272a4># AWS Metastore Name</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>DBX_METASTORE_NAME</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;metastore-sandbox&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#6272a4># AWS Share Name</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>DBX_SHARE_NAME</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;share_aws_dbx&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#6272a4># AWS Provider Name</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>DBX_PROVIDER_NAME</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;dbx_aws_sharing&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#6272a4># AWS Recipient for Databricks to Databricks Sharing</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>DBX_RECIPIENT_DBX</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;rcp_azure_dbx&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#6272a4># AWS Recipient for Open Sharing</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>DBX_RECIPIENT_OPEN</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;rcp_open_all&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span><span style=color:#6272a4>########################################</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span><span style=color:#6272a4>############# Azure ####################</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span><span style=color:#6272a4>########################################</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span><span style=color:#6272a4># Name of the ADLS Gen2 Storage</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>AZ_ADLS2_NAME</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;adls-dbx-metastore-uc&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span><span style=color:#6272a4># Name of the Container in the ADLS Gen2 Storage</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>AZ_ADLS2_CONTAINER_NAME</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;metastoredbx&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span><span style=color:#6272a4># Name of the Resource Group</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>AZ_RG_NAME</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;&lt;Azure Resource Group Name&gt;&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span><span style=color:#6272a4># Region</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>AZ_REGION</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;francecentral&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span><span style=color:#6272a4># Tags</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>AZ_TAGS</span><span style=color:#ff79c6>=(</span><span style=color:#f1fa8c>&#34;owner=john&#34;</span> <span style=color:#f1fa8c>&#34;project=databricks&#34;</span> <span style=color:#f1fa8c>&#34;TTL=7&#34;</span> <span style=color:#f1fa8c>&#34;environment=demo&#34;</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span><span style=color:#6272a4># Azure Databricks Access Connector Name</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>AZ_DBX_CONNECTOR_NAME</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;DBXAccessConnectorUC&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span><span style=color:#6272a4># Azure Workspace Databricks URL</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>DBX_AZ_API_URL</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;&lt;Azure Workspace Databricks URL&gt;&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span><span style=color:#6272a4># Azure Workspace Databricks ID</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>DBX_AZ_WORKSPACE_ID</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;&lt;Azure Workspace Databricks ID&gt;&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span><span style=color:#6272a4># Azure Metastore Name</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>DBX_AZ_METASTORE_NAME</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;metastore-az&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span><span style=color:#6272a4># Azure Storage Credential Name</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>DBX_AZ_METASTORE_SC_NAME</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;sc-metastore-az&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span><span style=color:#6272a4># Azure Metastore ADLS Gen2 Path</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>DBX_AZ_ADLS2_METASTORE_PATH</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_ADLS2_CONTAINER_NAME</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>@</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_ADLS2_NAME</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>.dfs.core.windows.net/</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_ADLS2_CONTAINER_NAME</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span>
</span></span></code></pre></div><h2 id=setting-up-a-dataset-on-the-aws-s3-resource>Setting up a dataset on the AWS S3 resource</h2><p>Content of the file <code>fct_transactions.csv</code> :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>id_trx,ts_trx,id_product,id_shop,id_client,quantity
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>1,2023-04-01 09:00:00,1,2,1,1
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>2,2023-04-01 11:00:00,1,1,1,3
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>3,2023-04-03 14:00:00,1,2,1,1
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>4,2023-04-05 08:00:00,3,1,2,9
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>5,2023-04-06 10:00:00,1,2,1,3
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>6,2023-04-06 12:00:00,2,2,1,1
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>7,2023-04-10 18:30:00,2,1,2,11
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9</span><span>8,2023-04-10 18:30:00,3,1,2,2
</span></span></code></pre></div><p>Copying data to the <code>demo</code> directory of the AWS S3 resource named <code>s3-demo-data-uc</code> with the AWS CLI tool :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>aws s3 cp fct_transactions.csv s3://s3-demo-data-uc/demo/fct_transactions.csv 
</span></span></code></pre></div><h2 id=setting-up-the-objects-on-the-unity-catalog-metastore>Setting up the objects on the Unity Catalog Metastore</h2><p>Note : Using a user from <code>grp_demo</code> group</p><ol><li>Creation of catalogs</li></ol><ul><li><code>ctg_mng</code> : Catalog to manage the elements managed by Unity Catalog</li><li><code>ctg_ext</code> : Catalog to manage external elements</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>-- Create Catalog (for managed data)
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>CATALOG</span> <span style=color:#ff79c6>IF</span> <span style=color:#ff79c6>NOT</span> <span style=color:#ff79c6>EXISTS</span> ctg_mn
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>    <span style=color:#ff79c6>COMMENT</span> <span style=color:#f1fa8c>&#39;Catalog for managed data&#39;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#6272a4>-- Create Catalog (for external data)
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>CATALOG</span> <span style=color:#ff79c6>IF</span> <span style=color:#ff79c6>NOT</span> <span style=color:#ff79c6>EXISTS</span> ctg_ext
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>    <span style=color:#ff79c6>COMMENT</span> <span style=color:#f1fa8c>&#39;Catalog for external data&#39;</span>;
</span></span></code></pre></div><ol start=2><li>Creation of schemas
The list of schemas :</li></ol><ul><li><code>ctg_ext.sch_ext</code> : Schema to manage the external elements</li><li><code>ctg_mng.sch_mng</code> : Schema to manage the elements managed by Unity Catalog</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>-- Create Schema for external data
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>SCHEMA</span> <span style=color:#ff79c6>IF</span> <span style=color:#ff79c6>NOT</span> <span style=color:#ff79c6>EXISTS</span> ctg_ext.sch_ext
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>    <span style=color:#ff79c6>COMMENT</span> <span style=color:#f1fa8c>&#39;Schema for external data&#39;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#6272a4>-- Create Schema for managed data
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>SCHEMA</span> <span style=color:#ff79c6>IF</span> <span style=color:#ff79c6>NOT</span> <span style=color:#ff79c6>EXISTS</span> ctg_mng.sch_mng
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>    <span style=color:#ff79c6>COMMENT</span> <span style=color:#f1fa8c>&#39;Schema for managed Data&#39;</span>;
</span></span></code></pre></div><ol start=3><li>Creation of tables</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>-- External table
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>TABLE</span> ctg_ext.sch_ext.fct_transactions_csv (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    id_trx <span style=color:#8be9fd;font-style:italic>integer</span> <span style=color:#ff79c6>not</span> <span style=color:#ff79c6>null</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    ,ts_trx <span style=color:#ff79c6>timestamp</span> <span style=color:#ff79c6>not</span> <span style=color:#ff79c6>null</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    ,id_product <span style=color:#8be9fd;font-style:italic>integer</span> <span style=color:#ff79c6>not</span> <span style=color:#ff79c6>null</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    ,id_shop <span style=color:#8be9fd;font-style:italic>integer</span> <span style=color:#ff79c6>not</span> <span style=color:#ff79c6>null</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    ,id_client <span style=color:#8be9fd;font-style:italic>integer</span> <span style=color:#ff79c6>not</span> <span style=color:#ff79c6>null</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    ,quantity <span style=color:#8be9fd;font-style:italic>integer</span> <span style=color:#ff79c6>not</span> <span style=color:#ff79c6>null</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#ff79c6>USING</span> CSV
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#ff79c6>OPTIONS</span> (path <span style=color:#f1fa8c>&#34;s3://s3-demo-data-uc/demo/fct_transactions.csv&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        <span style=color:#ff79c6>delimiter</span> <span style=color:#f1fa8c>&#34;,&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>        header <span style=color:#f1fa8c>&#34;true&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>        ;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#6272a4>-- External table with Change data feed activated
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>TABLE</span> ctg_ext.sch_ext.fct_transactions_ext (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    id_trx <span style=color:#8be9fd;font-style:italic>integer</span> <span style=color:#ff79c6>not</span> <span style=color:#ff79c6>null</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    ,ts_trx <span style=color:#ff79c6>timestamp</span> <span style=color:#ff79c6>not</span> <span style=color:#ff79c6>null</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>    ,id_product <span style=color:#8be9fd;font-style:italic>integer</span> <span style=color:#ff79c6>not</span> <span style=color:#ff79c6>null</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>    ,id_shop <span style=color:#8be9fd;font-style:italic>integer</span> <span style=color:#ff79c6>not</span> <span style=color:#ff79c6>null</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>    ,id_client <span style=color:#8be9fd;font-style:italic>integer</span> <span style=color:#ff79c6>not</span> <span style=color:#ff79c6>null</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>    ,quantity <span style=color:#8be9fd;font-style:italic>integer</span> <span style=color:#ff79c6>not</span> <span style=color:#ff79c6>null</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>    ,ts_tech <span style=color:#ff79c6>timestamp</span> <span style=color:#ff79c6>not</span> <span style=color:#ff79c6>null</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span><span style=color:#ff79c6>LOCATION</span> <span style=color:#f1fa8c>&#39;s3://s3-demo-data-uc/data/fct_transactions_delta&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span><span style=color:#ff79c6>COMMENT</span> <span style=color:#f1fa8c>&#39;External Delta Table for Transaction Data&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>TBLPROPERTIES (delta.enableChangeDataFeed <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>true</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span><span style=color:#6272a4>-- Managed table with column partition (id_client)
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>TABLE</span> ctg_mng.sch_mng.fct_transactions_mng (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>    id_trx <span style=color:#8be9fd;font-style:italic>integer</span> <span style=color:#ff79c6>not</span> <span style=color:#ff79c6>null</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>    ,ts_trx <span style=color:#ff79c6>timestamp</span> <span style=color:#ff79c6>not</span> <span style=color:#ff79c6>null</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>    ,id_product <span style=color:#8be9fd;font-style:italic>integer</span> <span style=color:#ff79c6>not</span> <span style=color:#ff79c6>null</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>    ,id_shop <span style=color:#8be9fd;font-style:italic>integer</span> <span style=color:#ff79c6>not</span> <span style=color:#ff79c6>null</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>    ,id_client <span style=color:#8be9fd;font-style:italic>integer</span> <span style=color:#ff79c6>not</span> <span style=color:#ff79c6>null</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>    ,quantity <span style=color:#8be9fd;font-style:italic>integer</span> <span style=color:#ff79c6>not</span> <span style=color:#ff79c6>null</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>    ,ts_tech <span style=color:#ff79c6>timestamp</span> <span style=color:#ff79c6>not</span> <span style=color:#ff79c6>null</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>PARTITIONED <span style=color:#ff79c6>BY</span> (id_client)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span><span style=color:#ff79c6>COMMENT</span> <span style=color:#f1fa8c>&#39;Managed Data Table for Transaction Data&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>;
</span></span></code></pre></div><ol start=4><li>Populate tables</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>-- Truncate table
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>DELETE</span> <span style=color:#ff79c6>FROM</span> ctg_ext.sch_ext.fct_transactions_ext;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#ff79c6>DELETE</span> <span style=color:#ff79c6>FROM</span> ctg_mng.sch_mng.fct_transactions_mng;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#6272a4>-- Add data in the external table
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>INSERT</span> <span style=color:#ff79c6>INTO</span> ctg_ext.sch_ext.fct_transactions_ext (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    id_trx
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    ,ts_trx
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    ,id_product
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    ,id_shop
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    ,id_client
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    ,quantity
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    ,ts_tech
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#ff79c6>SELECT</span> id_trx
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    ,ts_trx
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    ,id_product
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    ,id_shop
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    ,id_client
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    ,quantity
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>    ,<span style=color:#ff79c6>current_timestamp</span>() <span style=color:#ff79c6>as</span> ts_tech
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#ff79c6>FROM</span> ctg_ext.sch_ext.fct_transactions_csv;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span><span style=color:#6272a4>-- Add data in the managed table 
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>INSERT</span> <span style=color:#ff79c6>INTO</span> ctg_mng.sch_mng.fct_transactions_mng (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>    id_trx
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>    ,ts_trx
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>    ,id_product
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>    ,id_shop
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>    ,id_client
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>    ,quantity
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>    ,ts_tech
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span><span style=color:#ff79c6>SELECT</span> id_trx
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>    ,ts_trx
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>    ,id_product
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>    ,id_shop
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>    ,id_client
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>    ,quantity
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>    ,<span style=color:#ff79c6>current_timestamp</span>() <span style=color:#ff79c6>as</span> ts_tech
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span><span style=color:#ff79c6>FROM</span> ctg_ext.sch_ext.fct_transactions_csv;
</span></span></code></pre></div><h2 id=creating-a-notebook-to-be-able-to-share-it>Creating a notebook to be able to share it</h2><p>We will import a scala notebook named <code>read_demo_data_nbk_scala</code> into the <code>Shared</code> directory of the Databricks AWS Workspace with Databricks REST API :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>dbx-api -X POST <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.0/workspace/import -H <span style=color:#f1fa8c>&#39;Content-Type: application/json&#39;</span> -d <span style=color:#f1fa8c>&#34;{ 
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#f1fa8c>    \&#34;path\&#34;: \&#34;/Shared/read_demo_data_nbk_scala\&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#f1fa8c>    \&#34;content\&#34;: \&#34;Ly8gRGF0YWJyaWNrcyBub3RlYm9vayBzb3VyY2UKdmFsIGRmID0gc3BhcmsudGFibGUoImN0Z19tbnQuc2NoX21uZy5mY3RfdHJhbnNhY3Rpb25zX21uZyIpCgovLyBDT01NQU5EIC0tLS0tLS0tLS0KCmRpc3BsYXkoZGYp\&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#f1fa8c>    \&#34;language\&#34;: \&#34;SCALA\&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#f1fa8c>    \&#34;overwrite\&#34;: \&#34;true\&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#f1fa8c>    \&#34;format\&#34;:\&#34;SOURCE\&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span><span style=color:#f1fa8c>}&#34;</span>
</span></span></code></pre></div><p>Imported Notebook Content :
<a href=/blog/web/20230521_blog_article_unity_catalog_dela_sharing_01.png><img alt=schema_01 src=/blog/web/20230521_blog_article_unity_catalog_dela_sharing_01.png></a></p><h1 id=configuring-the-audit-logs-on-the-metastore>Configuring the audit logs on the Metastore</h1><p>We will start with the configuration of audit logs in order to be able to keep track of all events related to the Unity Catalog Metastore (for the Delta Sharing feature).</p><p>It is possible to capture all the events at the Databricks Account level or at the level of each Databricks Workspace.
In our case, we are going to focus on the Databricks Account level because it is at this level that the events related to the Metastore Unity Catalog are captured.</p><p>For this demonstration, we will focus only on events concerning requests from recipients on shared objects, but the audit logs contain much more information.</p><p>Goals :</p><ul><li>We want to capture audit logs in AWS S3 resource named <code>s3-demo-data-uc/dbx_logs</code></li><li>We do not want to filter Workspace Databricks identifiers in order to capture all the audit logs offered by Databricks</li></ul><p>You need to follow these steps: (based on the <a href=https://docs.databricks.com/administration-guide/account-settings/audit-logs.html#configure-audit-log-delivery>official documentation</a>)</p><ol><li>Create an AWS IAM role and AWS IAM policy for Databricks to access (and write to) the AWS S3 resource named <code>s3-demo-data-uc/dbx_logs</code></li><li>Creation of a Databricks Credential at the Databricks Account level to store connection information (AWS IAM role created)</li><li>Create a Storage Databricks at the Account Databricks level to store the path to the AWS S3 resource named <code>s3-demo-data-uc/dbx_logs</code></li><li>Creation of the log configuration at the Account Databricks level based on the Credential Databricks and the Storage Databricks</li></ol><h1 id=activate-the-delta-sharing-feature-on-the-metastore>Activate the Delta Sharing feature on the Metastore</h1><p>The management (creation and deletion) of shares does not require the activation of the Delta Sharing feature on the Metastore.
Enabling the Delta Sharing feature is mandatory only when you want to manage recipients and configure access to shared objects.</p><p>To enable this feature, perform the following action:</p><ol><li>Update the Metastore configuration with the following information:<ul><li>The <code>delta_sharing_scope</code> information must be set to <code>INTERNAL_AND_EXTERNAL</code><ul><li><code>INTERNAL</code> value means the feature is disabled</li></ul></li><li>The <code>delta_sharing_recipient_token_lifetime_in_seconds</code> information must be filled with the number of seconds of validity of the Databricks Token (for example with the value <code>86400</code> for one day)<ul><li>The recipient using a Databricks Token will be able to access shared objects only during the validity period of the Databricks Token</li></ul></li><li>The <code>delta_sharing_organization_name</code> information must be filled with the name representing your organization as a provider (for example: <code>dbx_aws_sharing</code>)<ul><li>This is the name that recipients, using Databricks, will see as the share provider</li></ul></li></ul></li></ol><p>Performing the action with Databricks REST API :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4># Get the Metastore ID (databricks)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>TMP_DBX_METASTORE_ID</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>`</span>dbx-api -X GET <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.1/unity-catalog/metastores | jq -r <span style=color:#f1fa8c>&#39;.metastores[]|select(.name==$ENV.DBX_METASTORE_NAME)|.metastore_id&#39;</span><span style=color:#f1fa8c>`</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#6272a4># Update the Metastore configuration to activate Delta Sharing (external)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>dbx-api -X PATCH <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.1/unity-catalog/metastores/<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>TMP_DBX_METASTORE_ID</span><span style=color:#f1fa8c>}</span> -H <span style=color:#f1fa8c>&#39;Content-Type: application/json&#39;</span> -d <span style=color:#f1fa8c>&#34;{
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#f1fa8c>    \&#34;delta_sharing_scope\&#34;: \&#34;INTERNAL_AND_EXTERNAL\&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span><span style=color:#f1fa8c>    \&#34;delta_sharing_recipient_token_lifetime_in_seconds\&#34;: \&#34;86400\&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span><span style=color:#f1fa8c>    \&#34;delta_sharing_organization_name\&#34;: \&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_PROVIDER_NAME</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>\&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9</span><span><span style=color:#f1fa8c>}&#34;</span>
</span></span></code></pre></div><h1 id=create-a-share-in-the-metastore>Create a share in the Metastore</h1><p>Creating a share can be done with Databricks REST API or directly with SQL commands.</p><p>The creation of a share requires the following rights on the Metastore:</p><ul><li>Right to create share objects on the Metastore</li><li>Right to use catalogs and schemas containing the data to be shared</li><li>Right to read the delta tables containing the data to be shared</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>GRANT</span> CREATE_SHARE <span style=color:#ff79c6>ON</span> METASTORE <span style=color:#ff79c6>TO</span> grp_demo;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#ff79c6>GRANT</span> USE, USE <span style=color:#ff79c6>SCHEMA</span>, <span style=color:#ff79c6>SELECT</span> <span style=color:#ff79c6>ON</span> <span style=color:#ff79c6>CATALOG</span> ctg_mng <span style=color:#ff79c6>TO</span> grp_demo;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#ff79c6>GRANT</span> USE, USE <span style=color:#ff79c6>SCHEMA</span>, <span style=color:#ff79c6>SELECT</span> <span style=color:#ff79c6>ON</span> <span style=color:#ff79c6>CATALOG</span> ctg_ext <span style=color:#ff79c6>TO</span> grp_demo;
</span></span></code></pre></div><p>The creation of the share allows you to define all the data to be shared :</p><ol><li>Create the <code>share_aws_dbx</code> share at the Metastore Unity Catalog level</li><li>Add the table <code>ctg_ext.sch_ext.fct_transactions_ext</code> using the alias <code>sch_share.fct_trx_ext</code><ol><li>Enable the Change Data Feed in the data sharing (option <code>cdf_enable: true</code>)</li><li>Allow access from version nÂ°0 of the data history (option <code>start_version: 0</code>)</li></ol></li><li>Add the table <code>ctg_mng.sch_mng.fct_transactions_mng</code> using the alias <code>sch_share.fct_trx_mng</code><ol><li>Allow access to only the latest version of data (no access to history) (option <code>history_data_sharing_status: false</code>)</li><li>Add partition management to allow access to data only for the partition (id_client) which is equal to the value of the property named <code>Ã¬d_client</code> associated with the recipient when it was created. (Each recipient will have a different value for the <code>id_client</code> property to highlight this access policy which cannot be bypassed by the recipient)</li></ol></li><li>Add the <code>/Shared/read_demo_data_nbk_scala</code> notebook in share manually (API didn&rsquo;t work during our tests)</li></ol><p>Using Databricks REST APIs :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4># 1. Create share</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>dbx-api -X POST -H <span style=color:#f1fa8c>&#39;Content-Type: application/json&#39;</span> <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.1/unity-catalog/shares -d <span style=color:#f1fa8c>&#34;{\&#34;name\&#34;: \&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_SHARE_NAME</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>\&#34;, \&#34;comment\&#34;: \&#34;Share DBX AWS Data\&#34;}&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#6272a4># 2. Add table ctg_ext.sch_ext.fct_transactions_ext</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>dbx-api -X PATCH <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.1/unity-catalog/shares/share_aws_dbx -H <span style=color:#f1fa8c>&#39;Content-Type: application/json&#39;</span> -d <span style=color:#f1fa8c>&#39;{&#34;updates&#34;: [
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#f1fa8c>    {&#34;action&#34;: &#34;ADD&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#f1fa8c>    ,&#34;data_object&#34;: {
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#f1fa8c>        &#34;name&#34;: &#34;ctg_ext.sch_ext.fct_transactions_ext&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#f1fa8c>        &#34;data_object_type&#34;: &#34;TABLE&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#f1fa8c>        &#34;shared_as&#34;: &#34;sch_share.fct_trx_ext&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#f1fa8c>        &#34;cdf_enabled&#34;: true,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#f1fa8c>        &#34;start_version&#34;: 0,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#f1fa8c>        &#34;status&#34;: &#34;ACTIVE&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#f1fa8c>        }
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#f1fa8c>    }
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#f1fa8c>    ]
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#f1fa8c>}&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#6272a4># 3. Add table ctg_mng.sch_mng.fct_transactions_mng</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>dbx-api -X PATCH <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.1/unity-catalog/shares/share_aws_dbx -H <span style=color:#f1fa8c>&#39;Content-Type: application/json&#39;</span> -d <span style=color:#f1fa8c>&#39;{&#34;updates&#34;: [
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#f1fa8c>    {&#34;action&#34;: &#34;ADD&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span><span style=color:#f1fa8c>    ,&#34;data_object&#34;: {
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span><span style=color:#f1fa8c>        &#34;name&#34;: &#34;ctg_mng.sch_mng.fct_transactions_mng&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span><span style=color:#f1fa8c>        &#34;data_object_type&#34;: &#34;TABLE&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span><span style=color:#f1fa8c>        &#34;shared_as&#34;: &#34;sch_share.fct_trx_mng&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span><span style=color:#f1fa8c>        &#34;history_data_sharing_status&#34;: &#34;DISABLED&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span><span style=color:#f1fa8c>        &#34;status&#34;: &#34;ACTIVE&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span><span style=color:#f1fa8c>        &#34;partitions&#34;: [
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span><span style=color:#f1fa8c>        {
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span><span style=color:#f1fa8c>          &#34;values&#34;: [
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span><span style=color:#f1fa8c>            {
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span><span style=color:#f1fa8c>              &#34;name&#34;: &#34;id_client&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span><span style=color:#f1fa8c>              &#34;recipient_property_key&#34;: &#34;id_client&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span><span style=color:#f1fa8c>              &#34;op&#34;: &#34;EQUAL&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span><span style=color:#f1fa8c>            }
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span><span style=color:#f1fa8c>          ]
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span><span style=color:#f1fa8c>        }
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span><span style=color:#f1fa8c>        ]
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span><span style=color:#f1fa8c>        }
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span><span style=color:#f1fa8c>    }
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span><span style=color:#f1fa8c>    ]
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span><span style=color:#f1fa8c>}&#39;</span>
</span></span></code></pre></div><p>Using SQL commands :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>-- 1. Create share
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>SHARE</span> <span style=color:#ff79c6>IF</span> <span style=color:#ff79c6>NOT</span> <span style=color:#ff79c6>EXISTS</span> share_aws_dbx <span style=color:#ff79c6>COMMENT</span> <span style=color:#f1fa8c>&#39;Share DBX AWS Data&#39;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#6272a4>-- 2. Add table ctg_ext.sch_ext.fct_transactions_ext
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#6272a4>-- With alias sch_share.fct_trx_ext
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#6272a4>-- With Change Data Feed and Historical Data
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>ALTER</span> <span style=color:#ff79c6>SHARE</span> share_aws_dbx
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#ff79c6>ADD</span> <span style=color:#ff79c6>TABLE</span> ctg_ext.sch_ext.fct_transactions_ext
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#ff79c6>COMMENT</span> <span style=color:#f1fa8c>&#39;Shared External Transactions data&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#ff79c6>AS</span> <span style=color:#f1fa8c>&#39;sch_share.fct_trx_ext&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#ff79c6>WITH</span> HISTORY;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#ff79c6>#</span> <span style=color:#bd93f9>3</span>. <span style=color:#ff79c6>Add</span> <span style=color:#ff79c6>table</span> ctg_mng.sch_mng.fct_transactions_mng
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#6272a4>-- With a specific rule on partition
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#6272a4>-- With alias sch_share.fct_trx_mng
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#6272a4>-- Without historical data (delta)
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>ALTER</span> <span style=color:#ff79c6>SHARE</span> share_aws_dbx
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#ff79c6>ADD</span> <span style=color:#ff79c6>TABLE</span> ctg_mng.sch_mng.fct_transactions_mng 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    <span style=color:#ff79c6>COMMENT</span> <span style=color:#f1fa8c>&#39;Shared Managed Transactions data&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    <span style=color:#ff79c6>AS</span> <span style=color:#f1fa8c>&#39;sch_share.fct_trx_mng&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>    PARTITION (id_client <span style=color:#ff79c6>=</span> CURRENT_RECIPIENT().id_client)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>    <span style=color:#ff79c6>WITHOUT</span> HISTORY;
</span></span></code></pre></div><p>For step nÂ°4 (adding the notebook in the Share), it is not possible to do it directly with SQL commands and we have not managed to do it using Databricks REST API, therefore we will do it manually by using Data Explorer:</p><ol><li>Go to <code>Workspace Databricks page > Data > Delta Sharing > Shared by me</code></li><li>Click on the desired share (Share) <code>share_aws_dbx</code></li><li>Click on <code>Manage assets</code> and select the option <code>Add notebook file</code></li><li>Fill in the information <code>Notebook file</code> with the path and name of the file to share <code>/Shared/read_demo_data_nbk_scala</code></li><li>Fill in the <code>Share as</code> information with the name you want to display in the share for the notebook <code>shared_nbk</code></li></ol><p>Result of creating and adding elements in the Share:
<a href=/blog/web/20230521_blog_article_unity_catalog_dela_sharing_02.png><img alt=schema_02 src=/blog/web/20230521_blog_article_unity_catalog_dela_sharing_02.png></a></p><h1 id=sharing-data-with-a-unity-catalog-metastore-on-azure>Sharing data with a Unity Catalog Metastore on Azure</h1><p>Sharing data between two Unity Catalog Metastores is called &ldquo;Databricks-to-Databricks Sharing&rdquo;.</p><p>To achieve this Databricks-to-Databricks sharing, we will use a Unity Catalog Metastore on a Databricks Azure Account in the France Central location.
As a reminder, the main Unity Catalog Metastore (provider) is on a Databricks AWS Account and in the eu-west-1 (Ireland) location</p><h2 id=unity-catalog-setup-on-azure>Unity Catalog setup on Azure</h2><p>To do this, we will start by setting up a Metastore on a Databricks Workspace on Azure.</p><p>Prerequisites:</p><ul><li>You must have installed the Azure CLI tool and configure the connection to Azure</li><li>You must have created a Databricks Workspace in a Resource Group and your account must have Databricks Workspace administration rights.</li><li>You must have the Databricks Azure Account administration rights<ul><li>This right can be given by an account with the &ldquo;Azure AD Global Administrator&rdquo; role by connecting to the Databricks Azure Account</li></ul></li><li>You must have the rights to create the various resources necessary in an Azure Group Resource</li></ul><p>The steps required to set up a Unity Catalog Metastore on Azure are :</p><ol><li>Creation of a storage (ADLS Gen2 obligatorily) in the same region as the Metastore</li><li>Creating a Databricks Access Connector</li><li>Assign the Databricks Access Connector with the created storage (ALDLS Gen2)</li><li>Creation of a Metastore</li><li>Association of the Metastore with the Workspace Databricks</li><li>Creation of a Credential Storage (for managing access rights)</li><li>Association of Credential Storage with the Metastore</li></ol><p>To speed up the process but keep an educational approach, we will use Azure CLI and Databricks REST API to perform the steps:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4># 1. Create the ADLS GEN 2 storage for the Metastore</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4># BlobStorage Creation</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>az storage account create --name <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_ADLS2_NAME</span><span style=color:#f1fa8c>}</span> --resource-group <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_RG_NAME</span><span style=color:#f1fa8c>}</span> --access-tier Hot --kind StorageV2 --location <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_REGION</span><span style=color:#f1fa8c>}</span> --allow-blob-public-access <span style=color:#8be9fd;font-style:italic>false</span> --sku Standard_LRS --tags <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_TAGS</span><span style=color:#f1fa8c>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#6272a4># Remove useless features (blobstorage)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>az storage account blob-service-properties show --account-name <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_ADLS2_NAME</span><span style=color:#f1fa8c>}</span> --resource-group <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_RG_NAME</span><span style=color:#f1fa8c>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>az storage account blob-service-properties update --account-name <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_ADLS2_NAME</span><span style=color:#f1fa8c>}</span> --resource-group <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_RG_NAME</span><span style=color:#f1fa8c>}</span> --enable-change-feed <span style=color:#8be9fd;font-style:italic>false</span> --enable-delete-retention <span style=color:#8be9fd;font-style:italic>false</span> --enable-last-access-tracking <span style=color:#8be9fd;font-style:italic>false</span> --enable-restore-policy <span style=color:#8be9fd;font-style:italic>false</span> --enable-versioning <span style=color:#8be9fd;font-style:italic>false</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#6272a4># Remove useless features (filestorage)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>az storage account file-service-properties show --account-name <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_ADLS2_NAME</span><span style=color:#f1fa8c>}</span> --resource-group <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_RG_NAME</span><span style=color:#f1fa8c>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>az storage account file-service-properties update --account-name <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_ADLS2_NAME</span><span style=color:#f1fa8c>}</span> --resource-group <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_RG_NAME</span><span style=color:#f1fa8c>}</span> --enable-delete-retention <span style=color:#8be9fd;font-style:italic>false</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#6272a4># Activate ADLS Gen2</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>az storage account hns-migration start --type validation --name <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_ADLS2_NAME</span><span style=color:#f1fa8c>}</span> --resource-group <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_RG_NAME</span><span style=color:#f1fa8c>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>az storage account hns-migration start --type upgrade --name <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_ADLS2_NAME</span><span style=color:#f1fa8c>}</span> --resource-group <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_RG_NAME</span><span style=color:#f1fa8c>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#6272a4># Create a container in the ADLS Gen2 Storage</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>TMP_AZ_ADLS_KEY</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>`</span>az storage account keys list --account-name <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_ADLS2_NAME</span><span style=color:#f1fa8c>}</span> --resource-group <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_RG_NAME</span><span style=color:#f1fa8c>}</span> -o json | jq <span style=color:#f1fa8c>&#39;.[0]|.value&#39;</span><span style=color:#f1fa8c>`</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>az storage container create --name <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_ADLS2_CONTAINER_NAME</span><span style=color:#f1fa8c>}</span> --account-name <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_ADLS2_NAME</span><span style=color:#f1fa8c>}</span> --account-key <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>TMP_AZ_ADLS_KEY</span><span style=color:#f1fa8c>}</span> --public-access off --fail-on-exist
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#6272a4># 2. Create the databricks access-connector to manage access between Databricks and the ADLS2 Gen storage</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>az databricks access-connector create --name <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_DBX_CONNECTOR_NAME</span><span style=color:#f1fa8c>}</span> --resource-group <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_RG_NAME</span><span style=color:#f1fa8c>}</span> --location <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_REGION</span><span style=color:#f1fa8c>}</span> --identity-type SystemAssigned --tags <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_TAGS</span><span style=color:#f1fa8c>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span><span style=color:#6272a4># 3. Assign Storage Blob Data Contributor role to Databricks Access Connecter</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>TMP_AZ_ADLS_ID</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>`</span>az storage account show --name <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_ADLS2_NAME</span><span style=color:#f1fa8c>}</span> --resource-group <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_RG_NAME</span><span style=color:#f1fa8c>}</span> | jq -r <span style=color:#f1fa8c>&#39;.id&#39;</span><span style=color:#f1fa8c>`</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>TMP_AZ_DBX_CONNECTOR_PRINCIPAL_ID</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>`</span>az databricks access-connector show --resource-group <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_RG_NAME</span><span style=color:#f1fa8c>}</span> --name <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_DBX_CONNECTOR_NAME</span><span style=color:#f1fa8c>}</span> -o json | jq -r <span style=color:#f1fa8c>&#39;.identity.principalId&#39;</span><span style=color:#f1fa8c>`</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>az role assignment create --assignee-object-id <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>TMP_AZ_DBX_CONNECTOR_PRINCIPAL_ID</span><span style=color:#f1fa8c>}</span> --assignee-principal-type ServicePrincipal --role <span style=color:#f1fa8c>&#34;Storage Blob Data Contributor&#34;</span> --scope <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>TMP_AZ_ADLS_ID</span><span style=color:#f1fa8c>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span><span style=color:#6272a4># 4. Create the Metastore in Unity Catalog</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>dbx-api -X POST <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_AZ_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.1/unity-catalog/metastores -H <span style=color:#f1fa8c>&#39;Content-Type: application/json&#39;</span> -d <span style=color:#f1fa8c>&#34;{\&#34;name\&#34;:\&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_AZ_METASTORE_NAME</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>\&#34;, \&#34;region\&#34;: \&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_REGION</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>\&#34;, \&#34;storage_root\&#34;:\&#34;abfss://</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_AZ_ADLS2_METASTORE_PATH</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>\&#34;}&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span><span style=color:#6272a4># Get the Metastore ID</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>TMP_DBZ_AZ_METASTORE_ID</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>`</span>dbx-api -X GET <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_AZ_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.1/unity-catalog/metastores | jq -r <span style=color:#f1fa8c>&#39;.metastores[]|select(.name==$ENV.DBX_AZ_METASTORE_NAME)|.metastore_id&#39;</span><span style=color:#f1fa8c>`</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span><span style=color:#6272a4># 5. Assign the Metastore to the Workspace Databricks Azure</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span><span style=color:#6272a4># It&#39;s not possible to create the Storage Credential if the Metastore is not assigned to the Workspace Databricks</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>dbx-api -X PUT <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_AZ_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.1/unity-catalog/workspaces/<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_AZ_WORKSPACE_ID</span><span style=color:#f1fa8c>}</span>/metastore -H <span style=color:#f1fa8c>&#39;Content-Type: application/json&#39;</span> -d <span style=color:#f1fa8c>&#34;{\&#34;metastore_id\&#34;:\&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>TMP_DBZ_AZ_METASTORE_ID</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>\&#34;,\&#34;default_catalog_name\&#34;:\&#34;main\&#34;}&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span><span style=color:#6272a4># 6. Create the Storage Credential (for Unity Catalog)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span><span style=color:#6272a4># Get the databricks access connector id</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>TMP_AZ_DBX_CONNECTOR_ID</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>`</span>az databricks access-connector show --resource-group <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_RG_NAME</span><span style=color:#f1fa8c>}</span> --name <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_DBX_CONNECTOR_NAME</span><span style=color:#f1fa8c>}</span> -o json | jq -r <span style=color:#f1fa8c>&#39;.id&#39;</span><span style=color:#f1fa8c>`</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span><span style=color:#6272a4># Create the Storage Credential</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span>dbx-api -X POST -H <span style=color:#f1fa8c>&#39;Content-Type: application/json&#39;</span> <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_AZ_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.0/unity-catalog/storage-credentials --data <span style=color:#f1fa8c>&#34;{
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span><span style=color:#f1fa8c>  \&#34;name\&#34;: \&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_AZ_METASTORE_SC_NAME</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>\&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span><span style=color:#f1fa8c>  \&#34;comment\&#34;: \&#34;storage credential for the Metastore\&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span><span style=color:#f1fa8c>  \&#34;azure_managed_identity\&#34;: {
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span><span style=color:#f1fa8c>    \&#34;access_connector_id\&#34;: \&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>TMP_AZ_DBX_CONNECTOR_ID</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>\&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span><span style=color:#f1fa8c>  }
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span><span style=color:#f1fa8c>}&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57</span><span><span style=color:#6272a4># 7. Assign the Storage Credential to the Metastore</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58</span><span><span style=color:#6272a4># Get the Storage Credential id </span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>TMP_DBX_AZ_METASTORE_SC_ID</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>`</span>dbx-api -X GET <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_AZ_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.1/unity-catalog/storage-credentials | jq -r <span style=color:#f1fa8c>&#39;.storage_credentials[]|select(.name==$ENV.DBX_AZ_METASTORE_SC_NAME)|.id&#39;</span><span style=color:#f1fa8c>`</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61</span><span><span style=color:#6272a4># Update Metastore configuration with the Storage Credential</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62</span><span>dbx-api -X PATCH <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_AZ_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.1/unity-catalog/metastores/<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>TMP_DBZ_AZ_METASTORE_ID</span><span style=color:#f1fa8c>}</span> -H <span style=color:#f1fa8c>&#39;Content-Type: application/json&#39;</span> -d <span style=color:#f1fa8c>&#34;{\&#34;storage_root_credential_id\&#34;: \&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>TMP_DBX_AZ_METASTORE_SC_ID</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>\&#34;}&#34;</span>
</span></span></code></pre></div><p>If creating the <code>Databricks Access Connector</code> (step #2) does not work with the Azure CLI tool, you can do it manually by following this steps :</p><ol><li>Go to <code>Microsoft Azure page > Resource Group</code></li><li>Click on the desired resource group</li><li>Click on <code>Create</code></li><li>Fill in the <code>Search the Marketplace</code> information with the value <code>access connector for azure databricks</code></li><li>Click on <code>Create > Access Connector for Azure Databricks</code></li><li>Click on <code>Create</code></li><li>Fill in the <code>Subscription</code> , <code>Resource group</code>, <code>Name</code> and <code>Region</code> information with the desired values</li><li>Click on <code>Review + create</code></li><li>Click on <code>Create</code></li></ol><p>Note: Regarding the SQL Warehouse resource on Azure, a SQL Warehouse 2X-Small requires a value of at least 8 for the quota named <code>Total Regional Spot vCPUs</code></p><h2 id=setting-up-a-databricks-to-databricks-recipient>Setting up a Databricks-to-Databricks recipient</h2><p>In order to be able to share data with a recipient using a Unity Catalog Metastore, we need to perform the following actions:</p><ol><li>Request the Unity Catalog Metastore sharing identifier of the recipient</li><li>Create a <code>rcp_azure_dbx</code> recipient on the Unity Catalog AWS Metastore of the provider using the shared identifier corresponding to the Unity Catalog Azure Metastore of the recipient</li><li>Give read rights to the recipient <code>rcp_azure_dbx</code> on the elements of the share named <code>share_aws_dbx</code></li></ol><p>Details of the steps:</p><ol><li>Request the Unity Catalog Metastore sharing identifier of the recipient</li></ol><p>The share identifier is a character string composed of the following information : <code>&lt;Metastore Cloud Provider>:&lt;Metastore Region>:&lt;Metastore ID></code></p><p>There are several ways to get this identifier for the recipient:</p><ul><li>The 1st way (which is the simplest) is to connect to Worspace Databricks and execute the command <code>select current_metastore()</code> on a SQL Warehouse (or <code>spark.sql("select current_metastore()")</code> in a notebook attached to a cluster with access rights to the Metastore Unity Catalog)</li><li>The 2nd way is using Databricks REST API</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4># Get Metastore Sharing ID</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>dbx-api -X GET <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_AZ_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.1/unity-catalog/metastores  | jq -r <span style=color:#f1fa8c>&#39;.metastores[]|select(.name==$ENV.DBX_AZ_METASTORE_NAME)|.cloud+&#34;:&#34;+.region+&#34;:&#34;+.metastore_id&#39;</span>
</span></span></code></pre></div><ul><li>Le 3Ã¨me moyen est d&rsquo;utiliser l&rsquo;outil Data Explorer<ol><li>Allez dans <code>Workspace Databricks page > Data > Delta Sharing > Shared with me</code></li><li>Cliquez sur <code>Copy sharing identifier</code></li></ol></li></ul><p>Once the share identifier has been retrieved, it must be sent to the provider of the share.</p><ol start=2><li>Create a <code>rcp_azure_dbx</code> recipient on the Unity Catalog AWS Metastore of the provider using the shared identifier corresponding to the Unity Catalog Azure Metastore of the recipient</li></ol><p>Note: We will set up a <code>id_client: 1</code> property to use the partitions of the shared object whose alias is <code>sch_share.fct_trx_mng</code></p><p>The creation of a recipient requires the following rights on the Metastore:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>GRANT</span> CREATE_RECIPIENT <span style=color:#ff79c6>ON</span> METASTORE <span style=color:#ff79c6>TO</span> grp_demo;
</span></span></code></pre></div><p>To create a recipient with Databricks REST API :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4># Get the Azure Metastore Sharing Identifier</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>TMP_AZ_METASTORE_SHARING_ID</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>`</span>dbx-api -X GET <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_AZ_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.1/unity-catalog/metastores  | jq -r <span style=color:#f1fa8c>&#39;.metastores[]|select(.name==$ENV.DBX_AZ_METASTORE_NAME)|.cloud+&#34;:&#34;+.region+&#34;:&#34;+.metastore_id&#39;</span><span style=color:#f1fa8c>`</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#6272a4># Create Recipient for Databricks-to-Databricks Share</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>dbx-api -X POST <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.1/unity-catalog/recipients -H <span style=color:#f1fa8c>&#39;Content-Type: application/json&#39;</span> -d <span style=color:#f1fa8c>&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#f1fa8c>{
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#f1fa8c>      \&#34;name\&#34;: \&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_RECIPIENT_DBX</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>\&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#f1fa8c>      \&#34;authentication_type\&#34;: \&#34;DATABRICKS\&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#f1fa8c>      \&#34;data_recipient_global_metastore_id\&#34;: \&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>TMP_AZ_METASTORE_SHARING_ID</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>\&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#f1fa8c>      \&#34;properties_kvpairs\&#34;: {
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#f1fa8c>        \&#34;properties\&#34;: {\&#34;id_client\&#34;: \&#34;1\&#34;}
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#f1fa8c>      },
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#f1fa8c>      \&#34;comment\&#34; : \&#34;Recipient Databricks (share data between databricks metastore)\&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#f1fa8c>    }
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#f1fa8c>&#34;</span>
</span></span></code></pre></div><p>To create a recipient with SQL commands :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>-- A recipient created for Databricks to Databricks sharing with a id_client properties
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>CREATE</span> RECIPIENT rcp_azure_dbx
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#ff79c6>USING</span> ID <span style=color:#f1fa8c>&#39;&lt;Metastore Azure Sharing identifier&gt;&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>PROPERTIES ( id_client <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span><span style=color:#6272a4>-- To get the detail of the recipient
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>DESCRIBE</span> RECIPIENT rcp_azure_dbx;
</span></span></code></pre></div><ol start=3><li>Give read rights to the recipient <code>rcp_azure_dbx</code> on the elements of the share named <code>share_aws_dbx</code></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>GRANT</span> <span style=color:#ff79c6>SELECT</span> <span style=color:#ff79c6>ON</span> <span style=color:#ff79c6>SHARE</span> share_aws_dbx <span style=color:#ff79c6>TO</span> RECIPIENT rcp_azure_dbx;
</span></span></code></pre></div><p>From this last step, the <code>rcp_azure_dbx</code> recipient will be able to access the objects of the share using his Metastore Unity Catalog with his Workspace Databricks on Azure.</p><p>Note: It may take a few seconds or minutes to see the new provider named <code>dbx_aws_sharing</code> appear in the Metastore Unity Catalog on Azure after creating the recipient <code>rcp_azure_dbx</code> on AWS</p><p>The result should be the following:
<a href=/blog/web/20230521_blog_article_unity_catalog_dela_sharing_03.png><img alt=schema_03 src=/blog/web/20230521_blog_article_unity_catalog_dela_sharing_03.png></a></p><h2 id=access-through-the-unity-catalog-metastore-on-azure>Access through the Unity Catalog Metastore on Azure</h2><p>Once the Databricks-to-Databricks share has been set up, an administrator of the Metastore Unity Catalog Azure must be able to create a catalog using the information from the share in order to be able to make the objects of the share accessible to Metastore users.</p><p>To do this, all you have to do is use the SQL commands to create a catalog and give the rights to use and read the catalog (and objects) as for any other catalog in the Metastore Unity Catalog.</p><p>The difference being that the catalog objects linked to the share can only be used in read-only mode and the data is stored in the AWS S3 resource of the provider and not in the Azure ADLS Gen2 resource of the recipient.</p><p>Creation of the catalog with an SQL command :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>CATALOG</span> <span style=color:#ff79c6>IF</span> <span style=color:#ff79c6>NOT</span> <span style=color:#ff79c6>EXISTS</span> ctg_aws
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#ff79c6>USING</span> <span style=color:#ff79c6>SHARE</span> <span style=color:#ff79c6>`</span>dbx_aws_sharing<span style=color:#ff79c6>`</span>.share_aws_dbx
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#ff79c6>COMMENT</span> <span style=color:#f1fa8c>&#39;Shared data from AWS Metastore&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>;
</span></span></code></pre></div><p>Note: When setting up Databricks-to-Databricks sharing, there is no need to share connection information between the two Metastores. We only used a sharing identifier linked to the Metastore of the recipient, which has the effect of simplifying and securing exchanges and setting up the share.</p><p>Example of data access from a query on a SQL Warehouse via the Azure Workspace Databricks :</p><ol><li><p>When we access the <code>sch_share.fct_trx_mng</code> object, we only see the information whose <code>id_client</code> column is equal to the value <code>1</code> because the recipient only has the right to access to this data partition as defined by the provider when creating the recipient
<a href=/blog/web/20230521_blog_article_unity_catalog_dela_sharing_04.png><img alt=schema_04 src=/blog/web/20230521_blog_article_unity_catalog_dela_sharing_04.png></a></p></li><li><p>When we access the <code>sch_share.fct_trx_ext</code> object, we can see all the data.
<a href=/blog/web/20230521_blog_article_unity_catalog_dela_sharing_05.png><img alt=schema_05 src=/blog/web/20230521_blog_article_unity_catalog_dela_sharing_05.png></a></p></li></ol><p>Regarding access to the shared notebook:
To access the <code>shared_nbk</code> notebook, use the Data Explorer tool:</p><ol><li>Go to <code>Workspace Databricks page > Data</code></li><li>Select Catalog (from Shared Objects)</li><li>Click on the <code>Other assets</code> tab</li><li>Click on the desired notebook</li></ol><p>Note: You will only be able to see the cells of the notebook in read-only HTML format and you will be able to clone the notebook into your Workspace Databricks.</p><p>Visualization of the list of notebooks shared with the Data Explorer tool
<a href=/blog/web/20230521_blog_article_unity_catalog_dela_sharing_06.png><img alt=schema_06 src=/blog/web/20230521_blog_article_unity_catalog_dela_sharing_06.png></a></p><p>Visualization of the <code>shared_nbk</code> notebook with the Data Explorer tool
<a href=/blog/web/20230521_blog_article_unity_catalog_dela_sharing_07.png><img alt=schema_07 src=/blog/web/20230521_blog_article_unity_catalog_dela_sharing_07.png></a></p><h2 id=reading-audit-logs>Reading audit logs</h2><p>To access the audit logs more easily, we will create an external table named <code>ctg_ext.sch_ext.audit_logs_json</code> based on the <code>s3://s3-demo-data-uc/dbx_logs/account</code> directory which contains all log files in JSON format with information on events related to the Databricks Account (and to the different Databricks Workspaces).</p><p>We will focus only on the <code>deltaSharingQueriedTable</code> and <code>deltaSharingQueryTable</code> actions at the Databricks Account level regarding the <code>rcp_azure_dbx</code> recipient to highlight some information that we can easily retrieve from the audit logs to track access to shared objects.</p><p>The steps are :</p><ol><li>Create the external table <code>ctg_ext.sch_ext.audit_logs_json</code> to easily access the JSON files of the AWS S3 resource named <code>s3://s3-demo-data-uc/dbx_logs/account</code></li><li>Retrieve information about <code>deltaSharingQueryTable</code> actions from the <code>rcp_azure_dbx</code> recipient</li><li>Retrieving <code>deltaSharingQueriedTable</code> action information from the <code>rcp_azure_dbx</code> recipient</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>-- 1. Create ctg_ext.sch_ext.audit_logs_json from JSON files
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>TABLE</span> ctg_ext.sch_ext.audit_logs_json
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#ff79c6>USING</span> JSON
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#ff79c6>OPTIONS</span> (path <span style=color:#f1fa8c>&#34;s3://s3-demo-data-uc/dbx_logs/account&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#6272a4>-- 2. Get deltaSharingQueryTable action informations from rcp_azure_dbx recipient
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>select</span> requestId
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>,requestParams.recipient_name
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>,requestParams.<span style=color:#ff79c6>share</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>,requestParams.<span style=color:#ff79c6>schema</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>,requestParams.name
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>,requestParams.user_agent
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>,response.statusCode
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>,serviceName
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>,sourceIPAddress
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>,<span style=color:#8be9fd;font-style:italic>date</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#ff79c6>from</span> ctg_ext.sch_ext.audit_logs_json 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#ff79c6>where</span> actionName <span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#39;deltaSharingQueryTable&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#ff79c6>and</span> auditLevel <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;ACCOUNT_LEVEL&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#ff79c6>and</span> requestParams.recipient_name <span style=color:#ff79c6>in</span> (<span style=color:#f1fa8c>&#39;rcp_azure_dbx&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#ff79c6>order</span> <span style=color:#ff79c6>by</span> <span style=color:#ff79c6>timestamp</span> <span style=color:#ff79c6>asc</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span><span style=color:#6272a4>-- 3. Get deltaSharingQueriedTable action informations from rcp_azure_dbx recipient
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>select</span> requestId
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>,requestParams.recipient_name
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>,response.<span style=color:#ff79c6>result</span>:numRecords
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>,response.<span style=color:#ff79c6>result</span>:tableName
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>,response.<span style=color:#ff79c6>result</span>:deltaSharingPartitionFilteringAccessed
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>,serviceName
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>,sourceIPAddress
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>,userAgent
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span><span style=color:#ff79c6>from</span> ctg_ext.sch_ext.audit_logs_json 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span><span style=color:#ff79c6>where</span> actionName <span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#39;deltaSharingQueriedTable&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span><span style=color:#ff79c6>and</span> auditLevel <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;ACCOUNT_LEVEL&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span><span style=color:#ff79c6>and</span> requestParams.recipient_name <span style=color:#ff79c6>in</span> (<span style=color:#f1fa8c>&#39;rcp_azure_dbx&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span><span style=color:#ff79c6>order</span> <span style=color:#ff79c6>by</span> <span style=color:#ff79c6>timestamp</span> <span style=color:#ff79c6>asc</span>
</span></span></code></pre></div><p>Result of query nÂ°2 for <code>deltaSharingQueryTable</code> actions :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>requestId,recipient_name,share,schema,name,user_agent,statusCode,serviceName,sourceIPAddress
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>CgsI3ceeowYQhsLgAzoQSHf2V13IQFqodUiz6jKNJw==,rcp_azure_dbx,share_aws_dbx,sch_share,fct_trx_mng,Delta-Sharing-Unity-Catalog-Databricks-Auth/1.0 Linux/5.4.0-1107-azure-fips OpenJDK_64-Bit_Server_VM/11.0.18+10-jvmci-22.3-b13 java/11.0.18 scala/2.12.15 java_vendor/GraalVM_Community,200,unityCatalog,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>CgsI78eeowYQvvjMFjoQvIDzt07UQ3mzAJR99KJGpg==,rcp_azure_dbx,share_aws_dbx,sch_share,fct_trx_ext,Delta-Sharing-Unity-Catalog-Databricks-Auth/1.0 Linux/5.4.0-1107-azure-fips OpenJDK_64-Bit_Server_VM/11.0.18+10-jvmci-22.3-b13 java/11.0.18 scala/2.12.15 java_vendor/GraalVM_Community,200,unityCatalog,
</span></span></code></pre></div><p>This query allows us to access information from query requests executed on shared objects (recipient name, share name, schema name, table name, etc&mldr;)</p><p>Result of query nÂ°3 for <code>deltaSharingQueriedTable</code> actions :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>requestId,recipient_name,numRecords,tableName,deltaSharingPartitionFilteringAccessed,serviceName,sourceIPAddress,userAgent
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>d8140290-4a65-44a2-aac0-31c7feaf4aac,rcp_azure_dbx,5,fct_trx_mng,true,unityCatalog,,Delta-Sharing-Unity-Catalog-Databricks-Auth/1.0 Linux/5.4.0-1107-azure-fips OpenJDK_64-Bit_Server_VM/11.0.18+10-jvmci-22.3-b13 java/11.0.18 scala/2.12.15 java_vendor/GraalVM_Community
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>854c0522-aaca-465c-8f7d-1684a003e8e1,rcp_azure_dbx,8,fct_trx_ext,false,unityCatalog,,Delta-Sharing-Unity-Catalog-Databricks-Auth/1.0 Linux/5.4.0-1107-azure-fips OpenJDK_64-Bit_Server_VM/11.0.18+10-jvmci-22.3-b13 java/11.0.18 scala/2.12.15 java_vendor/GraalVM_Community
</span></span></code></pre></div><p>This query allows us to access the information of the result of the queries executed on the shared objects.
We can see that the query on the <code>fct_trx_mng</code> table has the <code>deltaSharingPartitionFilteringAccessed</code> option enabled and returns only 3 rows (which corresponds to the filter on the partitions) and that the query on the <code>fct_trx_ext</code> table returns 8 rows.
We can also have other information such as the ip address, the agent of the tool that executed the request (Databricks in our case) and many more informations.</p><h1 id=data-sharing-in-open-sharing>Data sharing in Open Sharing</h1><p>In order to be able to share the data with a recipient not using Metastore Unity Catalog (named Open Sharing), we must perform the following actions :</p><ol><li>Create the <code>rcp_open_all</code> recipient based on a Databricks Token (which will have a lifetime defined at the Metastore level)</li><li>Give read rights to the <code>rcp_open_all</code> recipient on the objects of the <code>share_aws_dbx</code> share</li><li>Retrieve the activation URL to send to the <code>rcp_open_all</code> recipient</li><li>The recipient must connect to the given URL and download the configuration file named <code>config.share</code> to be able to connect to the <code>share_aws_dbx</code> share</li></ol><p>Details of the steps:</p><ol><li>Create the <code>rcp_open_all</code> recipient based on a Databricks Token</li></ol><p>Note: We will set up a <code>id_client: 2</code> property to use the partitions of the shared object whose alias is <code>sch_share.fct_trx_mng</code></p><p>The creation of a recipient requires the following rights on the Metastore:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>GRANT</span> CREATE_RECIPIENT <span style=color:#ff79c6>ON</span> METASTORE <span style=color:#ff79c6>TO</span> <span style=color:#f1fa8c>&#39;grp_demo&#39;</span>;
</span></span></code></pre></div><p>To create a recipient with Databricks REST API :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4># Create Recipient for Token Open Sharing</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>dbx-api -X POST <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.1/unity-catalog/recipients -H <span style=color:#f1fa8c>&#39;Content-Type: application/json&#39;</span> -d <span style=color:#f1fa8c>&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#f1fa8c>{
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#f1fa8c>      \&#34;name\&#34;: \&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_RECIPIENT_OPEN</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>\&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#f1fa8c>      \&#34;authentication_type\&#34;: \&#34;TOKEN\&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#f1fa8c>      \&#34;properties_kvpairs\&#34;: {
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#f1fa8c>        \&#34;properties\&#34;: {\&#34;id_client\&#34;: \&#34;2\&#34;}
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#f1fa8c>      },
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#f1fa8c>      \&#34;comment\&#34;: \&#34;Give access to shared data for external tools\&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#f1fa8c>    }
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#f1fa8c>&#34;</span>
</span></span></code></pre></div><p>To create a recipient with SQL commands :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>-- A recipient created for sharing outside of Databricks with a id_client properties
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>CREATE</span> RECIPIENT rcp_open_all
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#ff79c6>COMMENT</span> <span style=color:#f1fa8c>&#39;Give access to shared data for external tools&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>PROPERTIES ( id_client <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>2</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>;
</span></span></code></pre></div><ol start=2><li>Give read rights to the <code>rcp_open_all</code> recipient on the objects of the <code>share_aws_dbx</code> share</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>GRANT</span> <span style=color:#ff79c6>SELECT</span> <span style=color:#ff79c6>ON</span> <span style=color:#ff79c6>SHARE</span> share_aws_dbx <span style=color:#ff79c6>TO</span> RECIPIENT rcp_open_all;
</span></span></code></pre></div><ol start=3><li>Retrieve the activation URL to send to the <code>rcp_open_all</code> recipient
The URL retrieval can be done with a SQL command (by the provider) :</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>-- Get the activation url (activation_link parameter)
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>DESCRIBE</span> RECIPIENT rcp_open_all;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#6272a4>-- activation_link : https://ireland.cloud.databricks.com/delta_sharing/retrieve_config.html?XXXXXXXXXXXXX
</span></span></span></code></pre></div><p>The URL retrieval can be done with the Databricks REST API (by the provider) :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>dbx-api -X GET <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.1/unity-catalog/recipients/<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_RECIPIENT_OPEN</span><span style=color:#f1fa8c>}</span> | jq -r <span style=color:#f1fa8c>&#39;.tokens[0].activation_url&#39;</span>
</span></span></code></pre></div><ol start=4><li>The recipient must connect to the given URL and download the configuration file named <code>config.share</code> to be able to connect to the <code>share_aws_dbx</code> share</li></ol><p>Warning: Whatever the method used, the retrieve of connection information can only be done once. This is managed by Databricks.</p><p>It is possible to retrieve the information with Databricks REST API:
Note: writing connection information in the file <code>~/config.share</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4># Get the URL Activation Code (from Metastore Unity CAtalog AWS)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>TMP_DBX_RECIPIENT_OPEN_URL</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>`</span>dbx-api -X GET <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.1/unity-catalog/recipients/<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_RECIPIENT_OPEN</span><span style=color:#f1fa8c>}</span> | jq <span style=color:#f1fa8c>&#39;.tokens[0].activation_url&#39;</span> | sed <span style=color:#f1fa8c>&#34;s/.*?//&#34;</span> | sed <span style=color:#f1fa8c>&#39;s/&#34;//&#39;</span><span style=color:#f1fa8c>`</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#6272a4># Extract information to write the config.share file (instead of download from databricks activation page) from Public API</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>dbx-api -X GET <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.1/unity-catalog/public/data_sharing_activation/<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>TMP_DBX_RECIPIENT_OPEN_URL</span><span style=color:#f1fa8c>}</span> &gt; ~/config.share
</span></span></code></pre></div><p>For manual retrieval of <code>config.share</code> connection information, simply access the provided activation URL:
<a href=/blog/web/20230521_blog_article_unity_catalog_dela_sharing_08.png><img alt=schema_08 src=/blog/web/20230521_blog_article_unity_catalog_dela_sharing_08.png></a></p><p>Information :</p><ul><li>You will only be able to access the activation URL and the objects of the share during the validity period of the Token Databricks</li><li>It is possible to access the activation URL as many times as you want (during the validity period) but the download of the configuration file <code>config.share</code> is only possible once<ul><li>It is through this configuration file <code>config.share</code> that you will be able to access shared objects</li></ul></li><li>It is possible to rotate Token Databricks to re-enable access to shared objects, but this requires getting a new configuration file <code>config.share</code> (the keys will be different)</li></ul><p>Example of a rotation of Databricks Token (if for example the activation could not be done during the initial validity period) with Databricks REST API :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4># If you need to rotate the Databricks Token</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>dbx-api -X POST <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.1/unity-catalog/recipients/<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_RECIPIENT_OPEN</span><span style=color:#f1fa8c>}</span>/rotate-token -H <span style=color:#f1fa8c>&#39;Content-Type: application/json&#39;</span> -d <span style=color:#f1fa8c>&#39;{
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#f1fa8c>&#34;existing_token_expire_in_seconds&#34;: 0
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#f1fa8c>}&#39;</span>
</span></span></code></pre></div><p>From step nÂ°4, the recipient can access the objects (delta tables only) of the share using the desired tool depending on the <code>delta-sharing</code> connectors available (python, java, sparks, etc &mldr;)</p><h2 id=access-by-python-script>Access by python script</h2><p>Prerequisites: the configuration file <code>config.share</code> has been retrieved locally <code>~/config.share</code></p><p>Installation of the <code>delta-sharing</code> python library proposed by Databricks</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>pip install delta-sharing
</span></span></code></pre></div><p>Example of a python script to display the contents of shared delta tables :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>import</span> delta_sharing
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#ff79c6>from</span> tabulate <span style=color:#ff79c6>import</span> tabulate
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#6272a4># Define the profile file (config.share)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>profile_file <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;~/config.share&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#6272a4># Define the parameter to read data</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>read_share <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;share_aws_dbx&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>read_schema <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;sch_share&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>read_table_mng <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;fct_trx_mng&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>read_table_ext <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;fct_trx_ext&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#6272a4># Get the data from shared table fct_trx_mng</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>df_pandas_mng <span style=color:#ff79c6>=</span> delta_sharing<span style=color:#ff79c6>.</span>load_as_pandas(<span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>{0}</span><span style=color:#f1fa8c>#</span><span style=color:#f1fa8c>{1}</span><span style=color:#f1fa8c>.</span><span style=color:#f1fa8c>{2}</span><span style=color:#f1fa8c>.</span><span style=color:#f1fa8c>{3}</span><span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>.</span>format(profile_file,read_share,read_schema,read_table_mng))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#8be9fd;font-style:italic>print</span>(<span style=color:#f1fa8c>&#34;Table : [</span><span style=color:#f1fa8c>{0}</span><span style=color:#f1fa8c>.</span><span style=color:#f1fa8c>{1}</span><span style=color:#f1fa8c>.</span><span style=color:#f1fa8c>{2}</span><span style=color:#f1fa8c>]&#34;</span><span style=color:#ff79c6>.</span>format(read_share,read_schema,read_table_mng))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#8be9fd;font-style:italic>print</span>(tabulate(df_pandas_mng, headers <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;keys&#39;</span>, tablefmt <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;pretty&#39;</span>))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#6272a4># Get the data from shared table fct_trx_ext</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>df_pandas_ext <span style=color:#ff79c6>=</span> delta_sharing<span style=color:#ff79c6>.</span>load_as_pandas(<span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>{0}</span><span style=color:#f1fa8c>#</span><span style=color:#f1fa8c>{1}</span><span style=color:#f1fa8c>.</span><span style=color:#f1fa8c>{2}</span><span style=color:#f1fa8c>.</span><span style=color:#f1fa8c>{3}</span><span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>.</span>format(profile_file,read_share,read_schema,read_table_ext))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#8be9fd;font-style:italic>print</span>(<span style=color:#f1fa8c>&#34;Table : [</span><span style=color:#f1fa8c>{0}</span><span style=color:#f1fa8c>.</span><span style=color:#f1fa8c>{1}</span><span style=color:#f1fa8c>.</span><span style=color:#f1fa8c>{2}</span><span style=color:#f1fa8c>]&#34;</span><span style=color:#ff79c6>.</span>format(read_share,read_schema,read_table_ext))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#8be9fd;font-style:italic>print</span>(tabulate(df_pandas_ext, headers <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;keys&#39;</span>, tablefmt <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;pretty&#39;</span>))
</span></span></code></pre></div><p>Script result :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span># Result :
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>Table : [share_aws_dbx.sch_share.fct_trx_mng]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>+---+--------+---------------------+------------+---------+-----------+----------+----------------------------+
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>|   | id_trx |       ts_trx        | id_product | id_shop | id_client | quantity |          ts_tech           |
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>+---+--------+---------------------+------------+---------+-----------+----------+----------------------------+
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>| 0 |   8    | 2023-04-10 18:30:00 |     3      |    1    |     2     |    2     | 2023-05-19 12:52:17.070000 |
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>| 1 |   7    | 2023-04-10 18:30:00 |     2      |    1    |     2     |    11    | 2023-05-19 12:52:17.070000 |
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>| 2 |   4    | 2023-04-05 08:00:00 |     3      |    1    |     2     |    9     | 2023-05-19 12:52:17.070000 |
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>+---+--------+---------------------+------------+---------+-----------+----------+----------------------------+
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>Table : [share_aws_dbx.sch_share.fct_trx_ext]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>+---+--------+---------------------+------------+---------+-----------+----------+----------------------------+
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>|   | id_trx |       ts_trx        | id_product | id_shop | id_client | quantity |          ts_tech           |
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>+---+--------+---------------------+------------+---------+-----------+----------+----------------------------+
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>| 0 |   1    | 2023-04-01 09:00:00 |     1      |    2    |     1     |    1     | 2023-05-19 12:52:06.195000 |
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>| 1 |   2    | 2023-04-01 11:00:00 |     1      |    1    |     1     |    3     | 2023-05-19 12:52:06.195000 |
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>| 2 |   3    | 2023-04-03 14:00:00 |     1      |    2    |     1     |    1     | 2023-05-19 12:52:06.195000 |
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>| 3 |   4    | 2023-04-05 08:00:00 |     3      |    1    |     2     |    9     | 2023-05-19 12:52:06.195000 |
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>| 4 |   5    | 2023-04-06 10:00:00 |     1      |    2    |     1     |    3     | 2023-05-19 12:52:06.195000 |
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>| 5 |   6    | 2023-04-06 12:00:00 |     2      |    2    |     1     |    1     | 2023-05-19 12:52:06.195000 |
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>| 6 |   7    | 2023-04-10 18:30:00 |     2      |    1    |     2     |    11    | 2023-05-19 12:52:06.195000 |
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>| 7 |   8    | 2023-04-10 18:30:00 |     3      |    1    |     2     |    2     | 2023-05-19 12:52:06.195000 |
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>+---+--------+---------------------+------------+---------+-----------+----------+----------------------------+
</span></span></code></pre></div><p>We can see that the first delta table <code>share_aws_dbx.sch_share.fct_trx_mng</code> only returns the information corresponding to the partition <code>id_client = 2</code> and the second delta table <code>share_aws_dbx.sch_share.fct_trx_ext</code> returns all the rows.</p><p>With this python script, we can see that it is extremely easy to access shared delta tables.</p><p>Example of a python script to list the delta tables of the share with the <code>SharingClient</code> object :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>import</span> delta_sharing
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#6272a4># Define the profile file (config.share)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>profile_file <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;~/config.share&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#6272a4># Get the Client objet to managed the Sharing connexion</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>client <span style=color:#ff79c6>=</span> delta_sharing<span style=color:#ff79c6>.</span>SharingClient(profile_file)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#8be9fd;font-style:italic>print</span>(<span style=color:#f1fa8c>&#34;Listing of All the Tables :&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#ff79c6>for</span> element <span style=color:#ff79c6>in</span> client<span style=color:#ff79c6>.</span>list_all_tables():
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#8be9fd;font-style:italic>print</span>(<span style=color:#f1fa8c>&#34;  - </span><span style=color:#f1fa8c>{}</span><span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>.</span>format(element))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#8be9fd;font-style:italic>print</span>(<span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>Listing of Shares : &#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>l_shares <span style=color:#ff79c6>=</span> client<span style=color:#ff79c6>.</span>list_shares()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#ff79c6>for</span> element <span style=color:#ff79c6>in</span> l_shares:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    <span style=color:#8be9fd;font-style:italic>print</span>(<span style=color:#f1fa8c>&#34;  - </span><span style=color:#f1fa8c>{}</span><span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>.</span>format(element))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#8be9fd;font-style:italic>print</span>(<span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>Listing of Schema from Share [</span><span style=color:#f1fa8c>{}</span><span style=color:#f1fa8c>] : &#34;</span><span style=color:#ff79c6>.</span>format(l_shares[<span style=color:#bd93f9>0</span>]<span style=color:#ff79c6>.</span>name))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>l_schemas <span style=color:#ff79c6>=</span> client<span style=color:#ff79c6>.</span>list_schemas(l_shares[<span style=color:#bd93f9>0</span>])
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#ff79c6>for</span> element <span style=color:#ff79c6>in</span> l_schemas :
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>    <span style=color:#8be9fd;font-style:italic>print</span>(<span style=color:#f1fa8c>&#34;  - </span><span style=color:#f1fa8c>{}</span><span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>.</span>format(element))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#8be9fd;font-style:italic>print</span>(<span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>Listing of Tables from Schema [</span><span style=color:#f1fa8c>{}</span><span style=color:#f1fa8c>] from Share [</span><span style=color:#f1fa8c>{}</span><span style=color:#f1fa8c>] : &#34;</span><span style=color:#ff79c6>.</span>format(l_schemas[<span style=color:#bd93f9>0</span>]<span style=color:#ff79c6>.</span>name,l_shares[<span style=color:#bd93f9>0</span>]<span style=color:#ff79c6>.</span>name))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>l_tables <span style=color:#ff79c6>=</span> client<span style=color:#ff79c6>.</span>list_tables(l_schemas[<span style=color:#bd93f9>0</span>])
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span><span style=color:#ff79c6>for</span> element <span style=color:#ff79c6>in</span> l_tables :
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>    <span style=color:#8be9fd;font-style:italic>print</span>(<span style=color:#f1fa8c>&#34;  - </span><span style=color:#f1fa8c>{}</span><span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>.</span>format(element))
</span></span></code></pre></div><p>Script result :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>Listing of All the Tables :
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>  - Table(name=&#39;fct_trx_ext&#39;, share=&#39;share_aws_dbx&#39;, schema=&#39;sch_share&#39;)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>  - Table(name=&#39;fct_trx_mng&#39;, share=&#39;share_aws_dbx&#39;, schema=&#39;sch_share&#39;)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>Listing of Shares : 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>  - Share(name=&#39;share_aws_dbx&#39;)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>Listing of Schema from Share [share_aws_dbx] : 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>  - Schema(name=&#39;sch_share&#39;, share=&#39;share_aws_dbx&#39;)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>Listing of Tables from Schema [sch_share] from Share [share_aws_dbx] : 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>  - Table(name=&#39;fct_trx_ext&#39;, share=&#39;share_aws_dbx&#39;, schema=&#39;sch_share&#39;)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>  - Table(name=&#39;fct_trx_mng&#39;, share=&#39;share_aws_dbx&#39;, schema=&#39;sch_share&#39;)
</span></span></code></pre></div><h2 id=lecture-des-logs-daudit>Lecture des logs d&rsquo;audit</h2><p>We will use the same procedure as for reading the Databricks-to-Databricks Sharing audit logs.</p><p>We will only focus on the <code>deltaSharingQueriedTable</code> and <code>deltaSharingQueryTable</code> actions at the Databricks Account level for the <code>rcp_open_all</code> recipient to highlight some information that we can easily retrieve from the audit logs to track access to shared objects.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>-- 1. Create ctg_ext.sch_ext.audit_logs_json from JSON files
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>TABLE</span> ctg_ext.sch_ext.audit_logs_json
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#ff79c6>USING</span> JSON
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#ff79c6>OPTIONS</span> (path <span style=color:#f1fa8c>&#34;s3://s3-demo-data-uc/dbx_logs/account&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#6272a4>-- 2. Get deltaSharingQueryTable action informations from rcp_open_all recipient
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>select</span> requestId
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>,requestParams.recipient_name
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>,requestParams.<span style=color:#ff79c6>share</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>,requestParams.<span style=color:#ff79c6>schema</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>,requestParams.name
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>,requestParams.user_agent
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>,response.statusCode
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>,serviceName
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>,sourceIPAddress
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>,<span style=color:#8be9fd;font-style:italic>date</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#ff79c6>from</span> ctg_ext.sch_ext.audit_logs_json 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#ff79c6>where</span> actionName <span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#39;deltaSharingQueryTable&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#ff79c6>and</span> auditLevel <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;ACCOUNT_LEVEL&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#ff79c6>and</span> requestParams.recipient_name <span style=color:#ff79c6>in</span> (<span style=color:#f1fa8c>&#39;rcp_open_all&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#ff79c6>order</span> <span style=color:#ff79c6>by</span> <span style=color:#ff79c6>timestamp</span> <span style=color:#ff79c6>asc</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span><span style=color:#6272a4>-- 2. Get information from deltaSharingQueriedTable action from rcp_open_all recipient
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>select</span> requestId
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>,requestParams.recipient_name
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>,response.<span style=color:#ff79c6>result</span>:numRecords
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>,response.<span style=color:#ff79c6>result</span>:tableName
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>,response.<span style=color:#ff79c6>result</span>:deltaSharingPartitionFilteringAccessed
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>,serviceName
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>,sourceIPAddress
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>,userAgent
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span><span style=color:#ff79c6>from</span> ctg_ext.sch_ext.audit_logs_json 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span><span style=color:#ff79c6>where</span> actionName <span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#39;deltaSharingQueriedTable&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span><span style=color:#ff79c6>and</span> auditLevel <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;ACCOUNT_LEVEL&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span><span style=color:#ff79c6>and</span> requestParams.recipient_name <span style=color:#ff79c6>in</span> (<span style=color:#f1fa8c>&#39;rcp_open_all&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span><span style=color:#ff79c6>order</span> <span style=color:#ff79c6>by</span> <span style=color:#ff79c6>timestamp</span> <span style=color:#ff79c6>asc</span>
</span></span></code></pre></div><p>Result of query nÂ°2 for <code>deltaSharingQueryTable</code> actions :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>requestId,recipient_name,share,schema,name,user_agent,statusCode,serviceName,sourceIPAddress
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>d59abaa0-2829-4d4b-90ea-73e9f4ec11ee,rcp_open_all,share_aws_dbx,sch_share,fct_trx_mng,Delta-Sharing-Python/0.6.4 pandas/1.3.4 PyArrow/11.0.0 Python/3.11.3 System/macOS-13.3.1-arm64-arm-64bit,200,unityCatalog,86.247.59.138
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>0690bef9-413d-44ec-8541-4901273aa589,rcp_open_all,share_aws_dbx,sch_share,fct_trx_ext,Delta-Sharing-Python/0.6.4 pandas/1.3.4 PyArrow/11.0.0 Python/3.11.3 System/macOS-13.3.1-arm64-arm-64bit,200,unityCatalog,86.247.59.138
</span></span></code></pre></div><p>This query allows us to access information from query requests executed on shared objects (recipient name, share name, schema name, table name, etc&mldr;)</p><p>Result of query nÂ°3 for <code>deltaSharingQueriedTable</code> actions :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>requestId,recipient_name,numRecords,tableName,deltaSharingPartitionFilteringAccessed,serviceName,sourceIPAddress,userAgent
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>88dc2822-63c1-4384-b706-82ab9d5f5d9a,rcp_open_all,3,fct_trx_mng,true,unityCatalog,86.247.59.138,Delta-Sharing-Python/0.6.4 pandas/1.3.4 PyArrow/11.0.0 Python/3.11.3 System/macOS-13.3.1-arm64-arm-64bit
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>2be8d1b6-936c-40d9-89c1-60d104e9f50f,rcp_open_all,8,fct_trx_ext,false,unityCatalog,86.247.59.138,Delta-Sharing-Python/0.6.4 pandas/1.3.4 PyArrow/11.0.0 Python/3.11.3 System/macOS-13.3.1-arm64-arm-64bit
</span></span></code></pre></div><p>This query allows us to access the information of the result of the queries executed on the shared objects.
We can see that the query on the <code>fct_trx_mng</code> table has the <code>deltaSharingPartitionFilteringAccessed</code> option enabled and returns only 5 rows (which corresponds to the filter on the partitions) and that the query on the <code>fct_trx_ext</code> table returns 8 rows.
We can also have other information such as the ip address, the agent of the tool that executed the request (Python/pandas in our case) and many other information.</p><h1 id=clean-environment>Clean environment</h1><p>You will find, below, all the instructions necessary to clean the environment.</p><p>Deleting recipients (with Databricks REST API) :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>dbx-api -X DELETE <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.1/unity-catalog/recipients/<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_RECIPIENT_DBX</span><span style=color:#f1fa8c>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>dbx-api -X DELETE <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.1/unity-catalog/recipients/<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_RECIPIENT_OPEN</span><span style=color:#f1fa8c>}</span>
</span></span></code></pre></div><p>Deleting imported notebook (with Databricks REST API) :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>dbx-api -X POST <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.0/workspace/delete -H <span style=color:#f1fa8c>&#39;Content-Type: application/json&#39;</span> -d <span style=color:#f1fa8c>&#39;{&#34;path&#34;: &#34;/Shared/read_demo_data_nbk_scala&#34;, &#34;recursive&#34;:&#34;false&#34;}&#39;</span>
</span></span></code></pre></div><p>Deleting share (with Databricks REST API) :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4># Delete Share</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>dbx-api -X DELETE <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.1/unity-catalog/shares/<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_SHARE_NAME</span><span style=color:#f1fa8c>}</span>
</span></span></code></pre></div><p>Deleting catalog in Metastore Unity Catalog (with SQL commands) :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>-- Delete the Catalog with CASCADE option (to delete all objects)
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>DROP</span> <span style=color:#ff79c6>CATALOG</span> <span style=color:#ff79c6>IF</span> <span style=color:#ff79c6>EXISTS</span> ctg_mng <span style=color:#ff79c6>CASCADE</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#ff79c6>DROP</span> <span style=color:#ff79c6>CATALOG</span> <span style=color:#ff79c6>IF</span> <span style=color:#ff79c6>EXISTS</span> ctg_ext <span style=color:#ff79c6>CASCADE</span>;
</span></span></code></pre></div><p>Deactivating data sharing feature on the Unity Catalog Metastore (with Databricks REST API):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4># Get the Metastore ID (databricks)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>TMP_DBX_METASTORE_ID</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>`</span>dbx-api -X GET <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.1/unity-catalog/metastores | jq -r <span style=color:#f1fa8c>&#39;.metastores[]|select(.name==$ENV.DBX_METASTORE_NAME)|.metastore_id&#39;</span><span style=color:#f1fa8c>`</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#6272a4># Update the Metastore configuration to deactivate Delta Sharing (external)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>dbx-api -X PATCH <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.1/unity-catalog/metastores/<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>TMP_DBX_METASTORE_ID</span><span style=color:#f1fa8c>}</span> -H <span style=color:#f1fa8c>&#39;Content-Type: application/json&#39;</span> -d <span style=color:#f1fa8c>&#34;{
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#f1fa8c>    \&#34;delta_sharing_scope\&#34;: \&#34;INTERNAL\&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span><span style=color:#f1fa8c>}&#34;</span>
</span></span></code></pre></div><p>Deleting data stored in the AWS S3 resource (with AWS CLI) :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4># Delete all files stored in the AWS S3 resource</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>aws s3 rm <span style=color:#f1fa8c>&#34;s3://s3-demo-data-uc/demo/&#34;</span> --recursive 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>aws s3 rm <span style=color:#f1fa8c>&#34;s3://s3-demo-data-uc/data/&#34;</span> --recursive 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>aws s3 rm <span style=color:#f1fa8c>&#34;s3://s3-demo-data-uc/dbx_logs/&#34;</span> --recursive 
</span></span></code></pre></div><p>Deleting all elements in the Azure Databricks Account (with Azure CLI and Databricks REST API) :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4># Delete Metastore</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>dbx-api -X DELETE <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_AZ_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.1/unity-catalog/metastores/<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBZ_AZ_METASTORE_ID</span><span style=color:#f1fa8c>}</span>  -H <span style=color:#f1fa8c>&#39;Content-Type: application/json&#39;</span> -d <span style=color:#f1fa8c>&#39;{&#34;force&#34;: &#34;true&#34;}&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#6272a4># Delete Databricks Access Connector</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>az databricks access-connector delete --resource-group <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_RG_NAME</span><span style=color:#f1fa8c>}</span> --name <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_DBX_CONNECTOR_NAME</span><span style=color:#f1fa8c>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span><span style=color:#6272a4># Delete ADLS Gen2 Storage</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>az storage account delete -n <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_ADLS2_NAME</span><span style=color:#f1fa8c>}</span> -g <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AZ_RG_NAME</span><span style=color:#f1fa8c>}</span>
</span></span></code></pre></div><p>Note : Consider disabling audit logs configuration with <a href=https://docs.databricks.com/api-explorer/account/logdelivery/patchstatus>Databricks REST API</a> if this is no longer needed</p><h1 id=conclusion>Conclusion</h1><p>With the Delta Sharing functionality, the Unity Catalog solution makes it possible to set up governance and data sharing in a very simple and secure way with internal (teams, subsidiaries) and external partners in order to better enhance and monetize them.</p><p>The management of shared objects can be done only with SQL commands, which makes the administration of shares and the management of access for the different recipients very simple and efficient.</p><p>Data sharing with Delta Sharing does not require the use of Databricks computing resources (Cluster or SQL Warehouse) of the provider to access shared objects.
Delta Sharing makes it possible to share data, which can be voluminous, in an efficient way and by limiting costs by providing transparent access directly to data storage in a secure way (AWS S3, Azure ADLS, GCP)</p><p>This makes it possible to multiply the data usage without having to duplicate it and to be able to access it from a very large number of tools and technologies (Spark, Python, Java, Scala, PowerBI and many others in the futur)</p><p>By relying on audit logs, we have the possibility of tracking all the events related to the Metastores of the Unity Catalog solution at the account level and to be able to analyze the use of shared objects by the different recipients.</p><p>At the time of writing this document (April/May 2023), it was not yet possible to share other objects than delta tables (managed or external) and notebooks (only for Databricks-to-Databricks) but the Databricks roadmap for the next versions confirms that we will soon be able to share many more types of objects.</p><p>This functionality is still recent but should become essential in the near future for all Databricks users for the management and governance of a Data Lake or a Lakehouse in order to maximize the data usage by all partners (internal and external) with the Unity Catalog solution.</p></div></article></div></div><footer><div class="container-fluid prag-bg-primary prag-foot">Build With <a href=https://gohugo.io/>Hugo</a>
&nbsp; - &nbsp;
<a href=https://en.wikipedia.org/wiki/WTFPL>WTFPL license</a> Â© 2018â2024</div></footer></body></html>