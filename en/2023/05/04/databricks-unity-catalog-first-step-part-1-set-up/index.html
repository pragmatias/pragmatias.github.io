<!doctype html><html lang=en><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta charset=utf-8><meta name=robots content="noindex, nofollow, noarchive, nosnipper, noodp, noydir"><meta name=google content="notranslate, noimageindex"><meta name=slurp content="notranslate, noimageindex"><meta name=msnbot content="notranslate, noimageindex"><meta name=bingbot content="notranslate, noimageindex"><meta name=generator content="Hugo 0.125.2"><link rel=stylesheet href=https://www.pragmatias.fr//css/bootstrap.min.css><link rel=stylesheet href=https://www.pragmatias.fr//css/pragmatias.css><script src=https://www.pragmatias.fr//js/jquery-3.6.0.slim.min.js></script><script src=https://www.pragmatias.fr//js/popper.min.js></script><script src=https://www.pragmatias.fr//js/bootstrap.bundle.min.js></script><link rel=alternate type=application/rss+xml href=https://www.pragmatias.fr/en/feed.xml><title>Databricks : Unity Catalog - First Step - Part 1 - Set up</title><body><div class="navbar navbar-expand-md prag-bg-primary prag-header" role=navigation><div class="container-fluid justify-content-center"><div class=navbar-brand><a href=https://www.pragmatias.fr/en/blog/><img src=/images/logo_pragmatias.svg alt=pragmatias></a></div><button class="navbar-toggler justify-content-end prag-navbar" type=button data-toggle=collapse data-target=#navbarSupportedContent1,#navbarSupportedContent2 aria-controls=navbarSupportedContent1 aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent1><ul class="navbar-nav text-center"><li class=nav-item><a class=nav-link href=https://www.pragmatias.fr/en/blog/>Blog</a></li><li class=nav-item><a class=nav-link href=https://www.pragmatias.fr/en/tags/>Tags</a></li><li class=nav-item><a class=nav-link href=https://www.pragmatias.fr/en/archives/>Archives</a></li></ul></div><div class="collapse navbar-collapse justify-content-md-end" id=navbarSupportedContent2><ul class="navbar-nav flex-row justify-content-center"><li class=nav-item><a href=https://www.pragmatias.fr/2023/05/04/databricks-unity-catalog-d%C3%A9couverte-partie-1-mise-en-place/ class="prag_header_svg mr-1 ml-1"><img src=/images/france-flag-round-xs-24.png alt=Français></a></li><li class=nav-item><a href=https://www.pragmatias.fr/en/feed.xml title="Pragmatias Blog" class="prag_header_svg mr-1 ml-1"><svg height="24" style="enable-background:new 0 0 508.52 508.52" viewBox="0 0 508.52 508.52" width="24" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path style="fill-rule:evenodd;clip-rule:evenodd;fill:" d="M254.26.0C113.845.0.0 113.845.0 254.26s113.845 254.26 254.26 254.26 254.26-113.845 254.26-254.26C508.52 113.813 394.675.0 254.26.0zM137.141 412.441c-22.852.0-41.413-18.434-41.413-41.285.0-22.693 18.561-41.349 41.413-41.349 22.915.0 41.444 18.656 41.476 41.349C178.618 393.976 160.088 412.441 137.141 412.441zM241.197 412.791c0-39.029-15.16-75.674-42.62-103.071-27.46-27.524-63.978-42.716-102.785-42.716V207.38c113.177.0 205.315 92.137 205.315 205.41h-59.91zM347.001 412.727c0-138.603-112.669-251.399-251.145-251.399v-59.624c171.435.0 310.96 139.589 310.96 311.023H347.001z"/></svg></a></li><li class=nav-item><a href=mailto:contact@pragmatias.fr title=Mail class="prag_header_svg mr-1 ml-1"><svg height="24" style="enable-background:new 0 0 299.997 299.997" viewBox="0 0 299.997 299.997" width="24" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path style="fill-rule:evenodd;clip-rule:evenodd;fill:" d="M149.996.0C67.157.0.001 67.158.001 149.997c0 82.837 67.156 150 149.995 150s150-67.163 150-150C299.996 67.158 232.835.0 149.996.0zM149.999 52.686l88.763 55.35H61.236l88.763-55.35zm89.869 143.737h-.009c0 8.878-7.195 16.072-16.072 16.072H76.211c-8.878.0-16.072-7.195-16.072-16.072v-84.865c0-.939.096-1.852.252-2.749l84.808 52.883c.104.065.215.109.322.169.112.062.226.122.34.179.599.309 1.216.558 1.847.721.065.018.13.026.195.041.692.163 1.393.265 2.093.265h.005c.005.0.01.0.01.0.7.0 1.401-.099 2.093-.265.065-.016.13-.023.195-.041.63-.163 1.245-.412 1.847-.721.114-.057.228-.117.34-.179.106-.06.218-.104.322-.169l84.808-52.883c.156.897.252 1.808.252 2.749v84.865z"/></svg></a></li><li><a href=https://github.com/pragmatias/ title=github class="prag_header_svg mr-1 ml-1"><svg height="24" style="enable-background:new 0 0 438.549 438.549" viewBox="0 0 438.549 438.549" width="24" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path style="fill-rule:evenodd;clip-rule:evenodd;fill:" d="M409.132 114.573c-19.608-33.596-46.205-60.194-79.798-79.8C295.736 15.166 259.057 5.365 219.271 5.365c-39.781.0-76.472 9.804-110.063 29.408-33.596 19.605-60.192 46.204-79.8 79.8C9.803 148.168.0 184.854.0 224.63c0 47.78 13.94 90.745 41.827 128.906 27.884 38.164 63.906 64.572 108.063 79.227 5.14.954 8.945.283 11.419-1.996 2.475-2.282 3.711-5.14 3.711-8.562.0-.571-.049-5.708-.144-15.417-.098-9.709-.144-18.179-.144-25.406l-6.567 1.136c-4.187.767-9.469 1.092-15.846 1-6.374-.089-12.991-.757-19.842-1.999-6.854-1.231-13.229-4.086-19.13-8.559-5.898-4.473-10.085-10.328-12.56-17.556l-2.855-6.57c-1.903-4.374-4.899-9.233-8.992-14.559-4.093-5.331-8.232-8.945-12.419-10.848l-1.999-1.431c-1.332-.951-2.568-2.098-3.711-3.429-1.142-1.331-1.997-2.663-2.568-3.997-.572-1.335-.098-2.43 1.427-3.289s4.281-1.276 8.28-1.276l5.708.853c3.807.763 8.516 3.042 14.133 6.851 5.614 3.806 10.229 8.754 13.846 14.842 4.38 7.806 9.657 13.754 15.846 17.847 6.184 4.093 12.419 6.136 18.699 6.136s11.704-.476 16.274-1.423c4.565-.952 8.848-2.383 12.847-4.285 1.713-12.758 6.377-22.559 13.988-29.41-10.848-1.14-20.601-2.857-29.264-5.14-8.658-2.286-17.605-5.996-26.835-11.14-9.235-5.137-16.896-11.516-22.985-19.126-6.09-7.614-11.088-17.61-14.987-29.979-3.901-12.374-5.852-26.648-5.852-42.826.0-23.035 7.52-42.637 22.557-58.817-7.044-17.318-6.379-36.732 1.997-58.24 5.52-1.715 13.706-.428 24.554 3.853 10.85 4.283 18.794 7.952 23.84 10.994 5.046 3.041 9.089 5.618 12.135 7.708 17.705-4.947 35.976-7.421 54.818-7.421s37.117 2.474 54.823 7.421l10.849-6.849c7.419-4.57 16.18-8.758 26.262-12.565 10.088-3.805 17.802-4.853 23.134-3.138 8.562 21.509 9.325 40.922 2.279 58.24 15.036 16.18 22.559 35.787 22.559 58.817.0 16.178-1.958 30.497-5.853 42.966-3.9 12.471-8.941 22.457-15.125 29.979-6.191 7.521-13.901 13.85-23.131 18.986-9.232 5.14-18.182 8.85-26.84 11.136-8.662 2.286-18.415 4.004-29.263 5.146 9.894 8.562 14.842 22.077 14.842 40.539v60.237c0 3.422 1.19 6.279 3.572 8.562 2.379 2.279 6.136 2.95 11.276 1.995 44.163-14.653 80.185-41.062 108.068-79.226 27.88-38.161 41.825-81.126 41.825-128.906C438.536 184.851 428.728 148.168 409.132 114.573z"/></svg></a></li></ul></div></div></div><div id=content><div class=container-fluid><article class="blog-post blog-post-with-toc"><header><h2 class=blog-post-title>Databricks : Unity Catalog - First Step - Part 1 - Set up</h2><div class=blog-post-date><span>Last update : 4 May 2023</span></div><div class=blog-post-date>Reading time : 17 minute(s) - 3546 words</div><div class=blog-post-tags><strong>Tags:</strong>
<a href=https://www.pragmatias.fr/en/tags/databricks/>Databricks</a>
<a href=https://www.pragmatias.fr/en/tags/unity-catalog/>Unity Catalog</a></div></header><aside class=prag-toc><h1 class=prag-toc-head>Summary</h1><div class=prag-toc-body><nav id=TableOfContents><ol><li><a href=#introduction>Introduction</a></li><li><a href=#whats-a-metastore>What&rsquo;s a metastore</a></li><li><a href=#whas-the-unity-catalog-solution>Wha&rsquo;s the Unity Catalog solution</a></li><li><a href=#objects-hierarchy>Objects hierarchy</a></li><li><a href=#context>Context</a><ol><li><a href=#diagram>Diagram</a></li><li><a href=#prerequisites>Prerequisites</a></li><li><a href=#steps>Steps</a></li></ol></li><li><a href=#setting-up>Setting up</a><ol><li><a href=#step-n0--initialization-of-environment-variables>Step n°0 : Initialization of environment variables</a></li><li><a href=#step-n1--creation-of-the-aws-s3-resource>Step n°1 : Creation of the AWS S3 resource</a></li><li><a href=#étape-n2--création-dune-politique-et-dun-rôle-avec-la-ressource-aws-iam>Étape n°2 : Création d&rsquo;une politique et d&rsquo;un rôle avec la ressource AWS IAM</a></li><li><a href=#step-n3--creation-of-a-metastore>Step n°3 : Creation of a Metastore</a></li><li><a href=#step-n4--creation-of-a-storage-credential>Step n°4 : Creation of a Storage Credential</a></li><li><a href=#step-n5--association-of-the-databricks-storage-credentiel-with-the-databricks-metastore>Step n°5 : Association of the Databricks Storage Credentiel with the Databricks Metastore</a></li><li><a href=#step-n6--association-of-the-databricks-metastore-with-the-databricks-workspace>Step n°6 : Association of the Databricks Metastore with the Databricks Workspace</a></li><li><a href=#step-n7--cleaning-of-environment-variables>Step n°7 : Cleaning of environment variables</a></li></ol></li><li><a href=#conclusion>Conclusion</a></li><li><a href=#resources>Resources</a><ol><li><a href=#glossary>Glossary</a></li><li><a href=#connection-management-for-the-aws-cli-tool>Connection management for the AWS CLI tool</a></li><li><a href=#connection-management-for-the-databricks-cli-tool>Connection management for the Databricks CLI tool</a></li></ol></li></ol></nav></div></aside><a id=showTopBtn href=# class=prag-sticky-bot><svg height="24" id="Layer_1" style="enable-background:new 0 0 438.533 438.533" viewBox="0 0 438.533 438.533" width="24" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path style="fill-rule:evenodd;clip-rule:evenodd;fill:" d="M409.133 109.203c-19.608-33.592-46.205-60.189-79.798-79.796C295.736 9.801 259.058.0 219.273.0c-39.781.0-76.47 9.801-110.063 29.407-33.595 19.604-60.192 46.201-79.8 79.796C9.801 142.8.0 179.489.0 219.267c0 39.78 9.804 76.463 29.407 110.062 19.607 33.592 46.204 60.189 79.799 79.798 33.597 19.605 70.283 29.407 110.063 29.407s76.47-9.802 110.065-29.407c33.593-19.602 60.189-46.206 79.795-79.798 19.603-33.596 29.403-70.284 29.403-110.062C438.533 179.485 428.732 142.795 409.133 109.203zM361.449 231.831l-25.981 25.981c-3.613 3.613-7.901 5.42-12.847 5.42-4.948.0-9.229-1.807-12.847-5.42l-53.954-53.961v143.32c0 4.948-1.813 9.232-5.428 12.847-3.613 3.62-7.898 5.427-12.847 5.427h-36.547c-4.948.0-9.231-1.807-12.847-5.427-3.617-3.614-5.426-7.898-5.426-12.847v-143.32l-53.959 53.961c-3.431 3.425-7.708 5.133-12.85 5.133-5.14.0-9.423-1.708-12.85-5.133l-25.981-25.981c-3.422-3.429-5.137-7.714-5.137-12.852.0-5.137 1.709-9.419 5.137-12.847l103.356-103.353 25.981-25.981c3.427-3.425 7.71-5.14 12.847-5.14 5.142.0 9.423 1.715 12.849 5.14l25.98 25.981 103.35 103.353c3.432 3.427 5.14 7.71 5.14 12.847C366.589 224.117 364.881 228.402 361.449 231.831z"/></svg>
</a><script>$(document).ready(function(){$("#showTopBtn").removeClass("prag-sticky-bot"),$("#showTopBtn").addClass("prag-sticky-hide"),$(function(){$(window).scroll(function(){$(this).scrollTop()>900?($("#showTopBtn").addClass("prag-sticky-bot"),$("#showTopBtn").removeClass("prag-sticky-hide")):($("#showTopBtn").addClass("prag-sticky-hide"),$("#showTopBtn").removeClass("prag-sticky-bot"))})})})</script><div class=blog-post-main><p>We are going to discover the <a href=https://docs.databricks.com/data-governance/unity-catalog/index.html>Unity Catalog</a> solution from Databricks and more specifically how to set it up on an existing workspace.</p><p>We will use a Databricks account on AWS to perform this demonstration.</p><p><em>Note: Work is based on the state of the Unity Catalog solution at the end of Q1 2023 on AWS and Azure.</em></p><h1 id=introduction>Introduction</h1><p>In December 2021, Databricks announced the general availability of <a href=https://www.databricks.com/blog/2021/12/15/announcing-general-availability-of-databricks-sql.html>SQL Warehouse</a>. This represents an important step in the development of the Lakehouse platform in order to multiply the uses of the data stored in Delta format. Data management was mainly based on Hive Metastore, which had the disadvantage of being local to a Databricks Workspace by default.
This meant that it was necessary to redefine the different objects and the management of the rights on the different Workspace Databricks requiring access to the data of the Lakehouse platform.</p><p>In order to do the best use of the Lakehouse platform and especially to be able to manage data governance, we were waiting for a Databricks solution to centralize all the metadata at the Databricks Account level and to be able to facilitate the metadata sharing between Databricks Workspaces.</p><p>In the late summer 2022, Databricks announced the general availability of the Unity Catalog solution on <a href=https://docs.databricks.com/release-notes/unity-catalog/20220825.html>AWS</a> and on <a href=https://azure.microsoft.com/en-us/updates/generally-available-unity-catalog-for-azure-databricks/>Azure</a> and then in late Q1 2023, the announcement was made on <a href=https://www.databricks.com/blog/2023/03/22/announcing-general-availability-databricks-unity-catalog-google-cloud-platform.html>GCP</a>.
With these announcements, Unity Catalog has become the default data governance solution for Databricks Lakehouse platform (both on AWS, Azure and GCP).</p><p>At the end of summer 2022, Databricks also announced the general availability of <a href=https://www.databricks.com/blog/2022/08/26/announcing-general-availability-delta-sharing.html>Delta Sharing</a> which is an open protocol aiming at sharing in an efficient, simple and secure way the data managed by the Lakehouse platform with third party tools/technologies (Python, Java, Scala, Power BI, and many others) but also with other Databricks Accounts (using or not the Unity Catalog solution)</p><p>At the end of 2022, Databricks announced the general availability of the <a href=https://www.databricks.com/blog/2022/12/12/announcing-general-availability-data-lineage-unity-catalog.html>Data Lineage</a> feature. This feature is very important to be able to follow the life cycle of all the data on the Lakehouse platform.</p><p>In order to make the Unity Catalog solution accessible to as many people as possible, which is a key solution in the use and management of the Databricks Lakehouse platform, a series of 5 articles has been written in a spirit of discovery (pedagogical) to set up and use the various features of the Unity Catalog solution.</p><p>The 45 articles have been organized as follows :</p><ul><li>Databricks : Unity Catalog - First Step - Part 1 - Set up</li><li>Databricks : Unity Catalog - First Step - Part 2 - Data and Rights Management</li><li>Databricks : Unity Catalog - First Step - Part 3 - Data Lineage</li><li>Databricks : Unity Catalog - First Step - Part 4 - Delta Sharing</li><li>Databricks : Unity Catalog - First Step - Part 5 - Delta Live Tables</li></ul><p>Please note that the work is based on the state of the Unity Catalog solution at the end of Q1 2023 on AWS and Azure.</p><p>We will use the following tools :</p><ul><li><a href=https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-getting-started.html>AWS CLI</a></li><li><a href=https://learn.microsoft.com/en-us/cli/azure/>Azure CLI</a></li><li><a href=https://docs.databricks.com/dev-tools/cli/index.html>Databricks CLI</a></li><li><a href=https://docs.databricks.com/dev-tools/api/index.html>Databricks REST API</a></li></ul><h1 id=whats-a-metastore>What&rsquo;s a metastore</h1><p>A metastore is a repository allowing to store a set of metadata related to data (storage, usage, options).</p><p>A metadata is an information about a data allowing to define its context (description, rights, technical date and time of creation or update, creator, &mldr;) and its usage (storage, structure, access, &mldr;).</p><p>A metastore can be local to an instance of a resource (a cluster, a workspace) or central to all resources managing data.</p><p>In a company with a data governance based on a Data Lake, Datawarehouse or Lakehouse model for example, we will advise to set up a centralized metastore allowing to store all the metadata of the company&rsquo;s data in order to facilitate the governance, the use and the sharing of the data to all the teams</p><h1 id=whas-the-unity-catalog-solution>Wha&rsquo;s the Unity Catalog solution</h1><p>Unity Catalog is the Databricks solution that allows to have a unified and centralized governance for all the data managed by the Databricks resources as well as to secure and facilitate the management and the sharing of the data to all the internal and external actors of an organization.</p><p>The internal use is done by sharing a metastore of Unity Catalog on all Databricks workspaces.</p><p>The external use is done by using the &ldquo;Delta Sharing&rdquo; functionality of Unity Catalog or by using the SQL Warehouse functionality through an external tool (JDBC connector, ODC or Databricks partners).</p><p>Some examples of features offered by the Unity Catalog solution:</p><ul><li>Management of rights on objects by groups and users using an ANSI SQL syntax</li><li>Management of objects that can be created in a Databricks workspace and used by all Databricks workspaces using Unity Catalog</li><li>Possibility to share data in a simple and secure way through the Delta Sharing functionality</li><li>Allows to capture information on the life cycle and the origin of the data (Data Lineage)</li><li>Capture all logs to be able to audit data access and use</li></ul><p>You can get a more complete overview by reading the <a href=https://docs.databricks.com/data-governance/unity-catalog/index.html>official documentation</a></p><h1 id=objects-hierarchy>Objects hierarchy</h1><p>Avant d&rsquo;aller plus loin, nous allons introduire la hiérarchie des objets au sein de la solution Unity Catalog.
Nous allons nous concentrer uniquement sur les éléments nécessaires à la mise en place de la solution Unity Catalog.</p><p>We will introduce the object hierarchy within the Unity Catalog solution.
We will focus only on the elements that are used in our set up of the Unity Catalog solution.</p><p>Diagram of the objects hierarchy :
<a href=/blog/web/20230504_databricks_unity_catalog_schema_01.png><img alt=schema_01 src=/blog/web/20230504_databricks_unity_catalog_schema_01.png></a></p><p>The objects hierarchy consists of the following three levels :</p><ol><li>Metastore :<ol><li>It is the top level object that can contain metadata</li><li>There can only be one Metastore per region</li><li>A Metastore must be attached to a Workspace to be used</li><li>The Metastore must have the same region as the Workspace to which it is attached</li></ol></li><li>Catalog :<ol><li>It is the first level of the hierarchy used to organize the data</li><li>It allows to organize objects (data) by schema (also called database)</li><li>If you want to have several environments in the same Metastore (in the same region) then you can create one Catalog per environment</li></ol></li><li>Schema (or Database) :<ol><li>It is the 2nd and last level of the hierarchy used to organize the data</li><li>This level is used to store all the metadata about objects of type Table, View or Function</li></ol></li></ol><p>When you want to access an object (for example a table), it will be necessary to specify the Catalog and Schema where the object is defined.
Example : <code>select ... from catalog.schema.table</code></p><p>Object used by the Unity Catalog solution to manage global access to data :</p><ul><li>Storage Credential : This object is directly associated with the Metastore and used to store access to a cloud provider (for example AWS S3) allowing the Unity Catalog solution to manage the rights on the data.</li></ul><p>Objects used by the Unity Catalog solution to store and manage metadata (data usage):</p><ul><li>Table : Object used to define the structure and storage of data.<ul><li>Managed Table : The data is directly managed by the Unity Catalog solution and use the format Delta</li><li>External Table : The data is not directly managed by the Unity Catalog solution and can use any of the following formats : &ldquo;Delta, CSV, JSON, Avro, Parquet, ORC or Text&rdquo;</li></ul></li><li>View : Object used to encapsulate a query using one or more objects (table or view)</li><li>Function : Objet used to define user defined function (operations on data)</li></ul><p>Some information about object quotas in the Unity Catalog solution:</p><ul><li>A Metastore can contain up to 1000 Catalog</li><li>A Metastore can contain up to 200 Storage Credential</li><li>A Catalog can contain up to 10000 Schema</li><li>A Schema can contain up to 10000 Table and 10000 Function</li></ul><h1 id=context>Context</h1><p>For this demonstration, we will only focus on the set up of a Metastore of the Unity Catalog solution on a Databricks Account on AWS.</p><p>In a project/company context, it is recommended to use the Terraform tool in order to be able to manage the infrastructure as code (IaC) and make the elements reproducible.</p><p>In the context of this demonstration, we will deliberately use command lines to make our approach clearer and more didactical.</p><p>We will mainly use the following tools:</p><ul><li>Databricks CLI: Command line interface to facilitate the use and configuration of Databricks resources</li><li>AWS CLI: Command line interface to facilitate the use and configuration of AWS resources</li></ul><h2 id=diagram>Diagram</h2><p>Diagram of all the elements that we will put in place to use the Unity Catalog solution with a Databricks Workspace.</p><p><a href=/blog/web/20230504_databricks_unity_catalog_schema_02.png><img alt=schema_02 src=/blog/web/20230504_databricks_unity_catalog_schema_02.png></a></p><h2 id=prerequisites>Prerequisites</h2><p>The following items are required before starting the set up :</p><ul><li>The Workspace must be in a Premium plan or higher</li><li>You must have a Databricks Account on AWS</li><li>You must have a Databricks Workspace based on the &ldquo;eu-west-1&rdquo; region</li><li>You must have a Databricks user account with administrative rights on the Databricks account</li><li>You must have an AWS user account with administration rights on AWS S3 and AWS IAM resources</li></ul><p>In order to use the Databricks CLI and AWS CLI tools you must have created the following elements :</p><ul><li>A Databricks User Token to use Databricks CLI</li><li>An AWS User Token to use AWS CLI
<em>Note: You will find the procedure for configuring the AWS CLI and Databricks CLI tools in the resources of this article</em>.</li></ul><p>Information about the global Databricks role for managing AWS access through Unity Catalog solution :</p><ul><li>AWS IAM Role Unity Catalog : <code>arn:aws:iam::414351767826:role/unity-catalog-prod-UCMasterRole-14S5ZJVKOTYTL</code></li></ul><p>Information about le Databricks Workspace ID :</p><ul><li>Based on Databricks Workspace URL : <code>https://&lt;databricks-instance>.com/o=XXXXX</code>, the workspace ID is the numeric value represented by <code>XXXXX</code>.</li></ul><h2 id=steps>Steps</h2><p>To set up the Unity Catalog solution and create a Metastore, we will perform the following steps :</p><ol><li>Creation of an AWS S3 resource</li><li>Creation of a Policy and a Role to manage the AWS S3 resource with AWS IAM resource</li><li>Creation of a Databricks Metastore</li><li>Creation of a Databricks Storage Credential</li><li>Association of the Databricks Storage Credentiel with the Databricks Metastore</li><li>Association of the Databricks Metastore with the Databricks Workspace</li></ol><h1 id=setting-up>Setting up</h1><h2 id=step-n0--initialization-of-environment-variables>Step n°0 : Initialization of environment variables</h2><p>Creation of environment variables allowing to define the naming of objects and to facilitate the writing of the commands.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4># AWS Variables</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>AWS_S3_DBX_UC</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;s3-dbx-metastore-uc&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>AWS_IAM_ROLE_DBX_UC</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;role-dbx-metastore-uc&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>AWS_IAM_POLICY_DBX_UC</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;policy-dbx-metastore-uc&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>AWS_TAGS</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#39;{&#34;TagSet&#34;: [{&#34;Key&#34;: &#34;owner&#34;,&#34;Value&#34;: &#34;admin&#34;},{&#34;Key&#34;: &#34;project&#34;,&#34;Value&#34;: &#34;databricks&#34;}]}&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#6272a4># Databricks Variables</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>DBX_WORKSPACE_ID</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;0000000000000000&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>DBX_METASTORE_NAME</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;metastor-sandbox&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>DBX_METASTORE_SC</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;sc-metastore-sandbox&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#6272a4># AWS Variables to define during the steps executions</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>AWS_IAM_ROLE_DBX_UC_ARN</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>AWS_IAM_POLICY_DBX_UC_ARN</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#6272a4># Databricks Variables to define during the steps executions</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>DBX_METASTORE_ID</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>DBX_METASTORE_SC_ID</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;&#34;</span>
</span></span></code></pre></div><h2 id=step-n1--creation-of-the-aws-s3-resource>Step n°1 : Creation of the AWS S3 resource</h2><p>This AWS S3 resource will be used by Unity Catalog to store &ldquo;Managed&rdquo; object data and metadata.</p><p>Execute the following commands using the AWS CLI :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4># Bucket creation</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>aws s3api create-bucket --bucket <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AWS_S3_DBX_UC</span><span style=color:#f1fa8c>}</span> --create-bucket-configuration <span style=color:#8be9fd;font-style:italic>LocationConstraint</span><span style=color:#ff79c6>=</span>eu-west-1
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#6272a4># Add Encryption information</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>aws s3api put-bucket-encryption --bucket <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AWS_S3_DBX_UC</span><span style=color:#f1fa8c>}</span> --server-side-encryption-configuration <span style=color:#f1fa8c>&#39;{&#34;Rules&#34;: [{&#34;ApplyServerSideEncryptionByDefault&#34;: {&#34;SSEAlgorithm&#34;: &#34;AES256&#34;},&#34;BucketKeyEnabled&#34;: true}]}&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#6272a4># Revoke public access</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>aws s3api put-public-access-block --bucket <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AWS_S3_DBX_UC</span><span style=color:#f1fa8c>}</span> --public-access-block-configuration <span style=color:#f1fa8c>&#39;{&#34;BlockPublicAcls&#34;: true,&#34;IgnorePublicAcls&#34;: true,&#34;BlockPublicPolicy&#34;: true,&#34;RestrictPublicBuckets&#34;: true}&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#6272a4># Add ownership controls information</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>aws s3api put-bucket-ownership-controls --bucket <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AWS_S3_DBX_UC</span><span style=color:#f1fa8c>}</span> --ownership-controls <span style=color:#f1fa8c>&#39;{&#34;Rules&#34;: [{&#34;ObjectOwnership&#34;: &#34;BucketOwnerEnforced&#34;}]}&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#6272a4># Add tags</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>aws s3api put-bucket-tagging --bucket <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AWS_S3_DBX_UC</span><span style=color:#f1fa8c>}</span> --tagging <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AWS_TAGS</span><span style=color:#f1fa8c>}</span>
</span></span></code></pre></div><h2 id=étape-n2--création-dune-politique-et-dun-rôle-avec-la-ressource-aws-iam>Étape n°2 : Création d&rsquo;une politique et d&rsquo;un rôle avec la ressource AWS IAM</h2><p>The policy and the role will allow to give administrative rights to the Unity Catalog solution to manage data access on the AWS S3 resource.</p><p>Execute the following commands using the AWS CLI :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2</span><span><span style=color:#6272a4># Create JSON config file for role creation (init)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3</span><span>cat &gt; tmp_role_document.json <span style=color:#f1fa8c>&lt;&lt;EOF
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4</span><span><span style=color:#f1fa8c>{
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5</span><span><span style=color:#f1fa8c>    &#34;Version&#34;: &#34;2012-10-17&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6</span><span><span style=color:#f1fa8c>    &#34;Statement&#34;: [
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7</span><span><span style=color:#f1fa8c>        {
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8</span><span><span style=color:#f1fa8c>            &#34;Effect&#34;: &#34;Allow&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9</span><span><span style=color:#f1fa8c>            &#34;Principal&#34;: {
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10</span><span><span style=color:#f1fa8c>                &#34;AWS&#34;: [
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11</span><span><span style=color:#f1fa8c>                    &#34;arn:aws:iam::414351767826:role/unity-catalog-prod-UCMasterRole-14S5ZJVKOTYTL&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12</span><span><span style=color:#f1fa8c>                ]
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13</span><span><span style=color:#f1fa8c>            },
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14</span><span><span style=color:#f1fa8c>            &#34;Action&#34;: &#34;sts:AssumeRole&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15</span><span><span style=color:#f1fa8c>            &#34;Condition&#34;: {
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16</span><span><span style=color:#f1fa8c>                &#34;StringEquals&#34;: {
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17</span><span><span style=color:#f1fa8c>                    &#34;sts:ExternalId&#34;: &#34;&lt;AWS Account Databricks ID&gt;&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18</span><span><span style=color:#f1fa8c>                }
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19</span><span><span style=color:#f1fa8c>            }
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20</span><span><span style=color:#f1fa8c>        }
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21</span><span><span style=color:#f1fa8c>    ]
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22</span><span><span style=color:#f1fa8c>}
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23</span><span><span style=color:#f1fa8c>EOF</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27</span><span><span style=color:#6272a4># Role creation</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28</span><span>aws iam create-role --role-name <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AWS_IAM_ROLE_DBX_UC</span><span style=color:#f1fa8c>}</span> --assume-role-policy-document file://tmp_role_document.json
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29</span><span><span style=color:#6272a4># Get the role ARN</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>AWS_IAM_ROLE_DBX_UC_ARN</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>`</span>aws_ippon_dtl iam get-role --role-name <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AWS_IAM_ROLE_DBX_UC</span><span style=color:#f1fa8c>}</span> | jq <span style=color:#f1fa8c>&#39;.Role.Arn&#39;</span><span style=color:#f1fa8c>`</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34</span><span><span style=color:#6272a4># Create JSON config file for role update</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35</span><span>cat &gt; tmp_role_document_update.json <span style=color:#f1fa8c>&lt;&lt;EOF
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36</span><span><span style=color:#f1fa8c>{
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37</span><span><span style=color:#f1fa8c>    &#34;Version&#34;: &#34;2012-10-17&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38</span><span><span style=color:#f1fa8c>    &#34;Statement&#34;: [
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39</span><span><span style=color:#f1fa8c>        {
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40</span><span><span style=color:#f1fa8c>            &#34;Effect&#34;: &#34;Allow&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41</span><span><span style=color:#f1fa8c>            &#34;Principal&#34;: {
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42</span><span><span style=color:#f1fa8c>                &#34;AWS&#34;: [
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43</span><span><span style=color:#f1fa8c>                    ${AWS_IAM_ROLE_DBX_UC_ARN},
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44</span><span><span style=color:#f1fa8c>                    &#34;arn:aws:iam::414351767826:role/unity-catalog-prod-UCMasterRole-14S5ZJVKOTYTL&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45</span><span><span style=color:#f1fa8c>                ]
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46</span><span><span style=color:#f1fa8c>            },
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47</span><span><span style=color:#f1fa8c>            &#34;Action&#34;: &#34;sts:AssumeRole&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48</span><span><span style=color:#f1fa8c>            &#34;Condition&#34;: {
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49</span><span><span style=color:#f1fa8c>                &#34;StringEquals&#34;: {
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50</span><span><span style=color:#f1fa8c>                    &#34;sts:ExternalId&#34;: &#34;&lt;AWS Account Databricks ID&gt;&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51</span><span><span style=color:#f1fa8c>                }
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52</span><span><span style=color:#f1fa8c>            }
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53</span><span><span style=color:#f1fa8c>        }
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54</span><span><span style=color:#f1fa8c>    ]
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55</span><span><span style=color:#f1fa8c>}
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56</span><span><span style=color:#f1fa8c>EOF</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58</span><span><span style=color:#6272a4># Add reference on himself</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59</span><span>aws iam update-assume-role-policy --role-name <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AWS_IAM_ROLE_DBX_UC</span><span style=color:#f1fa8c>}</span>  --policy-document file://tmp_role_document_update.json
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60</span><span><span style=color:#6272a4># Add tags</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61</span><span>aws iam tag-role --role-name <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AWS_IAM_ROLE_DBX_UC</span><span style=color:#f1fa8c>}</span> --tags <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AWS_TAGS</span><span style=color:#f1fa8c>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62</span><span><span style=color:#6272a4># Add description</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63</span><span>aws iam update-role-description --role-name <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AWS_IAM_ROLE_DBX_UC</span><span style=color:#f1fa8c>}</span> --description <span style=color:#f1fa8c>&#39;This role is used for storing Databricks Unity Catalog metadata to S3 Resources&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68</span><span><span style=color:#6272a4># Create JSON config file for policy creation</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69</span><span>cat &gt; tmp_policy_document.json <span style=color:#f1fa8c>&lt;&lt;EOF
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70</span><span><span style=color:#f1fa8c>{
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71</span><span><span style=color:#f1fa8c> &#34;Version&#34;: &#34;2012-10-17&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72</span><span><span style=color:#f1fa8c> &#34;Statement&#34;: [
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73</span><span><span style=color:#f1fa8c>     {
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74</span><span><span style=color:#f1fa8c>         &#34;Action&#34;: [
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75</span><span><span style=color:#f1fa8c>             &#34;s3:GetObject&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76</span><span><span style=color:#f1fa8c>             &#34;s3:PutObject&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77</span><span><span style=color:#f1fa8c>             &#34;s3:DeleteObject&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78</span><span><span style=color:#f1fa8c>             &#34;s3:ListBucket&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79</span><span><span style=color:#f1fa8c>             &#34;s3:GetBucketLocation&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80</span><span><span style=color:#f1fa8c>             &#34;s3:GetLifecycleConfiguration&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81</span><span><span style=color:#f1fa8c>             &#34;s3:PutLifecycleConfiguration&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82</span><span><span style=color:#f1fa8c>         ],
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83</span><span><span style=color:#f1fa8c>         &#34;Resource&#34;: [
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84</span><span><span style=color:#f1fa8c>             &#34;arn:aws:s3:::${AWS_S3_DBX_UC}/*&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85</span><span><span style=color:#f1fa8c>             &#34;arn:aws:s3:::${AWS_S3_DBX_UC}&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86</span><span><span style=color:#f1fa8c>         ],
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87</span><span><span style=color:#f1fa8c>         &#34;Effect&#34;: &#34;Allow&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88</span><span><span style=color:#f1fa8c>     },
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89</span><span><span style=color:#f1fa8c>     {
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90</span><span><span style=color:#f1fa8c>         &#34;Action&#34;: [
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91</span><span><span style=color:#f1fa8c>             &#34;sts:AssumeRole&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92</span><span><span style=color:#f1fa8c>         ],
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93</span><span><span style=color:#f1fa8c>         &#34;Resource&#34;: [
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94</span><span><span style=color:#f1fa8c>             ${AWS_IAM_ROLE_DBX_UC_ARN}
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95</span><span><span style=color:#f1fa8c>         ],
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96</span><span><span style=color:#f1fa8c>         &#34;Effect&#34;: &#34;Allow&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97</span><span><span style=color:#f1fa8c>     }
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98</span><span><span style=color:#f1fa8c>   ]
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99</span><span><span style=color:#f1fa8c>}
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">100</span><span><span style=color:#f1fa8c>EOF</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">101</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">102</span><span><span style=color:#6272a4># Policy creation</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">103</span><span>aws iam create-policy --policy-name <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AWS_IAM_POLICY_DBX_UC</span><span style=color:#f1fa8c>}</span> --policy-document file://tmp_policy_document.json &gt; tmp_result_creation_policy.json
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">104</span><span><span style=color:#6272a4># Get Policy ARN</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">105</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>AWS_IAM_POLICY_DBX_UC_ARN</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>`</span>cat tmp_result_creation_policy.json | jq <span style=color:#f1fa8c>&#39;.Policy.Arn&#39;</span><span style=color:#f1fa8c>`</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">106</span><span><span style=color:#6272a4># Add tags</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">107</span><span>aws iam tag-policy --policy-arn <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AWS_IAM_POLICY_DBX_UC_ARN</span><span style=color:#f1fa8c>}</span> --tags <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AWS_TAGS</span><span style=color:#f1fa8c>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">108</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">109</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">110</span><span><span style=color:#6272a4># Attach Policy to the Role</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">111</span><span>aws iam attach-role-policy --role-name <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AWS_IAM_ROLE_DBX_UC</span><span style=color:#f1fa8c>}</span>  --policy-arn <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AWS_IAM_POLICY_DBX_UC_ARN</span><span style=color:#f1fa8c>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">112</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">113</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">114</span><span><span style=color:#6272a4># Delete temporary JSON files</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">115</span><span>rm tmp_role_document_update.json
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">116</span><span>rm tmp_role_document.json
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">117</span><span>rm tmp_policy_document.json
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">118</span><span>rm tmp_result_creation_policy.json
</span></span></code></pre></div><h2 id=step-n3--creation-of-a-metastore>Step n°3 : Creation of a Metastore</h2><p>Create a Unity Catalog Metastore in the same region as the Workspace we want to use it with.</p><p>Execute the following commands using the Databricks CLI :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4># Create metastore</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>databricks unity-catalog metastores create --name <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_METASTORE_NAME</span><span style=color:#f1fa8c>}</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#f1fa8c></span>                                           --storage-root s3://<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>AWS_S3_DBX_UC</span><span style=color:#f1fa8c>}</span>/<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_METASTORE_NAME</span><span style=color:#f1fa8c>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#6272a4># Get the metastore ID</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>DBX_METASTORE_ID</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>`</span>databricks unity-catalog metastores get-summary | jq <span style=color:#f1fa8c>&#39;select(.name == $ENV.DBX_METASTORE_NAME) | .metastore_id&#39;</span><span style=color:#f1fa8c>`</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#6272a4># Check the metastore ID (it must not be empty)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_METASTORE_ID</span><span style=color:#f1fa8c>}</span>
</span></span></code></pre></div><h2 id=step-n4--creation-of-a-storage-credential>Step n°4 : Creation of a Storage Credential</h2><p>Created a Storage Credential to store access for the global Databricks role on the AWS S3 resource used to store Metastore data.</p><p>Execute the following commands using the Databricks CLI :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4># Create JSON config file</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>cat &gt; tmp_databricks_metastore_storagecredential.json <span style=color:#f1fa8c>&lt;&lt;EOF
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#f1fa8c>{
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#f1fa8c>  &#34;name&#34;: ${DBX_METASTORE_SC},
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#f1fa8c>  &#34;aws_iam_role&#34;: {
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#f1fa8c>    &#34;role_arn&#34;: ${AWS_IAM_ROLE_DBX_UC_ARN}
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#f1fa8c>  },
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#f1fa8c>  &#34;comment&#34; : &#34;Storage Credential for Unity Catalog Storage&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#f1fa8c>}
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#f1fa8c>EOF</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#6272a4># Create Storage Credential</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>databricks unity-catalog storage-credentials create --json-file tmp_databricks_metastore_storagecredential.json
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#6272a4># Get Storage Credential ID</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>DBX_METASTORE_SC_ID</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>`</span>databricks unity-catalog storage-credentials get --name <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_METASTORE_SC</span><span style=color:#f1fa8c>}</span> | jq <span style=color:#f1fa8c>&#39;.id&#39;</span><span style=color:#f1fa8c>`</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#6272a4># Delete temporary files</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>rm tmp_databricks_metastore_storagecredential.json
</span></span></code></pre></div><h2 id=step-n5--association-of-the-databricks-storage-credentiel-with-the-databricks-metastore>Step n°5 : Association of the Databricks Storage Credentiel with the Databricks Metastore</h2><p>In order for the Metastore to use the Storage Credential to access the AWS S3 resource and to be able to manage access on the data for all users, we need to associate the Storage Credential with the Metastore.</p><p>Execute the following commands using the Databricks CLI :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4># Create JSON config file</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>cat &gt; tmp_databricks_metastore_update_sc.json <span style=color:#f1fa8c>&lt;&lt;EOF
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#f1fa8c>{
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#f1fa8c>  &#34;default_data_access_config_id&#34;: ${DBX_METASTORE_SC_ID},
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#f1fa8c>  &#34;storage_root_credential_id&#34;: ${DBX_METASTORE_SC_ID}
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#f1fa8c>}
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#f1fa8c>EOF</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#6272a4># Update Metastore with the Storage Credential</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>databricks unity-catalog metastores update --id <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_METASTORE_ID</span><span style=color:#f1fa8c>}</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#f1fa8c></span>                                           --json-file tmp_databricks_metastore_update_sc.json
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#6272a4># Delete temporary files</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>rm tmp_databricks_metastore_update_sc.json
</span></span></code></pre></div><h2 id=step-n6--association-of-the-databricks-metastore-with-the-databricks-workspace>Step n°6 : Association of the Databricks Metastore with the Databricks Workspace</h2><p>To be able to use the Metastore with a Databricks Workspace, it is necessary to assign the Metastore to the Databricks Workspace at the Databricks account level.
Note: it is possible to define the name of the Catalog by default for the users of the Workspace.</p><p>Execute the following commands using the Databricks CLI :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>databricks unity-catalog metastores assign --workspace-id <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_WORKSPACE_ID</span><span style=color:#f1fa8c>}</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#f1fa8c></span>                                           --metastore-id <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_METASTORE_ID</span><span style=color:#f1fa8c>}</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#f1fa8c></span>                                           --default-catalog-name main
</span></span></code></pre></div><h2 id=step-n7--cleaning-of-environment-variables>Step n°7 : Cleaning of environment variables</h2><p>We can unset all the environment variables used when setting up Unity Catalog solution.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4># Clean the AWS &amp; Databricks Attributes</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#8be9fd;font-style:italic>unset</span> AWS_S3_DBX_UC
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#8be9fd;font-style:italic>unset</span> AWS_IAM_ROLE_DBX_UC
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#8be9fd;font-style:italic>unset</span> AWS_IAM_POLICY_DBX_UC
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#8be9fd;font-style:italic>unset</span> AWS_TAGS
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#8be9fd;font-style:italic>unset</span> DBX_WORKSPACE_ID
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#8be9fd;font-style:italic>unset</span> DBX_METASTORE_NAME
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#8be9fd;font-style:italic>unset</span> DBX_METASTORE_SC
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#8be9fd;font-style:italic>unset</span> AWS_IAM_ROLE_DBX_UC_ARN
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#8be9fd;font-style:italic>unset</span> AWS_IAM_POLICY_DBX_UC_ARN
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#8be9fd;font-style:italic>unset</span> DBX_METASTORE_ID
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#8be9fd;font-style:italic>unset</span> DBX_METASTORE_SC_ID
</span></span></code></pre></div><h1 id=conclusion>Conclusion</h1><p>With the help of the Databricks CLI and AWS CLI tools, we were able to easily set up a Metastore on our Databricks Workspace in order to use the Unity Catalog solution.</p><p>This allowed us to easily set up a solution to manage our centralized metadata repository for all the data managed and manipulated by our Databricks resources (Cluster and SQL Warehouse).</p><p>Les avantages de l&rsquo;utilisation de la solution Unity Catalog :</p><ul><li>Unity Catalog permet de simplifier et centraliser la gestion des droits sur l&rsquo;ensemble des objets gérés.</li><li>Unity Catalog permet de sécuriser, faciliter et multiplier les usages sur les données grâce aux nombreux connecteurs pour SQL Warehouse ainsi que la possibilité d&rsquo;exporter les informations vers d&rsquo;autres outils de gestion de catalogue de données.</li><li>Unity Catalog est un outil qui s&rsquo;améliore régulièrement et qui devrait devenir la référence pour la gouvernance des données pour toutsceux qui utilisent Databricks.</li></ul><p>The advantages of using the Unity Catalog solution :</p><ul><li>Unity Catalog simplifies and centralizes the management of rights on all managed objects.</li><li>Unity Catalog allows you to secure, facilitate and multiply the usages of data by using the numerous connectors for SQL Warehouse as well as the possibility of exporting information to other data catalog management tools.</li><li>Unity Catalog is a tool that is regularly improved and that should become the reference for data governance for all those who use Databricks.</li></ul><p>Some information about the limitations on the Unity Catalog solution:</p><ul><li>The Workspace must be at least at the premium plan to use Unity Catalog</li><li>A Metastore must contain all the elements concerning a region.</li><li>It is recommended to use a cluster with Databricks Runtime version 11.3 LTS or higher</li><li>The creation of a Storage Credential is only possible with an AWS IAM role when the Databricks Account is on AWS</li><li>Part of the management of users and groups must be done at the account level and not only at the workspace level</li><li>The groups defined locally in a workspace cannot be used with Unity Catalog, it is necessary to recreate the groups at the Databricks account level to be used by Unity Catalog (Migration).</li></ul><h1 id=resources>Resources</h1><h2 id=glossary>Glossary</h2><ul><li>Account Databricks : Highest level for Databricks administration</li><li>Cluster Databricks : A set of computational resources for running Spark processing with Databricks</li><li>Databricks Workspace ID : Identifier of the Databricks workspace</li><li>Storage Credential : Object used to store the access for the Unity Catalog solution</li><li>Data Lake : Used to store structured, semi-structured and unstructured data</li><li>Data Warehouse : Used to store structured data (relational database)</li><li>Lakehouse : Data management architecture that combines the benefits of a Data Lake with the management capabilities of a Data Warehouse</li><li>AWS S3 : AWS Simple Storage Service for storing data/objects</li><li>AWS IAM : AWS Identity and Access Management Service to control access to AWS services and resources.</li></ul><h2 id=connection-management-for-the-aws-cli-tool>Connection management for the AWS CLI tool</h2><ol><li><p>Install the tool <code>AWS CLI</code> on macOS with Homebrew <code>brew install awscli</code></p></li><li><p>Define a specific user for AWS CLI :</p><ol><li>Go to <code>IAM > Users</code></li><li>Click on <code>Add users</code></li><li>Fill the &ldquo;User Name&rdquo; : <code>usr_adm_cli</code> and click on <code>Next</code></li><li>If you have an admin group defined :<ol><li>Choose <code>Add user to group</code></li><li>Choose the desired group name : <code>FullAdmin</code> and click on <code>Next</code></li></ol></li><li>If you have a policy defined :<ol><li>Choose <code>Attach policies directly</code></li><li>Choose the desired policy name : <code>AdministratorAccess</code> and click on <code>Next</code></li></ol></li><li>If you need to define Tag : Click on <code>Add new tag</code> and add the needed tag</li><li>Click on <code>Create user</code></li><li>Click on the created user <code>usr_adm_cli</code></li><li>Click on <code>Security credentials</code></li><li>Click on <code>Create access key</code></li><li>Choose <code>Command Line Interface (CLI)</code>, check the box <code>I understand the above .... to proceed to create an access key</code> and click on <code>Next</code></li><li>Fill the <code>Description tag value</code> : <code>administration</code> and click on <code>Create access key</code></li><li>Copy the <code>Access key</code> and the <code>Secret access key</code> to be able to use it with AWS CLI</li></ol></li><li><p>Create configuration for AWS CLI to use the new user :</p><ol><li>Execute the command : <code>aws configure</code><ol><li>Fill <code>AWS Access Key ID</code> with the <code>Access key</code> of the new user <code>usr_adm_cli</code></li><li>Fill <code>AWS Secret Access Key</code> with the <code>Secret access key</code> of the new user <code>usr_adm_cli</code></li><li>Fill <code>Default region name</code> with the default location : <code>eu-west-1</code></li><li>Fill <code>Default output format</code> with the default output format <code>json</code></li></ol></li></ol></li><li><p>Check the AWS CLI configuration</p><ol><li>Execute the commande <code>aws s3api list-buckets</code></li><li>Result :</li></ol></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    <span style=color:#ff79c6>&#34;Buckets&#34;</span>: [
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>        {...}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>    ]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>}
</span></span></code></pre></div><h2 id=connection-management-for-the-databricks-cli-tool>Connection management for the Databricks CLI tool</h2><ol><li><p>Install the tool <code>Databricks CLI</code> with <code>pip</code> (requires python3)</p><ol><li>Execute the command : <code>pip install databricks-cli</code></li><li>Check the result with the command : <code>databricks --version</code> (Result : <code>Version 0.17.6</code>)</li></ol></li><li><p>Create a Databricks Token</p><ol><li>Go to your Databricks workspace</li><li>Click on your user and click on <code>User Settings</code></li><li>Click on <code>Access tokens</code></li><li>Click on <code>Generate new token</code></li><li>Fill the comment and define the token life time</li><li>Click on <code>Generate</code></li><li>Copy the Databricks Token to be able to use it with Databricks CLI</li></ol></li><li><p>Configure Databricks CLI</p><ol><li>Execute the command : <code>databricks configure --token</code></li><li>Fill the <code>Databricks Host (should begin with https://):</code> with your workspace url : <code>https://dbc-0a000411-23e7.cloud.databricks.com</code></li><li>Fill the <code>Access Token</code> with the Databricks Token created : <code>dapi2c0000aa000a0r0a00e000000000000</code></li></ol></li></ol><p>You can see your credential with the command<code>cat ~/.databrickscfg</code></p></div></article></div></div><footer><div class="container-fluid prag-bg-primary prag-foot">Build With <a href=https://gohugo.io/>Hugo</a>
&nbsp; - &nbsp;
<a href=https://en.wikipedia.org/wiki/WTFPL>WTFPL license</a> © 2018–2024</div></footer></body></html>