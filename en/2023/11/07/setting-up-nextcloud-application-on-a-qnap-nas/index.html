<!doctype html><html lang=en><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta charset=utf-8><meta name=robots content="noindex, nofollow, noarchive, nosnipper, noodp, noydir"><meta name=google content="notranslate, noimageindex"><meta name=slurp content="notranslate, noimageindex"><meta name=msnbot content="notranslate, noimageindex"><meta name=bingbot content="notranslate, noimageindex"><meta name=generator content="Hugo 0.120.3"><link rel=stylesheet href=https://www.pragmatias.fr/css/bootstrap.min.css><link rel=stylesheet href=https://www.pragmatias.fr/css/pragmatias.css><script src=https://www.pragmatias.fr/js/jquery-3.6.0.slim.min.js></script><script src=https://www.pragmatias.fr/js/popper.min.js></script><script src=https://www.pragmatias.fr/js/bootstrap.bundle.min.js></script><link rel=alternate type=application/rss+xml href=https://www.pragmatias.fr/en/feed.xml><title>Setting up Nextcloud application on a QNAP NAS</title><body><div class="navbar navbar-expand-md prag-bg-primary prag-header" role=navigation><div class="container-fluid justify-content-center"><div class=navbar-brand><a href=https://www.pragmatias.fr/en/blog/><img src=/images/logo_pragmatias.svg alt=pragmatias></a></div><button class="navbar-toggler justify-content-end prag-navbar" type=button data-toggle=collapse data-target=#navbarSupportedContent1,#navbarSupportedContent2 aria-controls=navbarSupportedContent1 aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent1><ul class="navbar-nav text-center"><li class=nav-item><a class=nav-link href=https://www.pragmatias.fr/en/blog/>Blog</a></li><li class=nav-item><a class=nav-link href=https://www.pragmatias.fr/en/tags/>Tags</a></li><li class=nav-item><a class=nav-link href=https://www.pragmatias.fr/en/archives/>Archives</a></li></ul></div><div class="collapse navbar-collapse justify-content-md-end" id=navbarSupportedContent2><ul class="navbar-nav flex-row justify-content-center"><li class=nav-item><a href=https://www.pragmatias.fr/2023/11/07/mise-en-place-de-lapplication-nextcloud-sur-un-nas-qnap/ class="prag_header_svg mr-1 ml-1"><img src=/images/france-flag-round-xs-24.png alt=FranÃ§ais></a></li><li class=nav-item><a href=https://www.pragmatias.fr/en/feed.xml title="Pragmatias Blog" class="prag_header_svg mr-1 ml-1"><svg height="24" style="enable-background:new 0 0 508.52 508.52" viewBox="0 0 508.52 508.52" width="24" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path style="fill-rule:evenodd;clip-rule:evenodd;fill:" d="M254.26.0C113.845.0.0 113.845.0 254.26s113.845 254.26 254.26 254.26 254.26-113.845 254.26-254.26C508.52 113.813 394.675.0 254.26.0zM137.141 412.441c-22.852.0-41.413-18.434-41.413-41.285.0-22.693 18.561-41.349 41.413-41.349 22.915.0 41.444 18.656 41.476 41.349C178.618 393.976 160.088 412.441 137.141 412.441zM241.197 412.791c0-39.029-15.16-75.674-42.62-103.071-27.46-27.524-63.978-42.716-102.785-42.716V207.38c113.177.0 205.315 92.137 205.315 205.41h-59.91zM347.001 412.727c0-138.603-112.669-251.399-251.145-251.399v-59.624c171.435.0 310.96 139.589 310.96 311.023H347.001z"/></svg></a></li><li class=nav-item><a href=mailto:contact@pragmatias.fr title=Mail class="prag_header_svg mr-1 ml-1"><svg height="24" style="enable-background:new 0 0 299.997 299.997" viewBox="0 0 299.997 299.997" width="24" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path style="fill-rule:evenodd;clip-rule:evenodd;fill:" d="M149.996.0C67.157.0.001 67.158.001 149.997c0 82.837 67.156 150 149.995 150s150-67.163 150-150C299.996 67.158 232.835.0 149.996.0zM149.999 52.686l88.763 55.35H61.236l88.763-55.35zm89.869 143.737h-.009c0 8.878-7.195 16.072-16.072 16.072H76.211c-8.878.0-16.072-7.195-16.072-16.072v-84.865c0-.939.096-1.852.252-2.749l84.808 52.883c.104.065.215.109.322.169.112.062.226.122.34.179.599.309 1.216.558 1.847.721.065.018.13.026.195.041.692.163 1.393.265 2.093.265h.005c.005.0.01.0.01.0.7.0 1.401-.099 2.093-.265.065-.016.13-.023.195-.041.63-.163 1.245-.412 1.847-.721.114-.057.228-.117.34-.179.106-.06.218-.104.322-.169l84.808-52.883c.156.897.252 1.808.252 2.749v84.865z"/></svg></a></li><li><a href=https://github.com/pragmatias/ title=github class="prag_header_svg mr-1 ml-1"><svg height="24" style="enable-background:new 0 0 438.549 438.549" viewBox="0 0 438.549 438.549" width="24" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path style="fill-rule:evenodd;clip-rule:evenodd;fill:" d="M409.132 114.573c-19.608-33.596-46.205-60.194-79.798-79.8C295.736 15.166 259.057 5.365 219.271 5.365c-39.781.0-76.472 9.804-110.063 29.408-33.596 19.605-60.192 46.204-79.8 79.8C9.803 148.168.0 184.854.0 224.63c0 47.78 13.94 90.745 41.827 128.906 27.884 38.164 63.906 64.572 108.063 79.227 5.14.954 8.945.283 11.419-1.996 2.475-2.282 3.711-5.14 3.711-8.562.0-.571-.049-5.708-.144-15.417-.098-9.709-.144-18.179-.144-25.406l-6.567 1.136c-4.187.767-9.469 1.092-15.846 1-6.374-.089-12.991-.757-19.842-1.999-6.854-1.231-13.229-4.086-19.13-8.559-5.898-4.473-10.085-10.328-12.56-17.556l-2.855-6.57c-1.903-4.374-4.899-9.233-8.992-14.559-4.093-5.331-8.232-8.945-12.419-10.848l-1.999-1.431c-1.332-.951-2.568-2.098-3.711-3.429-1.142-1.331-1.997-2.663-2.568-3.997-.572-1.335-.098-2.43 1.427-3.289s4.281-1.276 8.28-1.276l5.708.853c3.807.763 8.516 3.042 14.133 6.851 5.614 3.806 10.229 8.754 13.846 14.842 4.38 7.806 9.657 13.754 15.846 17.847 6.184 4.093 12.419 6.136 18.699 6.136s11.704-.476 16.274-1.423c4.565-.952 8.848-2.383 12.847-4.285 1.713-12.758 6.377-22.559 13.988-29.41-10.848-1.14-20.601-2.857-29.264-5.14-8.658-2.286-17.605-5.996-26.835-11.14-9.235-5.137-16.896-11.516-22.985-19.126-6.09-7.614-11.088-17.61-14.987-29.979-3.901-12.374-5.852-26.648-5.852-42.826.0-23.035 7.52-42.637 22.557-58.817-7.044-17.318-6.379-36.732 1.997-58.24 5.52-1.715 13.706-.428 24.554 3.853 10.85 4.283 18.794 7.952 23.84 10.994 5.046 3.041 9.089 5.618 12.135 7.708 17.705-4.947 35.976-7.421 54.818-7.421s37.117 2.474 54.823 7.421l10.849-6.849c7.419-4.57 16.18-8.758 26.262-12.565 10.088-3.805 17.802-4.853 23.134-3.138 8.562 21.509 9.325 40.922 2.279 58.24 15.036 16.18 22.559 35.787 22.559 58.817.0 16.178-1.958 30.497-5.853 42.966-3.9 12.471-8.941 22.457-15.125 29.979-6.191 7.521-13.901 13.85-23.131 18.986-9.232 5.14-18.182 8.85-26.84 11.136-8.662 2.286-18.415 4.004-29.263 5.146 9.894 8.562 14.842 22.077 14.842 40.539v60.237c0 3.422 1.19 6.279 3.572 8.562 2.379 2.279 6.136 2.95 11.276 1.995 44.163-14.653 80.185-41.062 108.068-79.226 27.88-38.161 41.825-81.126 41.825-128.906C438.536 184.851 428.728 148.168 409.132 114.573z"/></svg></a></li></ul></div></div></div><div id=content><div class=container-fluid><article class="blog-post blog-post-with-toc"><header><h2 class=blog-post-title>Setting up Nextcloud application on a QNAP NAS</h2><div class=blog-post-date><span>Last update : 7 November 2023</span></div><div class=blog-post-date>Reading time : 18 minute(s) - 3693 words</div><div class=blog-post-tags><strong>Tags:</strong>
<a href=https://www.pragmatias.fr/en/tags/nextcloud/>Nextcloud</a>
<a href=https://www.pragmatias.fr/en/tags/cloud/>Cloud</a>
<a href=https://www.pragmatias.fr/en/tags/qnap/>QNAP</a>
<a href=https://www.pragmatias.fr/en/tags/docker/>Docker</a></div></header><aside class=prag-toc><h1 class=prag-toc-head>Summary</h1><div class=prag-toc-body><nav id=TableOfContents><ol><li><a href=#whats-a-nas>What&rsquo;s a NAS</a></li><li><a href=#whats-nexcloud>What&rsquo;s Nexcloud</a></li><li><a href=#objective>Objective</a><ol><li><a href=#constraints-specific-to-qnap-nas>Constraints specific to QNAP NAS</a></li><li><a href=#qnap-nas-specification>QNAP NAS specification</a></li><li><a href=#process>Process</a></li></ol></li><li><a href=#details>Details</a><ol><li><a href=#create-a-specific-user-for-docker>Create a specific user for Docker</a></li><li><a href=#create-a-shared-directory-for-docker>Create a shared directory for Docker</a></li><li><a href=#enable-ssh-access-on-qnap-nas>Enable SSH access on QNAP NAS</a></li><li><a href=#install-qnap-container-station-application>Install QNAP Container Station application</a></li><li><a href=#ssh-connection-to-qnap-nas>SSH connection to QNAP NAS</a></li><li><a href=#create-a-dockerfile>Create a Dockerfile</a><ol><li><a href=#creating-the-directories-needed-for-the-docker-image>Creating the directories needed for the Docker image</a></li><li><a href=#create-a-dockerfile-1>Create a Dockerfile</a></li></ol></li><li><a href=#creating-a-docker-compose-file>Creating a Docker Compose file</a></li><li><a href=#create-nextcloud-application-configuration-files>Create Nextcloud application configuration files</a></li><li><a href=#creation-of-an-initialization-script-for-the-nextcloud-application>Creation of an initialization script for the Nextcloud application</a></li><li><a href=#creation-of-a-configuration-file-for-all-environment-variables>Creation of a configuration file for all environment variables</a></li><li><a href=#set-up-a-startup-script-on-the-qnap-nas>Set up a startup script on the QNAP NAS</a></li></ol></li><li><a href=#run-the-nextcloud-application>Run the Nextcloud application</a></li><li><a href=#commands>Commands</a></li></ol></nav></div></aside><a id=showTopBtn href=# class=prag-sticky-bot><svg height="24" id="Layer_1" style="enable-background:new 0 0 438.533 438.533" viewBox="0 0 438.533 438.533" width="24" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path style="fill-rule:evenodd;clip-rule:evenodd;fill:" d="M409.133 109.203c-19.608-33.592-46.205-60.189-79.798-79.796C295.736 9.801 259.058.0 219.273.0c-39.781.0-76.47 9.801-110.063 29.407-33.595 19.604-60.192 46.201-79.8 79.796C9.801 142.8.0 179.489.0 219.267c0 39.78 9.804 76.463 29.407 110.062 19.607 33.592 46.204 60.189 79.799 79.798 33.597 19.605 70.283 29.407 110.063 29.407s76.47-9.802 110.065-29.407c33.593-19.602 60.189-46.206 79.795-79.798 19.603-33.596 29.403-70.284 29.403-110.062C438.533 179.485 428.732 142.795 409.133 109.203zM361.449 231.831l-25.981 25.981c-3.613 3.613-7.901 5.42-12.847 5.42-4.948.0-9.229-1.807-12.847-5.42l-53.954-53.961v143.32c0 4.948-1.813 9.232-5.428 12.847-3.613 3.62-7.898 5.427-12.847 5.427h-36.547c-4.948.0-9.231-1.807-12.847-5.427-3.617-3.614-5.426-7.898-5.426-12.847v-143.32l-53.959 53.961c-3.431 3.425-7.708 5.133-12.85 5.133-5.14.0-9.423-1.708-12.85-5.133l-25.981-25.981c-3.422-3.429-5.137-7.714-5.137-12.852.0-5.137 1.709-9.419 5.137-12.847l103.356-103.353 25.981-25.981c3.427-3.425 7.71-5.14 12.847-5.14 5.142.0 9.423 1.715 12.849 5.14l25.98 25.981 103.35 103.353c3.432 3.427 5.14 7.71 5.14 12.847C366.589 224.117 364.881 228.402 361.449 231.831z"/></svg></a><script>$(document).ready(function(){$("#showTopBtn").removeClass("prag-sticky-bot"),$("#showTopBtn").addClass("prag-sticky-hide"),$(function(){$(window).scroll(function(){$(this).scrollTop()>900?($("#showTopBtn").addClass("prag-sticky-bot"),$("#showTopBtn").removeClass("prag-sticky-hide")):($("#showTopBtn").addClass("prag-sticky-hide"),$("#showTopBtn").removeClass("prag-sticky-bot"))})})})</script><div class=blog-post-main><p>In this article, you&rsquo;ll find everything you need to set up the <a href=https://nextcloud.com>Nextcloud</a> application on a <a href=https://www.qnap.com/en/product/series/home>QNAP NAS</a> using the <a href=https://www.qnap.com/en/software/container-station>QNAP Container Station</a> application and, more specifically, <a href=https://www.docker.com/>Docker</a>.</p><p>The set up is specific to the QNAP NAS of the <a href=https://www.qnap.com/static/landing/2020/fr-ts-x31p3-ts-x31k/index.html>TS-x31P3 Series</a> which has a constraint limiting the use of Docker images in general and consequently blocking the use of the <a href=https://github.com/nextcloud/all-in-one>Nextcloud AIO</a> image.</p><h1 id=whats-a-nas>What&rsquo;s a NAS</h1><p>A <a href=https://en.wikipedia.org/wiki/Network-attached_storage>NAS (Network Attached Storage)</a> is a network storage server that stores, backs up, shares, secures and facilitates access to files (photos, videos, music, documents), as well as running applications to add more services (vpn, sftp, web server, etc.).</p><h1 id=whats-nexcloud>What&rsquo;s Nexcloud</h1><p><a href=https://en.wikipedia.org/wiki/Nextcloud>Nextcloud</a> is a open source software offering a platform for file storage and sharing services as well as online applications.</p><h1 id=objective>Objective</h1><p>The objective of this approach is to be able to have a private cloud (based on Nextcloud application) allowing the whole family to store, share and manage their data while using an existing QNAP NAS.</p><p>The Nextcloud application must be accessible locally using the following HTTPS address: <code>https://110.110.110.151</code></p><p><em>Note: To have access to the Nextcloud application from Internet, you&rsquo;ll need to add a NAT rule on your router or Internet box to redirect traffic from ports 80 and 443 to the address <code>110.110.110.151</code></em></p><h2 id=constraints-specific-to-qnap-nas>Constraints specific to QNAP NAS</h2><p>The specific QNAP NAS constraint of the <a href=https://www.qnap.com/static/landing/2020/fr-ts-x31p3-ts-x31k/index.html>TS-x31P3 Series</a> is as follows:</p><ul><li>This NAS has an ARM v7 processor but the QNAP Container Station application has been modified to implement a page size of 32k instead of the <a href=https://wiki.osdev.org/ARM_Paging>default</a>.<ul><li>The majority of existing Docker images don&rsquo;t work, including <a href=https://github.com/nextcloud/all-in-one>Nextcloud AIO</a> (which is Nextcloud&rsquo;s recommended Docker image).</li><li>The error message displayed is :</li></ul></li></ul><blockquote><p>/bin/sh: error while loading shared libraries: libc.so.6: ELF load command address/offset not page-aligned</p></blockquote><h2 id=qnap-nas-specification>QNAP NAS specification</h2><ul><li>OS : QTS 5.X</li><li>CPU : Quad-Core ARM Cortex-A15</li><li>Memory : 4GB</li><li>IP Static : 110.110.110.110</li></ul><h2 id=process>Process</h2><p>We&rsquo;ll be using the following components:</p><ul><li>QNAP Container Station application (Docker and Docker Compose)</li><li>Nextcloud v27 application (archive)</li><li>A static IP for Nextcloud access (110.110.110.151)</li></ul><p>The steps are as follows:</p><ol><li>Create a specific user for Docker</li><li>Create a shared directory for Docker</li><li>Enable SSH access on QNAP NAS</li><li>Install QNAP Container Station application</li><li>SSH connection to QNAP NAS</li><li>Create a Dockerfile</li><li>Creating a Docker Compose file</li><li>Create Nextcloud application configuration files</li><li>Creation of an initialization script for the Nextcloud application</li><li>Creation of a configuration file for all environment variables</li><li>Set up a startup script on the QNAP NAS</li></ol><h1 id=details>Details</h1><h2 id=create-a-specific-user-for-docker>Create a specific user for Docker</h2><p>Create a specific user for Docker to limit rights on all QNAP NAS components and services:</p><ol><li>Go to <code>Main Menu > ControlPanel > Privilege > Users</code>.</li><li>Click on the <code>Create</code> button, then on the <code>Create a User</code> option.</li><li>Fill in the form and choose the name (username) <strong>dockeruser</strong>.</li><li>Click on the <code>Create</code> button</li></ol><p><em>Note: Save the PUID (e.g. 501) and PGID (e.g. 100), as these will be required for the rights of the Docker container containing the Nextcloud application.</em></p><p><a href=/blog/web/20231107_Blog_use_nextcloud_on_qnap_01.png><img src=/blog/web/20231107_Blog_use_nextcloud_on_qnap_01.png alt=20231107_Blog_use_nextcloud_on_qnap_01></a></p><h2 id=create-a-shared-directory-for-docker>Create a shared directory for Docker</h2><p>To create a specific shared directory for the data and configuration files of the Docker container containing the Nextcloud application, follow these steps:</p><ol><li>Go to <code>Main Menu > ControlPanel > Privilege > Shared Folders</code>.</li><li>Click on the <code>Create</code> button, then on the <code>Create A Shared Folder</code> option.</li><li>Fill in the details and click on the <code>Next</code> button.<ol><li>Folder Name : Folder name</li><li>Comment : Comment for the directory</li><li>Disk Volume : Disk on which the folder will be created.</li><li>Path: Directory path</li></ol></li><li>In the <strong>Configure access privileges for users</strong> window, select the <code>RW</code> (read & write) option for your administration user and for the <strong>dockeruser</strong> user, and click on the <code>Next</code> button.</li><li>In the <strong>Properties</strong> window, select the desired options and click on the <code>Finish</code> button.</li></ol><p><a href=/blog/web/20231107_Blog_use_nextcloud_on_qnap_02.png><img src=/blog/web/20231107_Blog_use_nextcloud_on_qnap_02.png alt=20231107_Blog_use_nextcloud_on_qnap_02></a></p><h2 id=enable-ssh-access-on-qnap-nas>Enable SSH access on QNAP NAS</h2><p>To be able to connect to the QNAP NAS via SSH, you must first activate the service by following the steps below:</p><ol><li>Go to <code>Main Menu > ControlPanel > Network & File Services > Telnet / SSH</code>.</li><li>Check the <code>Allow SSH connection</code> option and enter the desired port number.</li><li>Click on the <code>Apply</code> button</li></ol><p><em>Note: In our case, we&rsquo;ll use port 23422 for SSH access.</em></p><p><a href=/blog/web/20231107_Blog_use_nextcloud_on_qnap_03.png><img src=/blog/web/20231107_Blog_use_nextcloud_on_qnap_03.png alt=20231107_Blog_use_nextcloud_on_qnap_03></a></p><h2 id=install-qnap-container-station-application>Install QNAP Container Station application</h2><p>To use Docker on the QNAP NAS, you need to install the QNAP Container Station application, following these steps:</p><ol><li>Go to <code>Main Menu > App Center > QNAP Store > All Apps</code>.</li><li>Find the <strong>Container Station (Utilities)</strong> application and click on the <code>+ Install</code> option.</li></ol><p><em>Note: A shortcut named <strong>Container Station</strong> should be present on the home page of your QNAP NAS.</em></p><p><a href=/blog/web/20231107_Blog_use_nextcloud_on_qnap_04.png><img src=/blog/web/20231107_Blog_use_nextcloud_on_qnap_04.png alt=20231107_Blog_use_nextcloud_on_qnap_04></a></p><h2 id=ssh-connection-to-qnap-nas>SSH connection to QNAP NAS</h2><p>To connect to the QNAP NAS via SSH, simply use the following command: <code>ssh &lt;useradmin>@&lt;ip NAS QNAP> -p &lt;port></code>
In our case, the command would be: <code>ssh admin@110.110.110.110 -p 23422</code></p><p>Let&rsquo;s take this opportunity to create the first directories needed for Docker and the Docker container containing the Nextcloud application</p><ol><li>Go to the Docker shared directory: <code>cd /share/Docker</code>.</li><li>Create the <strong>nextcloud</strong> directory, which will store all data associated with the Nextcloud application: <code>mkdir /share/Docker/nextcloud</code>.</li><li>Create the <strong>scripts</strong> directory, which will store all the scripts and configuration files needed to build the Docker image and container containing the Nextcloud application: <code>mkdir /share/Docker/scripts</code>.</li></ol><h2 id=create-a-dockerfile>Create a Dockerfile</h2><p>To set up the Nextcloud application on the QNAP NAS, we&rsquo;re going to create the required elements.</p><h3 id=creating-the-directories-needed-for-the-docker-image>Creating the directories needed for the Docker image</h3><p>We&rsquo;re going to create an <strong>nextcloud_app</strong> directory in which we&rsquo;ll put all the elements needed to build the Docker image containing the Nextcloud application :</p><ol><li>Create an <strong>nextcloud_app</strong> directory: <code>mkdir /share/Docker/scripts/nextcloud_app</code>.</li><li>Create a <strong>config</strong> subdirectory to store all the configuration files required for the Nextcloud application: <code>mkdir /share/Docker/scripts/nextcloud_app/config</code>.</li></ol><h3 id=create-a-dockerfile-1>Create a Dockerfile</h3><p>Create a file named <strong>Dockerfile</strong> in the directory <code>/share/Docker/scripts/nextcloud_app</code>.</p><p>The contents of the file <strong>Dockerfile</strong> :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4># Based on ubuntu image</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#ff79c6>FROM</span><span style=color:#f1fa8c> ubuntu:22.04</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#6272a4># Default value</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#ff79c6>ARG</span> <span style=color:#8be9fd;font-style:italic>build_TZ</span><span style=color:#ff79c6>=</span>Europe/Paris
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#ff79c6>ARG</span> <span style=color:#8be9fd;font-style:italic>build_PUID</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>501</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#ff79c6>ARG</span> <span style=color:#8be9fd;font-style:italic>build_PGID</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>100</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#6272a4># Config environment</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#ff79c6>ENV</span> <span style=color:#8be9fd;font-style:italic>TZ</span><span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>$build_TZ</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#ff79c6>ENV</span> DEBIAN_FRONTEND noninteractive
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#ff79c6>ENV</span> <span style=color:#8be9fd;font-style:italic>PUID</span><span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>$build_PUID</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#ff79c6>ENV</span> <span style=color:#8be9fd;font-style:italic>PGID</span><span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>$build_PGID</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#6272a4># Work directory</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#ff79c6>WORKDIR</span><span style=color:#f1fa8c> /</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#6272a4># Update Ubuntu system</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#ff79c6>RUN</span> apt-get update -y <span style=color:#ff79c6>&amp;&amp;</span> apt-get upgrade -y
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#6272a4># Install tools (apache2, mariadb and php)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#ff79c6>RUN</span> apt-get install sudo vim wget cron curl ffmpeg apache2 mariadb-server libapache2-mod-php <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#f1fa8c></span>php-gd php-mysql php-curl php-mbstring php-intl php-gmp php-bcmath php-xml php-imagick php-zip <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span><span style=color:#f1fa8c></span>php-bz2 php-ldap php-smbclient php-imap php-apcu -y
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span><span style=color:#6272a4># Clean APT cache</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span><span style=color:#ff79c6>RUN</span> apt-get clean
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span><span style=color:#ff79c6>RUN</span> rm -rf /var/lib/apt/lists/*
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span><span style=color:#6272a4># Install Nextcloud in the folder /var/www</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span><span style=color:#ff79c6>RUN</span> wget https://download.nextcloud.com/server/releases/latest-27.tar.bz2 -O /tmp/nextcloud-27.tar.bz2
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span><span style=color:#ff79c6>RUN</span> tar -xjvf /tmp/nextcloud-27.tar.bz2 -C /tmp
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span><span style=color:#ff79c6>RUN</span> cp -r /tmp/nextcloud /var/www
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span><span style=color:#ff79c6>RUN</span> chown -R www-data:www-data /var/www/nextcloud
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span><span style=color:#6272a4># Copy the template nextcloud config files for run_nextcloud.sh later use</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span><span style=color:#ff79c6>RUN</span> cp -r /tmp/nextcloud/config /tmp/nextcloud_config
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span><span style=color:#6272a4># Clean nextcloud temporary folder</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span><span style=color:#ff79c6>RUN</span> rm -rf /tmp/nextcloud
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span><span style=color:#ff79c6>RUN</span> rm /tmp/nextcloud-27.*
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span><span style=color:#6272a4># Manage SSL certificate</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span><span style=color:#ff79c6>RUN</span> openssl req -x509 -nodes -days <span style=color:#bd93f9>365</span> -newkey rsa:2048 -keyout /etc/ssl/private/apache-selfsigned.key -out /etc/ssl/certs/apache-selfsigned.crt <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span><span style=color:#f1fa8c></span>-subj /C<span style=color:#ff79c6>=</span>FR/ST<span style=color:#ff79c6>=</span>France/L<span style=color:#ff79c6>=</span>Paris/O<span style=color:#ff79c6>=</span>NAS/OU<span style=color:#ff79c6>=</span>Nextcloud/CN<span style=color:#ff79c6>=</span>nas@nas.nas
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span><span style=color:#6272a4># Create specific folder</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span><span style=color:#ff79c6>RUN</span> mkdir /scripts
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span><span style=color:#6272a4># Copy config files</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span><span style=color:#ff79c6>COPY</span> ./config /config
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span><span style=color:#6272a4># Prepare execution of the run_nextcloud.sh script</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span><span style=color:#ff79c6>RUN</span> chmod +x /config/run_nextcloud.sh
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span><span><span style=color:#6272a4># Configuration Crontab</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span><span><span style=color:#ff79c6>RUN</span> <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#8be9fd;font-style:italic>exit</span> <span style=color:#bd93f9>0</span> &gt; /usr/sbin/policy-rc.d
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57</span><span><span style=color:#ff79c6>RUN</span> <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;*/5  *  *  *  * php -f /var/www/nextcloud/cron.php&#34;</span> | crontab -u www-data -
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59</span><span><span style=color:#6272a4># Expose ports for Nextcloud application</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60</span><span><span style=color:#ff79c6>EXPOSE</span><span style=color:#f1fa8c> 80</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61</span><span><span style=color:#ff79c6>EXPOSE</span><span style=color:#f1fa8c> 443</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62</span><span><span style=color:#ff79c6>EXPOSE</span><span style=color:#f1fa8c> 3478</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64</span><span><span style=color:#6272a4># Define Entrypoint to execute the run_nextcloud.sh script</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65</span><span><span style=color:#ff79c6>ENTRYPOINT</span> [<span style=color:#f1fa8c>&#34;bash&#34;</span>,<span style=color:#f1fa8c>&#34;/config/run_nextcloud.sh&#34;</span>,<span style=color:#f1fa8c>&#34;&gt;&#34;</span>,<span style=color:#f1fa8c>&#34;/var/log/nextcloud/run_nextcloud.log&#34;</span>]
</span></span></code></pre></div><h2 id=creating-a-docker-compose-file>Creating a Docker Compose file</h2><p>To make it easier to use Docker to build the Nextcloud application, we&rsquo;re going to use Docker Compose to create a file named <strong>docker-compose.yml</strong> in the <code>/share/Docker/scripts/nextcloud_app</code> directory.</p><p>This file will enable us to define the <strong>build</strong> of the Docker image and the Docker <strong>network</strong> to be used by the Docker container containing the Nextcloud application.</p><p>The contents of the file <strong>docker-compose.yml</strong> :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>version</span>: <span style=color:#f1fa8c>&#34;3.7&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#ff79c6>services</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>  <span style=color:#6272a4># Nextcloud application</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>  <span style=color:#ff79c6>nextcloud</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#ff79c6>image</span>: nextcloud-qnas-img:v27
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#6272a4># Build configuration</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#ff79c6>build</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>      <span style=color:#ff79c6>context</span>: .
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>      <span style=color:#ff79c6>dockerfile</span>: Dockerfile
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>      <span style=color:#6272a4># Default argument for the build</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>      <span style=color:#ff79c6>args</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>        <span style=color:#ff79c6>build_PUID </span>: <span style=color:#bd93f9>501</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>        <span style=color:#ff79c6>build_PGID </span>: <span style=color:#bd93f9>100</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>        <span style=color:#ff79c6>build_TZ </span>: Europe/Paris
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    <span style=color:#6272a4># Name of the application for QNAP Container Station</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    <span style=color:#ff79c6>container_name</span>: nextcloud-qnas
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    <span style=color:#6272a4># Define the Static IP from QNET Network</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    <span style=color:#ff79c6>networks</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>      <span style=color:#ff79c6>qnet-static-eth0</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>        <span style=color:#ff79c6>ipv4_address</span>: <span style=color:#bd93f9>110.110.110.151</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>    <span style=color:#6272a4># Define the Env file to initialise environment variable for the container</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>    <span style=color:#ff79c6>env_file</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>      - ./config/.env
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>    <span style=color:#6272a4># Define all the volume to store the data and logs into the shared folder (and not into the container)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>    <span style=color:#ff79c6>volumes</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>      - /share/Docker/nextcloud/nc_data:/var/www/nextcloud/data
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>      - /share/Docker/nextcloud/nc_apps:/var/www/nextcloud/apps
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>      - /share/Docker/nextcloud/db_data:/var/lib/mysql
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>      - /share/Docker/nextcloud/nc_log:/var/log/nextcloud
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>      - /share/Docker/nextcloud/db_log:/var/log/mysql
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>    <span style=color:#6272a4># Define the exposed port</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>    <span style=color:#ff79c6>ports</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>      - <span style=color:#bd93f9>80</span>:<span style=color:#bd93f9>80</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>      - <span style=color:#bd93f9>443</span>:<span style=color:#bd93f9>443</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>      - <span style=color:#bd93f9>3478</span>:<span style=color:#bd93f9>3478</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>    <span style=color:#6272a4># Don&#39;t restart the container only if we manually stop it</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>    <span style=color:#ff79c6>restart</span>: unless-stopped
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span><span style=color:#6272a4># Define the network based en NAS QNAP interfaces</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span><span style=color:#ff79c6>networks</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>  <span style=color:#ff79c6>qnet-static-eth0 </span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>    <span style=color:#ff79c6>driver</span>: qnet
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>    <span style=color:#ff79c6>driver_opts</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>      <span style=color:#ff79c6>iface</span>: <span style=color:#f1fa8c>&#34;eth0&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>    <span style=color:#ff79c6>ipam</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span>      <span style=color:#ff79c6>driver</span>: qnet
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span>      <span style=color:#ff79c6>options</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span>        <span style=color:#ff79c6>iface</span>: <span style=color:#f1fa8c>&#34;eth0&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span>      <span style=color:#ff79c6>config</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span>        - <span style=color:#ff79c6>subnet</span>: <span style=color:#bd93f9>110.110.110.0</span>/24
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span>          <span style=color:#ff79c6>gateway</span>: <span style=color:#bd93f9>110.110.110.1</span>
</span></span></code></pre></div><p>Note on <strong>volumes</strong>:</p><ul><li>The <code>/share/Docker/nextcloud/nc_data</code> directory will contain all Nextcloud application user data.</li><li>The <code>/share/Docker/nextcloud/nc_apps</code> directory will contain all the Nextcloud application&rsquo;s internal applications.</li><li>The <code>/share/Docker/nextcloud/db_data</code> directory will contain all the MariaDB database data used by the Nextcloud application.</li><li>The <code>/share/Docker/nextcloud/nc_log</code> directory will contain all Nextcloud application logs.</li><li>The <code>/share/Docker/nextcloud/db_log</code> directory will contain all logs from the MariaDB database used by the Nextcloud application.</li></ul><p><em>Note: The objective is to keep the data from the mariaDB database and the Nextcloud application in the shared directory, to make backups easier and to be able to dissociate the data from the container.</em></p><h2 id=create-nextcloud-application-configuration-files>Create Nextcloud application configuration files</h2><p>In order to configure the services required by the Nextcloud application when running the Docker container, we&rsquo;ll prepare the following configuration files:</p><p>1. For the <strong>Apache2</strong> service :</p><ol><li>Create the configuration directory <code>mkdir /share/Docker/scripts/nextcloud_app/config/apache2</code></li><li>Create the configuration file <strong>nextcloud.conf</strong> in the created directory</li></ol><p>The contents of the file <strong>nextcloud.conf</strong> :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-apacheconf data-lang=apacheconf><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>&lt;VirtualHost</span> <span style=color:#f1fa8c>*:80</span><span style=color:#ff79c6>&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#8be9fd;font-style:italic>ServerName</span> ${NC_HOSTNAME}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#8be9fd;font-style:italic>Redirect</span> permanent / https://${NC_HOSTNAME}/
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#ff79c6>&lt;/VirtualHost&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#ff79c6>&lt;VirtualHost</span> <span style=color:#f1fa8c>*:443</span><span style=color:#ff79c6>&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>     <span style=color:#8be9fd;font-style:italic>ServerName</span> ${NC_HOSTNAME}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>     <span style=color:#8be9fd;font-style:italic>DocumentRoot</span> ${ROOT_NC}/
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>     <span style=color:#8be9fd;font-style:italic>Alias</span> / <span style=color:#f1fa8c>&#34;${ROOT_NC}/&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>     <span style=color:#8be9fd;font-style:italic>SSLEngine</span> <span style=color:#ff79c6>on</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>     <span style=color:#8be9fd;font-style:italic>SSLCertificateFile</span> <span style=color:#f1fa8c>/etc/ssl/certs/apache-selfsigned.crt</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>     <span style=color:#8be9fd;font-style:italic>SSLCertificateKeyFile</span> <span style=color:#f1fa8c>/etc/ssl/private/apache-selfsigned.key</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>     <span style=color:#ff79c6>&lt;Directory</span> <span style=color:#f1fa8c>${ROOT_NC}/</span><span style=color:#ff79c6>&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>       <span style=color:#8be9fd;font-style:italic>Options</span> +FollowSymlinks
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>        <span style=color:#8be9fd;font-style:italic>AllowOverride</span> <span style=color:#ff79c6>All</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>        <span style=color:#8be9fd;font-style:italic>Require</span> <span style=color:#ff79c6>all</span> granted
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>          <span style=color:#ff79c6>&lt;IfModule</span> <span style=color:#f1fa8c>mod_dav.c</span><span style=color:#ff79c6>&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>            <span style=color:#8be9fd;font-style:italic>Dav</span> <span style=color:#ff79c6>off</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>          <span style=color:#ff79c6>&lt;/IfModule&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>        <span style=color:#8be9fd;font-style:italic>SetEnv</span> HOME ${ROOT_NC}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>        <span style=color:#8be9fd;font-style:italic>SetEnv</span> HTTP_HOME ${ROOT_NC}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>        <span style=color:#8be9fd;font-style:italic>SetEnv</span> HTTPS_HOME ${ROOT_NC}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>     <span style=color:#ff79c6>&lt;/Directory&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>     <span style=color:#8be9fd;font-style:italic>ErrorLog</span> ${APACHE_LOG_DIR}/error.log
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>     <span style=color:#8be9fd;font-style:italic>CustomLog</span> ${APACHE_LOG_DIR}/access.log combined
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span><span style=color:#ff79c6>&lt;/VirtualHost&gt;</span>
</span></span></code></pre></div><p>2. For the <strong>MariaDB</strong> service</p><ol><li>Create the configuration directory <code>mkdir /share/Docker/scripts/nextcloud_app/config/mariadb</code>.</li><li>Create the <strong>50-server.conf</strong> configuration file in the directory you&rsquo;ve created, using the desired template and modifying the line starting with <code>datadir</code> with the following line <code>datadir = ${ROOT_DB_DATA}</code>.</li></ol><p>3. For the <strong>Nextcloud</strong> application</p><ol><li>Create the <code>mkdir /share/Docker/scripts/nextcloud_app/config/nextcloud</code> configuration directory.</li><li>Create configuration files named <strong>autoconfig.php</strong> and <strong>docker.config.php</strong> in the created directory to automatically configure the Nextcloud application on the first run.</li></ol><p>The contents of the file <strong>autoconfig.php</strong> :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>&lt;?</span>php
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#8be9fd;font-style:italic>$AUTOCONFIG</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>array</span>(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>  <span style=color:#f1fa8c>&#34;dbtype&#34;</span>        <span style=color:#ff79c6>=&gt;</span> <span style=color:#f1fa8c>&#34;mysql&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>  <span style=color:#f1fa8c>&#34;dbname&#34;</span>        <span style=color:#ff79c6>=&gt;</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>MYSQL_DATABASE</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>  <span style=color:#f1fa8c>&#34;dbuser&#34;</span>        <span style=color:#ff79c6>=&gt;</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>MYSQL_USER</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>  <span style=color:#f1fa8c>&#34;dbpass&#34;</span>        <span style=color:#ff79c6>=&gt;</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>MYSQL_PASSWORD</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>  <span style=color:#f1fa8c>&#34;dbhost&#34;</span>        <span style=color:#ff79c6>=&gt;</span> <span style=color:#f1fa8c>&#34;localhost&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>  <span style=color:#f1fa8c>&#34;dbtableprefix&#34;</span> <span style=color:#ff79c6>=&gt;</span> <span style=color:#f1fa8c>&#34;oc_&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>  <span style=color:#f1fa8c>&#34;adminlogin&#34;</span>    <span style=color:#ff79c6>=&gt;</span> <span style=color:#f1fa8c>&#34;admin&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>  <span style=color:#f1fa8c>&#34;adminpass&#34;</span>     <span style=color:#ff79c6>=&gt;</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>NC_ADMIN_PASSWORD</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>  <span style=color:#f1fa8c>&#34;directory&#34;</span>     <span style=color:#ff79c6>=&gt;</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>ROOT_NC_DATA</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>  <span style=color:#f1fa8c>&#34;trusted_domains&#34;</span> <span style=color:#ff79c6>=&gt;</span> 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>  <span style=color:#ff79c6>array</span> (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    <span style=color:#bd93f9>0</span> <span style=color:#ff79c6>=&gt;</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>STATIC_IP</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    <span style=color:#bd93f9>1</span> <span style=color:#ff79c6>=&gt;</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>NC_HOSTNAME</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>  ),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>);
</span></span></code></pre></div><p>The contents of the file <strong>docker.config.php</strong> :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>&lt;?</span>php
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#8be9fd;font-style:italic>$CONFIG</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>array</span> (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>  <span style=color:#f1fa8c>&#39;overwriteprotocol&#39;</span> <span style=color:#ff79c6>=&gt;</span> <span style=color:#f1fa8c>&#39;https&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>  <span style=color:#f1fa8c>&#39;overwritewebroot&#39;</span> <span style=color:#ff79c6>=&gt;</span> <span style=color:#f1fa8c>&#39;/&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>  <span style=color:#f1fa8c>&#39;overwrite.cli.url&#39;</span> <span style=color:#ff79c6>=&gt;</span> <span style=color:#f1fa8c>&#39;https://${NC_HOSTNAME}&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>  <span style=color:#f1fa8c>&#39;htaccess.RewriteBase&#39;</span> <span style=color:#ff79c6>=&gt;</span> <span style=color:#f1fa8c>&#39;/&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>  <span style=color:#f1fa8c>&#39;mysql.utf8mb4&#39;</span> <span style=color:#ff79c6>=&gt;</span> <span style=color:#ff79c6>true</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>  <span style=color:#f1fa8c>&#39;default_language&#39;</span> <span style=color:#ff79c6>=&gt;</span> <span style=color:#f1fa8c>&#39;fr&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>  <span style=color:#f1fa8c>&#39;force_language&#39;</span> <span style=color:#ff79c6>=&gt;</span> <span style=color:#f1fa8c>&#39;fr&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>  <span style=color:#f1fa8c>&#39;default_locale&#39;</span> <span style=color:#ff79c6>=&gt;</span> <span style=color:#f1fa8c>&#39;fr_FR&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>  <span style=color:#f1fa8c>&#39;default_phone_region&#39;</span> <span style=color:#ff79c6>=&gt;</span> <span style=color:#f1fa8c>&#39;FR&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>  <span style=color:#f1fa8c>&#39;force_locale&#39;</span> <span style=color:#ff79c6>=&gt;</span> <span style=color:#f1fa8c>&#39;fr_FR&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>  <span style=color:#f1fa8c>&#39;knowledgebaseenabled&#39;</span> <span style=color:#ff79c6>=&gt;</span> <span style=color:#ff79c6>true</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>  <span style=color:#f1fa8c>&#39;allow_user_to_change_display_name&#39;</span> <span style=color:#ff79c6>=&gt;</span> <span style=color:#ff79c6>true</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>  <span style=color:#f1fa8c>&#39;auth.bruteforce.protection.enabled&#39;</span> <span style=color:#ff79c6>=&gt;</span> <span style=color:#ff79c6>true</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>  <span style=color:#f1fa8c>&#39;auth.bruteforce.protection.testing&#39;</span> <span style=color:#ff79c6>=&gt;</span> <span style=color:#ff79c6>false</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>  <span style=color:#f1fa8c>&#39;ratelimit.protection.enabled&#39;</span> <span style=color:#ff79c6>=&gt;</span> <span style=color:#ff79c6>true</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>  <span style=color:#f1fa8c>&#39;auth.webauthn.enabled&#39;</span> <span style=color:#ff79c6>=&gt;</span> <span style=color:#ff79c6>true</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>  <span style=color:#f1fa8c>&#39;auth.storeCryptedPassword&#39;</span> <span style=color:#ff79c6>=&gt;</span> <span style=color:#ff79c6>true</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>  <span style=color:#f1fa8c>&#39;lost_password_link&#39;</span> <span style=color:#ff79c6>=&gt;</span> <span style=color:#f1fa8c>&#39;disabled&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>  <span style=color:#f1fa8c>&#39;mail_domain&#39;</span> <span style=color:#ff79c6>=&gt;</span> <span style=color:#f1fa8c>&#39;${MAIL_DOMAINE}&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>  <span style=color:#f1fa8c>&#39;updatechecker&#39;</span> <span style=color:#ff79c6>=&gt;</span> <span style=color:#ff79c6>true</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>  <span style=color:#f1fa8c>&#39;updater.server.url&#39;</span> <span style=color:#ff79c6>=&gt;</span> <span style=color:#f1fa8c>&#39;https://updates.nextcloud.com/updater_server/&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>  <span style=color:#f1fa8c>&#39;updater.release.channel&#39;</span> <span style=color:#ff79c6>=&gt;</span> <span style=color:#f1fa8c>&#39;stable&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>  <span style=color:#f1fa8c>&#39;has_internet_connection&#39;</span> <span style=color:#ff79c6>=&gt;</span> <span style=color:#ff79c6>true</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>  <span style=color:#f1fa8c>&#39;connectivity_check_domains&#39;</span> <span style=color:#ff79c6>=&gt;</span> [
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>    <span style=color:#f1fa8c>&#39;www.nextcloud.com&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>    <span style=color:#f1fa8c>&#39;www.startpage.com&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>    <span style=color:#f1fa8c>&#39;www.eff.org&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>    <span style=color:#f1fa8c>&#39;www.edri.org&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>  ],
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>  <span style=color:#f1fa8c>&#39;log_type&#39;</span> <span style=color:#ff79c6>=&gt;</span> <span style=color:#f1fa8c>&#39;file&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>  <span style=color:#f1fa8c>&#39;log_type_audit&#39;</span> <span style=color:#ff79c6>=&gt;</span> <span style=color:#f1fa8c>&#39;file&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>  <span style=color:#f1fa8c>&#39;logfile&#39;</span> <span style=color:#ff79c6>=&gt;</span> <span style=color:#f1fa8c>&#39;${ROOT_NC_LOG}/nextcloud.log&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>  <span style=color:#f1fa8c>&#39;logfile_audit&#39;</span> <span style=color:#ff79c6>=&gt;</span> <span style=color:#f1fa8c>&#39;${ROOT_NC_LOG}/audit.log&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>  <span style=color:#f1fa8c>&#39;logfilemode&#39;</span> <span style=color:#ff79c6>=&gt;</span> <span style=color:#bd93f9>0640</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>  <span style=color:#f1fa8c>&#39;loglevel&#39;</span> <span style=color:#ff79c6>=&gt;</span> <span style=color:#bd93f9>2</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>  <span style=color:#f1fa8c>&#39;loglevel_frontend&#39;</span> <span style=color:#ff79c6>=&gt;</span> <span style=color:#bd93f9>2</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>  <span style=color:#f1fa8c>&#39;syslog_tag&#39;</span> <span style=color:#ff79c6>=&gt;</span> <span style=color:#f1fa8c>&#39;Nextcloud&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>  <span style=color:#f1fa8c>&#39;syslog_tag_audit&#39;</span> <span style=color:#ff79c6>=&gt;</span> <span style=color:#f1fa8c>&#39;Nextcloud&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>  <span style=color:#f1fa8c>&#39;logdateformat&#39;</span> <span style=color:#ff79c6>=&gt;</span> <span style=color:#f1fa8c>&#39;F d, Y H:i:s&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>  <span style=color:#f1fa8c>&#39;logtimezone&#39;</span> <span style=color:#ff79c6>=&gt;</span> <span style=color:#f1fa8c>&#39;${TZ}&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>  <span style=color:#f1fa8c>&#39;customclient_desktop&#39;</span> <span style=color:#ff79c6>=&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>	<span style=color:#f1fa8c>&#39;https://nextcloud.com/install/#install-clients&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span><span style=color:#f1fa8c>&#39;customclient_android&#39;</span> <span style=color:#ff79c6>=&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>	<span style=color:#f1fa8c>&#39;https://play.google.com/store/apps/details?id=com.nextcloud.client&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span><span style=color:#f1fa8c>&#39;customclient_ios&#39;</span> <span style=color:#ff79c6>=&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span>	<span style=color:#f1fa8c>&#39;https://itunes.apple.com/us/app/nextcloud/id1125420102?mt=8&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span><span style=color:#f1fa8c>&#39;customclient_ios_appid&#39;</span> <span style=color:#ff79c6>=&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span>		<span style=color:#f1fa8c>&#39;1125420102&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span>  <span style=color:#f1fa8c>&#39;defaultapp&#39;</span> <span style=color:#ff79c6>=&gt;</span> <span style=color:#f1fa8c>&#39;dashboard,files&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span>  <span style=color:#f1fa8c>&#39;appstoreenabled&#39;</span> <span style=color:#ff79c6>=&gt;</span> <span style=color:#ff79c6>true</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span>  <span style=color:#f1fa8c>&#39;apps_paths&#39;</span> <span style=color:#ff79c6>=&gt;</span> [
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span>    [
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span><span>      <span style=color:#f1fa8c>&#39;path&#39;</span><span style=color:#ff79c6>=&gt;</span> OC<span style=color:#ff79c6>::</span><span style=color:#8be9fd;font-style:italic>$SERVERROOT</span> <span style=color:#ff79c6>.</span> <span style=color:#f1fa8c>&#39;/apps&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span><span>      <span style=color:#f1fa8c>&#39;url&#39;</span> <span style=color:#ff79c6>=&gt;</span> <span style=color:#f1fa8c>&#39;/apps&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57</span><span>      <span style=color:#f1fa8c>&#39;writable&#39;</span> <span style=color:#ff79c6>=&gt;</span> <span style=color:#ff79c6>true</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58</span><span>    ],
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59</span><span>  ],
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60</span><span>  <span style=color:#f1fa8c>&#39;enable_previews&#39;</span> <span style=color:#ff79c6>=&gt;</span> <span style=color:#ff79c6>false</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61</span><span>  <span style=color:#f1fa8c>&#39;memcache.local&#39;</span> <span style=color:#ff79c6>=&gt;</span> <span style=color:#f1fa8c>&#39;\OC\Memcache\APCu&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62</span><span>);
</span></span></code></pre></div><p>4. For the <strong>PHP</strong> service</p><ol><li>Create the configuration directory <code>mkdir /share/Docker/scripts/nextcloud_app/config/php</code>.</li><li>Create a configuration file named <strong>20-pdo_mysql.ini</strong> in the created directory.</li></ol><p>The contents of the file <strong>20-pdo_mysql.ini</strong>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>; configuration for php mysql module</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4>; priority=20</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#50fa7b>extension</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>pdo_mysql.so</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#ff79c6>[mysql]</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#50fa7b>mysql.allow_local_infile</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>On</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#50fa7b>mysql.allow_persistent</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>On</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#50fa7b>mysql.cache_size</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>2000</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#50fa7b>mysql.max_persistent</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>-1</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#50fa7b>mysql.max_links</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>-1</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#50fa7b>mysql.default_port</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>3306</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#50fa7b>mysql.default_socket</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>/var/lib/mysql/mysql.sock</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#50fa7b>mysql.default_host</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>localhost</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#50fa7b>mysql.connect_timeout</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>60</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#50fa7b>mysql.trace_mode</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>Off</span>
</span></span></code></pre></div><h2 id=creation-of-an-initialization-script-for-the-nextcloud-application>Creation of an initialization script for the Nextcloud application</h2><p>In order to initialize the Nextcloud application when the container is executed, we&rsquo;ll set up the <strong>run_nextcloud.sh</strong> script in the <code>/share/Docker/scripts/nextcloud_app/config</code> directory.</p><p>The contents of the file <strong>run_nextcloud.sh</strong> :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1</span><span><span style=color:#ff79c6>#!/bin/sh
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2</span><span><span style=color:#ff79c6></span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3</span><span><span style=color:#6272a4># ENV</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4</span><span><span style=color:#8be9fd;font-style:italic>ROOT_CONF</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;/config&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6</span><span><span style=color:#6272a4># Check one environment variable (if .env is ok)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7</span><span><span style=color:#ff79c6>if</span> <span style=color:#ff79c6>[</span> -z <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>ROOT_DB_DATA</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span> <span style=color:#ff79c6>]</span>; <span style=color:#ff79c6>then</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8</span><span>    <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>$(</span>date +<span style=color:#f1fa8c>&#34;%Y-%m-%d %H:%M:%S&#34;</span><span style=color:#ff79c6>)</span><span style=color:#f1fa8c> - Error - Environment variable issues&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9</span><span>    <span style=color:#8be9fd;font-style:italic>exit</span> <span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10</span><span><span style=color:#ff79c6>fi</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13</span><span><span style=color:#6272a4># Check data folder to do the initialisation only if one or more folders are emppty</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14</span><span><span style=color:#8be9fd;font-style:italic>CHECK_FOLDER_MARIADB</span><span style=color:#ff79c6>=</span><span style=color:#ff79c6>$(</span>ls <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>ROOT_DB_DATA</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span> | wc -l<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15</span><span><span style=color:#8be9fd;font-style:italic>CHECK_FOLDER_NC</span><span style=color:#ff79c6>=</span><span style=color:#ff79c6>$(</span>ls <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>ROOT_NC_DATA</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span> | wc -l<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16</span><span><span style=color:#8be9fd;font-style:italic>CHECK_FOLDER_NC_CONF</span><span style=color:#ff79c6>=</span><span style=color:#ff79c6>$(</span>ls <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>ROOT_NC_CONF</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span> | wc -l<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17</span><span><span style=color:#ff79c6>if</span> <span style=color:#ff79c6>[</span> <span style=color:#8be9fd;font-style:italic>$CHECK_FOLDER_MARIADB</span> -eq <span style=color:#bd93f9>0</span> <span style=color:#ff79c6>]</span> <span style=color:#ff79c6>||</span> <span style=color:#ff79c6>[</span> <span style=color:#8be9fd;font-style:italic>$CHECK_FOLDER_NC</span> -eq <span style=color:#bd93f9>0</span> <span style=color:#ff79c6>]</span> <span style=color:#ff79c6>||</span> <span style=color:#ff79c6>[</span> <span style=color:#8be9fd;font-style:italic>$CHECK_FOLDER_NC_CONF</span> -eq <span style=color:#bd93f9>0</span> <span style=color:#ff79c6>]</span>; <span style=color:#ff79c6>then</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19</span><span>    <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>$(</span>date +<span style=color:#f1fa8c>&#34;%Y-%m-%d %H:%M:%S&#34;</span><span style=color:#ff79c6>)</span><span style=color:#f1fa8c> - Info - Init Nextcloud&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21</span><span>    <span style=color:#6272a4># Delete old data</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22</span><span>    <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>$(</span>date +<span style=color:#f1fa8c>&#34;%Y-%m-%d %H:%M:%S&#34;</span><span style=color:#ff79c6>)</span><span style=color:#f1fa8c> - Info - Delete existing Data&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23</span><span>    rm -rf <span style=color:#8be9fd;font-style:italic>$ROOT_DB_DATA</span>/*
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24</span><span>    rm -rf <span style=color:#8be9fd;font-style:italic>$ROOT_NC_DATA</span>/*
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25</span><span>    rm -rf <span style=color:#8be9fd;font-style:italic>$ROOT_NC_CONF</span>/*
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27</span><span>    <span style=color:#6272a4># Copy config files</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28</span><span>    <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>$(</span>date +<span style=color:#f1fa8c>&#34;%Y-%m-%d %H:%M:%S&#34;</span><span style=color:#ff79c6>)</span><span style=color:#f1fa8c> - Info - Copy config files&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29</span><span>    <span style=color:#6272a4># Mariadb</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30</span><span>    cat <span style=color:#8be9fd;font-style:italic>$ROOT_CONF</span>/mariadb/50-server.cnf | sed <span style=color:#f1fa8c>&#39;s|${ROOT_DB_DATA}|&#39;</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>ROOT_DB_DATA</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>&#39;|g&#39;</span> &gt; /etc/mysql/mariadb.conf.d/50-server.cnf
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31</span><span>    <span style=color:#6272a4># Apache2 and PHP</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32</span><span>    <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;apc.enable_cli = 1&#34;</span> &gt;&gt; /etc/php/8.1/apache2/php.ini
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33</span><span>    cat <span style=color:#8be9fd;font-style:italic>$ROOT_CONF</span>/php/20-pdo_mysql.ini &gt; /etc/php/8.1/apache2/conf.d/20-pdo_mysql.ini
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34</span><span>    cat <span style=color:#8be9fd;font-style:italic>$ROOT_CONF</span>/apache2/nextcloud.conf | sed <span style=color:#f1fa8c>&#39;s|${NC_HOSTNAME}|&#39;</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>NC_HOSTNAME</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>&#39;|g&#39;</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35</span><span><span style=color:#f1fa8c></span>        | sed <span style=color:#f1fa8c>&#39;s|${ROOT_NC}|&#39;</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>ROOT_NC</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>&#39;|g&#39;</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36</span><span><span style=color:#f1fa8c></span>        &gt; /etc/apache2/sites-available/nextcloud.conf
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37</span><span>    <span style=color:#6272a4># Nextcloud</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38</span><span>    cp /tmp/nextcloud_config/* <span style=color:#8be9fd;font-style:italic>$ROOT_NC_CONF</span>/.
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39</span><span>    cat <span style=color:#8be9fd;font-style:italic>$ROOT_CONF</span>/nextcloud/autoconfig.php | sed <span style=color:#f1fa8c>&#39;s|${NC_HOSTNAME}|&#39;</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>NC_HOSTNAME</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>&#39;|g&#39;</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40</span><span><span style=color:#f1fa8c></span>        | sed <span style=color:#f1fa8c>&#39;s|${ROOT_NC_DATA}|&#39;</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>ROOT_NC_DATA</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>&#39;|g&#39;</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41</span><span><span style=color:#f1fa8c></span>        | sed <span style=color:#f1fa8c>&#39;s|${MYSQL_DATABASE}|&#39;</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>MYSQL_DATABASE</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>&#39;|g&#39;</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42</span><span><span style=color:#f1fa8c></span>        | sed <span style=color:#f1fa8c>&#39;s|${MYSQL_USER}|&#39;</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>MYSQL_USER</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>&#39;|g&#39;</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43</span><span><span style=color:#f1fa8c></span>        | sed <span style=color:#f1fa8c>&#39;s|${MYSQL_PASSWORD}|&#39;</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>MYSQL_PASSWORD</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>&#39;|g&#39;</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44</span><span><span style=color:#f1fa8c></span>        | sed <span style=color:#f1fa8c>&#39;s|${STATIC_IP}|&#39;</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>STATIC_IP</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>&#39;|g&#39;</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45</span><span><span style=color:#f1fa8c></span>        | sed <span style=color:#f1fa8c>&#39;s|${NC_ADMIN_PASSWORD}|&#39;</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>NC_ADMIN_PASSWORD</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>&#39;|g&#39;</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46</span><span><span style=color:#f1fa8c></span>        &gt; <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>ROOT_NC_CONF</span><span style=color:#f1fa8c>}</span>/autoconfig.php
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47</span><span>    cat <span style=color:#8be9fd;font-style:italic>$ROOT_CONF</span>/nextcloud/docker.config.php | sed <span style=color:#f1fa8c>&#39;s|${NC_HOSTNAME}|&#39;</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>NC_HOSTNAME</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>&#39;|g&#39;</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48</span><span><span style=color:#f1fa8c></span>        | sed <span style=color:#f1fa8c>&#39;s|${MAIL_DOMAINE}|&#39;</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>MAIL_DOMAINE</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>&#39;|g&#39;</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49</span><span><span style=color:#f1fa8c></span>        | sed <span style=color:#f1fa8c>&#39;s|${ROOT_LOG}|&#39;</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>ROOT_LOG</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>&#39;|g&#39;</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50</span><span><span style=color:#f1fa8c></span>        | sed <span style=color:#f1fa8c>&#39;s|${TZ}|&#39;</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>TZ</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>&#39;|g&#39;</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51</span><span><span style=color:#f1fa8c></span>        | sed <span style=color:#f1fa8c>&#39;s|${ROOT_NC_LOG}|&#39;</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>ROOT_NC_LOG</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>&#39;|g&#39;</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52</span><span><span style=color:#f1fa8c></span>        | sed <span style=color:#f1fa8c>&#39;s|${ROOT_NC_APPS}|&#39;</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>ROOT_NC_APPS</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>&#39;|g&#39;</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53</span><span><span style=color:#f1fa8c></span>        &gt; <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>ROOT_NC_CONF</span><span style=color:#f1fa8c>}</span>/docker.config.php
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55</span><span>    <span style=color:#6272a4># Manage right on config files</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56</span><span>    <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>$(</span>date +<span style=color:#f1fa8c>&#34;%Y-%m-%d %H:%M:%S&#34;</span><span style=color:#ff79c6>)</span><span style=color:#f1fa8c> - Info - Manage right on config files&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57</span><span>    chmod <span style=color:#bd93f9>644</span> /etc/mysql/mariadb.conf.d/50-server.cnf
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58</span><span>    chmod <span style=color:#bd93f9>644</span> /etc/php/8.1/apache2/conf.d/20-pdo_mysql.ini
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59</span><span>    chmod <span style=color:#bd93f9>644</span> /etc/php/8.1/apache2/php.ini
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60</span><span>    chmod <span style=color:#bd93f9>644</span> /etc/apache2/sites-available/nextcloud.conf
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61</span><span>    chmod <span style=color:#bd93f9>644</span> <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>ROOT_NC_CONF</span><span style=color:#f1fa8c>}</span>/*
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63</span><span>    <span style=color:#6272a4># Init MariaDB service</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64</span><span>    <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>$(</span>date +<span style=color:#f1fa8c>&#34;%Y-%m-%d %H:%M:%S&#34;</span><span style=color:#ff79c6>)</span><span style=color:#f1fa8c> - Info - MariasDB : Install DB (mysql)&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65</span><span>    mariadb-install-db --user<span style=color:#ff79c6>=</span>mysql
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66</span><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>[</span> <span style=color:#8be9fd;font-style:italic>$?</span> -ne <span style=color:#bd93f9>0</span> <span style=color:#ff79c6>]</span>; <span style=color:#ff79c6>then</span> <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>$(</span>date +<span style=color:#f1fa8c>&#34;%Y-%m-%d %H:%M:%S&#34;</span><span style=color:#ff79c6>)</span><span style=color:#f1fa8c> - Error - MariasDB Install&#34;</span>; <span style=color:#8be9fd;font-style:italic>exit</span> <span style=color:#bd93f9>1</span> ; <span style=color:#ff79c6>fi</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68</span><span>    <span style=color:#6272a4># Start MariaDB service</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69</span><span>    <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>$(</span>date +<span style=color:#f1fa8c>&#34;%Y-%m-%d %H:%M:%S&#34;</span><span style=color:#ff79c6>)</span><span style=color:#f1fa8c> - Info - MariasDB : Start service&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70</span><span>    service mariadb start
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71</span><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>[</span> <span style=color:#8be9fd;font-style:italic>$?</span> -ne <span style=color:#bd93f9>0</span> <span style=color:#ff79c6>]</span>; <span style=color:#ff79c6>then</span> <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>$(</span>date +<span style=color:#f1fa8c>&#34;%Y-%m-%d %H:%M:%S&#34;</span><span style=color:#ff79c6>)</span><span style=color:#f1fa8c> - Error - MariasDB Start&#34;</span>; <span style=color:#8be9fd;font-style:italic>exit</span> <span style=color:#bd93f9>1</span> ; <span style=color:#ff79c6>fi</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73</span><span>    <span style=color:#6272a4># Create nextcloud user into MariaDB</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74</span><span>    <span style=color:#8be9fd;font-style:italic>QRY_SQL</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;CREATE USER IF NOT EXISTS &#39;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>MYSQL_USER</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#39;@&#39;localhost&#39; IDENTIFIED BY &#39;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>MYSQL_PASSWORD</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#39;;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75</span><span><span style=color:#f1fa8c>    CREATE DATABASE IF NOT EXISTS </span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>MYSQL_DATABASE</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c> CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76</span><span><span style=color:#f1fa8c>    GRANT ALL PRIVILEGES ON </span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>MYSQL_DATABASE</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>.* TO &#39;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>MYSQL_USER</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#39;@&#39;localhost&#39;;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77</span><span><span style=color:#f1fa8c>    FLUSH PRIVILEGES;&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79</span><span>    <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>$(</span>date +<span style=color:#f1fa8c>&#34;%Y-%m-%d %H:%M:%S&#34;</span><span style=color:#ff79c6>)</span><span style=color:#f1fa8c> - Info - MariasDB : Create user et database&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80</span><span>    mariadb -u root -e <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>QRY_SQL</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81</span><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>[</span> <span style=color:#8be9fd;font-style:italic>$?</span> -ne <span style=color:#bd93f9>0</span> <span style=color:#ff79c6>]</span>; <span style=color:#ff79c6>then</span> <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>$(</span>date +<span style=color:#f1fa8c>&#34;%Y-%m-%d %H:%M:%S&#34;</span><span style=color:#ff79c6>)</span><span style=color:#f1fa8c> - Error - MariasDB exec QRY&#34;</span>; <span style=color:#8be9fd;font-style:italic>exit</span> <span style=color:#bd93f9>1</span> ; <span style=color:#ff79c6>fi</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84</span><span>    <span style=color:#6272a4># Init Apache2 service</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85</span><span>    <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>$(</span>date +<span style=color:#f1fa8c>&#34;%Y-%m-%d %H:%M:%S&#34;</span><span style=color:#ff79c6>)</span><span style=color:#f1fa8c> - Info - Apache2 : Init conf&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86</span><span>    <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;ServerName </span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>STATIC_IP</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span> &gt;&gt; /etc/apache2/apache2.conf
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87</span><span>    a2ensite nextcloud.conf
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88</span><span>    a2enmod rewrite headers env dir mime ssl
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90</span><span>    <span style=color:#6272a4># Start Apache2 service</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91</span><span>    <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>$(</span>date +<span style=color:#f1fa8c>&#34;%Y-%m-%d %H:%M:%S&#34;</span><span style=color:#ff79c6>)</span><span style=color:#f1fa8c> - Info - Apache2 : Start service&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92</span><span>    service apache2 start
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93</span><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>[</span> <span style=color:#8be9fd;font-style:italic>$?</span> -ne <span style=color:#bd93f9>0</span> <span style=color:#ff79c6>]</span>; <span style=color:#ff79c6>then</span> <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>$(</span>date +<span style=color:#f1fa8c>&#34;%Y-%m-%d %H:%M:%S&#34;</span><span style=color:#ff79c6>)</span><span style=color:#f1fa8c> - Error - apache2 service start&#34;</span>; <span style=color:#8be9fd;font-style:italic>exit</span> <span style=color:#bd93f9>1</span> ; <span style=color:#ff79c6>fi</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95</span><span>    <span style=color:#6272a4># Manage folders rights</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96</span><span>    <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>$(</span>date +<span style=color:#f1fa8c>&#34;%Y-%m-%d %H:%M:%S&#34;</span><span style=color:#ff79c6>)</span><span style=color:#f1fa8c> - Info - Manage folders chown&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97</span><span>    chown -R www-data:www-data <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>ROOT_NC</span><span style=color:#f1fa8c>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98</span><span>    chown -R www-data:www-data <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>ROOT_NC_DATA</span><span style=color:#f1fa8c>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99</span><span>    chown -R www-data:www-data <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>ROOT_NC_CONF</span><span style=color:#f1fa8c>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">100</span><span>    chown -R www-data:www-data <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>ROOT_NC_APPS</span><span style=color:#f1fa8c>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">101</span><span>    chown -R mysql:mysql <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>ROOT_DB_DATA</span><span style=color:#f1fa8c>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">102</span><span>    chmod -R <span style=color:#bd93f9>766</span> <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>ROOT_NC_LOG</span><span style=color:#f1fa8c>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">103</span><span>    chmod -R <span style=color:#bd93f9>766</span> <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>ROOT_DB_LOG</span><span style=color:#f1fa8c>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">104</span><span>    chown -R www-data:www-data <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>ROOT_NC_LOG</span><span style=color:#f1fa8c>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">105</span><span>    chown -R www-data:www-data <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>ROOT_DB_LOG</span><span style=color:#f1fa8c>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">106</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">107</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">108</span><span>    <span style=color:#6272a4># Execute Nextcloud for the first time with HTTPS (initialize admin user and data folder)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">109</span><span>    openssl s_client -showcerts -connect <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>NC_HOSTNAME</span><span style=color:#f1fa8c>}</span>:443 &lt;/dev/null | sed -n -e <span style=color:#f1fa8c>&#39;/-.BEGIN/,/-.END/ p&#39;</span> &gt; /tmp/nextcloud.pem
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">110</span><span>    curl --cacert /tmp/nextcloud.pem https://<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>NC_HOSTNAME</span><span style=color:#f1fa8c>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">111</span><span>    rm /tmp/nextcloud.pem
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">112</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">113</span><span>    <span style=color:#6272a4># Start Cron service</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">114</span><span>    service cron start
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">115</span><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>[</span> <span style=color:#8be9fd;font-style:italic>$?</span> -ne <span style=color:#bd93f9>0</span> <span style=color:#ff79c6>]</span>; <span style=color:#ff79c6>then</span> <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>$(</span>date +<span style=color:#f1fa8c>&#34;%Y-%m-%d %H:%M:%S&#34;</span><span style=color:#ff79c6>)</span><span style=color:#f1fa8c> - Error - cron service start&#34;</span>; <span style=color:#8be9fd;font-style:italic>exit</span> <span style=color:#bd93f9>1</span> ; <span style=color:#ff79c6>fi</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">116</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">117</span><span><span style=color:#ff79c6>else</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">118</span><span>    <span style=color:#6272a4># If init already done : Start services</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">119</span><span>    service mariadb start
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">120</span><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>[</span> <span style=color:#8be9fd;font-style:italic>$?</span> -ne <span style=color:#bd93f9>0</span> <span style=color:#ff79c6>]</span>; <span style=color:#ff79c6>then</span> <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>$(</span>date +<span style=color:#f1fa8c>&#34;%Y-%m-%d %H:%M:%S&#34;</span><span style=color:#ff79c6>)</span><span style=color:#f1fa8c> - Error - mariadb service start&#34;</span>; <span style=color:#8be9fd;font-style:italic>exit</span> <span style=color:#bd93f9>1</span> ; <span style=color:#ff79c6>fi</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">121</span><span>    service apache2 start
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">122</span><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>[</span> <span style=color:#8be9fd;font-style:italic>$?</span> -ne <span style=color:#bd93f9>0</span> <span style=color:#ff79c6>]</span>; <span style=color:#ff79c6>then</span> <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>$(</span>date +<span style=color:#f1fa8c>&#34;%Y-%m-%d %H:%M:%S&#34;</span><span style=color:#ff79c6>)</span><span style=color:#f1fa8c> - Error - apache2 service start&#34;</span>; <span style=color:#8be9fd;font-style:italic>exit</span> <span style=color:#bd93f9>1</span> ; <span style=color:#ff79c6>fi</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">123</span><span>    service cron start
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">124</span><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>[</span> <span style=color:#8be9fd;font-style:italic>$?</span> -ne <span style=color:#bd93f9>0</span> <span style=color:#ff79c6>]</span>; <span style=color:#ff79c6>then</span> <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>$(</span>date +<span style=color:#f1fa8c>&#34;%Y-%m-%d %H:%M:%S&#34;</span><span style=color:#ff79c6>)</span><span style=color:#f1fa8c> - Error - cron service start&#34;</span>; <span style=color:#8be9fd;font-style:italic>exit</span> <span style=color:#bd93f9>1</span> ; <span style=color:#ff79c6>fi</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">125</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">126</span><span><span style=color:#ff79c6>fi</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">127</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">128</span><span><span style=color:#6272a4># Infinite loop to keep service up</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">129</span><span><span style=color:#ff79c6>while</span> <span style=color:#ff79c6>[</span> <span style=color:#bd93f9>1</span> <span style=color:#ff79c6>]</span>; <span style=color:#ff79c6>do</span> 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">130</span><span>    sleep <span style=color:#bd93f9>300</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">131</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">132</span><span>    <span style=color:#6272a4># Check Apache2 service</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">133</span><span>    <span style=color:#8be9fd;font-style:italic>CHECK_APACHE</span><span style=color:#ff79c6>=</span><span style=color:#ff79c6>$(</span>service apache2 status | grep <span style=color:#f1fa8c>&#39;is running&#39;</span> | wc -l<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">134</span><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>[</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$CHECK_APACHE</span><span style=color:#f1fa8c>&#34;</span> !<span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;1&#34;</span> <span style=color:#ff79c6>]</span>; <span style=color:#ff79c6>then</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">135</span><span>        <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>$(</span>date +<span style=color:#f1fa8c>&#34;%Y-%m-%d %H:%M:%S&#34;</span><span style=color:#ff79c6>)</span><span style=color:#f1fa8c> - Info - Restart apache2 service&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">136</span><span>        service apache2 start
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">137</span><span>        <span style=color:#8be9fd;font-style:italic>CHECK_APACHE_2</span><span style=color:#ff79c6>=</span><span style=color:#ff79c6>$(</span>service apache2 status | grep <span style=color:#f1fa8c>&#39;is running&#39;</span> | wc -l<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">138</span><span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>[</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$CHECK_APACHE_2</span><span style=color:#f1fa8c>&#34;</span> !<span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;1&#34;</span> <span style=color:#ff79c6>]</span>; <span style=color:#ff79c6>then</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">139</span><span>            <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>$(</span>date +<span style=color:#f1fa8c>&#34;%Y-%m-%d %H:%M:%S&#34;</span><span style=color:#ff79c6>)</span><span style=color:#f1fa8c> - Error - Service apache2 KO&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">140</span><span>            <span style=color:#8be9fd;font-style:italic>exit</span> <span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">141</span><span>        <span style=color:#ff79c6>fi</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">142</span><span>    <span style=color:#ff79c6>fi</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">143</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">144</span><span>    <span style=color:#6272a4># Check MariaDB service</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">145</span><span>    <span style=color:#8be9fd;font-style:italic>CHECK_MARIADB</span><span style=color:#ff79c6>=</span><span style=color:#ff79c6>$(</span>service mariadb status | grep <span style=color:#f1fa8c>&#39;Uptime&#39;</span> | wc -l<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">146</span><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>[</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$CHECK_MARIADB</span><span style=color:#f1fa8c>&#34;</span> !<span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;1&#34;</span> <span style=color:#ff79c6>]</span>; <span style=color:#ff79c6>then</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">147</span><span>        <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>$(</span>date +<span style=color:#f1fa8c>&#34;%Y-%m-%d %H:%M:%S&#34;</span><span style=color:#ff79c6>)</span><span style=color:#f1fa8c> - Info - Restart mariadb service&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">148</span><span>        service mariadb start
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">149</span><span>        <span style=color:#8be9fd;font-style:italic>CHECK_MARIADB_2</span><span style=color:#ff79c6>=</span><span style=color:#ff79c6>$(</span>service mariadb status | grep <span style=color:#f1fa8c>&#39;Uptime&#39;</span> | wc -l<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">150</span><span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>[</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$CHECK_MARIADB_2</span><span style=color:#f1fa8c>&#34;</span> !<span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;1&#34;</span> <span style=color:#ff79c6>]</span>; <span style=color:#ff79c6>then</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">151</span><span>            <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>$(</span>date +<span style=color:#f1fa8c>&#34;%Y-%m-%d %H:%M:%S&#34;</span><span style=color:#ff79c6>)</span><span style=color:#f1fa8c> - Error - Service mariadb KO&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">152</span><span>            <span style=color:#8be9fd;font-style:italic>exit</span> <span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">153</span><span>        <span style=color:#ff79c6>fi</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">154</span><span>    <span style=color:#ff79c6>fi</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">155</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">156</span><span><span style=color:#ff79c6>done</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">157</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">158</span><span><span style=color:#8be9fd;font-style:italic>exit</span> <span style=color:#bd93f9>0</span>
</span></span></code></pre></div><h2 id=creation-of-a-configuration-file-for-all-environment-variables>Creation of a configuration file for all environment variables</h2><p>In order to finalize the creation of the Docker image, we need to set up an <strong>.env</strong> file to centralize all the environment variables required by the container and, more specifically, by the <strong>run_nextcloud.sh</strong> initialization script.</p><p>This environment file is defined in the <strong>docker-compose.yml</strong> file.
The <strong>.env</strong> file must be created in the <code>/share/Docker/scripts/nextcloud_app/config</code> directory.</p><p>The contents of the file <strong>.env</strong> : <em>(replacing the values required for your environment))</em></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8be9fd;font-style:italic>PUID</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>501</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#8be9fd;font-style:italic>PGID</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>100</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#8be9fd;font-style:italic>ROOT_DB_DATA</span><span style=color:#ff79c6>=</span>/var/lib/mysql
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#8be9fd;font-style:italic>ROOT_NC</span><span style=color:#ff79c6>=</span>/var/www/nextcloud
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#8be9fd;font-style:italic>ROOT_NC_DATA</span><span style=color:#ff79c6>=</span>/var/www/nextcloud/data
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#8be9fd;font-style:italic>ROOT_NC_CONF</span><span style=color:#ff79c6>=</span>/var/www/nextcloud/config
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#8be9fd;font-style:italic>ROOT_NC_LOG</span><span style=color:#ff79c6>=</span>/var/log/nextcloud
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#8be9fd;font-style:italic>ROOT_DB_LOG</span><span style=color:#ff79c6>=</span>/var/log/mysql
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#8be9fd;font-style:italic>ROOT_NC_APPS</span><span style=color:#ff79c6>=</span>/var/www/nextcloud/apps
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#8be9fd;font-style:italic>NC_HOSTNAME</span><span style=color:#ff79c6>=</span>&lt;hostname <span style=color:#ff79c6>(</span>ex: nextcloud.nas.nas<span style=color:#ff79c6>)</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#8be9fd;font-style:italic>MYSQL_DATABASE</span><span style=color:#ff79c6>=</span>nextcloud
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#8be9fd;font-style:italic>MYSQL_USER</span><span style=color:#ff79c6>=</span>&lt;nextcloud username <span style=color:#ff79c6>for</span> mariadb&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#8be9fd;font-style:italic>MYSQL_PASSWORD</span><span style=color:#ff79c6>=</span>&lt;nextcloud user password <span style=color:#ff79c6>for</span> mariadb&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#8be9fd;font-style:italic>STATIC_IP</span><span style=color:#ff79c6>=</span>110.110.110.151
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#8be9fd;font-style:italic>MAIL_DOMAINE</span><span style=color:#ff79c6>=</span>nas@nas.nas
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#8be9fd;font-style:italic>TZ</span><span style=color:#ff79c6>=</span>Europe/Paris
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#8be9fd;font-style:italic>NC_ADMIN_PASSWORD</span><span style=color:#ff79c6>=</span>&lt;nextcloud admin password&gt;
</span></span></code></pre></div><h2 id=set-up-a-startup-script-on-the-qnap-nas>Set up a startup script on the QNAP NAS</h2><p>In order to start the Docker container of the Nextcloud application at the QNAP NAS startup :</p><ol><li>Go to <code>Main Menu > ControlPanel > System > Hardware</code>.</li><li>In the <code>General</code> tab, check the <code>Run user defined processes during startup</code> option.</li><li>Connect to the QNAS NAS via SSH with an administrator account: <code>ssh &lt;user>@&lt;ip> -p &lt;port></code></li><li>Run the follow commands to mount the directory <code>/tmp/config</code></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>ubiattach -m <span style=color:#bd93f9>6</span> -d <span style=color:#bd93f9>2</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>/bin/mount -t ubifs ubi2:config /tmp/config
</span></span></code></pre></div><ol start=5><li>Create the file <code>/tmp/config/autorun.sh</code> with the content as follow :</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>#!/bin/sh
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#ff79c6></span><span style=color:#8be9fd;font-style:italic>cd</span> /share/Docker/scripts/nextcloud_app
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>docker compose up -d
</span></span></code></pre></div><ol start=6><li>Run the following commands to be able to run the file <code>/tmp/config/autorun.sh</code> and unmount he directory <code>/tmp/config</code></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>chmod +x /tmp/config/autorun.sh
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>umount /tmp/config
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>ubidetach -m <span style=color:#bd93f9>6</span>
</span></span></code></pre></div><h1 id=run-the-nextcloud-application>Run the Nextcloud application</h1><p>The steps for manually running the Nextcloud application are as follows:</p><ol><li>Connect SSH to the QNAP NAS with an administrator account: <code>ssh &lt;user>@&lt;ip> -p &lt;port></code></li><li>Go to the directory containing the Docker image elements: <code>cd /share/Docker/scripts/nextcloud_app</code></li><li>Run the following Docker Compose command: <code>docker compose up -d</code></li><li>Wait a few seconds/minutes and check that the container is running correctly by connecting to the Nextcloud application <code>https://110.110.110.151</code></li></ol><p>You can check that the container is running correctly by checking the information in the QNAP Container Station application, or by using the usual docker commands (stats, logs, ps, &mldr;).</p><p><a href=/blog/web/20231107_Blog_use_nextcloud_on_qnap_05png><img src=/blog/web/20231107_Blog_use_nextcloud_on_qnap_05.png alt=20231107_Blog_use_nextcloud_on_qnap_05></a></p><p><a href=/blog/web/20231107_Blog_use_nextcloud_on_qnap_06.png><img src=/blog/web/20231107_Blog_use_nextcloud_on_qnap_06.png alt=20231107_Blog_use_nextcloud_on_qnap_06></a></p><p><a href=/blog/web/20231107_Blog_use_nextcloud_on_qnap_07.png><img src=/blog/web/20231107_Blog_use_nextcloud_on_qnap_07.png alt=20231107_Blog_use_nextcloud_on_qnap_07></a></p><h1 id=commands>Commands</h1><p>Some commands for using Docker :</p><ul><li><code>docker build -t nextcloud-qnas-img:v27 . </code>: Builds the image from the <strong>Dockerfile</strong> in the current directory.<ul><li><code>docker build -t nextcloud-qnas-img:v27 . --build-arg build_TZ=Europe/Paris --build-arg build_PUID=501 --build-arg build_PGID=100</code> : Build command with argument</li></ul></li><li><code>docker ps</code> : List of running containers</li><li><code>docker ps -a</code> : List of all existing containers</li><li><code>docker stats</code> : Statistics on running container usage</li><li><code>docker logs nextcloud-qnas</code> : Container log message (standard output)</li><li><code>docker create -i -t -v /share/Docker/nextcloud/...:/... -v ... --name nextcloud-qnas nextcloud-qnas-img:v27</code> : Create an <strong>nextcloud-qnas</strong> container from the <strong>nextcloud-qnas-img:v27</strong> image</li><li><code>docker container start -a -i nextcloud-qnas</code> : Start a container by accessing the console directly</li><li><code>docker rm nextcloud-qnas</code> : Delete the container</li></ul><p>If you need to manually recreate the QNAP NAS <strong>network</strong> for Docker :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4># Create dhcp network</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>docker network create -d qnet --opt<span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>iface</span><span style=color:#ff79c6>=</span>eth0 --ipam-driver<span style=color:#ff79c6>=</span>qnet --ipam-opt<span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>iface</span><span style=color:#ff79c6>=</span>eth0 qnet-dhcp-eth0
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#6272a4># Create static network</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>docker network create -d qnet --opt<span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>iface</span><span style=color:#ff79c6>=</span>eth0 --ipam-driver<span style=color:#ff79c6>=</span>qnet --ipam-opt<span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>iface</span><span style=color:#ff79c6>=</span>eth0 <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#f1fa8c></span>      --subnet<span style=color:#ff79c6>=</span>110.110.110.0/24 --gateway<span style=color:#ff79c6>=</span>110.110.110.1 qnet-static-eth0
</span></span></code></pre></div><p>Some commands for using Docker Compose : <em>(You need to be in the directory containing the <code>docker-compose.yaml</code> file)</em></p><ul><li><code>docker compose build --build-arg TZ=Europe/Paris --build-arg PUID=501 --build-arg PGID=100</code> : Allows build to be performed in the same way as the Docker command</li><li><code>docker compose up -d</code> : Create and start defined containers</li><li><code>docker compose down</code> : Stop and delete defined containers</li><li><code>docker compose start</code> : Start defined containers</li><li><code>docker compose stop</code> : Stop defined containers</li></ul></div></article></div></div><footer><div class="container-fluid prag-bg-primary prag-foot">Build With <a href=https://gohugo.io/>Hugo</a>
&nbsp; - &nbsp;
<a href=https://en.wikipedia.org/wiki/WTFPL>WTFPL license</a> Â© 2018â2023</div></footer></body></html>