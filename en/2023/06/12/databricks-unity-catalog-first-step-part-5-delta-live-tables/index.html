<!doctype html><html lang=en><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta http-equiv=x-ua-compatible content="IE=edge"><meta charset=utf-8><meta name=robots content="noindex, nofollow, noarchive, nosnipper, noodp, noydir"><meta name=google content="notranslate, noimageindex"><meta name=slurp content="notranslate, noimageindex"><meta name=msnbot content="notranslate, noimageindex"><meta name=bingbot content="notranslate, noimageindex"><meta name=generator content="Hugo 0.113.0"><link rel=stylesheet href=https://www.pragmatias.fr/css/bootstrap.min.css><link rel=stylesheet href=https://www.pragmatias.fr/css/pragmatias.css><script src=https://www.pragmatias.fr/js/jquery-3.6.0.slim.min.js></script>
<script src=https://www.pragmatias.fr/js/popper.min.js></script>
<script src=https://www.pragmatias.fr/js/bootstrap.bundle.min.js></script>
<link rel=alternate type=application/rss+xml href=https://www.pragmatias.fr/en/feed.xml><title>Databricks : Unity Catalog - First Step - Part 5 - Delta Live Tables</title><body><div class="navbar navbar-expand-md prag-bg-primary prag-header" role=navigation><div class="container-fluid justify-content-center"><div class=navbar-brand><a href=https://www.pragmatias.fr/en/blog/><img src=/images/logo_pragmatias.svg alt=pragmatias></a></div><button class="navbar-toggler justify-content-end prag-navbar" type=button data-toggle=collapse data-target=#navbarSupportedContent1,#navbarSupportedContent2 aria-controls=navbarSupportedContent1 aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent1><ul class="navbar-nav text-center"><li class=nav-item><a class=nav-link href=https://www.pragmatias.fr/en/blog/>Blog</a></li><li class=nav-item><a class=nav-link href=https://www.pragmatias.fr/en/tags/>Tags</a></li><li class=nav-item><a class=nav-link href=https://www.pragmatias.fr/en/archives/>Archives</a></li></ul></div><div class="collapse navbar-collapse justify-content-md-end" id=navbarSupportedContent2><ul class="navbar-nav flex-row justify-content-center"><li class=nav-item><a href=https://www.pragmatias.fr/2023/06/12/databricks-unity-catalog-d%C3%A9couverte-partie-5-delta-live-tables/ class="prag_header_svg mr-1 ml-1"><img src=/images/france-flag-round-xs-24.png alt=Français></a></li><li class=nav-item><a href=https://www.pragmatias.fr/en/feed.xml title="Pragmatias Blog" class="prag_header_svg mr-1 ml-1"><svg height="24" style="enable-background:new 0 0 508.52 508.52" viewBox="0 0 508.52 508.52" width="24" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path style="fill-rule:evenodd;clip-rule:evenodd;fill:" d="M254.26.0C113.845.0.0 113.845.0 254.26s113.845 254.26 254.26 254.26 254.26-113.845 254.26-254.26C508.52 113.813 394.675.0 254.26.0zM137.141 412.441c-22.852.0-41.413-18.434-41.413-41.285.0-22.693 18.561-41.349 41.413-41.349 22.915.0 41.444 18.656 41.476 41.349C178.618 393.976 160.088 412.441 137.141 412.441zM241.197 412.791c0-39.029-15.16-75.674-42.62-103.071-27.46-27.524-63.978-42.716-102.785-42.716V207.38c113.177.0 205.315 92.137 205.315 205.41h-59.91zM347.001 412.727c0-138.603-112.669-251.399-251.145-251.399v-59.624c171.435.0 310.96 139.589 310.96 311.023H347.001z"/></svg></a></li><li class=nav-item><a href=mailto:contact@pragmatias.fr title=Mail class="prag_header_svg mr-1 ml-1"><svg height="24" style="enable-background:new 0 0 299.997 299.997" viewBox="0 0 299.997 299.997" width="24" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path style="fill-rule:evenodd;clip-rule:evenodd;fill:" d="M149.996.0C67.157.0.001 67.158.001 149.997c0 82.837 67.156 150 149.995 150s150-67.163 150-150C299.996 67.158 232.835.0 149.996.0zM149.999 52.686l88.763 55.35H61.236l88.763-55.35zm89.869 143.737h-.009c0 8.878-7.195 16.072-16.072 16.072H76.211c-8.878.0-16.072-7.195-16.072-16.072v-84.865c0-.939.096-1.852.252-2.749l84.808 52.883c.104.065.215.109.322.169.112.062.226.122.34.179.599.309 1.216.558 1.847.721.065.018.13.026.195.041.692.163 1.393.265 2.093.265h.005c.005.0.01.0.01.0.7.0 1.401-.099 2.093-.265.065-.016.13-.023.195-.041.63-.163 1.245-.412 1.847-.721.114-.057.228-.117.34-.179.106-.06.218-.104.322-.169l84.808-52.883c.156.897.252 1.808.252 2.749v84.865z"/></svg></a></li><li><a href=https://github.com/pragmatias/ title=github class="prag_header_svg mr-1 ml-1"><svg height="24" style="enable-background:new 0 0 438.549 438.549" viewBox="0 0 438.549 438.549" width="24" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path style="fill-rule:evenodd;clip-rule:evenodd;fill:" d="M409.132 114.573c-19.608-33.596-46.205-60.194-79.798-79.8C295.736 15.166 259.057 5.365 219.271 5.365c-39.781.0-76.472 9.804-110.063 29.408-33.596 19.605-60.192 46.204-79.8 79.8C9.803 148.168.0 184.854.0 224.63c0 47.78 13.94 90.745 41.827 128.906 27.884 38.164 63.906 64.572 108.063 79.227 5.14.954 8.945.283 11.419-1.996 2.475-2.282 3.711-5.14 3.711-8.562.0-.571-.049-5.708-.144-15.417-.098-9.709-.144-18.179-.144-25.406l-6.567 1.136c-4.187.767-9.469 1.092-15.846 1-6.374-.089-12.991-.757-19.842-1.999-6.854-1.231-13.229-4.086-19.13-8.559-5.898-4.473-10.085-10.328-12.56-17.556l-2.855-6.57c-1.903-4.374-4.899-9.233-8.992-14.559-4.093-5.331-8.232-8.945-12.419-10.848l-1.999-1.431c-1.332-.951-2.568-2.098-3.711-3.429-1.142-1.331-1.997-2.663-2.568-3.997-.572-1.335-.098-2.43 1.427-3.289s4.281-1.276 8.28-1.276l5.708.853c3.807.763 8.516 3.042 14.133 6.851 5.614 3.806 10.229 8.754 13.846 14.842 4.38 7.806 9.657 13.754 15.846 17.847 6.184 4.093 12.419 6.136 18.699 6.136s11.704-.476 16.274-1.423c4.565-.952 8.848-2.383 12.847-4.285 1.713-12.758 6.377-22.559 13.988-29.41-10.848-1.14-20.601-2.857-29.264-5.14-8.658-2.286-17.605-5.996-26.835-11.14-9.235-5.137-16.896-11.516-22.985-19.126-6.09-7.614-11.088-17.61-14.987-29.979-3.901-12.374-5.852-26.648-5.852-42.826.0-23.035 7.52-42.637 22.557-58.817-7.044-17.318-6.379-36.732 1.997-58.24 5.52-1.715 13.706-.428 24.554 3.853 10.85 4.283 18.794 7.952 23.84 10.994 5.046 3.041 9.089 5.618 12.135 7.708 17.705-4.947 35.976-7.421 54.818-7.421s37.117 2.474 54.823 7.421l10.849-6.849c7.419-4.57 16.18-8.758 26.262-12.565 10.088-3.805 17.802-4.853 23.134-3.138 8.562 21.509 9.325 40.922 2.279 58.24 15.036 16.18 22.559 35.787 22.559 58.817.0 16.178-1.958 30.497-5.853 42.966-3.9 12.471-8.941 22.457-15.125 29.979-6.191 7.521-13.901 13.85-23.131 18.986-9.232 5.14-18.182 8.85-26.84 11.136-8.662 2.286-18.415 4.004-29.263 5.146 9.894 8.562 14.842 22.077 14.842 40.539v60.237c0 3.422 1.19 6.279 3.572 8.562 2.379 2.279 6.136 2.95 11.276 1.995 44.163-14.653 80.185-41.062 108.068-79.226 27.88-38.161 41.825-81.126 41.825-128.906C438.536 184.851 428.728 148.168 409.132 114.573z"/></svg></a></li></ul></div></div></div><div id=content><div class=container-fluid><article class="blog-post blog-post-with-toc"><header><h2 class=blog-post-title>Databricks : Unity Catalog - First Step - Part 5 - Delta Live Tables</h2><div class=blog-post-date><span>Last update : 12 June 2023</span></div><div class=blog-post-date>Reading time : 30 minute(s) - 6300 words</div><div class=blog-post-tags><strong>Tags:</strong>
<a href=https://www.pragmatias.fr/en/tags/databricks/>Databricks</a>
<a href=https://www.pragmatias.fr/en/tags/unity-catalog/>Unity Catalog</a></div></header><aside class=prag-toc><h1 class=prag-toc-head>Summary</h1><div class=prag-toc-body><nav id=TableOfContents><ol><li><a href=#whats-delta-live-tables>What&rsquo;s Delta Live Tables</a><ol><li><a href=#overview>Overview</a></li><li><a href=#regarding-objects>Regarding objects</a></li><li><a href=#regarding-data-quality-management>Regarding data quality management</a></li><li><a href=#regarding-dlt-pipeline>Regarding DLT pipeline</a></li></ol></li><li><a href=#how-it-works-with-unity-catalog>How it works with Unity Catalog</a><ol><li><a href=#overview-1>Overview</a></li><li><a href=#regarding-object-management-by-the-dlt-framework-during-dlt-pipeline-execution>Regarding object management by the DLT framework (during DLT pipeline execution)</a></li><li><a href=#restrictions>Restrictions</a></li></ol></li><li><a href=#set-up-the-environment>Set-up the environment</a><ol><li><a href=#context>Context</a></li><li><a href=#schématisation-de-lenvironnement>Schématisation de l&rsquo;environnement</a></li><li><a href=#setting-up-a-dataset>Setting up a dataset</a></li><li><a href=#setting-up-the-objects-on-the-unity-catalog-metastore>Setting up the objects on the Unity Catalog Metastore</a></li><li><a href=#creation-of-the-python-script-containing-the-objects-definition-for-the-dlt-framework>Creation of the python script containing the objects definition for the DLT framework</a></li></ol></li><li><a href=#creating-a-dlt-pipeline>Creating a DLT Pipeline</a></li><li><a href=#running-and-viewing-a-dlt-pipeline>Running and Viewing a DLT Pipeline</a><ol><li><a href=#running-a-dlt-pipeline>Running a DLT Pipeline</a></li><li><a href=#dlt-pipeline-visualization>DLT Pipeline Visualization</a></li><li><a href=#visualization-with-unity-catalog>Visualization with Unity Catalog</a></li></ol></li><li><a href=#monitoring-a-dlt-pipeline>Monitoring a DLT pipeline</a></li><li><a href=#clean-environment>Clean environment</a></li><li><a href=#conclusion>Conclusion</a></li></ol></nav></div></aside><a id=showTopBtn href=# class=prag-sticky-bot><svg height="24" id="Layer_1" style="enable-background:new 0 0 438.533 438.533" viewBox="0 0 438.533 438.533" width="24" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path style="fill-rule:evenodd;clip-rule:evenodd;fill:" d="M409.133 109.203c-19.608-33.592-46.205-60.189-79.798-79.796C295.736 9.801 259.058.0 219.273.0c-39.781.0-76.47 9.801-110.063 29.407-33.595 19.604-60.192 46.201-79.8 79.796C9.801 142.8.0 179.489.0 219.267c0 39.78 9.804 76.463 29.407 110.062 19.607 33.592 46.204 60.189 79.799 79.798 33.597 19.605 70.283 29.407 110.063 29.407s76.47-9.802 110.065-29.407c33.593-19.602 60.189-46.206 79.795-79.798 19.603-33.596 29.403-70.284 29.403-110.062C438.533 179.485 428.732 142.795 409.133 109.203zM361.449 231.831l-25.981 25.981c-3.613 3.613-7.901 5.42-12.847 5.42-4.948.0-9.229-1.807-12.847-5.42l-53.954-53.961v143.32c0 4.948-1.813 9.232-5.428 12.847-3.613 3.62-7.898 5.427-12.847 5.427h-36.547c-4.948.0-9.231-1.807-12.847-5.427-3.617-3.614-5.426-7.898-5.426-12.847v-143.32l-53.959 53.961c-3.431 3.425-7.708 5.133-12.85 5.133-5.14.0-9.423-1.708-12.85-5.133l-25.981-25.981c-3.422-3.429-5.137-7.714-5.137-12.852.0-5.137 1.709-9.419 5.137-12.847l103.356-103.353 25.981-25.981c3.427-3.425 7.71-5.14 12.847-5.14 5.142.0 9.423 1.715 12.849 5.14l25.98 25.981 103.35 103.353c3.432 3.427 5.14 7.71 5.14 12.847C366.589 224.117 364.881 228.402 361.449 231.831z"/></svg></a><script>$(document).ready(function(){$("#showTopBtn").removeClass("prag-sticky-bot"),$("#showTopBtn").addClass("prag-sticky-hide"),$(function(){$(window).scroll(function(){$(this).scrollTop()>900?($("#showTopBtn").addClass("prag-sticky-bot"),$("#showTopBtn").removeClass("prag-sticky-hide")):($("#showTopBtn").addClass("prag-sticky-hide"),$("#showTopBtn").removeClass("prag-sticky-bot"))})})})</script><div class=blog-post-main><p>We are going to discover the <a href=https://www.databricks.com/product/delta-live-tables>Delta Live Tables</a> framework with the <a href=https://docs.databricks.com/data-governance/unity-catalog/index.html>Unity Catalog</a> solution (instead of the Hive Metastore).</p><p>We&rsquo;re going to focus on the specific elements from the Unity Catalog solution.</p><p>The use of the Unity Catalog solution with the Delta Live Tables framework was in &ldquo;Public Preview&rdquo; at the time of writing this article in early June 2023.</p><p>We&rsquo;re going to use a Databricks account on AWS to make this discovery.</p><h1 id=whats-delta-live-tables>What&rsquo;s Delta Live Tables</h1><h2 id=overview>Overview</h2><p>Delta Live Tables is a declarative framework for defining all the elements of an ETL processing pipeline.</p><p>This framework allows you to work in <a href=https://docs.databricks.com/delta-live-tables/python-ref.html>Python</a> or <a href=https://docs.databricks.com/delta-live-tables/sql-ref.html>SQL</a>.</p><p>This framework lets you define objects in a Python script or in a Python or SQL notebook, which is then executed by a DLT (Delta Live Tables) pipeline using the &ldquo;Workflows&rdquo; functionality.</p><p>This framework is based on the following three types of objects to manage the orchestration of all the tasks in a DLT pipeline :</p><ul><li><strong>Streaming Table</strong> : This corresponds to the SQL term <code>STREAMING TABLE &lt;objet></code></li><li><strong>Materialized View</strong> : This corresponds to the SQL term <code>LIVE TABLE &lt;objet></code></li><li><strong>View</strong> : This corresponds to the SQL term <code>TEMPORARY LIVE VIEW &lt;objet></code> or <code>TEMPORARY STREAMING LIVE VIEW &lt;objet></code></li></ul><p>You could find full details of costs and features available for each edition type with <a href=https://www.databricks.com/product/pricing/delta-live>this link</a>
A concise overview of the different editions :</p><ul><li>DLT Core :<ul><li>Allows you to manage basic functionality</li></ul></li><li>DLT Pro :<ul><li>Allows you to manage all the functions of the &ldquo;DLT Core&rdquo; edition, including Change Data Capture (CDC) and Slow Changing Dimension (SCD) type 2 object (very useful for simplifying referential data management when you want to keep track of changes)</li></ul></li><li>DLT Advanced :<ul><li>Allows you to manage all the functions of the &ldquo;DLT Pro&rdquo; edition, as well as all data quality management functions (mainly the definition of constraints (expectations) and their observability (metrics)).</li></ul></li></ul><h2 id=regarding-objects>Regarding objects</h2><p>Regarding the <strong>Streaming Table</strong> object :</p><ul><li>This object can be used to manage the streaming of a data source and read a record only once (Spark Structured Streaming).</li><li>Element management (checkpoint, etc.) is handled by default by the DLT framework.</li><li>Data source must be append-only</li><li>If the data source is managed with <a href=https://docs.databricks.com/ingestion/auto-loader/index.html>Auto Loader</a>, an additional column named <code>_rescued_data</code> will be created by default to handle malformed data.</li><li>Expectations can be defined at object level</li><li>To read a &ldquo;Streaming table&rdquo; object in the same DLT pipeline, use the syntax <code>STREAM(LIVE.&lt;object>)</code> (SQL) or <code>dlt.read_stream("&lt;object>")</code> (Python).</li><li>It is possible to define the ingestion of data from a &ldquo;Streaming Table&rdquo; object with a type 2 Slow Changing Dimension process automatically managed by the DLT framework.<ul><li>This makes it very easy to set up history management for referential data from a source using CDC (Change Data Capture) or CDF (Change Data Feed).</li></ul></li><li>Since objects are managed by the DLT framework when a DLT pipeline is executed, it&rsquo;s not recommended to changes data (update, delete, insert) outside the DLT pipeline.<ul><li>It is possible to perform modifications (DML-type queries) with certain limitations on &ldquo;Streaming Table&rdquo; objects, but this is not recommended and not all operations are supported.</li></ul></li></ul><p>Regarding the <strong>Materialized View</strong> object :</p><ul><li>This object is used to manage the refresh of object data according to its state when the DLT pipeline is executed. The DLT framework defines what it should update according to the state of the sources and the target.</li><li>Expectations can be defined at object level</li><li>To read a &ldquo;Materialized View&rdquo; object in the same DLT pipeline, use the syntax <code>LIVE.&lt;object></code> (SQL) or <code>dlt.read("&lt;object>")</code> (Python).</li><li>It is not possible to execute DML (Update, Delete, Insert) queries on a &ldquo;Materialized View&rdquo; object, as the accessible object is not defined as a Delta table.</li><li>To read a &ldquo;Materialized View&rdquo; object outside the DLT pipeline, you need to use a Shared Cluster or a SQL Warehouse Pro or Serverless (recommended).</li></ul><p>Regarding the <strong>View</strong> object :</p><ul><li>This object is used to define a temporary view (encapsulated query) of a data source, which will only exist during execution of the DLT pipeline.</li><li>The encapsulated query is executed each time the object is read</li><li>Expectations can be defined at object level</li></ul><h2 id=regarding-data-quality-management>Regarding data quality management</h2><p>Data quality management is done by declaring constraints (expectations) on objects:</p><ul><li>SQL Syntax : <code>CONSTRAINT expectation_name EXPECT (expectation_expr) [ON VIOLATION { FAIL UPDATE | DROP ROW }]</code></li></ul><p>When you define a constraint (expectation) on an object, the DLT framework will check when ingesting the record and perform the defined action :</p><ul><li><code>CONSTRAINT expectation_name EXPECT (expectation_expr)</code> : When there is no action defined, the records not respecting the constraint will be inserted in the object and information will be added in the event logs of the DLT pipeline with the number of records concerned for this object.</li><li><code>CONSTRAINT expectation_name EXPECT (expectation_expr) ON VIOLATION FAIL UPDATE</code> : When the action defined is &ldquo;FAIL UPDATE&rdquo;, the DLT pipeline will stop in error at the first record not respecting the constraint with the error message in the event logs of the DLT pipeline.</li><li><code>CONSTRAINT expectation_name EXPECT (expectation_expr) ON VIOLATION DROP ROW</code> : When the action defined is &ldquo;DROP ROW&rdquo;, the records that do not respect the constraint will not be inserted into the object and information will be added in the event logs of the DLT pipeline with the number of records concerned for this object.</li></ul><h2 id=regarding-dlt-pipeline>Regarding DLT pipeline</h2><p>In order to be able to run a script (Python) or notebook (SQL or Python) with the DLT framework, it is necessary to create a DLT pipeline specifying the desired edition.</p><p>The definition of the DLT pipeline is done using the &ldquo;Workflows&rdquo; functionality.
Access is as follows :</p><ol><li>Click on the &ldquo;Data Science & Engineering&rdquo; view in the sidebar</li><li>Click on &ldquo;Workflows&rdquo; option in the sidebar</li><li>Click on the &ldquo;Delta Live Tables&rdquo; tab
<a href=/blog/web/20230612_databricks_unity_catalog_deltalivetables_01.png><img src=/blog/web/20230612_databricks_unity_catalog_deltalivetables_01.png alt=schema_01></a></li></ol><p>From this screen, you will be able to manage DLT pipelines (creation, deletion, configuration, modification) and view the different executions (within the limit of the observability data retention period defined for each pipeline)
<a href=/blog/web/20230612_databricks_unity_catalog_deltalivetables_02.png><img src=/blog/web/20230612_databricks_unity_catalog_deltalivetables_02.png alt=schema_02></a></p><p>Useful information for creating a DLT pipeline:</p><ul><li>General :<ul><li>Product edition : Edition to be chosen among DLT Core, DLT Pro and DLT Advanced, this will define the usable functionalities as well as one of the criteria of the cost of the DLT pipeline execution</li><li>Pipeline mode :<ul><li>Triggered : Allows to manage the execution in batch mode and therefore to stop the cluster after execution of the DLT pipeline</li><li>Continuous : Allows to manage the execution in streaming mode and therefore to execute the pipeline continuously to process the data as soon as it arrives.</li></ul></li></ul></li><li>Source Code : Allows to define the script (Python) or the Notebook (Python or SQL) to be executed by the DLT pipeline</li><li>Destination<ul><li>Storage Option : Choose Unity Catalog to use the Unity Catalog solution with the DLT framework</li><li>Catalog : Define the target catalog for the DLT pipeline (catalog that contains the target schema of the DLT pipeline)</li><li>Target schema : Define the target schema for the DLT pipeline (schema that will be used to manage DLT pipeline objects)</li></ul></li><li>Compute<ul><li>Cluster mode : To define whether you want a fixed number of workers (Fixed size) or which adapts to the workload within the limits indicated (Enhanced autoscaling, Legacy autoscaling)</li><li>Workers : Allows you to define the number of workers if the mode is fixed or the minimum and maximum number of workers if the mode is not fixed</li></ul></li></ul><p>Useful information after creating the DLT pipeline :</p><ul><li>Execution Mode :<ul><li>Development : In this mode, the cluster used by the DLT pipeline will stop only after 2h (by default) to avoid the restart time of a cluster and there is no automatic restart management.<ul><li>It is possible to modify the delay time before cluster shutdown by configuring the parameter <code>pipelines.clusterShutdown.delay</code> with the desired value (for example &ldquo;300s&rdquo; for 5 minutes)</li><li>Example : <code>{"configuration": {"pipelines.clusterShutdown.delay": "300s"}})</code></li></ul></li><li>Production : In this mode, the cluster stops automatically after the execution of the DLT pipeline and it restarts automatically in the event of a technical issue (memory leak, authorizations, startup, etc.)</li></ul></li><li>Schedule :<ul><li>Allows you to define a trigger constraint for the DLT pipeline execution</li></ul></li><li>Execution :<ul><li>Start : To run the DLT pipeline considering only new available data</li><li>Start with Full refresh all : To run the DLT pipeline considering all available data</li><li>Select tables for refresh : To define the objects that we want to update during the DLT pipeline execution (partial execution)</li></ul></li></ul><p>Warning :</p><ul><li>It is not possible to run the defined script or notebook locally or with a Databricks cluster.<ul><li>You will get the following message : <code>This Delta Live Tables query is syntactically valid, but you must create a pipeline in order to define and populate your table.</code></li></ul></li><li>A DLT pipeline corresponds to one script or one notebook only, therefore if you want to run several scripts or notebooks, you must use the &ldquo;Job&rdquo; feature (from the &ldquo;Workflows&rdquo; feature) to orchestrate the execution of several DLT pipelines.<ul><li>Execute the &ldquo;Job&rdquo; will run the DLT pipelines with the defined constraints and orchestration</li></ul></li><li>It is only possible to access an object with the syntax of the DLT framework within the same DLT pipeline, if you need to read an object outside the DLT pipeline then it will be accessed as an external object and he will not be tracked in the graph and in the event logs of the DLT pipeline.<ul><li>Syntax for accessing an object within the same DLT pipeline : <code>dlt.read(&lt;object>)</code> or <code>dlt.read_stream(&lt;object>)</code> with Python and <code>LIVE.&lt;object></code> or <code>STREAM(LIVE.&lt;object>)</code> with SQL.</li></ul></li></ul><p>Regarding the data management associated with a DLT pipeline (maintenance) :</p><ul><li>The DLT framework performs automatic maintenance of each object (Delta table) updated within 24h after the last execution of a DLT pipeline.<ul><li>By default, the system performs a full OPTIMIZE operation, followed by a VACUUM operation</li><li>If you do not want a Delta table to be automated by default, you must use the <code>pipelines.autoOptimize.managed = false</code> property when defining the object (TBLPROPERTIES).</li></ul></li></ul><p>Restrictions :</p><ul><li>It is not possible to mix the use of Hive Metastore with the Unity Catalog solution or to switch between the two metastores for the target of the DLT pipeline after its creation.</li><li>All tables created and updated by a DLT pipeline are Delta tables</li><li>Objects managed by the DLT framework can only be defined once, that means they can only be the target in one DLT pipeline only (can&rsquo;t define the same object in the same target schema in two different DLT pipelines )</li><li>A Databricks Workspace is limited to 100 DLT pipeline updates</li></ul><h1 id=how-it-works-with-unity-catalog>How it works with Unity Catalog</h1><h2 id=overview-1>Overview</h2><p>In order to use Unity Catalog, when creating the DLT pipeline you must fill the destination with the Unity Catalog information (with target catalog and target schema).</p><p>It is not possible to use the recommended &ldquo;three namespaces&rdquo; notation <code>catalog.schema.object</code> to access an object managed by the DLT framework.
Objects are defined by name only, and it is the definition of the target catalog and target schema in the DLT pipeline that defines where the objects will be created.
Note: read access to objects not managed by the DLT framework is possible using classic spark syntax (<code>spark.table("catalog.schema.object")</code>).</p><p>In order to use Unity Catalog with Delta Live Tables, you must have the following rights as the owner of the DLT pipeline :</p><ul><li>You must have &ldquo;USE CATALOG&rdquo; rights on the target catalog</li><li>You must have &ldquo;USE SCHEMA&rdquo; rights on the target schema</li><li>You must have &ldquo;CREATE MATERIALIZED VIEW&rdquo; rights on the target schema to be able to create &ldquo;Materialized View&rdquo; objects</li><li>You must have &ldquo;CREATE TABLE&rdquo; rights on the target schema to be able to create &ldquo;Streaming table&rdquo; objects</li></ul><p>Advice on file ingestion :</p><ul><li>When retrieving information (metadata) about ingested files, it is not possible to use the <code>input_file_name</code> function, which is not supported by Unity Catalog.<ul><li>Use the <code>_metadata</code> column to retrieve the necessary information, such as the file name <code>_metadata.file_name</code></li><li>You will find the list of information available in the <code>_metadata</code> column on the <a href=https://docs.databricks.com/ingestion/file-metadata-column.html>official documentation</a></li></ul></li></ul><h2 id=regarding-object-management-by-the-dlt-framework-during-dlt-pipeline-execution>Regarding object management by the DLT framework (during DLT pipeline execution)</h2><p>In reality, when you define an object with the DLT framework, an object will be created in the target schema indicated in the DLT pipeline (with a specific type that will not be a Delta table directly) and a Delta table will be created in an internal schema (managed by the system and not accessible by default to users) to manage the storage of data from the object defined with the DLT framework.
The internal schema is located in the catalog named <code>__databricks__internal</code> and owned by <code>System</code>.
The default schema name is : <code>__dlt_materialization_schema_&lt;pipeline_id></code>.
In this schema, you&rsquo;ll find all the Delta tables whose storage is managed directly by the DLT framework (the owner of the Delta tables is the owner of the DLT pipeline), as well as the Delta table <code>__event_log</code>, which will contain all the event logs of DLT pipeline executions.
<a href=/blog/web/20230612_databricks_unity_catalog_deltalivetables_03.png><img src=/blog/web/20230612_databricks_unity_catalog_deltalivetables_03.png alt=schema_03></a></p><p>Example of the definition of a &ldquo;Streaming Table&rdquo; object in the &ldquo;ctg.sch&rdquo; schema in a DLT pipeline whose identifier is &ldquo;0000&rdquo;. The data management will be done as follows:</p><ol><li>Creating a Delta table (with a unique identifier) ​​in an internal system-maintained schema named <code>__databricks__internal.__dlt_materialization_schema_0000</code><ol><li>With subdirectory (at the Delta data storage level) <code>_dlt_metadata</code> containing a <code>checkpoints</code> directory to manage the information needed to manage streaming data ingestion</li></ol></li><li>Creation of an object of type &ldquo;STREAMING_TABLE&rdquo; in the schema &ldquo;ctg.sch&rdquo; which refers to the Delta table created in the internal schema <code>__databricks__internal.__dlt_materialization_schema_0000</code><ol><li>This allows accessing data from the internal Delta table with some constraints</li></ol></li></ol><p>Example of the definition of a &ldquo;Materialized View&rdquo; object in the &ldquo;ctg.sch&rdquo; schema in a DLT pipeline whose identifier is &ldquo;0000&rdquo;. The data management will be done as follows:</p><ol><li>Creating a Delta table (with a unique identifier) ​​in an internal system-maintained schema named <code>__databricks__internal.__dlt_materialization_schema_0000</code><ol><li>With subdirectory (at the Delta data storage level) <code>_dlt_metadata</code> containing a <code>_enzyme_log</code> directory to manage the information needed by the Enzyme Project to manage the refresh of object data</li></ol></li><li>Creation of an object of type &ldquo;MATERIALIZED_VIEW&rdquo; in the schema &ldquo;ctg.sch&rdquo; which refers to the Delta table created in the internal schema <code>__databricks__internal.__dlt_materialization_schema_0000</code><ol><li>This allows accessing data from the internal Delta table with some constraints</li></ol></li></ol><p>Note: The &ldquo;View&rdquo; object does not require object creation in the target or internal schema.</p><h2 id=restrictions>Restrictions</h2><p>It is also possible to take advantage of the Data Lineage functionality of the Unity Catalog solution with the following limitations:</p><ul><li>There is no trace of source objects that are not defined in a DLT pipeline, so the lineage view is incomplete when the DLT pipeline does not contain all elements.<ul><li>For example, if a referential data source is used as the source of a &ldquo;Materialized View&rdquo; object, the lineage will not have the information about this source.</li></ul></li><li>Lineage doesn&rsquo;t take temporary views into account, and this can prevent a link being made between the view sources and the target object.</li></ul><p>Limitations (non-exhaustive) when using Unity Catalog with Delta Live Table :</p><ul><li>It is not possible to change the owner of a pipeline using Unity Catalog.</li><li>Objects are managed/stored only in Unity Catalog&rsquo;s default Metastore storage, it is not possible to define another path (managed or external).</li><li>Delta Sharing cannot be used with objects managed by the DLT framework.</li><li>DLT pipeline event logs can only be read by the DLT pipeline (by default).</li><li>Access to data on certain objects can only be made using a SQL Warehouse (Pro or Serverless) or a Cluster (Shared).</li></ul><h1 id=set-up-the-environment>Set-up the environment</h1><h2 id=context>Context</h2><p>Prerequisite :</p><ul><li>Creation of the <code>grp_demo</code> group</li><li>Create <code>john.do.dbx@gmail.com</code> user and add user to <code>grp_demo</code> group.</li><li>Create a SQL Warehouse and give use rights to the <code>grp_demo</code> group</li><li>Metastore named <code>metastore-sandbox</code> with Storage Credential named <code>sc-metastore-sandbox</code> to store default data in AWS S3 resource named <code>s3-dbx-metastore-uc</code>.</li><li>Add the right to create a catalog on the Metastore Unity Catalog and the right to access files</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>GRANT</span> <span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>CATALOG</span> <span style=color:#ff79c6>on</span> METASTORE <span style=color:#ff79c6>to</span> grp_demo;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#ff79c6>GRANT</span> <span style=color:#ff79c6>SELECT</span> <span style=color:#ff79c6>ON</span> <span style=color:#ff79c6>ANY</span> FILE <span style=color:#ff79c6>TO</span> grp_demo;
</span></span></code></pre></div><p>To make the examples easier to understand, we&rsquo;ll use the following list of environment variables:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4># Create an alias to use the tool curl with .netrc file</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#8be9fd;font-style:italic>alias</span> dbx-api<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#39;curl --netrc-file ~/.databricks/.netrc&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#6272a4># Create an environment variable with Databricks API URL</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;&lt;Workspace Databricks AWS URL&gt;&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#6272a4># Init local variables</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>LOC_PATH_SCRIPT</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;&lt;Local Path for the folder with the Python script&gt;&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>LOC_PATH_DATA</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;&lt;Local Path for the folder with the CSV files&gt;&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#6272a4># Name for DLT Script (Python)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>LOC_SCRIPT_DLT</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;dlt_pipeline.py&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#6272a4># List CSV files for the first execution</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>LOC_SCRIPT_DATA_1</span><span style=color:#ff79c6>=(</span>ref_products_20230501.csv ref_clients_20230501.csv fct_transactions_20230501.csv<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#6272a4># List CSV viles for the second execution</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>LOC_SCRIPT_DATA_2</span><span style=color:#ff79c6>=(</span>ref_clients_20230601.csv fct_transactions_20230601.csv<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#6272a4># Init Databricks variables (Workspace)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#6272a4># Path to store the CSV files</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>DBX_PATH_DATA</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;dbfs:/mnt/dlt_demo/data&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#6272a4># Name for the DLT pipeline</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>DBX_DLT_PIPELINE_NAME</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;DLT_pipeline_demo&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#6272a4># DLT pipeline Target Catalog</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>DBX_UC_CATALOG</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;CTG_DLT_DEMO&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span><span style=color:#6272a4># DLT pipeline Target Schema</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>DBX_UC_SCHEMA</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;SCH_DLT_DEMO&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span><span style=color:#6272a4># Path to store the DLT Script (Python)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>DBX_USER_NBK_PATH</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;/Users/john.do.dbx@gmail.com&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span><span style=color:#6272a4># Init Pipeline variable</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>DBX_DLT_PIPELINE_ID</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;&#34;</span>
</span></span></code></pre></div><h2 id=schématisation-de-lenvironnement>Schématisation de l&rsquo;environnement</h2><p>Diagram of the DLT pipeline we are going to set up :
<a href=/blog/web/20230612_databricks_unity_catalog_deltalivetables_04.png><img src=/blog/web/20230612_databricks_unity_catalog_deltalivetables_04.png alt=schema_04></a></p><p>Details of the DLT pipeline:</p><ul><li>Stream product referential data from CSV file (ref_products_YYYMMDD.csv) to a &ldquo;Streaming Table&rdquo; object named &ldquo;REF_PRODUCTS_RAW&rdquo;.</li><li>Stream data from the &ldquo;REF_PRODUCTS_RAW&rdquo; object to a &ldquo;Streaming Table&rdquo; object named &ldquo;REF_PRODUCTS&rdquo;.</li><li>Stream customer referential data from CSV file (ref_clients_YYYMMDD.csv) to a &ldquo;Streaming Table&rdquo; object named &ldquo;REF_CLIENTS_RAW&rdquo; (with Change Data Feed enabled)</li><li>Stream data from the &ldquo;REF_PRODUCTS_RAW&rdquo; object to a &ldquo;Streaming Table&rdquo; object using SCD Type 2 functionality and named &ldquo;REF_CLIENTS&rdquo;.<ul><li>Using a view named &ldquo;REF_CLIENTS_CAST&rdquo; to transform upstream data</li></ul></li><li>Stream transaction data from CSV file (fct_transactions_YYYMMDD.csv) to a &ldquo;Streaming Table&rdquo; object named &ldquo;FCT_TRX_RAW&rdquo;.</li><li>Ingest data in a &ldquo;Streaming Table&rdquo; object named &ldquo;FCT_TRX&rdquo; from the &ldquo;FCT_TRX_RAW&rdquo; object, applying a constraint on the &ldquo;quantity&rdquo; information which must not be equal to 0.</li><li>Feed a &ldquo;Materialized View&rdquo; object named &ldquo;FCT_TRX_AGG_MONTH&rdquo; from the &ldquo;FCT_TRX&rdquo;, &ldquo;REF_CLIENTS&rdquo; and &ldquo;REF_PRODUCTS&rdquo; objects to aggregate sales by month, customer and product.</li></ul><h2 id=setting-up-a-dataset>Setting up a dataset</h2><p>The dataset will be build of two batches in order to run two executions and put data refreshment into practice.</p><p>Dataset for batch n°1 (first execution of the DLT pipeline) :<br>Content of the file <code>ref_clients_20230501.csv</code> :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>id,lib,age,contact,phone,is_member,last_maj
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>1,Maxence,23,max1235@ter.tt,+33232301123,No,2023-01-01 11:01:02
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>2,Bruce,26,br_br@ter.tt,+33230033155,Yes,2023-01-01 13:01:00
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>3,Charline,40,ccccharline@ter.tt,+33891234192,Yes,2023-03-02 09:00:00
</span></span></code></pre></div><p>Content of the file <code>ref_products_20230501.csv</code> :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>id,lib,brand,os,last_maj
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>1,Pixel 7 Pro,Google,Android,2023-01-01 09:00:00
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>2,Iphone 14,Apple,IOS,2023-01-01 09:00:00
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>3,Galaxy S23,Samsung,Android,2023-01-01 09:00:00
</span></span></code></pre></div><p>Content of the file <code>fct_transactions_20230501.csv</code> :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>id_trx,ts_trx,id_product,id_shop,id_client,quantity
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>1,2023-04-01 09:00:00,1,2,1,1
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>2,2023-04-01 11:00:00,1,1,1,3
</span></span></code></pre></div><p>Dataset for batch n°2 (second execution of the DLT pipeline) :<br>Content of the file <code>ref_clients_20230601.csv</code> :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>id,lib,age,contact,phone,is_member,last_maj
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>2,Bruce,26,br_br@ter.tt,+33990033100,Yes,2023-04-01 12:00:00
</span></span></code></pre></div><p>Content of the file <code>fct_transactions_20230601.csv</code> :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>id_trx,ts_trx,id_product,id_shop,id_client,quantity
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>3,2023-04-03 14:00:00,1,2,1,1
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>4,2023-04-05 08:00:00,3,1,2,9
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>5,2023-04-06 10:00:00,1,2,1,3
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>6,2023-04-06 12:00:00,2,2,1,1
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>7,2023-01-01 13:00:00,1,2,1,0
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>8,2023-04-10 18:30:00,2,1,2,11
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>9,2023-04-10 18:30:00,3,1,2,2
</span></span></code></pre></div><h2 id=setting-up-the-objects-on-the-unity-catalog-metastore>Setting up the objects on the Unity Catalog Metastore</h2><p>Steps for creating the necessary objects :</p><ol><li>Create a catalog named <code>ctg_dlt_demo</code>.</li><li>Create a schema named <code>sch_dlt_demo</code>.</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>-- 1. Create Catalog
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>CATALOG</span> <span style=color:#ff79c6>IF</span> <span style=color:#ff79c6>NOT</span> <span style=color:#ff79c6>EXISTS</span> ctg_dlt_demo
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#ff79c6>COMMENT</span> <span style=color:#f1fa8c>&#39;Catalog to store the dlt demo objects&#39;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#6272a4>-- 2. Create Schema
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>SCHEMA</span> <span style=color:#ff79c6>IF</span> <span style=color:#ff79c6>NOT</span> <span style=color:#ff79c6>EXISTS</span> ctg_dlt_demo.sch_dlt_demo
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span><span style=color:#ff79c6>COMMENT</span> <span style=color:#f1fa8c>&#39;Schema to store the dlt demo objects&#39;</span>;
</span></span></code></pre></div><h2 id=creation-of-the-python-script-containing-the-objects-definition-for-the-dlt-framework>Creation of the python script containing the objects definition for the DLT framework</h2><p>The script is named <code>dlt_pipeline.py</code> and will be copied to the Databricks Workspace (it will be used by the DLT pipeline).</p><p>The Python script contains the following code :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1</span><span><span style=color:#f1fa8c>&#34;&#34;&#34;Pipeline DLT demo&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2</span><span><span style=color:#ff79c6>import</span> dlt
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3</span><span><span style=color:#ff79c6>from</span> pyspark.sql.functions <span style=color:#ff79c6>import</span> col, current_timestamp, expr, <span style=color:#8be9fd;font-style:italic>sum</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5</span><span><span style=color:#6272a4># Folder to store data for the demo</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6</span><span>PATH_DATA <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;dbfs:/mnt/dlt_demo/data&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9</span><span><span style=color:#6272a4>###################</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10</span><span><span style=color:#6272a4>## Products Data ##</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11</span><span><span style=color:#6272a4>###################</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13</span><span><span style=color:#6272a4># Create the streaming table named REF_PRODUCTS_RAW</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14</span><span>@dlt.table(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15</span><span>  name<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;REF_PRODUCTS_RAW&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16</span><span>  comment<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;Raw Products Referential Data&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17</span><span>  table_properties<span style=color:#ff79c6>=</span>{<span style=color:#f1fa8c>&#34;quality&#34;</span> : <span style=color:#f1fa8c>&#34;bronze&#34;</span>},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18</span><span>  temporary<span style=color:#ff79c6>=</span><span style=color:#ff79c6>False</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19</span><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>get_products_raw</span>():
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20</span><span>    <span style=color:#ff79c6>return</span> spark<span style=color:#ff79c6>.</span>readStream<span style=color:#ff79c6>.</span>format(<span style=color:#f1fa8c>&#34;cloudFiles&#34;</span>) \
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21</span><span>                <span style=color:#ff79c6>.</span>option(<span style=color:#f1fa8c>&#34;cloudFiles.format&#34;</span>, <span style=color:#f1fa8c>&#34;csv&#34;</span>) \
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22</span><span>                <span style=color:#ff79c6>.</span>option(<span style=color:#f1fa8c>&#34;delimiter&#34;</span>,<span style=color:#f1fa8c>&#34;,&#34;</span>) \
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23</span><span>                <span style=color:#ff79c6>.</span>option(<span style=color:#f1fa8c>&#34;header&#34;</span>,<span style=color:#f1fa8c>&#34;true&#34;</span>) \
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24</span><span>                <span style=color:#ff79c6>.</span>load(PATH_DATA<span style=color:#ff79c6>+</span><span style=color:#f1fa8c>&#34;/ref_products_*.csv&#34;</span>) \
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25</span><span>                <span style=color:#ff79c6>.</span>select(<span style=color:#f1fa8c>&#34;*&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26</span><span>                        ,col(<span style=color:#f1fa8c>&#34;_metadata.file_name&#34;</span>)<span style=color:#ff79c6>.</span>alias(<span style=color:#f1fa8c>&#34;source_file&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27</span><span>                        ,current_timestamp()<span style=color:#ff79c6>.</span>alias(<span style=color:#f1fa8c>&#34;processing_time&#34;</span>))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29</span><span><span style=color:#6272a4># Create the streaming table named REF_PRODUCTS</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30</span><span>@dlt.table(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31</span><span>  name<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;REF_PRODUCTS&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32</span><span>  comment<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;Products Referential Data&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33</span><span>  table_properties<span style=color:#ff79c6>=</span>{<span style=color:#f1fa8c>&#34;quality&#34;</span> : <span style=color:#f1fa8c>&#34;silver&#34;</span>},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34</span><span>  temporary<span style=color:#ff79c6>=</span><span style=color:#ff79c6>False</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35</span><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>get_products</span>():
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36</span><span>   <span style=color:#ff79c6>return</span> dlt<span style=color:#ff79c6>.</span>read_stream(<span style=color:#f1fa8c>&#34;REF_PRODUCTS_RAW&#34;</span>) \
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37</span><span>            <span style=color:#ff79c6>.</span>where(<span style=color:#f1fa8c>&#34;_rescued_data is null&#34;</span>) \
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38</span><span>            <span style=color:#ff79c6>.</span>select(col(<span style=color:#f1fa8c>&#34;id&#34;</span>)<span style=color:#ff79c6>.</span>cast(<span style=color:#f1fa8c>&#34;INT&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39</span><span>                    ,col(<span style=color:#f1fa8c>&#34;lib&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40</span><span>                    ,col(<span style=color:#f1fa8c>&#34;brand&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41</span><span>                    ,col(<span style=color:#f1fa8c>&#34;os&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42</span><span>                    ,col(<span style=color:#f1fa8c>&#34;last_maj&#34;</span>)<span style=color:#ff79c6>.</span>cast(<span style=color:#f1fa8c>&#34;TIMESTAMP&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43</span><span>                    ,col(<span style=color:#f1fa8c>&#34;source_file&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44</span><span>                    ,col(<span style=color:#f1fa8c>&#34;processing_time&#34;</span>))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47</span><span><span style=color:#6272a4>###################</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48</span><span><span style=color:#6272a4>## Clients Data ##</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49</span><span><span style=color:#6272a4>##################</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51</span><span><span style=color:#6272a4># Create the streaming table named REF_CLIENTS_RAW</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52</span><span>@dlt.table(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53</span><span>  name<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;REF_CLIENTS_RAW&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54</span><span>  comment<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;Raw Clients Referential Data&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55</span><span>  table_properties<span style=color:#ff79c6>=</span>{<span style=color:#f1fa8c>&#34;quality&#34;</span> : <span style=color:#f1fa8c>&#34;bronze&#34;</span>, <span style=color:#f1fa8c>&#34;delta.enableChangeDataFeed&#34;</span> : <span style=color:#f1fa8c>&#34;true&#34;</span>},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56</span><span>  temporary<span style=color:#ff79c6>=</span><span style=color:#ff79c6>False</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57</span><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>get_products_raw</span>():
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58</span><span>    <span style=color:#ff79c6>return</span> spark<span style=color:#ff79c6>.</span>readStream<span style=color:#ff79c6>.</span>format(<span style=color:#f1fa8c>&#34;cloudFiles&#34;</span>) \
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59</span><span>                <span style=color:#ff79c6>.</span>option(<span style=color:#f1fa8c>&#34;cloudFiles.format&#34;</span>, <span style=color:#f1fa8c>&#34;csv&#34;</span>) \
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60</span><span>                <span style=color:#ff79c6>.</span>option(<span style=color:#f1fa8c>&#34;delimiter&#34;</span>,<span style=color:#f1fa8c>&#34;,&#34;</span>) \
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61</span><span>                <span style=color:#ff79c6>.</span>option(<span style=color:#f1fa8c>&#34;header&#34;</span>,<span style=color:#f1fa8c>&#34;true&#34;</span>) \
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62</span><span>                <span style=color:#ff79c6>.</span>load(PATH_DATA<span style=color:#ff79c6>+</span><span style=color:#f1fa8c>&#34;/ref_clients_*.csv&#34;</span>) \
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63</span><span>                <span style=color:#ff79c6>.</span>select(<span style=color:#f1fa8c>&#34;*&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64</span><span>                        ,col(<span style=color:#f1fa8c>&#34;_metadata.file_name&#34;</span>)<span style=color:#ff79c6>.</span>alias(<span style=color:#f1fa8c>&#34;source_file&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65</span><span>                        ,current_timestamp()<span style=color:#ff79c6>.</span>alias(<span style=color:#f1fa8c>&#34;processing_time&#34;</span>))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67</span><span><span style=color:#6272a4># Create the temporary view named REF_CLIENTS_RAW_CAST</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68</span><span>@dlt.view(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69</span><span>      name<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;REF_CLIENTS_RAW_CAST&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70</span><span>      ,comment<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;Temp view for Clients Raw Casting&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71</span><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>view_clients_cast</span>():
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72</span><span>  <span style=color:#ff79c6>return</span> dlt<span style=color:#ff79c6>.</span>read_stream(<span style=color:#f1fa8c>&#34;REF_CLIENTS_RAW&#34;</span>) \
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73</span><span>            <span style=color:#ff79c6>.</span>select(expr(<span style=color:#f1fa8c>&#34;cast(id as INT) as id&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74</span><span>                    ,col(<span style=color:#f1fa8c>&#34;lib&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75</span><span>                    ,expr(<span style=color:#f1fa8c>&#34;cast(age as INT) as age&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76</span><span>                    ,col(<span style=color:#f1fa8c>&#34;contact&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77</span><span>                    ,col(<span style=color:#f1fa8c>&#34;phone&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78</span><span>                    ,expr(<span style=color:#f1fa8c>&#34;(is_member = &#39;Yes&#39;) as is_member&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79</span><span>                    ,expr(<span style=color:#f1fa8c>&#34;cast(last_maj as timestamp) as last_maj&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80</span><span>                    ,col(<span style=color:#f1fa8c>&#34;source_file&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81</span><span>                    ,col(<span style=color:#f1fa8c>&#34;processing_time&#34;</span>))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83</span><span><span style=color:#6272a4># Create the streaming table named REF_CLIENTS (and using SCD Type 2 management)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84</span><span>dlt<span style=color:#ff79c6>.</span>create_streaming_table(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85</span><span>  name <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;REF_CLIENTS&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86</span><span>  comment <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;Clients Referential Data (SCD2)&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87</span><span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89</span><span><span style=color:#6272a4># Apply modification (for SCD Type 2 management) based on the temporary view</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90</span><span>dlt<span style=color:#ff79c6>.</span>apply_changes(target <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;REF_CLIENTS&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91</span><span>                source <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;REF_CLIENTS_RAW_CAST&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92</span><span>                keys <span style=color:#ff79c6>=</span> [<span style=color:#f1fa8c>&#34;id&#34;</span>],
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93</span><span>                sequence_by <span style=color:#ff79c6>=</span> col(<span style=color:#f1fa8c>&#34;last_maj&#34;</span>),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94</span><span>                stored_as_scd_type <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>2</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97</span><span><span style=color:#6272a4>#######################</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98</span><span><span style=color:#6272a4>## Transactions Data ##</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99</span><span><span style=color:#6272a4>#######################</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">100</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">101</span><span><span style=color:#6272a4># Create the streaming table named FCT_TRX_RAW</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">102</span><span>@dlt.table(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">103</span><span>    name<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;FCT_TRX_RAW&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">104</span><span>    comment<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;Raw Transactions Fact Data&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">105</span><span>    table_properties<span style=color:#ff79c6>=</span>{<span style=color:#f1fa8c>&#34;quality&#34;</span> : <span style=color:#f1fa8c>&#34;bronze&#34;</span>},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">106</span><span>    partition_cols<span style=color:#ff79c6>=</span>[<span style=color:#f1fa8c>&#34;dt_tech&#34;</span>],
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">107</span><span>    temporary<span style=color:#ff79c6>=</span><span style=color:#ff79c6>False</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">108</span><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>get_transactions_raw</span>():
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">109</span><span>    <span style=color:#ff79c6>return</span> spark<span style=color:#ff79c6>.</span>readStream<span style=color:#ff79c6>.</span>format(<span style=color:#f1fa8c>&#34;cloudFiles&#34;</span>) \
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">110</span><span>                <span style=color:#ff79c6>.</span>option(<span style=color:#f1fa8c>&#34;cloudFiles.format&#34;</span>, <span style=color:#f1fa8c>&#34;csv&#34;</span>) \
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">111</span><span>                <span style=color:#ff79c6>.</span>option(<span style=color:#f1fa8c>&#34;delimiter&#34;</span>,<span style=color:#f1fa8c>&#34;,&#34;</span>) \
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">112</span><span>                <span style=color:#ff79c6>.</span>option(<span style=color:#f1fa8c>&#34;header&#34;</span>,<span style=color:#f1fa8c>&#34;true&#34;</span>) \
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">113</span><span>                <span style=color:#ff79c6>.</span>load(PATH_DATA<span style=color:#ff79c6>+</span><span style=color:#f1fa8c>&#34;/fct_transactions_*.csv&#34;</span>) \
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">114</span><span>                <span style=color:#ff79c6>.</span>select(<span style=color:#f1fa8c>&#34;*&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">115</span><span>                        ,col(<span style=color:#f1fa8c>&#34;_metadata.file_name&#34;</span>)<span style=color:#ff79c6>.</span>alias(<span style=color:#f1fa8c>&#34;source_file&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">116</span><span>                        ,current_timestamp()<span style=color:#ff79c6>.</span>alias(<span style=color:#f1fa8c>&#34;processing_time&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">117</span><span>                        ,expr(<span style=color:#f1fa8c>&#34;current_date() as dt_tech&#34;</span>))\
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">118</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">119</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">120</span><span><span style=color:#6272a4># Create the streaming table named FCT_TRX (with expectation)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">121</span><span>@dlt.table(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">122</span><span>    name<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;FCT_TRX&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">123</span><span>    comment<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;Transactions Fact Data&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">124</span><span>    table_properties<span style=color:#ff79c6>=</span>{<span style=color:#f1fa8c>&#34;quality&#34;</span> : <span style=color:#f1fa8c>&#34;silver&#34;</span>},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">125</span><span>    partition_cols<span style=color:#ff79c6>=</span>[<span style=color:#f1fa8c>&#34;dt_trx&#34;</span>],
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">126</span><span>    temporary<span style=color:#ff79c6>=</span><span style=color:#ff79c6>False</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">127</span><span>@dlt.expect(<span style=color:#f1fa8c>&#34;valide quantity&#34;</span>,<span style=color:#f1fa8c>&#34;quantity &lt;&gt; 0&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">128</span><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>get_transactions</span>():
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">129</span><span>    <span style=color:#ff79c6>return</span> dlt<span style=color:#ff79c6>.</span>read_stream(<span style=color:#f1fa8c>&#34;FCT_TRX_RAW&#34;</span>) \
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">130</span><span>                <span style=color:#ff79c6>.</span>where(<span style=color:#f1fa8c>&#34;_rescued_data IS NULL&#34;</span>) \
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">131</span><span>                <span style=color:#ff79c6>.</span>select(expr(<span style=color:#f1fa8c>&#34;cast(id_trx as INT) as id_trx&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">132</span><span>                        ,expr(<span style=color:#f1fa8c>&#34;cast(ts_trx as timestamp) as ts_trx&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">133</span><span>                        ,expr(<span style=color:#f1fa8c>&#34;cast(id_product as INT) as id_product&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">134</span><span>                        ,expr(<span style=color:#f1fa8c>&#34;cast(id_shop as INT) as id_shop&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">135</span><span>                        ,expr(<span style=color:#f1fa8c>&#34;cast(id_client as INT) as id_client&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">136</span><span>                        ,expr(<span style=color:#f1fa8c>&#34;cast(quantity as DOUBLE) as quantity&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">137</span><span>                        ,col(<span style=color:#f1fa8c>&#34;source_file&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">138</span><span>                        ,col(<span style=color:#f1fa8c>&#34;processing_time&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">139</span><span>                        ,col(<span style=color:#f1fa8c>&#34;dt_tech&#34;</span>)) \
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">140</span><span>                <span style=color:#ff79c6>.</span>withColumn(<span style=color:#f1fa8c>&#34;_invalid_data&#34;</span>,expr(<span style=color:#f1fa8c>&#34;not(coalesce(quantity,0) &lt;&gt; 0)&#34;</span>)) \
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">141</span><span>                <span style=color:#ff79c6>.</span>withColumn(<span style=color:#f1fa8c>&#34;dt_trx&#34;</span>,expr(<span style=color:#f1fa8c>&#34;cast(ts_trx  as date)&#34;</span>))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">142</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">143</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">144</span><span><span style=color:#6272a4># Create the Materialized View named FCT_TRX_AGG_MONTH</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">145</span><span>@dlt.table(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">146</span><span>    name<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;FCT_TRX_AGG_MONTH&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">147</span><span>    comment<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;Transactions Fact Data Aggregate Month&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">148</span><span>    table_properties<span style=color:#ff79c6>=</span>{<span style=color:#f1fa8c>&#34;quality&#34;</span> : <span style=color:#f1fa8c>&#34;gold&#34;</span>},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">149</span><span>    partition_cols<span style=color:#ff79c6>=</span>[<span style=color:#f1fa8c>&#34;dt_month&#34;</span>],
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">150</span><span>    temporary<span style=color:#ff79c6>=</span><span style=color:#ff79c6>False</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">151</span><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>get_transactions_agg_month</span>():
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">152</span><span>    data_fct <span style=color:#ff79c6>=</span> dlt<span style=color:#ff79c6>.</span>read(<span style=color:#f1fa8c>&#34;FCT_TRX&#34;</span>)<span style=color:#ff79c6>.</span>where(<span style=color:#f1fa8c>&#34;not(_invalid_data)&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">153</span><span>    data_ref_products <span style=color:#ff79c6>=</span> dlt<span style=color:#ff79c6>.</span>read(<span style=color:#f1fa8c>&#34;REF_PRODUCTS&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">154</span><span>    data_ref_clients <span style=color:#ff79c6>=</span> dlt<span style=color:#ff79c6>.</span>read(<span style=color:#f1fa8c>&#34;REF_CLIENTS&#34;</span>)<span style=color:#ff79c6>.</span>where(<span style=color:#f1fa8c>&#34;__END_AT IS NULL&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">155</span><span>    <span style=color:#ff79c6>return</span> data_fct<span style=color:#ff79c6>.</span>alias(<span style=color:#f1fa8c>&#34;fct&#34;</span>)<span style=color:#ff79c6>.</span>join(data_ref_products<span style=color:#ff79c6>.</span>alias(<span style=color:#f1fa8c>&#34;rp&#34;</span>), data_fct<span style=color:#ff79c6>.</span>id_product <span style=color:#ff79c6>==</span> data_ref_products<span style=color:#ff79c6>.</span>id, how<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;inner&#34;</span>) \
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">156</span><span>                <span style=color:#ff79c6>.</span>join(data_ref_clients<span style=color:#ff79c6>.</span>alias(<span style=color:#f1fa8c>&#34;rc&#34;</span>),data_fct<span style=color:#ff79c6>.</span>id_client <span style=color:#ff79c6>==</span> data_ref_clients<span style=color:#ff79c6>.</span>id, how<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;inner&#34;</span>) \
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">157</span><span>                <span style=color:#ff79c6>.</span>withColumn(<span style=color:#f1fa8c>&#34;dt_month&#34;</span>,expr(<span style=color:#f1fa8c>&#34;cast(substring(cast(fct.dt_trx as STRING),0,7)||&#39;-01&#39; as date)&#34;</span>)) \
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">158</span><span>                <span style=color:#ff79c6>.</span>groupBy(<span style=color:#f1fa8c>&#34;dt_month&#34;</span>,<span style=color:#f1fa8c>&#34;rc.lib&#34;</span>,<span style=color:#f1fa8c>&#34;rc.contact&#34;</span>,<span style=color:#f1fa8c>&#34;rp.brand&#34;</span>) \
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">159</span><span>                <span style=color:#ff79c6>.</span>agg(<span style=color:#8be9fd;font-style:italic>sum</span>(<span style=color:#f1fa8c>&#34;fct.quantity&#34;</span>)<span style=color:#ff79c6>.</span>alias(<span style=color:#f1fa8c>&#34;sum_quantity&#34;</span>)) \
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">160</span><span>                <span style=color:#ff79c6>.</span>select(col(<span style=color:#f1fa8c>&#34;dt_month&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">161</span><span>                        ,col(<span style=color:#f1fa8c>&#34;rc.lib&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">162</span><span>                        ,col(<span style=color:#f1fa8c>&#34;rc.contact&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">163</span><span>                        ,col(<span style=color:#f1fa8c>&#34;rp.brand&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">164</span><span>                        ,col(<span style=color:#f1fa8c>&#34;sum_quantity&#34;</span>)<span style=color:#ff79c6>.</span>alias(<span style=color:#f1fa8c>&#34;quantity&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">165</span><span>                        ,expr(<span style=color:#f1fa8c>&#34;current_timestamp() as ts_tech&#34;</span>))
</span></span></code></pre></div><h1 id=creating-a-dlt-pipeline>Creating a DLT Pipeline</h1><p>To create the DLT pipeline, we will follow these steps:</p><ol><li>Create a directory in the DBFS directory to store CSV files</li><li>Copy the Python script to the Databricks Workspace</li><li>Create the DLT pipeline (taking as source the Python script copied to the Workspace Databricks)</li><li>Retrieve the DLT pipeline identifier in an environment variable named &ldquo;DBX_DLT_PIPELINE_NAME&rdquo;</li></ol><p>Using Databricks REST APIs :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4># 1. Create the directory to store CSV files (on the DBFS)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>dbx-api -X POST <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.0/dbfs/mkdirs -H <span style=color:#f1fa8c>&#39;Content-Type: application/json&#39;</span> -d <span style=color:#f1fa8c>&#34;{
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#f1fa8c>    \&#34;path\&#34;: \&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_PATH_DATA</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>\&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#f1fa8c>}&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#6272a4># 2. Copy the Python script into the Workspace</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>dbx-api -X POST <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.0/workspace/import -H <span style=color:#f1fa8c>&#39;Content-Type: application/json&#39;</span> -d <span style=color:#f1fa8c>&#34;{
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#f1fa8c>    \&#34;format\&#34;: \&#34;SOURCE\&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#f1fa8c>    \&#34;path\&#34;: \&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_USER_NBK_PATH</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>/</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>LOC_SCRIPT_DLT</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>\&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#f1fa8c>    \&#34;content\&#34; : \&#34;</span><span style=color:#ff79c6>$(</span>base64 -i <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>LOC_PATH_SCRIPT</span><span style=color:#f1fa8c>}</span>/<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>LOC_SCRIPT_DLT</span><span style=color:#f1fa8c>}</span><span style=color:#ff79c6>)</span><span style=color:#f1fa8c>\&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#f1fa8c>    \&#34;language\&#34;: \&#34;PYTHON\&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#f1fa8c>    \&#34;overwrite\&#34;: \&#34;true\&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#f1fa8c>}&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#6272a4># 3. Create the DLT Pipeline based on the Python script</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>dbx-api -X POST <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.0/pipelines -H <span style=color:#f1fa8c>&#39;Content-Type: application/json&#39;</span> -d <span style=color:#f1fa8c>&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#f1fa8c>{
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#f1fa8c>    \&#34;continuous\&#34;: false,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#f1fa8c>    \&#34;name\&#34;: \&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_DLT_PIPELINE_NAME</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>\&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#f1fa8c>    \&#34;channel\&#34;: \&#34;PREVIEW\&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#f1fa8c>    \&#34;catalog\&#34;: \&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_UC_CATALOG</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>\&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#f1fa8c>    \&#34;target\&#34;: \&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_UC_SCHEMA</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>\&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#f1fa8c>    \&#34;development\&#34;: true,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span><span style=color:#f1fa8c>    \&#34;photon\&#34;: false,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span><span style=color:#f1fa8c>    \&#34;edition\&#34;: \&#34;ADVANCED\&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span><span style=color:#f1fa8c>    \&#34;allow_duplicate_names\&#34;: \&#34;false\&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span><span style=color:#f1fa8c>    \&#34;dry_run\&#34;: false,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span><span style=color:#f1fa8c>    \&#34;configuration\&#34;: {
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span><span style=color:#f1fa8c>      \&#34;pipelines.clusterShutdown.delay\&#34;: \&#34;600s\&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span><span style=color:#f1fa8c>    },
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span><span style=color:#f1fa8c>    \&#34;clusters\&#34;: [
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span><span style=color:#f1fa8c>      {
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span><span style=color:#f1fa8c>        \&#34;label\&#34;: \&#34;default\&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span><span style=color:#f1fa8c>        \&#34;num_workers\&#34;: 1
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span><span style=color:#f1fa8c>      }
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span><span style=color:#f1fa8c>    ],
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span><span style=color:#f1fa8c>    \&#34;libraries\&#34;: [
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span><span style=color:#f1fa8c>      {
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span><span style=color:#f1fa8c>        \&#34;notebook\&#34;: {
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span><span style=color:#f1fa8c>          \&#34;path\&#34;: \&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_USER_NBK_PATH</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>/</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>LOC_SCRIPT_DLT</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>\&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span><span style=color:#f1fa8c>        }
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span><span style=color:#f1fa8c>      }
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span><span style=color:#f1fa8c>    ]
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span><span style=color:#f1fa8c>}&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span><span style=color:#6272a4># 4. Retrieve the Pipeline ID</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>DBX_DLT_PIPELINE_ID</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>`</span>dbx-api -X GET <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.0/pipelines | jq -r <span style=color:#f1fa8c>&#39;.statuses[]|select(.name==$ENV.DBX_DLT_PIPELINE_NAME)|.pipeline_id&#39;</span><span style=color:#f1fa8c>`</span>
</span></span></code></pre></div><h1 id=running-and-viewing-a-dlt-pipeline>Running and Viewing a DLT Pipeline</h1><h2 id=running-a-dlt-pipeline>Running a DLT Pipeline</h2><p>In order to be able to run the first execution of the DLT pipeline, the following actions must be done :</p><ol><li>Copy the CSV data from batch n°1 to the DBFS directory (on the Databricks Workspace)</li><li>Run the DLT pipeline</li><li>Retrieve DLT pipeline status</li></ol><p>Using Databricks REST APIs :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4># 1. Upload CSV Files (for execution)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#ff79c6>for</span> file in <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>LOC_SCRIPT_DATA_1</span><span style=color:#f1fa8c>}</span>; <span style=color:#ff79c6>do</span> 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    dbx-api -X POST <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.0/dbfs/put -H <span style=color:#f1fa8c>&#39;Content-Type: application/json&#39;</span> -d <span style=color:#f1fa8c>&#34;{
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#f1fa8c>        \&#34;path\&#34;: \&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_PATH_DATA</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>/</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>file</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>\&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#f1fa8c>        \&#34;contents\&#34;: \&#34;</span><span style=color:#ff79c6>$(</span>base64 -i <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>LOC_PATH_DATA</span><span style=color:#f1fa8c>}</span>/<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>file</span><span style=color:#f1fa8c>}</span><span style=color:#ff79c6>)</span><span style=color:#f1fa8c>\&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#f1fa8c>        \&#34;overwrite\&#34;: \&#34;true\&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#f1fa8c>        }&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#ff79c6>done</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#6272a4># 2. Execute the DLT Pipeline</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>dbx-api -X POST <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.0/pipelines/<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_DLT_PIPELINE_ID</span><span style=color:#f1fa8c>}</span>/updates -H <span style=color:#f1fa8c>&#39;Content-Type: application/json&#39;</span> -d <span style=color:#f1fa8c>&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#f1fa8c>{
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#f1fa8c>    \&#34;full_refresh\&#34;: false,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#f1fa8c>    \&#34;cause\&#34;: \&#34;USER_ACTION\&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#f1fa8c>}&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#6272a4># 3. Retrieve the status of the DLT Pipeline execution</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>dbx-api -X GET <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.0/pipelines/<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_DLT_PIPELINE_ID</span><span style=color:#f1fa8c>}</span>/events | jq <span style=color:#f1fa8c>&#39;.events[0]|.details&#39;</span>
</span></span></code></pre></div><p>In order to be able to run the second execution of the DLT pipeline, the following actions must be done :</p><ol><li>Copy the CSV data from batch n°2 to the DBFS directory (on the Databricks Workspace)</li><li>Run the DLT pipeline</li><li>Retrieve DLT pipeline status</li></ol><p>Using Databricks REST APIs :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4># 1. Upload CSV Files (for execution)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#ff79c6>for</span> file in <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>LOC_SCRIPT_DATA_2</span><span style=color:#f1fa8c>}</span>; <span style=color:#ff79c6>do</span> 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    dbx-api -X POST <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.0/dbfs/put -H <span style=color:#f1fa8c>&#39;Content-Type: application/json&#39;</span> -d <span style=color:#f1fa8c>&#34;{
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#f1fa8c>        \&#34;path\&#34;: \&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_PATH_DATA</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>/</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>file</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>\&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#f1fa8c>        \&#34;contents\&#34;: \&#34;</span><span style=color:#ff79c6>$(</span>base64 -i <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>LOC_PATH_DATA</span><span style=color:#f1fa8c>}</span>/<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>file</span><span style=color:#f1fa8c>}</span><span style=color:#ff79c6>)</span><span style=color:#f1fa8c>\&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#f1fa8c>        \&#34;overwrite\&#34;: \&#34;true\&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#f1fa8c>        }&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#ff79c6>done</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#6272a4># 2. Execute the DLT Pipeline</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>dbx-api -X POST <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.0/pipelines/<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_DLT_PIPELINE_ID</span><span style=color:#f1fa8c>}</span>/updates -H <span style=color:#f1fa8c>&#39;Content-Type: application/json&#39;</span> -d <span style=color:#f1fa8c>&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#f1fa8c>{
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#f1fa8c>    \&#34;full_refresh\&#34;: false,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#f1fa8c>    \&#34;cause\&#34;: \&#34;USER_ACTION\&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#f1fa8c>}&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#6272a4># 3. Retrieve the status of the DLT Pipeline execution</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>dbx-api -X GET <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.0/pipelines/<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_DLT_PIPELINE_ID</span><span style=color:#f1fa8c>}</span>/events | jq <span style=color:#f1fa8c>&#39;.events[0]|.details&#39;</span>
</span></span></code></pre></div><h2 id=dlt-pipeline-visualization>DLT Pipeline Visualization</h2><p>Result after the first execution of the DLT pipeline :
<a href=/blog/web/20230612_databricks_unity_catalog_deltalivetables_05.png><img src=/blog/web/20230612_databricks_unity_catalog_deltalivetables_05.png alt=schema_05></a></p><p>Detail of the &ldquo;FCT_TRX&rdquo; object (with the constraint/expectation on the &ldquo;quantity&rdquo; information) :
<a href=/blog/web/20230612_databricks_unity_catalog_deltalivetables_06.png><img src=/blog/web/20230612_databricks_unity_catalog_deltalivetables_06.png alt=schema_06></a></p><p>Detail of the &ldquo;REF_CLIENTS&rdquo; object (feeded by the SCD type 2 process) :
<a href=/blog/web/20230612_databricks_unity_catalog_deltalivetables_07.png><img src=/blog/web/20230612_databricks_unity_catalog_deltalivetables_07.png alt=schema_07></a></p><p>Result after the seoncd execution of the DLT pipeline ::
<a href=/blog/web/20230612_databricks_unity_catalog_deltalivetables_08.png><img src=/blog/web/20230612_databricks_unity_catalog_deltalivetables_08.png alt=schema_08></a></p><p>Detail of the &ldquo;FCT_TRX&rdquo; object (with the constraint/expectation on the &ldquo;quantity&rdquo; information) :
<a href=/blog/web/20230612_databricks_unity_catalog_deltalivetables_09.png><img src=/blog/web/20230612_databricks_unity_catalog_deltalivetables_08.png alt=schema_09></a></p><p>Detail of the &ldquo;REF_CLIENTS&rdquo; object (feeded by the SCD type 2 process) :
<a href=/blog/web/20230612_databricks_unity_catalog_deltalivetables_10.png><img src=/blog/web/20230612_databricks_unity_catalog_deltalivetables_10.png alt=schema_10></a></p><p>Example of the tab containing the event logs of the second execution of the DLT pipeline :
<a href=/blog/web/20230612_databricks_unity_catalog_deltalivetables_11.png><img src=/blog/web/20230612_databricks_unity_catalog_deltalivetables_11.png alt=schema_11></a></p><p>Oberservation :</p><ul><li>The DLT pipeline graph makes it very easy to visualize the lineage of the data as well as the number of records processed (or deleted) during each step (object)</li><li>When we click on an object, we can have metrics on the object (number of records written and deleted, number of records violating a constraint, schema of the object, date and time of execution, duration, . ..)</li><li>At the bottom of the screen, we have access to all the event logs of the execution of the DLT pipeline and it is possible to filter them on the options &ldquo;All&rdquo;, &ldquo;Info&rdquo;, &ldquo;Warning&rdquo; and " Error" or on the description of the events.</li><li>It is possible to choose the execution you want to view by selecting it from the drop-down list (by execution timestamp and containing the last execution status).</li></ul><h2 id=visualization-with-unity-catalog>Visualization with Unity Catalog</h2><p>Visualization of the objects in the &ldquo;sch_dlt_demo&rdquo; schema in the &ldquo;ctg_dlt_demo&rdquo; catalog:
<a href=/blog/web/20230612_databricks_unity_catalog_deltalivetables_12.png><img src=/blog/web/20230612_databricks_unity_catalog_deltalivetables_12.png alt=schema_12></a></p><p>Viewing details for the &ldquo;FCT_TRX&rdquo; object which is a &ldquo;Streaming Table&rdquo; object :
<a href=/blog/web/20230612_databricks_unity_catalog_deltalivetables_13.png><img src=/blog/web/20230612_databricks_unity_catalog_deltalivetables_13.png alt=schema_13></a></p><p>Viewing details for the &ldquo;FCT_TRX_AGG_MONTH&rdquo; object which is a &ldquo;Materialized View&rdquo; object :
<a href=/blog/web/20230612_databricks_unity_catalog_deltalivetables_14.png><img src=/blog/web/20230612_databricks_unity_catalog_deltalivetables_14.png alt=schema_14></a></p><p>Observation :</p><ul><li>We can see that the &ldquo;Storage Location&rdquo; information does not exist because they are not actually Delta tables but they can be seen as logical objects.</li></ul><p>Regarding Data Lineage :
Visualization of the lineage starting from the &ldquo;REF_CLIENTS&rdquo; object :
<a href=/blog/web/20230612_databricks_unity_catalog_deltalivetables_15.png><img src=/blog/web/20230612_databricks_unity_catalog_deltalivetables_15.png alt=schema_15></a>
Observation :</p><ul><li>We can observe that there is information for the objects defined in the DLT pipeline except for the data source of the object &ldquo;REF_CLIENTS&rdquo; which is named &ldquo;REF_CLIENTS_RAW&rdquo;</li><li>We can observe that there is no information about data sources (CSV files)</li></ul><p>Visualization of the lineage starting from the &ldquo;REF_CLIENTS_RAW&rdquo; object :
<a href=/blog/web/20230612_databricks_unity_catalog_deltalivetables_16.png><img src=/blog/web/20230612_databricks_unity_catalog_deltalivetables_16.png alt=schema_16></a>
Observation :</p><ul><li>We can observe that the &ldquo;REF_CLIENTS_RAW&rdquo; object has no lineage information while it is the source of the &ldquo;REF_CLIENTS&rdquo; object&rsquo;s in the DLT pipeline</li></ul><p>Regarding internal objects :
Warning: To be able to view them, you must have the following rights</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>GRANT</span> USE_CATALOG <span style=color:#ff79c6>ON</span> <span style=color:#ff79c6>CATALOG</span> __databricks_internal <span style=color:#ff79c6>TO</span> <span style=color:#ff79c6>&lt;</span><span style=color:#ff79c6>user</span> <span style=color:#ff79c6>or</span> <span style=color:#ff79c6>group</span><span style=color:#ff79c6>&gt;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#ff79c6>GRANT</span> USE_SCHEMA <span style=color:#ff79c6>ON</span> <span style=color:#ff79c6>SCHEMA</span> __databricks_internal.__dlt_materialization_schema_<span style=color:#ff79c6>&lt;</span>pipeline_id<span style=color:#ff79c6>&gt;</span> <span style=color:#ff79c6>TO</span> <span style=color:#ff79c6>&lt;</span><span style=color:#ff79c6>user</span> <span style=color:#ff79c6>or</span> <span style=color:#ff79c6>group</span><span style=color:#ff79c6>&gt;</span>;
</span></span></code></pre></div><p>Visualizing the <code>__databricks_internal</code> internal catalog with Data Explorer
<a href=/blog/web/20230612_databricks_unity_catalog_deltalivetables_17.png><img src=/blog/web/20230612_databricks_unity_catalog_deltalivetables_17.png alt=schema_17></a></p><p>Visualization of details for the &ldquo;FCT_TRX&rdquo; internal object (which contains the data of a &ldquo;Streaming Table&rdquo; object) :
<a href=/blog/web/20230612_databricks_unity_catalog_deltalivetables_18.png><img src=/blog/web/20230612_databricks_unity_catalog_deltalivetables_18.png alt=schema_18></a></p><p>Visualization of details for the &ldquo;FCT_TRX_AGG_MONTH&rdquo; internal object (which contains the data of a &ldquo;Materialized View&rdquo; object) :
<a href=/blog/web/20230612_databricks_unity_catalog_deltalivetables_19.png><img src=/blog/web/20230612_databricks_unity_catalog_deltalivetables_19.png alt=schema_19></a></p><p>Observation :</p><ul><li>We can observe that these are Delta tables</li></ul><h1 id=monitoring-a-dlt-pipeline>Monitoring a DLT pipeline</h1><p>Monitoring a DLT pipeline relies on event logs related to the execution of the DLT pipeline, including audit, data quality, and lineage logs.
This enables analysis of executions and status of DLT pipelines.</p><p>The <code>__event_log</code> internal object is a Delta table which contains a subdirectory named <code>_dlt_metadata</code> and containing an <code>_autoloader</code> directory with information allowing to manage the loading of data by the system with Auto Loader.</p><p>There are four methods of accessing event logs regarding the DLT pipelines execution :</p><ol><li>The 1st method is to use the Databricks Workspace user interface<ol><li>Click on the &ldquo;Workflows&rdquo; option in the side menu</li><li>Click on the &ldquo;Delta Live Tables&rdquo; tab</li><li>Select the desired DLT pipeline</li><li>Select the desired DLT pipeline run (sorted by descending start timestamp)</li><li>All event logs can be found in the tab at the bottom of the interface</li></ol></li><li>The 2nd method is to use the <a href=https://docs.databricks.com/api/workspace/pipelines/listpipelineevents>Databricks REST API</a></li><li>The 3rd method is to use the <code>event_log(&lt;pipeline_id)</code> function (table valued function), this is the method recommended by Databricks</li><li>The 4th method is to access the Delta table <code>__event_log</code> located in the internal schema linked to the DLT pipeline<ol><li>This method requires having the &ldquo;USE&rdquo; right on the internal schema and on the corresponding internal catalog</li></ol></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>GRANT</span> USE_CATALOG <span style=color:#ff79c6>ON</span> <span style=color:#ff79c6>CATALOG</span> __databricks_internal <span style=color:#ff79c6>TO</span> <span style=color:#ff79c6>&lt;</span><span style=color:#ff79c6>user</span> <span style=color:#ff79c6>or</span> <span style=color:#ff79c6>group</span><span style=color:#ff79c6>&gt;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#ff79c6>GRANT</span> USE_SCHEMA <span style=color:#ff79c6>ON</span> <span style=color:#ff79c6>SCHEMA</span> __databricks_internal.__dlt_materialization_schema_<span style=color:#ff79c6>&lt;</span>pipeline_id<span style=color:#ff79c6>&gt;</span> <span style=color:#ff79c6>TO</span> <span style=color:#ff79c6>&lt;</span><span style=color:#ff79c6>user</span> <span style=color:#ff79c6>or</span> <span style=color:#ff79c6>group</span><span style=color:#ff79c6>&gt;</span>;
</span></span></code></pre></div><p>DLT pipeline event log storage is physically separated for each DLT pipeline and there is no default view that provides an aggregated view of event logs.
You will find detail of the event logs schema in the <a href=https://docs.databricks.com/delta-live-tables/observability.html#event-log-schema>official documentation</a></p><p>The types of existing events are as follows (not exhaustive):</p><ul><li>user_action: Information about user actions (creation of a DLT pipeline, execution of a DLT pipeline, stop of a DLT pipeline)</li><li>create_update: Information about the DLT pipeline execution request (origin of the request)</li><li>update_progress: Information about the execution steps of the DLT pipeline (WAITING_FOR_RESOURCES, INITIALIZING, SETTING_UP_TABLES, RUNNING, COMPLETED, FAILED)</li><li>flow_definition: Information about the definition of objects (Type of update (INCREMENTAL, CHANGE, COMPLETE), object schema, &mldr;)</li><li>dataset_definition: Information about the definition of objects (schema, storage, type, &mldr;)</li><li>graph_created: Information about the creation of the graph during the execution of the DLT pipeline</li><li>planning_information: Information about the refresh schedule for &ldquo;Materialized View&rdquo; objects</li><li>flow_progress: Information about the execution steps of all the elements defined in the DLT pipeline (QUEUED, STARTING, RUNNING, COMPLETED, FAILED)</li><li>cluster_resources: Information about DLT pipeline cluster resource management</li><li>maintenance_progress: Information about the maintenance operations on the data within 24 hours after the last execution of the DLT pipeline</li></ul><p>Warning :</p><ul><li>Metrics are not captured for &ldquo;Streaming Table&rdquo; objects feeded with the Type 2 Slow Changing Dimension (SCD) process managed by the DLT framework<ul><li>Nevertheless, it is possible to have metrics by accessing the history of the internal Delta table directly</li></ul></li><li>When there are records that do not respect the constraints on an object, we have access to the metrics on the number of records but not the details of the records concerned.</li></ul><p>It is very easy to set up event logs based dashboards or exports to centralize information from the Databricks REST API, SQL Warehouse or by adding processing (in a Job) after the execution of each DLT pipeline to retrieve the necessary information.</p><p>We will use the 3rd method to give examples of queries to analyze the DLT pipeline.</p><p>1/ Example query to retrieve all information for the last run of the DLT pipeline :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>with</span> updid (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>  <span style=color:#ff79c6>select</span> row_number() over (<span style=color:#ff79c6>order</span> <span style=color:#ff79c6>by</span> ts_start_pipeline <span style=color:#ff79c6>desc</span>) <span style=color:#ff79c6>as</span> num_exec_desc
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>        ,update_id
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>        ,ts_start_pipeline
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>  <span style=color:#ff79c6>from</span> (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#ff79c6>select</span> origin.update_id <span style=color:#ff79c6>as</span> update_id,<span style=color:#ff79c6>min</span>(<span style=color:#ff79c6>timestamp</span>) <span style=color:#ff79c6>as</span> ts_start_pipeline
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#ff79c6>from</span> event_log(<span style=color:#f1fa8c>&#39;a64f295a-1655-43ca-9543-f1dd1e73009c&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#ff79c6>where</span> origin.update_id <span style=color:#ff79c6>is</span> <span style=color:#ff79c6>not</span> <span style=color:#ff79c6>null</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#ff79c6>group</span> <span style=color:#ff79c6>by</span> origin.update_id
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>  )
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#ff79c6>select</span> l.<span style=color:#ff79c6>*</span> 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#ff79c6>from</span> event_log(<span style=color:#f1fa8c>&#39;a64f295a-1655-43ca-9543-f1dd1e73009c&#39;</span>) l
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#ff79c6>where</span> l.origin.update_id <span style=color:#ff79c6>=</span> (<span style=color:#ff79c6>select</span> update_id <span style=color:#ff79c6>from</span> updid <span style=color:#ff79c6>where</span> num_exec_desc <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#ff79c6>order</span> <span style=color:#ff79c6>by</span> <span style=color:#ff79c6>timestamp</span> <span style=color:#ff79c6>desc</span>
</span></span></code></pre></div><p>Result :
<a href=/blog/web/20230612_databricks_unity_catalog_deltalivetables_20.png><img src=/blog/web/20230612_databricks_unity_catalog_deltalivetables_20.png alt=schema_20></a></p><p>2/ Example of a query to retrieve the number of lines written for each object during the two executions of the DLT pipeline :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>with</span> updid (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>  <span style=color:#ff79c6>select</span> row_number() over (<span style=color:#ff79c6>order</span> <span style=color:#ff79c6>by</span> ts_start_pipeline <span style=color:#ff79c6>desc</span>) <span style=color:#ff79c6>as</span> num_exec_desc
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>        ,update_id
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>        ,ts_start_pipeline
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>  <span style=color:#ff79c6>from</span> (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#ff79c6>select</span> origin.update_id <span style=color:#ff79c6>as</span> update_id,<span style=color:#ff79c6>min</span>(<span style=color:#ff79c6>timestamp</span>) <span style=color:#ff79c6>as</span> ts_start_pipeline
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#ff79c6>from</span> event_log(<span style=color:#f1fa8c>&#39;a64f295a-1655-43ca-9543-f1dd1e73009c&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#ff79c6>where</span> origin.update_id <span style=color:#ff79c6>is</span> <span style=color:#ff79c6>not</span> <span style=color:#ff79c6>null</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#ff79c6>group</span> <span style=color:#ff79c6>by</span> origin.update_id
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>  )
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#ff79c6>select</span> l.origin.flow_name
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>  ,u.ts_start_pipeline
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>  ,<span style=color:#ff79c6>sum</span>(l.details:[<span style=color:#f1fa8c>&#39;flow_progress&#39;</span>][<span style=color:#f1fa8c>&#39;metrics&#39;</span>][<span style=color:#f1fa8c>&#39;num_output_rows&#39;</span>]) <span style=color:#ff79c6>as</span> num_output_rows
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>  ,<span style=color:#ff79c6>sum</span>(l.details:[<span style=color:#f1fa8c>&#39;flow_progress&#39;</span>][<span style=color:#f1fa8c>&#39;metrics&#39;</span>][<span style=color:#f1fa8c>&#39;num_upserted_rows&#39;</span>]) <span style=color:#ff79c6>as</span> num_upserted_rows
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>  ,<span style=color:#ff79c6>sum</span>(l.details:[<span style=color:#f1fa8c>&#39;flow_progress&#39;</span>][<span style=color:#f1fa8c>&#39;metrics&#39;</span>][<span style=color:#f1fa8c>&#39;num_deleted_rows&#39;</span>]) <span style=color:#ff79c6>as</span> num_deleted_rows
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#ff79c6>from</span> event_log(<span style=color:#f1fa8c>&#39;a64f295a-1655-43ca-9543-f1dd1e73009c&#39;</span>) l
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#ff79c6>inner</span> <span style=color:#ff79c6>join</span> updid u
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#ff79c6>on</span> (l.origin.update_id <span style=color:#ff79c6>=</span> u.update_id)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#ff79c6>and</span> event_type <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;flow_progress&#39;</span> 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#ff79c6>and</span> details:[<span style=color:#f1fa8c>&#39;flow_progress&#39;</span>][<span style=color:#f1fa8c>&#39;metrics&#39;</span>] <span style=color:#ff79c6>is</span> <span style=color:#ff79c6>not</span> <span style=color:#ff79c6>null</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#ff79c6>group</span> <span style=color:#ff79c6>by</span> l.origin.flow_name
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>  ,u.ts_start_pipeline
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span><span style=color:#ff79c6>order</span> <span style=color:#ff79c6>by</span> l.origin.flow_name
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>  ,u.ts_start_pipeline
</span></span></code></pre></div><p>Comments :</p><ul><li>When the object is a &ldquo;Streaming Table&rdquo;, the metrics are captured with the event that has the &ldquo;RUNNING&rdquo; status<ul><li>Special case for the &ldquo;Streaming Table&rdquo; object using the SCD Type 2 process whose metrics are not captured</li></ul></li><li>When the object is a &ldquo;Materialized View&rdquo;, the metrics are captured with the event which has the status &ldquo;COMPLETED&rdquo;</li><li>When the object is a &ldquo;View&rdquo;, no metrics are captured</li></ul><p>Result :
<a href=/blog/web/20230612_databricks_unity_catalog_deltalivetables_21.png><img src=/blog/web/20230612_databricks_unity_catalog_deltalivetables_21.png alt=schema_21></a></p><p>Comments :</p><ul><li>We can observe that the &ldquo;REF_PRODUCTS&rdquo; and &ldquo;REF_PRODUCTS_RAW&rdquo; objects had no new data on the second run</li><li>We can observe that the &ldquo;REF_CLIENT&rdquo; object has no information while the &ldquo;REF_CLIENT_RAW&rdquo; source object has retrieved only the new data during each execution of the DLT pipeline</li></ul><p>3/ Example query to retrieve the number of records violating the constraints for the &ldquo;FCT_TRX&rdquo; object during each execution of the DLT pipeline:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>with</span> updid (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>  <span style=color:#ff79c6>select</span> row_number() over (<span style=color:#ff79c6>order</span> <span style=color:#ff79c6>by</span> ts_start_pipeline <span style=color:#ff79c6>desc</span>) <span style=color:#ff79c6>as</span> num_exec_desc
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>        ,update_id
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>        ,ts_start_pipeline
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>  <span style=color:#ff79c6>from</span> (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#ff79c6>select</span> origin.update_id <span style=color:#ff79c6>as</span> update_id,<span style=color:#ff79c6>min</span>(<span style=color:#ff79c6>timestamp</span>) <span style=color:#ff79c6>as</span> ts_start_pipeline
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#ff79c6>from</span> event_log(<span style=color:#f1fa8c>&#39;a64f295a-1655-43ca-9543-f1dd1e73009c&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#ff79c6>where</span> origin.update_id <span style=color:#ff79c6>is</span> <span style=color:#ff79c6>not</span> <span style=color:#ff79c6>null</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#ff79c6>group</span> <span style=color:#ff79c6>by</span> origin.update_id
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>  )
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#ff79c6>select</span> flow_name
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>  ,metrics.name
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>  ,ts_start_pipeline
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>  ,<span style=color:#ff79c6>sum</span>(metrics.passed_records) <span style=color:#ff79c6>as</span> passed_records
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>  ,<span style=color:#ff79c6>sum</span>(metrics.failed_records) <span style=color:#ff79c6>as</span> failed_records
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#ff79c6>from</span> (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>  <span style=color:#ff79c6>select</span> l.origin.flow_name <span style=color:#ff79c6>as</span> flow_name
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    ,u.ts_start_pipeline <span style=color:#ff79c6>as</span> ts_start_pipeline
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    ,explode(from_json(l.details:[<span style=color:#f1fa8c>&#39;flow_progress&#39;</span>][<span style=color:#f1fa8c>&#39;data_quality&#39;</span>][<span style=color:#f1fa8c>&#39;expectations&#39;</span>][<span style=color:#ff79c6>*</span>], <span style=color:#f1fa8c>&#39;array&lt;struct&lt;name string, passed_records int, failed_records int &gt;&gt;&#39;</span>)) <span style=color:#ff79c6>as</span> metrics
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>  <span style=color:#ff79c6>from</span> event_log(<span style=color:#f1fa8c>&#39;a64f295a-1655-43ca-9543-f1dd1e73009c&#39;</span>) l
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>  <span style=color:#ff79c6>inner</span> <span style=color:#ff79c6>join</span> updid u
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>  <span style=color:#ff79c6>on</span> (l.origin.update_id <span style=color:#ff79c6>=</span> u.update_id)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>  <span style=color:#ff79c6>and</span> event_type <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;flow_progress&#39;</span> 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>  <span style=color:#ff79c6>and</span> origin.flow_name <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;fct_trx&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>  <span style=color:#ff79c6>and</span> details:[<span style=color:#f1fa8c>&#39;flow_progress&#39;</span>][<span style=color:#f1fa8c>&#39;data_quality&#39;</span>] <span style=color:#ff79c6>is</span> <span style=color:#ff79c6>not</span> <span style=color:#ff79c6>null</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>) wrk
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span><span style=color:#ff79c6>group</span> <span style=color:#ff79c6>by</span> flow_name
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>  ,metrics.name
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>  ,ts_start_pipeline
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span><span style=color:#ff79c6>order</span> <span style=color:#ff79c6>by</span> flow_name
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>  ,metrics.name
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>  ,ts_start_pipeline
</span></span></code></pre></div><p>Result :
<a href=/blog/web/20230612_databricks_unity_catalog_deltalivetables_22.png><img src=/blog/web/20230612_databricks_unity_catalog_deltalivetables_22.png alt=schema_22></a></p><p>4/ Example query to retrieve the start and end timestamp of each run of the DLT pipeline :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>with</span> updid (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>  <span style=color:#ff79c6>select</span> row_number() over (<span style=color:#ff79c6>order</span> <span style=color:#ff79c6>by</span> ts_start_pipeline <span style=color:#ff79c6>desc</span>) <span style=color:#ff79c6>as</span> num_exec_desc
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>        ,update_id
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>        ,ts_start_pipeline
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>  <span style=color:#ff79c6>from</span> (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#ff79c6>select</span> origin.update_id <span style=color:#ff79c6>as</span> update_id,<span style=color:#ff79c6>min</span>(<span style=color:#ff79c6>timestamp</span>) <span style=color:#ff79c6>as</span> ts_start_pipeline
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#ff79c6>from</span> event_log(<span style=color:#f1fa8c>&#39;a64f295a-1655-43ca-9543-f1dd1e73009c&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#ff79c6>where</span> origin.update_id <span style=color:#ff79c6>is</span> <span style=color:#ff79c6>not</span> <span style=color:#ff79c6>null</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#ff79c6>group</span> <span style=color:#ff79c6>by</span> origin.update_id
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>  )
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#ff79c6>select</span> update_id
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>,start_time
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>,end_time
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>,end_time <span style=color:#ff79c6>-</span> start_time <span style=color:#ff79c6>as</span> duration
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>,last_state
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#ff79c6>from</span> (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>  <span style=color:#ff79c6>select</span> l.origin.update_id <span style=color:#ff79c6>as</span> update_id
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    ,<span style=color:#ff79c6>min</span>(l.<span style=color:#ff79c6>timestamp</span>) over (partition <span style=color:#ff79c6>by</span> l.origin.update_id) <span style=color:#ff79c6>as</span> start_time
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    ,<span style=color:#ff79c6>max</span>(l.<span style=color:#ff79c6>timestamp</span>) over (partition <span style=color:#ff79c6>by</span> l.origin.update_id) <span style=color:#ff79c6>as</span> end_time
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>    ,row_number() over (partition <span style=color:#ff79c6>by</span> l.origin.update_id <span style=color:#ff79c6>order</span> <span style=color:#ff79c6>by</span> <span style=color:#ff79c6>timestamp</span> <span style=color:#ff79c6>desc</span>) <span style=color:#ff79c6>as</span> num
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>    ,l.details:[<span style=color:#f1fa8c>&#39;update_progress&#39;</span>][<span style=color:#f1fa8c>&#39;state&#39;</span>] <span style=color:#ff79c6>as</span> last_state
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>  <span style=color:#ff79c6>from</span> event_log(<span style=color:#f1fa8c>&#39;a64f295a-1655-43ca-9543-f1dd1e73009c&#39;</span>) l
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>  <span style=color:#ff79c6>inner</span> <span style=color:#ff79c6>join</span> updid u
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>  <span style=color:#ff79c6>on</span> (l.origin.update_id <span style=color:#ff79c6>=</span> u.update_id)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>  <span style=color:#ff79c6>and</span> event_type <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;update_progress&#39;</span> 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>) wrk
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span><span style=color:#ff79c6>where</span> num <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span><span style=color:#ff79c6>order</span> <span style=color:#ff79c6>by</span> update_id
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>,start_time <span style=color:#ff79c6>asc</span>
</span></span></code></pre></div><p>Result :
<a href=/blog/web/20230612_databricks_unity_catalog_deltalivetables_23.png><img src=/blog/web/20230612_databricks_unity_catalog_deltalivetables_23.png alt=schema_23></a></p><h1 id=clean-environment>Clean environment</h1><p>Delete the DLT pipeline</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>dbx-api -X DELETE <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.0/pipelines/<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_DLT_PIPELINE_ID</span><span style=color:#f1fa8c>}</span>
</span></span></code></pre></div><p>Delete the Python script from the Databricks Workspace</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>dbx-api -X POST <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.0/workspace/delete -H <span style=color:#f1fa8c>&#39;Content-Type: application/json&#39;</span> -d <span style=color:#f1fa8c>&#34;{
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#f1fa8c>    \&#34;path\&#34;: \&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_USER_NBK_PATH</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>/</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>LOC_SCRIPT_DLT</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>\&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#f1fa8c>    \&#34;recursive\&#34;: \&#34;false\&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#f1fa8c>}&#34;</span>
</span></span></code></pre></div><p>Delete CSV fils from Databricks Workspace DBFS storage</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>dbx-api -X POST <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_API_URL</span><span style=color:#f1fa8c>}</span>/api/2.0/dbfs/delete -H <span style=color:#f1fa8c>&#39;Content-Type: application/json&#39;</span> -d <span style=color:#f1fa8c>&#34;{
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#f1fa8c>    \&#34;path\&#34;: \&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DBX_PATH_DATA</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>\&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#f1fa8c>    \&#34;recursive\&#34;: \&#34;true\&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#f1fa8c>}&#34;</span>
</span></span></code></pre></div><p>Delete the &ldquo;CTG_DLT_DEMO&rdquo; catalog from the Unity Catalog Metastore :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>-- Delete the Catalog with CASCADE option (to delete all objects)
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>DROP</span> <span style=color:#ff79c6>CATALOG</span> <span style=color:#ff79c6>IF</span> <span style=color:#ff79c6>EXISTS</span> CTG_DLT_DEMO <span style=color:#ff79c6>CASCADE</span>;
</span></span></code></pre></div><p>Warning :</p><ul><li>When we delete the catalog &ldquo;CTG_DLT_DEMO&rdquo; and the DLT pipeline, the internal Delta tables are not deleted directly (nor the internal schema).</li><li>It is necessary to wait for the automatic maintenance operation after the deletion of the DLT pipeline so that the elements are deleted.</li></ul><h1 id=conclusion>Conclusion</h1><p>The DLT framework makes it possible to be very efficient in the creation and execution of an ETL pipeline and to be able to easily add data quality management (subject to use the Advanced edition).</p><p>Being able to view the graph and metrics associated with objects of a specific DLT pipeline run is extremely convenient for quick analysis.
In addition, access to event logs (stored in a Delta table) allows us to retrieve a lot of information and to be able to perform analyzes and dashboards very simply.</p><p>During POC or specific ETL ingestion processing, it is very practical to be able to rely on the DLT framework but in the context of a project requiring the management of numerous objects and schemas, we find ourselves much too limited to be able to use the DLT framework.</p><p>As it stands (public preview), the limitations are too important for us to recommend using the DLT framework with Unity Catalog for major projects:</p><ul><li>Lineage is incomplete if the object is not managed in the DLT pipeline, or if &ldquo;View&rdquo; objects are used.</li><li>Only one target schema can be used for all elements of a DLT pipeline</li><li>Some operations (SCD Type 1 and 2 management) have no metrics captured in event logs</li><li>No aggregation of event logs for all pipelines by default if you wish to perform analyses on all DLT pipelines</li></ul><p>In my humble opinion, it&rsquo;s still a bit early to use the DLT framework relying on the Unity Catalog solution to manage all the ETL processes for managing a company&rsquo;s data, but i can&rsquo;t wait to see future improvements made by Databricks to make it a central and powerful tool for managing ETL processes while taking advantage of all the features of the Unity Catalog solution (Data Lineage, Delta Sharing, &mldr;).</p></div></article></div></div><footer><div class="container-fluid prag-bg-primary prag-foot">Build With <a href=https://gohugo.io/>Hugo</a>
&nbsp; - &nbsp;
<a href=https://en.wikipedia.org/wiki/WTFPL>WTFPL license</a> © 2018–2023</div></footer></body></html>